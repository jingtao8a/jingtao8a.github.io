<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jingtao8a.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="this is life, full of ups and down">
<meta property="og:type" content="website">
<meta property="og:title" content="jingtao8a&#39;s blog">
<meta property="og:url" content="http://jingtao8a.github.io/index.html">
<meta property="og:site_name" content="jingtao8a&#39;s blog">
<meta property="og:description" content="this is life, full of ups and down">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="jingtao8a">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://jingtao8a.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>jingtao8a's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">jingtao8a's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/09/28/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/28/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/" class="post-title-link" itemprop="url">EWALI:a Data-aware Learned Index Schema for Efficient Writes</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-28 18:58:19 / Modified: 19:11:12" itemprop="dateCreated datePublished" datetime="2024-09-28T18:58:19-07:00">2024-09-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Learned-Index/" itemprop="url" rel="index"><span itemprop="name">Learned Index</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="应用场景："><a href="#应用场景：" class="headerlink" title="应用场景："></a>应用场景：</h3><p>(1)支持读写工作负载,在重写工作负载中性能表现很好<br><br>(2)使用轻量的light-weight data-aware data partition algorithm构建模型<br><br>(3)当data distribution发生变化，EWALI会自动分裂相关叶子节点，重训练模型<br><br>(4)并采用duel buffer（双缓冲）来处理新数据，并采用延迟更新机制合并数据，提高写入性能<br></p>
<p>问题描述：<br>（1）RMI不支持写操作，插入新数据导致data distribution变化，需要重训练所有模型<br>（2）RMI构建时采用统一的数据划分策略，没有考虑划分到同一模型中数据的相似性，导致预测不准确</p>
<h3 id="难点和分析过程："><a href="#难点和分析过程：" class="headerlink" title="难点和分析过程："></a>难点和分析过程：</h3><p>（1）现在支持写操作的方法包括就地插入（gap array，需要移动数据或产生不必要的空间开销）缓冲区插入（发生写入阻塞）<br><br>（2）现存的data-partition-algorithm<br><br>K-means算法（Dabble模型）<br><br>贪心算法（ASLM）<br><br>Piece-wise linear function（PGM-iNDEX  FITing-Tree）</p>
<p>以上不同的算法有不同的计算开销和误差</p>
<h3 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h3><p><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image.png" alt="img"></p>
<h4 id="Data-partition-algorithm"><a href="#Data-partition-algorithm" class="headerlink" title="Data-partition-algorithm"></a>Data-partition-algorithm</h4><p>考虑lower model error 和 time cost 以及 memory usage选择ShrinkingCone<br><br><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy.png" alt="img"><br><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%202.png" alt="img"></p>
<h4 id="DARMI-Design"><a href="#DARMI-Design" class="headerlink" title="DARMI Design"></a>DARMI Design</h4><h5 id="Model-Training"><a href="#Model-Training" class="headerlink" title="Model Training:"></a>Model Training:</h5><p>(1)non-leaf node<br>(2)leaf node</p>
<h5 id="Model-Retraining"><a href="#Model-Retraining" class="headerlink" title="Model Retraining:"></a>Model Retraining:</h5><p>当incremental buffer与segments合并后，改变了数据分布，后台线程被唤醒进行retraining操作</p>
<h5 id="Node-Split"><a href="#Node-Split" class="headerlink" title="Node Split:"></a>Node Split:</h5><p>当一个Node管辖的data数量超过一定数量时，会产生以下影响<br>1.过多的数据会导致重训练的时候要扫描更多的key，增加训练耗时，降低写性能<br>2.过多的数据也会让线性模型更难去拟合，精准度会下降</p>
<p>(1)horizontal split<br>Disadvantages: result in lower prediction accuracy of parent model</p>
<p>(2)Vertical split<br>Disadvantages: increase the height of DARMI, result in high lookup time<br><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%203.png" alt="img"><br>DARMI会动态地选择两种split方式<br><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%204.png" alt="img"><br><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%205.png" alt="img"></p>
<h5 id="Retrain-DARMI"><a href="#Retrain-DARMI" class="headerlink" title="Retrain DARMI"></a>Retrain DARMI</h5><p>当DARMI的高度达到一个阈值，查找性能退化地过于严重了，需要对root Node进行重训练，<br>将所有的old leaf node的first key用来训练root node的线性模型，DARMI又变成two-layer</p>
<h4 id="Incremental-Buffer-Design"><a href="#Incremental-Buffer-Design" class="headerlink" title="Incremental Buffer Design"></a>Incremental Buffer Design</h4><p><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%206.png" alt="img"></p>
<h4 id="DARMI的核心操作"><a href="#DARMI的核心操作" class="headerlink" title="DARMI的核心操作"></a>DARMI的核心操作</h4><p><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%207.png" alt="img"></p>
<p><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%208.png" alt="img"></p>
<p><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%209.png" alt="img"></p>
<p><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%2010.png" alt="img"></p>
<h3 id="结果："><a href="#结果：" class="headerlink" title="结果："></a>结果：</h3><p>数据集：<br><br>真实数据集（NYCT、OSM） 合成数据集（Lognormal）<br><br>工作负载：<br><br>（1）read-only （2）write-only （3）write-read-balance (50% read 50%write)<br><br>（4）write-heavy(95% write 5% read) （5）read-heavy(95% read 5%write)<br><br>（6）short-ranges(95% range queries 5% write)<br></p>
<p><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%2011.png" alt="img"><br><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%2012.png" alt="img"><br><img src="/../images/EWALI-a-Data-aware-Learned-Index-Schema-for-Efficient-Writes/image%20copy%2013.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/09/28/ASLM-Adaptive-Single-Layer-Model-for-Learned-Index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/28/ASLM-Adaptive-Single-Layer-Model-for-Learned-Index/" class="post-title-link" itemprop="url">ASLM:Adaptive Single Layer Model for Learned Index</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-28 18:51:06 / Modified: 18:56:14" itemprop="dateCreated datePublished" datetime="2024-09-28T18:51:06-07:00">2024-09-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Learned-Index/" itemprop="url" rel="index"><span itemprop="name">Learned Index</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="应用场景："><a href="#应用场景：" class="headerlink" title="应用场景："></a>应用场景：</h3><p>读写场景</p>
<h3 id="问题描述："><a href="#问题描述：" class="headerlink" title="问题描述："></a>问题描述：</h3><p>Learned Index<br><br>(1)RMI 采用的分区策略没有考虑数据之间的相似性<br><br>(2)RMI 不支持更新</p>
<p><img src="/../images/ASLM-Adaptive-Single-Layer-Model-for-Learned-Index/1.png" alt="img"></p>
<h3 id="方法："><a href="#方法：" class="headerlink" title="方法："></a>方法：</h3><h4 id="分区算法"><a href="#分区算法" class="headerlink" title="分区算法"></a>分区算法</h4><h5 id="Method1"><a href="#Method1" class="headerlink" title="Method1:"></a>Method1:</h5><p><img src="/../images/ASLM-Adaptive-Single-Layer-Model-for-Learned-Index/2.png" alt="img"><br>SLM:这是一个简单的模型，只有一层，这一层包含K个子模型</p>
<h5 id="Method2："><a href="#Method2：" class="headerlink" title="Method2："></a>Method2：</h5><p><img src="/../images/ASLM-Adaptive-Single-Layer-Model-for-Learned-Index/3.png" alt="img"><br>数据点之间三角形面积可替换为欧式距离，用来表示两个数据点之间的相似度</p>
<h4 id="数据插入："><a href="#数据插入：" class="headerlink" title="数据插入："></a>数据插入：</h4><p><img src="/../images/ASLM-Adaptive-Single-Layer-Model-for-Learned-Index/4.png" alt="img"></p>
<p><img src="/../images/ASLM-Adaptive-Single-Layer-Model-for-Learned-Index/5.png" alt="img"></p>
<h3 id="结果："><a href="#结果：" class="headerlink" title="结果："></a>结果：</h3><p><img src="/../images/ASLM-Adaptive-Single-Layer-Model-for-Learned-Index/6.png" alt="img"></p>
<p><img src="/../images/ASLM-Adaptive-Single-Layer-Model-for-Learned-Index/7.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/09/28/Dabble-%E5%9F%BA%E4%BA%8E%E4%B8%AD%E9%97%B4%E5%B1%82%E7%9A%84%E5%8F%AF%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0%E7%B4%A2%E5%BC%95%E6%8A%80%E6%9C%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/28/Dabble-%E5%9F%BA%E4%BA%8E%E4%B8%AD%E9%97%B4%E5%B1%82%E7%9A%84%E5%8F%AF%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0%E7%B4%A2%E5%BC%95%E6%8A%80%E6%9C%AF/" class="post-title-link" itemprop="url">Dabble:基于中间层的可扩展学习索引技术</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-28 18:45:43 / Modified: 18:48:28" itemprop="dateCreated datePublished" datetime="2024-09-28T18:45:43-07:00">2024-09-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Learned-Index/" itemprop="url" rel="index"><span itemprop="name">Learned Index</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="应用场景："><a href="#应用场景：" class="headerlink" title="应用场景："></a>应用场景：</h3><p>读写场景</p>
<h3 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h3><p>提出Dabble模型<br><img src="/../images/Dabble-%E5%9F%BA%E4%BA%8E%E4%B8%AD%E9%97%B4%E5%B1%82%E7%9A%84%E5%8F%AF%E6%89%A9%E5%B1%95%E5%AD%A6%E4%B9%A0%E7%B4%A2%E5%BC%95%E6%8A%80%E6%9C%AF/1.png" alt="img"><br>（1）用K-Means算法把数据集进行聚类，从而划分为K个数据区域，使得每个区域内的数据分布尽可能的一致<br><br>（2）在模型训练阶段，我们对K个数据区域采用前馈神经网络进行学习，并在模型的损失函数中加入数据的访问热度，从而使模型对访问频率高的数据预测率该更加精准<br><br>（3）针对数据插入问题，借鉴LSM树中的延迟更新机制，在内存中开辟一块缓存用来存放新插入的数据，当缓存溢出时一次性将数据进行插入<br><br>（4）针对索引更新问题，提出了一种基于中间层的机制，通过模型解耦的方式缓解了索引带来的消耗</p>
<h3 id="结果："><a href="#结果：" class="headerlink" title="结果："></a>结果：</h3><p>（1）在 Lognormal 人工数据集上,Dabble 模型的查询性能比 B+树提升了 69%,比学习索引提升了 13%,比 ALEX提升了 8%;内存占用比 B+树减少了 92%,神经网络模型的内存占用比学习索引减少了 99%,<br>比 ALEX 减少了 98%.同时,Dabble 模型的插入性能比 B+树提升了 250%,比 ALEX 提升了 123%; <br><br>（2）在真实数据集 Weblogs 上,Dabble 的查询性能比 B+树提升了 49%,比学习索引提升了 33%,比 ALEX 提升了 9%;内存占用比 B+树减少了 92%,神经网络模型的内存占用比学习索引减少了 99%,比 ALEX 减少了 98%.同时,Dabble 的插入性能比 B+树提升了 400%,比 ALEX 提升了 88%. </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/08/20/VMware%E7%9A%84%E4%B8%89%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/20/VMware%E7%9A%84%E4%B8%89%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">VMware的三种网络模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-08-20 18:31:39 / Modified: 18:33:16" itemprop="dateCreated datePublished" datetime="2024-08-20T18:31:39-07:00">2024-08-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9A%8F%E7%AC%94/" itemprop="url" rel="index"><span itemprop="name">随笔</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://wxler.github.io/2021/02/02/221724/">参考链接</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/05/12/vue3%E5%AD%A6%E4%B9%A0%E2%80%94%E2%80%94Tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/12/vue3%E5%AD%A6%E4%B9%A0%E2%80%94%E2%80%94Tutorial/" class="post-title-link" itemprop="url">vue3学习——Tutorial</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-05-12 21:00:54 / Modified: 23:18:12" itemprop="dateCreated datePublished" datetime="2024-05-12T21:00:54-07:00">2024-05-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/vue3/" itemprop="url" rel="index"><span itemprop="name">vue3</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="reactive-和-ref"><a href="#reactive-和-ref" class="headerlink" title="reactive() 和 ref()"></a>reactive() 和 ref()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; reactive, ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counter = <span class="title function_">reactive</span>(&#123; <span class="attr">count</span>: <span class="number">0</span> &#125;)</span><br><span class="line"><span class="keyword">const</span> message = <span class="title function_">ref</span>(<span class="string">&#x27;Hello World!&#x27;</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; message.split(&#x27;&#x27;).reverse().join(&#x27;&#x27;) &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>Count is: &#123;&#123; counter.count &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="v-bind"><a href="#v-bind" class="headerlink" title="v-bind"></a>v-bind</h3><p>v-bind:id&#x3D;””<br><br>v-bind:class&#x3D;””<br><br>v-bind:value&#x3D;””<br></p>
<p>简化为<br></p>
<p>:id&#x3D;””<br><br>:class&#x3D;””<br><br>:value&#x3D;””<br></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> titleClass = <span class="title function_">ref</span>(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h1</span> <span class="attr">:class</span>=<span class="string">&quot;titleClass&quot;</span>&gt;</span>Make me red<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="selector-class">.title</span> &#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">color</span>: red;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="v-on"><a href="#v-on" class="headerlink" title="v-on"></a>v-on</h3><p>Event Listeners</p>
<p>v-on:click&#x3D;””<br><br>v-on:input&#x3D;””<br></p>
<p>简化为<br></p>
<p>@click&#x3D;””<br><br>@input&#x3D;””<br></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">increment</span>(<span class="params"></span>) &#123;</span><br><span class="line">  count.<span class="property">value</span>++</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;increment&quot;</span>&gt;</span>Count is: &#123;&#123; count &#125;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a>v-model</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> text = <span class="title function_">ref</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Type here&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; text &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="v-if-和-v-else"><a href="#v-if-和-v-else" class="headerlink" title="v-if 和 v-else"></a>v-if 和 v-else</h3><p>Conditional Rendering</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> awesome = <span class="title function_">ref</span>(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toggle</span>(<span class="params"></span>) &#123;</span><br><span class="line">  awesome.<span class="property">value</span> = !awesome.<span class="property">value</span></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;toggle&quot;</span>&gt;</span>Toggle<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-if</span>=<span class="string">&quot;awesome&quot;</span>&gt;</span>Vue is awesome!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-else</span>&gt;</span>Oh no 😢<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="v-for"><a href="#v-for" class="headerlink" title="v-for"></a>v-for</h3><p>List Rendering</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// give each todo a unique id</span></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newTodo = <span class="title function_">ref</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> todos = <span class="title function_">ref</span>([</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn HTML&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn JavaScript&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn Vue&#x27;</span> &#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">// const index = ref(&quot;123&quot;)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addTodo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  todos.<span class="property">value</span>.<span class="title function_">push</span>(&#123;<span class="attr">id</span>: id++, <span class="attr">text</span>: newTodo.<span class="property">value</span>&#125;);</span><br><span class="line">  newTodo.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeTodo</span>(<span class="params">todo</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// index.value</span></span><br><span class="line">  todos.<span class="property">value</span>.<span class="title function_">splice</span>(todos.<span class="property">value</span>.<span class="title function_">indexOf</span>(todo), <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">form</span> @<span class="attr">submit.prevent</span>=<span class="string">&quot;addTodo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">&quot;newTodo&quot;</span> <span class="attr">required</span> <span class="attr">placeholder</span>=<span class="string">&quot;new todo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">button</span>&gt;</span>Add Todo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!--   &lt;p&gt;</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">    &#123;&#123;index&#125;&#125;</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">  &lt;/p&gt; --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;todo in todos&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;todo.id&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;&#123; todo.text &#125;&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;removeTodo(todo)&quot;</span>&gt;</span>X<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>


<h3 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h3><blockquote>
<p>introducing computed().We can create a computed ref that computes its .value based on other reactive data sources:</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref, computed &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newTodo = <span class="title function_">ref</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> hideCompleted = <span class="title function_">ref</span>(<span class="literal">false</span>)</span><br><span class="line"><span class="keyword">const</span> todos = <span class="title function_">ref</span>([</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn HTML&#x27;</span>, <span class="attr">done</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn JavaScript&#x27;</span>, <span class="attr">done</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn Vue&#x27;</span>, <span class="attr">done</span>: <span class="literal">false</span> &#125;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> filteredTodos = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> hideCompleted.<span class="property">value</span></span><br><span class="line">    ? todos.<span class="property">value</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">t</span>) =&gt;</span> !t.<span class="property">done</span>)</span><br><span class="line">    : todos.<span class="property">value</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addTodo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  todos.<span class="property">value</span>.<span class="title function_">push</span>(&#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: newTodo.<span class="property">value</span>, <span class="attr">done</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">  newTodo.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeTodo</span>(<span class="params">todo</span>) &#123;</span><br><span class="line">  todos.<span class="property">value</span> = todos.<span class="property">value</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">t</span>) =&gt;</span> t !== todo)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;form @submit.prevent=&quot;addTodo&quot;&gt;</span><br><span class="line">    &lt;input v-model=&quot;newTodo&quot; required placeholder=&quot;new todo&quot;&gt;</span><br><span class="line">    &lt;button&gt;Add Todo&lt;/button&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">  &lt;ul&gt;</span><br><span class="line">    &lt;li v-for=&quot;todo in filteredTodos&quot; :key=&quot;todo.id&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;checkbox&quot; v-model=&quot;todo.done&quot;&gt;</span><br><span class="line">      &lt;span :class=&quot;&#123; done: todo.done &#125;&quot;&gt;&#123;&#123; todo.text &#125;&#125;&lt;/span&gt;</span><br><span class="line">      &lt;button @click=&quot;removeTodo(todo)&quot;&gt;X&lt;/button&gt;</span><br><span class="line">    &lt;/li&gt;</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">  &lt;button @click=&quot;hideCompleted = !hideCompleted&quot;&gt;</span><br><span class="line">    &#123;&#123; hideCompleted ? &#x27;Show all&#x27; : &#x27;Hide completed&#x27; &#125;&#125;</span><br><span class="line">  &lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">.done &#123;</span><br><span class="line">  text-decoration: line-through;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Lifecycle-and-Template-Refs"><a href="#Lifecycle-and-Template-Refs" class="headerlink" title="Lifecycle and Template Refs"></a>Lifecycle and Template Refs</h3><blockquote>
<p>Hook函数 onMounted onUpdated 等 …</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref, onMounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pElementRef = <span class="title function_">ref</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">const</span> customValue = <span class="title function_">ref</span>(<span class="string">&quot;123&quot;</span>)</span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  customValue.<span class="property">value</span> = pElementRef.<span class="property">value</span>.<span class="property">textContent</span></span><br><span class="line">  pElementRef.<span class="property">value</span>.<span class="property">textContent</span> = <span class="string">&#x27;mounted!&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span>&gt;</span> &#123;&#123;customValue&#125;&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">ref</span>=<span class="string">&quot;pElementRef&quot;</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, watch &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_">watch</span>(count, <span class="function">(<span class="params">newCount</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// yes, console.log() is a side effect</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`new count is: <span class="subst">$&#123;newCount&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>watch() can directly watch a ref, and the callback gets fired whenever count’s value changes.</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref, watch &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoId = <span class="title function_">ref</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">const</span> todoData = <span class="title function_">ref</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params">id</span>) &#123;</span><br><span class="line">  todoData.<span class="property">value</span> = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(</span><br><span class="line">    <span class="string">`https://jsonplaceholder.typicode.com/todos/<span class="subst">$&#123;id.value&#125;</span>`</span></span><br><span class="line">  )</span><br><span class="line">  todoData.<span class="property">value</span> = <span class="keyword">await</span> res.<span class="title function_">json</span>()</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="title function_">fetchData</span>(todoId)</span><br><span class="line"><span class="title function_">watch</span>(todoId, <span class="function">(<span class="params">todoId</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fetchData</span>(todoId);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>Todo id: &#123;&#123; todoId &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;todoId++&quot;</span> <span class="attr">:disabled</span>=<span class="string">&quot;!todoData&quot;</span>&gt;</span>Fetch next todo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-if</span>=<span class="string">&quot;!todoData&quot;</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">pre</span> <span class="attr">v-else</span>&gt;</span>&#123;&#123; todoData &#125;&#125;<span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Components"><a href="#Components" class="headerlink" title="Components"></a>Components</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ChildComp</span> <span class="keyword">from</span> <span class="string">&#x27;./ChildComp.vue&#x27;</span></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- render child component --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">ChildComp</span>&gt;</span><span class="tag">&lt;/<span class="name">ChildComp</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Props"><a href="#Props" class="headerlink" title="Props"></a>Props</h3><blockquote>
<p>A child component can accept input from the parent via props. First, it needs to declare the props it accepts:</p>
</blockquote>
<p>App.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ChildComp</span> <span class="keyword">from</span> <span class="string">&#x27;./ChildComp.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> greeting = <span class="title function_">ref</span>(<span class="string">&#x27;Hello from parent&#x27;</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">ChildComp</span> <span class="attr">:msg</span>=<span class="string">&quot;greeting&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>ChildComp.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">const</span> props = <span class="title function_">defineProps</span>(&#123;</span><br><span class="line">  <span class="attr">msg</span>: <span class="title class_">String</span></span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123; msg || &#x27;No props passed yet&#x27; &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Emits"><a href="#Emits" class="headerlink" title="Emits"></a>Emits</h3><blockquote>
<p>In addition to receiving props, a child component can also emit events to the parent:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class="line">import ChildComp from &#x27;./ChildComp.vue&#x27;</span><br><span class="line"></span><br><span class="line">const childMsg = ref(&#x27;No child msg yet&#x27;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;ChildComp @response=&quot;(msg) =&gt; childMsg = msg &quot; @response1=&quot;(msg)=&gt; childMsg=msg&quot;/&gt;</span><br><span class="line">  &lt;p&gt;&#123;&#123; childMsg &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">const emit = defineEmits([&#x27;response&#x27;, &#x27;response1&#x27;])</span><br><span class="line"></span><br><span class="line">emit(&#x27;response&#x27;, &#x27;hello from child&#x27;)</span><br><span class="line">emit(&#x27;response1&#x27;, &quot;flafkjka&quot;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h2&gt;Child component&lt;/h2&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Slots"><a href="#Slots" class="headerlink" title="Slots"></a>Slots</h3><blockquote>
<p>In addition to passing data via props, the parent component can also pass down template fragments to the child via slots</p>
</blockquote>
<p>App.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ChildComp</span> <span class="keyword">from</span> <span class="string">&#x27;./ChildComp.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> msg = <span class="title function_">ref</span>(<span class="string">&#x27;from parent&#x27;</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">ChildComp</span>&gt;</span><span class="tag">&lt;/<span class="name">ChildComp</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>ChildComp.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">slot</span>&gt;</span>Fallback content<span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/05/11/javascript%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/11/javascript%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/" class="post-title-link" itemprop="url">javascript基础语法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-05-11 05:44:34 / Modified: 20:47:39" itemprop="dateCreated datePublished" datetime="2024-05-11T05:44:34-07:00">2024-05-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index"><span itemprop="name">javascript</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p><strong>值类型(基本类型)</strong>  ：字符串（String）、数字(Number)、布尔(Boolean)、空（null）、未定义（Undefined）、Symbol。</p>
<blockquote>
<p>所有的值类型(基本类型), 除了null和undefined, 都可以被看做对象</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;abc&quot;</span>)</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">123</span>)</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>js中一切皆对象</p>
</blockquote>
<p><strong>引用数据类型(对象类型)</strong> ： 对象(Object)、数组(Array)、函数(Function)、正则（RegExp）和日期（Date）</p>
<p><img src="/../images/javascript%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/1.png" alt="img"></p>
<blockquote>
<p>ps: 定义变量得使用 var 或者 let<br>可以用typeof 来查看变量的类型</p>
</blockquote>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">myFunction</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="原型链"><a href="#原型链" class="headerlink" title="原型链"></a>原型链</h3><p>class关键字是原型系统上的一个语法糖，创造了一种基于类的语言的错觉。</p>
<p><strong>proto</strong>, prototype, constructor的关系</p>
<p><img src="/../images/javascript%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/3.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/04/02/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/02/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/" class="post-title-link" itemprop="url">DILI论文重点部分</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-02 05:08:10" itemprop="dateCreated datePublished" datetime="2024-04-02T05:08:10-07:00">2024-04-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-12 20:46:32" itemprop="dateModified" datetime="2024-04-12T20:46:32-07:00">2024-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Learned-Index/" itemprop="url" rel="index"><span itemprop="name">Learned Index</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="DILI：A-Distribution-driven-Learned-Index"><a href="#DILI：A-Distribution-driven-Learned-Index" class="headerlink" title="DILI：A Distribution-driven Learned Index"></a>DILI：A Distribution-driven Learned Index</h2><p>摘要：<br><br>DILI的每个节点（internal node 和 leaf node）都有一个Linear model，并且internal node的key’s range被它的child node均分，当进行key查找时，可以准确地找到对应的leaf node。在leaf node中的linear model是可以准确预测key的位置的。</p>
<p>为了构建DILI，首先构建一颗bottom-up tree,然后使用这个bottom-up tree，自顶向下构建一个DILI树。DILI在the number of leaf nodes和tree height之间有一个很好的平衡（the number of leaf nodes 和 tree height是影响key搜索时间的关键因素）。设计了灵活的插入和删除算法，并在必要时调整树形结构。</p>
<p>实验结果表明DILI比其它baseline在不同的workloads上要表现的更好。</p>
<h3 id="1-INTRODUCTION"><a href="#1-INTRODUCTION" class="headerlink" title="1.INTRODUCTION"></a>1.INTRODUCTION<br></h3><p>RMI：仅支持查找<br><br>ALEX：扩展RMI，在leaf node中使用 gapped array，使用 cost model初始化RMI结构和动态更新RMI结构。存在last-mile问题<br><br>LIPP：解决last-mile问题，但是没有利用data distribution<br><br>DILI-LO：未解决last-mile问题，利用data distribution<br><br>DILI：解决last-mile问题，利用data distribution<br></p>
<p>构建DILI的目的是实现最好的搜索性能 —&gt; 搜索的开销取决于(1)leaf node的深度(2)leaf  node中的linear model预测的accuracy —&gt; 这两个factors都应该在DILI的构建中被考虑</p>
<p>因此，提出了一个two-phase bulk loading 方法<br><br><strong>Phase1</strong> -&gt; 使用greedy merging algorithm（考虑到了上面的两个factors） 构建一棵BU-tree（BU-tree的internal node’srange并不是被它的child nodes均分的，因此在BU-tree进行key搜索时，确定child node需要额外的开销）</p>
<p><strong>Phase2</strong> -&gt;  借鉴BU-tree的结构构建DILI</p>
<h4 id="Contribution"><a href="#Contribution" class="headerlink" title="Contribution"></a>Contribution</h4><ul>
<li>提出DILI，algorithms 和它的cost analysis</li>
<li>构建DILI的two-phase bulk loading 方法</li>
<li>对DILI的leaf node的local optimization，解决last-mile问题</li>
<li>对于DILI的insertion和deletion操作提出相应的algorithm来维持查找性能</li>
<li>在synthetic data和real data上证实DILI的性能</li>
</ul>
<h3 id="2-OVERVIEW-OF-DILI"><a href="#2-OVERVIEW-OF-DILI" class="headerlink" title="2.OVERVIEW OF DILI"></a>2.OVERVIEW OF DILI</h3><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/1.png" alt="img"><br>DILI的结构如Figure 1所示<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/2.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/3.png" alt="img"><br>DILI在没有使用local Optimization的时候SEARCH算法如下，查找key时，锁定了leaf node后需要再进行指数查找来确定position。<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/4.png" alt="img"></p>
<h4 id="Local-Optimization-strategy"><a href="#Local-Optimization-strategy" class="headerlink" title="Local Optimization strategy"></a>Local Optimization strategy</h4><p>在leaf node中，先用线性模型预测key的position，之后直接将key放到预测的position上，如果发生冲突，就创建一个新的node，对应的entry设置为指向新node的指针</p>
<h4 id="Updates"><a href="#Updates" class="headerlink" title="Updates"></a>Updates</h4><p>当对DILI插入数据时，如果发生conflict，会创建新的Node，当创建的新Node过多并且退化了查找性能时，需要进行调整策略（在section6会详细描述）</p>
<h3 id="3-SEARCH-COST-ANALYSIS"><a href="#3-SEARCH-COST-ANALYSIS" class="headerlink" title="3.SEARCH COST ANALYSIS"></a>3.SEARCH COST ANALYSIS</h3><p>Cost Analysis:<br>未使用local optimization strategy<br>Algorithm1由两步组成(1)找到包含search key的leaf node (2)leaf node中的local search<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/5.png" alt="img"></p>
<h3 id="4-CONSTRUCTION-OF-DILI"><a href="#4-CONSTRUCTION-OF-DILI" class="headerlink" title="4.CONSTRUCTION OF DILI"></a>4.CONSTRUCTION OF DILI</h3><h4 id="4-1Motivation-and-Overall-Idea-of-BU-Tree"><a href="#4-1Motivation-and-Overall-Idea-of-BU-Tree" class="headerlink" title="4.1Motivation and Overall Idea of BU-Tree"></a>4.1Motivation and Overall Idea of BU-Tree</h4><p>DILI的internal node的线性模型有着完美的准确性，因为internal node被它的child nodes均分。—-&gt; 现在有一个问题，如何确定DILI的fanout</p>
<p>大致思路：<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/6.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/7.png" alt="img"></p>
<h4 id="4-2-Building-BU-Tree"><a href="#4-2-Building-BU-Tree" class="headerlink" title="4.2 Building BU-Tree"></a>4.2 Building BU-Tree</h4><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/8.png" alt="img"></p>
<h5 id="4-2-1-Bottom-up-Node-and-Model-Creation"><a href="#4-2-1-Bottom-up-Node-and-Model-Creation" class="headerlink" title="4.2.1 Bottom-up Node and Model Creation"></a>4.2.1 Bottom-up Node and Model Creation</h5><p>构建第0层的leaf node<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/9.png" alt="img"><br>已知h - 1层的internal node,构建第h层的internal node<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/10.png" alt="img"></p>
<h5 id="4-2-2-Determining-Node-Layout-at-A-Height"><a href="#4-2-2-Determining-Node-Layout-at-A-Height" class="headerlink" title="4.2.2 Determining Node Layout at A Height"></a>4.2.2 Determining Node Layout at A Height</h5><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/11.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/12.png" alt="img"></p>
<p>但是BU-Tree是从下往上创建的，即使创建了第h层的node，我们也不知道BU-Tree的高度</p>
<p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/13.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/14.png" alt="img"></p>
<h4 id="4-3-BU-Tree-based-Bulk-loading-for-DILI"><a href="#4-3-BU-Tree-based-Bulk-loading-for-DILI" class="headerlink" title="4.3 BU-Tree based Bulk loading for DILI"></a>4.3 BU-Tree based Bulk loading for DILI</h4><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/15.png" alt="img"></p>
<h4 id="4-4-Remarks"><a href="#4-4-Remarks" class="headerlink" title="4.4 Remarks"></a>4.4 Remarks</h4><p>Skip ……</p>
<h3 id="5-LOCAL-OPTIMIZATION-OF-DILI"><a href="#5-LOCAL-OPTIMIZATION-OF-DILI" class="headerlink" title="5. LOCAL OPTIMIZATION OF DILI"></a>5. LOCAL OPTIMIZATION OF DILI</h3><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/16.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/17.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/18.png" alt="img"></p>
<h3 id="6-DATA-UPDATES-IN-DILI"><a href="#6-DATA-UPDATES-IN-DILI" class="headerlink" title="6. DATA UPDATES IN DILI"></a>6. DATA UPDATES IN DILI</h3><h4 id="6-1-Insertions"><a href="#6-1-Insertions" class="headerlink" title="6.1 Insertions"></a>6.1 Insertions</h4><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/19.png" alt="img"><br>P exists标注的地方错误		应设置为notExist  &lt;—  False</p>
<h4 id="6-2-Deletions"><a href="#6-2-Deletions" class="headerlink" title="6.2 Deletions"></a>6.2 Deletions</h4><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/20.png" alt="img"></p>
<h3 id="7-EXPERIMENTAL-STUDIES"><a href="#7-EXPERIMENTAL-STUDIES" class="headerlink" title="7.EXPERIMENTAL STUDIES"></a>7.EXPERIMENTAL STUDIES</h3><h4 id="7-1-Experimental-Settings"><a href="#7-1-Experimental-Settings" class="headerlink" title="7.1 Experimental Settings"></a>7.1 Experimental Settings</h4><p>数据集：使用了SOSD benchmark中的4个真实数据集 和 1 个合成数据集</p>
<ul>
<li>FB : 200M Facebook 用户id</li>
<li>WikiTS : 200M 维基百科网站日志条目的唯一请求时间戳</li>
<li>OSM :  800M OpenStreetMap单元格的id</li>
<li>Books : 800M Amazon的books的id</li>
<li>Logn : 200M 从重尾采样的独特值 N(0， 1) 的对数正态分布</li>
</ul>
<p>比较的baselines:<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/21.png" alt="img"></p>
<p>Table 2 总结了所有index的属性特点，更好的表现被加粗了<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/22.png" alt="img"></p>
<p>Evaluation Metrics : <br><br>Lookup —&gt; 平均每次query所用的时间 <br><br>Throughtput —&gt; 平均每second执行的operations的次数（query、insertion、deletion）<br></p>
<h4 id="7-2-Overall-Query-Performance"><a href="#7-2-Overall-Query-Performance" class="headerlink" title="7.2 Overall Query Performance"></a>7.2 Overall Query Performance</h4><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/23.png" alt="img"></p>
<p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/24.png" alt="img"></p>
<h4 id="7-3-Performance-on-Different-Workloads"><a href="#7-3-Performance-on-Different-Workloads" class="headerlink" title="7.3 Performance on Different Workloads"></a>7.3 Performance on Different Workloads</h4><p>(1)The Read-only workload: 100M point queries <br><br>(2)The Read-Heavy workload: 50M insertions and 100M point queries <br><br>(3)The Write-Heavy workload: 100M insertions and 50M point queries <br><br>(4)The Write-only workload: 100M insertions <br></p>
<p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/25.png" alt="img"></p>
<h4 id="7-4-Effect-of-Many-Deletions"><a href="#7-4-Effect-of-Many-Deletions" class="headerlink" title="7.4 Effect of Many Deletions"></a>7.4 Effect of Many Deletions</h4><p>(1)Read-Heavy workload : 100M lookups and 50M deletions<br>DILI achieves up to 3.6X, 2.3X, 7.0X and 2.3X higher throughput than B+ Tree,PGM,MassTree and ALEX,respectively.</p>
<p>(2)Deletion-Heavy workload : 100M deletions and 50M lookups<br>Only ALEX performs a little better than DILI on Logn dataset</p>
<p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/26.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/03/16/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/16/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" class="post-title-link" itemprop="url">布隆过滤器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-16 02:55:19" itemprop="dateCreated datePublished" datetime="2024-03-16T02:55:19-07:00">2024-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-02 05:03:05" itemprop="dateModified" datetime="2024-04-02T05:03:05-07:00">2024-04-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">布隆过滤器</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>查找时，过滤掉一定不存在的key，提高查找效率</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>在数组或者列表中搜索相应值的时候，你必须遍历已有的集合。若集合中存在大量的数据，就会影响查找的效率</p>
<p>针对这个问题，可以考虑使用哈希表，利用哈希表来对”值”进行哈希处理来获得该值对应的索引值，然后将该”值”存放到列表中对应的索引位置。<br>这意味着判断列表中是否存在该值时，只需要对值进行哈希处理并在相应的索引位置进行搜索即可，这时的搜索速度是非常快的。</p>
<p><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/1.png" alt="img"></p>
<p>Bloom Filter本质上是由长度为m的位向量（仅包含0或者1）组成，最初所有值均设置为0，如下图所示：<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/2.png" alt="img"></p>
<p>为了将数据项添加到布隆过滤器中，使用k个不同的哈希函数对其进行哈希，并将结果位置上对应位置为1</p>
<h3 id="简单的例子"><a href="#简单的例子" class="headerlink" title="简单的例子"></a>简单的例子</h3><p>输入”semlinker”，预设的3个哈希函数将输出2、4、6,我们把相应位置为1<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/3.png" alt="img"><br>再输入”kakuqo”，哈希函数输出3、4、7,把对应位置为1<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/4.png" alt="img"><br>再输入”fullstack”,哈希函数输出2、3、7，这时发现相应的索引位都已经置为了1，这意味着我们可以说”fullstack”可能已经插入到集合中。这是一种误判情况<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/5.png" alt="img"></p>
<p>布隆过滤器有一个可预测的误判率(FPP):<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/6.png" alt="img"></p>
<ul>
<li>n是已经添加元素的数量</li>
<li>k是哈希的次数</li>
<li>m为布隆过滤器的长度(如比特数组的大小)</li>
</ul>
<p>实际情况中，布隆过滤器的长度m可以根据误判率(FFP)的和期望添加的元素个数n的通过如下公式计算:<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/7.png" alt="img"></p>
<blockquote>
<p>因此，我们得出一个结论，当我们搜索一个值的时候，若该值经过k个哈希函数运算后任何一个索引位为0，那么该值肯定不在集合中。但如果所有哈希索引值均为1，则只能说该搜索的值可能存在集合中</p>
</blockquote>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>在实际工作中，布隆过滤器常见的应用场景如下：</p>
<ul>
<li>网页爬虫对 URL 去重，避免爬取相同的 URL 地址；</li>
<li>反垃圾邮件，从数十亿个垃圾邮件列表中判断某邮箱是否垃圾邮箱；</li>
<li>Google Chrome 使用布隆过滤器识别恶意 URL；</li>
<li>Medium 使用布隆过滤器避免推荐给用户已经读过的文章；</li>
<li>Google BigTable，Apache HBbase 和 Apache Cassandra 使用布隆过滤器减少对不存在的行和列的查找</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/03/04/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/04/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/" class="post-title-link" itemprop="url">GRE使用手册</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-03-04 06:02:31 / Modified: 07:12:51" itemprop="dateCreated datePublished" datetime="2024-03-04T06:02:31-08:00">2024-03-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Learned-Index/" itemprop="url" rel="index"><span itemprop="name">Learned Index</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="下载官网地址"><a href="#下载官网地址" class="headerlink" title="下载官网地址:"></a>下载官网地址:<br></h2><p><a target="_blank" rel="noopener" href="https://github.com/jingtao8a/GRE">https://github.com/jingtao8a/GRE</a></p>
<h2 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h2><p>Ubuntu 20.04.6 LTS<br><br>gcc 9.4.0<br><br>cmake 3.16.3</p>
<h2 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h2><h3 id="intel-mkl-2018-4-274"><a href="#intel-mkl-2018-4-274" class="headerlink" title="intel-mkl 2018.4.274"></a>intel-mkl 2018.4.274<br></h3><p>这里安装2024的版本也可以<br><br>进入官网 <a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl-download.html">https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl-download.html</a><br></p>
<p>选择Linux 和 APT Package Manager<br><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/3.png" alt="img"><br>依次输入命令<br><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/1.png" alt="img"><br><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/2.png" alt="img"></p>
<p>默认安装路径如下：<br><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/4.png" alt="img"></p>
<p>使用mkl库需要配置环境变量：<br></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">对所有用户生效，需要重启系统</span><br><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure>
<p><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/5.png" alt="img"></p>
<h3 id="intel-tbb-2020-3"><a href="#intel-tbb-2020-3" class="headerlink" title="intel-tbb 2020.3"></a>intel-tbb 2020.3<br></h3><p>tbb库的版本必须使用2020.3<br><br>下载地址<a target="_blank" rel="noopener" href="https://github.com/oneapi-src/oneTBB/releases/tag/2020_U3">https://github.com/oneapi-src/oneTBB/releases/tag/2020_U3</a></p>
<h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">tar -zxvf oneTBB-2020_U3.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因为要使用 gcc-9 进行编译，所以需要编辑成 gcc-9 形式</span></span><br><span class="line">cp build/linux.gcc.inc build/linux.gcc-9.inc </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编辑 linux.gcc-9.inc 文件：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第15、16行原来是</span></span><br><span class="line">CPLUS ?= g++</span><br><span class="line">CONLY ?= gcc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改为</span></span><br><span class="line">CPLUS ?= g++-9</span><br><span class="line">CONLY ?= gcc-9</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">然后在文件夹 oneTBB-2020_U3/ 中编译</span></span><br><span class="line">cd oneTBB-2020_U3</span><br><span class="line">make compiler=gcc-9 stdver=c++17 tbb_build_prefix=my_tbb_build</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译完成后，在 builld/ 文件夹下会看到编译生成的文件夹 my_tbb_build_release/</span></span><br></pre></td></tr></table></figure>

<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /usr/local/tbb-2020_U3</span><br><span class="line"></span><br><span class="line">sudo cp -r oneTBB-2020_U3/include /usr/local/tbb-2020_U3/include</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建立新安装tbb版本的符号链接</span></span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/include/tbb /usr/local/include/tbb</span><br><span class="line"></span><br><span class="line">sudo cp -r oneTBB-2020_U3/build/my_tbb_build_release /usr/local/tbb-2020_U3/lib</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">建立新安装tbb版本的符号链接</span></span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbb.so.2 /usr/local/lib/libtbb.so</span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbb.so.2 /usr/local/lib/libtbb.so2</span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbbmalloc.so.2 /usr/local/lib/libtbbmalloc.so</span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbbmalloc.so.2 /usr/local/lib/libtbbmalloc.so2</span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbbmalloc_proxy.so.2 /usr/local/lib/libtbbmalloc_proxy.so</span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbbmalloc_proxy.so.2 /usr/local/lib/libtbbmalloc_proxy.so2</span><br></pre></td></tr></table></figure>

<p>然后把 库文件的路径写入到 ~&#x2F;.bashrc：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;export LD_LIBRARY_PATH=/usr/local/tbb-2020_U3/lib:$LD_LIBRARY_PATH&#x27; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>参考链接: <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39779233/article/details/126284595">https://blog.csdn.net/qq_39779233&#x2F;article&#x2F;details&#x2F;126284595</a></p>
<h3 id="jemalloc"><a href="#jemalloc" class="headerlink" title="jemalloc"></a>jemalloc</h3><p>下载地址: <a target="_blank" rel="noopener" href="https://github.com/jemalloc/jemalloc/releases">https://github.com/jemalloc/jemalloc/releases</a></p>
<h4 id="编译与安装"><a href="#编译与安装" class="headerlink" title="编译与安装"></a>编译与安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">step 1</span></span><br><span class="line">./autogen.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">step 2</span></span><br><span class="line">make</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">step 3</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>参考链接: <a target="_blank" rel="noopener" href="https://blog.csdn.net/SweeNeil/article/details/94648313">https://blog.csdn.net/SweeNeil/article/details/94648313</a></p>
<h2 id="USAGE"><a href="#USAGE" class="headerlink" title="USAGE"></a>USAGE</h2><h3 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git submodule update --init # only for the first time</span><br><span class="line">mkdir -p build</span><br><span class="line">cd build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=Release .. &amp;&amp; make</span><br></pre></td></tr></table></figure>
<h3 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./build/microbench \</span><br><span class="line">--keys_file=./data/dataset \  // 数据地址</span><br><span class="line">--keys_file_type=&#123;binary,text&#125; \  // 二进制 或者 文本</span><br><span class="line">--read=0.5 --insert=0.5 \ </span><br><span class="line">--operations_num=800000000 \ </span><br><span class="line">--table_size=-1 \ // 所使用的数据的size</span><br><span class="line">--init_table_ratio=0.5 \ //bulk_load所使用的数据的百分比</span><br><span class="line">--thread_num=24 \</span><br><span class="line">--index=index_name \ //测试的索引名称</span><br></pre></td></tr></table></figure>

<p>其它参数见官网:<br><a target="_blank" rel="noopener" href="https://github.com/jingtao8a/GRE">https://github.com/jingtao8a/GRE</a></p>
<h3 id="如果要测试新的索引结构"><a href="#如果要测试新的索引结构" class="headerlink" title="如果要测试新的索引结构"></a>如果要测试新的索引结构</h3><h4 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h4><p>src&#x2F;competitor&#x2F;competitor.h<br>get_index函数中添加对应的index_type<br><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/6.png" alt="img"></p>
<h4 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h4><p>在 src&#x2F;competitor 下放置源代码 new_index_name&#x2F;src<br>编写接口文件 src&#x2F;competitor&#x2F;new_index_name.h</p>
<p>以lipp的接口文件为例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;./src/src/core/lipp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;../indexInterface.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LIPPInterface</span> : <span class="keyword">public</span> indexInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(Param *param = <span class="literal">nullptr</span>)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">bulk_load</span><span class="params">(std::pair &lt;KEY_TYPE, PAYLOAD_TYPE&gt; *key_value, <span class="type">size_t</span> num, Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">get</span><span class="params">(KEY_TYPE key, PAYLOAD_TYPE &amp;val, Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">put</span><span class="params">(KEY_TYPE key, PAYLOAD_TYPE value, Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">update</span><span class="params">(KEY_TYPE key, PAYLOAD_TYPE value, Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">remove</span><span class="params">(KEY_TYPE key, Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">scan</span><span class="params">(KEY_TYPE key_low_bound, <span class="type">size_t</span> key_num, std::pair &lt;KEY_TYPE, PAYLOAD_TYPE&gt; *result,</span></span></span><br><span class="line"><span class="params"><span class="function">                Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">long</span> <span class="type">long</span> <span class="title">memory_consumption</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> lipp.<span class="built_in">total_size</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    LIPP &lt;KEY_TYPE, PAYLOAD_TYPE&gt; lipp;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">void</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">bulk_load</span>(std::pair &lt;KEY_TYPE, PAYLOAD_TYPE&gt; *key_value, <span class="type">size_t</span> num,</span><br><span class="line">                                                      Param *param) &#123;</span><br><span class="line">    lipp.<span class="built_in">bulk_load</span>(key_value, <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(num));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">bool</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">get</span>(KEY_TYPE key, PAYLOAD_TYPE &amp;val, Param *param) &#123;</span><br><span class="line">    <span class="type">bool</span> exist;</span><br><span class="line">    val = lipp.<span class="built_in">at</span>(key, <span class="literal">false</span>, exist);</span><br><span class="line">    <span class="keyword">return</span> exist;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">bool</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">put</span>(KEY_TYPE key, PAYLOAD_TYPE value, Param *param) &#123;</span><br><span class="line">    <span class="keyword">return</span> lipp.<span class="built_in">insert</span>(key, value);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">bool</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">update</span>(KEY_TYPE key, PAYLOAD_TYPE value, Param *param) &#123;</span><br><span class="line">    <span class="keyword">return</span> lipp.<span class="built_in">update</span>(key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">bool</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">remove</span>(KEY_TYPE key, Param *param) &#123;</span><br><span class="line">    <span class="keyword">return</span> lipp.<span class="built_in">remove</span>(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">size_t</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">scan</span>(KEY_TYPE key_low_bound, <span class="type">size_t</span> key_num,</span><br><span class="line">                                                   std::pair &lt;KEY_TYPE, PAYLOAD_TYPE&gt; *result,</span><br><span class="line">                                                   Param *param) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!result) &#123;</span><br><span class="line">        result = <span class="keyword">new</span> std::pair &lt;KEY_TYPE, PAYLOAD_TYPE&gt;[key_num];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lipp.<span class="built_in">range_query_len</span>(result, key_low_bound, key_num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/02/29/cmu15445-project4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/29/cmu15445-project4/" class="post-title-link" itemprop="url">cmu15445-project4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-29 04:11:36" itemprop="dateCreated datePublished" datetime="2024-02-29T04:11:36-08:00">2024-02-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-04 05:59:21" itemprop="dateModified" datetime="2024-03-04T05:59:21-08:00">2024-03-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cmu15445-2023/" itemprop="url" rel="index"><span itemprop="name">cmu15445-2023</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Concurrency-Control-Theory"><a href="#Concurrency-Control-Theory" class="headerlink" title="Concurrency Control Theory"></a>Concurrency Control Theory</h2><h3 id="formal-Definitions"><a href="#formal-Definitions" class="headerlink" title="formal Definitions"></a>formal Definitions</h3><p>Database: A fixed set of named data objects (e.g., A, B, C, …)<br>Transaction: A sequence of read and write operations (e.g., R(A), W(B), …)</p>
<p>transaction的正确性标准ACID：</p>
<ul>
<li>Atomicity: 原子性 “all or nothing”</li>
<li>Consistency: 一致性 “it looks correct to me”</li>
<li>Isolation: 隔离性 “as if alone”</li>
<li>Durability: 持久性 “survive failures”</li>
</ul>
<h3 id="Conflicting-Operations"><a href="#Conflicting-Operations" class="headerlink" title="Conflicting Operations"></a>Conflicting Operations</h3><p>多个transaction并发执行时会发生冲突:</p>
<ul>
<li>读写冲突(R-W)</li>
<li>写读冲突(W-R)</li>
<li>写写冲突(W-W)</li>
</ul>
<p>读写冲突造成的问题：<br></p>
<ul>
<li>不可重复读(在一个事务内多次读取同一个数据，如果出现前后两次读到的数据不一样的情况，就意味着发生了[不可重复读]的现象)</li>
<li>幻读：在一个事务内多次查询某个符合查询条件的[记录数量]，出现前后两次查询到的记录数量不一样</li>
</ul>
<p>写读冲突造成的问题：<br></p>
<ul>
<li>脏读(一个事务[读到]了另一个[未提交事务修改过的数据],就意味着发生了[脏读]现象)</li>
</ul>
<p>写写冲突造成的问题: <br></p>
<ul>
<li>丢失修改</li>
</ul>
<p><img src="/../images/cmu15445-project4/2.png" alt="img"><br><img src="/../images/cmu15445-project4/3.png" alt="img"><br><img src="/../images/cmu15445-project4/4.png" alt="img"></p>
<blockquote>
<p>MySQL InnoDB引擎的默认隔离级别虽然是[可重复读]，但是它很大程度上避免幻读现象，并没有解决幻读 <a target="_blank" rel="noopener" href="https://xiaolincoding.com/mysql/transaction/phantom.html">参考文章</a><br></p>
</blockquote>
<hr>
<blockquote>
<p>解决方案有两种:</p>
<ul>
<li>普通select语句(快照读),通过MVCC方式解决了幻读问题</li>
<li>select … for update语句(当前读)，通过next-key lock(记录锁 + 间隙锁)方式解决了幻读</li>
</ul>
</blockquote>
<h3 id="Read-View在MVCC里如何工作的"><a href="#Read-View在MVCC里如何工作的" class="headerlink" title="Read View在MVCC里如何工作的?"></a>Read View在MVCC里如何工作的?</h3><p>Read View有四个重要的字段<br><br>四个字段只有m_ids是一个集合，creator_trx_id在m_ids集合中，<br>min_trx_id是m_ids集合的最小值<br><img src="/../images/cmu15445-project4/5.png" alt="img"></p>
<p>记录的两个隐藏列<br><img src="/../images/cmu15445-project4/6.png" alt="img"></p>
<ul>
<li>trx_id，当一个事务对某条聚簇索引记录进行改动时，就会把该事务的事务 id 记录在 trx_id 隐藏列里；</li>
<li>roll_pointer，每次对某条聚簇索引记录进行改动时，都会把旧版本的记录写入到 undo 日志中，然后这个隐藏列是个指针，指向每一个旧版本记录，于是就可以通过它找到修改前的记录</li>
</ul>
<p>在创建ReadView后，一个事务去访问记录的时候，除了自己的更新记录总是可见之外，还有几种情况：</p>
<ul>
<li>如果记录的trx_id小于ReadView的min_trx_id，表示这个版本的记录是在创建 Read View 前已经提交的事务生成的，所以该版本的记录对当前事务可见</li>
<li>如果记录的trx_id大于等于ReadView中的max_trx_id,表示这个版本的记录是在创建 Read View 后才启动的事务生成的，所以该版本的记录对当前事务不可见</li>
<li>如果记录的 trx_id 值在 Read View 的 min_trx_id 和 max_trx_id 之间，需要判断 trx_id 是否在 m_ids 列表中：<ul>
<li>如果记录的 trx_id 在 m_ids 列表中，表示生成该版本记录的活跃事务依然活跃着（还没提交事务），所以该版本的记录对当前事务不可见。</li>
<li>如果记录的 trx_id 不在 m_ids列表中，表示生成该版本记录的活跃事务已经被提交，所以该版本的记录对当前事务可见。</li>
</ul>
</li>
</ul>
<h3 id="Two-Phase-Locking-两阶段锁"><a href="#Two-Phase-Locking-两阶段锁" class="headerlink" title="Two Phase Locking 两阶段锁"></a>Two Phase Locking 两阶段锁</h3><p>2PL将事务划分为两个阶段:</p>
<ul>
<li>Growing Phase: 只获得锁</li>
<li>Shrink Phase: 只释放锁</li>
</ul>
<p><img src="/../images/cmu15445-project4/7.png" alt="img"><br>2PL本身已经足够保证schedule是seriable的，但2PL可能导致cascading aborts，举例如下:<br><img src="/../images/cmu15445-project4/8.png" alt="img"></p>
<p>于是引入2PL的增强版变种，Rigorous 2PL，后者每个事务在结束之前，其写过的数据不能被其它事务读取或者重写</p>
<p><img src="/../images/cmu15445-project4/9.png" alt="img"></p>
<h3 id="Deadlock-Detection-Prevention"><a href="#Deadlock-Detection-Prevention" class="headerlink" title="Deadlock Detection &amp; Prevention"></a>Deadlock Detection &amp; Prevention</h3><p>2PL 无法避免的一个问题就是死锁，解决方案：<br></p>
<h4 id="Deadlock-Detection-事后检测"><a href="#Deadlock-Detection-事后检测" class="headerlink" title="Deadlock Detection 事后检测"></a>Deadlock Detection 事后检测</h4><p>为了检测死锁，DBMS 会维护一张 waits-for graph，来跟踪每个事务正在等待 (释放锁) 的其它事务，然后系统会定期地检查 waits-for graph，看其中是否有成环，如果成环了就要决定如何打破这个环。<br><br>waits-for graph 中的节点是事务，从 Ti 到 Tj 的边就表示 Ti 正在等待 Tj 释放锁，举例如下<br><img src="/../images/cmu15445-project4/10.png" alt="img"><br>当 DBMS 检测到死锁时，它会选择一个 “受害者” (事务)，将该事务回滚，打破环形依赖，而这个 “受害者” 将依靠配置或者应用层逻辑重试或中止。这里有两个设计决定：</p>
<ol>
<li>检测死锁的频率</li>
<li>如何选择合适的 “受害者”</li>
</ol>
<p>检测死锁的频率越高，陷入死锁的事务等待的时间越短，但消耗的 cpu 也就越多。所以这是个典型的 trade-off，通常有一个调优的参数供用户配置。</p>
<p>选择 “受害者” 的指标可能有很多：事务持续时间、事务的进度、事务锁住的数据数量、级联事务的数量、事务曾经重启的次数等等。在选择完 “受害者” 后，DBMS 还有一个设计决定需要做：完全回滚还是回滚到足够消除环形依赖即可。</p>
<h4 id="Deadlock-Prevention-事前阻止"><a href="#Deadlock-Prevention-事前阻止" class="headerlink" title="Deadlock Prevention 事前阻止"></a>Deadlock Prevention 事前阻止</h4><p>通常 prevention 会按照事务的年龄来赋予优先级，事务的时间戳越老，优先级越高。有两种 prevention 的策略： <br></p>
<ul>
<li>Old Waits for Young：如果 requesting txn 优先级比 holding txn 更高则等待后者释放锁；更低则自行中止<br></li>
<li>Young Waits for Old：如果 requesting txn 优先级比 holding txn 更高则后者自行中止释放锁，让前者获取锁，否则 requesting txn 等待 holding txn 释放锁</li>
</ul>
<p>举例如下:</p>
<p><img src="/../images/cmu15445-project4/11.png" alt="img"></p>
<p>死锁产生的必要条件是<br><br>1.互斥 2.请求与保持 3.不可抢占 4.循环等待<br></p>
<h2 id="Task-1-Lock-Manager"><a href="#Task-1-Lock-Manager" class="headerlink" title="Task#1 Lock Manager"></a>Task#1 Lock Manager</h2><p>五种锁 S X IS IX SIX<br><img src="/../images/cmu15445-project4/12.png" alt="img"><br>这里只实现三种隔离级别READ_UNCOMMITTED、READ_COMMITTED、REPEATABLE_READ</p>
<h3 id="LOCK-NOTE"><a href="#LOCK-NOTE" class="headerlink" title="LOCK NOTE"></a>LOCK NOTE</h3><ol>
<li><p>GENERAL BEHAVIOUR:</p>
<ul>
<li>Both LockTable() and LockRow() are blocking methods; they should wait till the lock is granted and then return.</li>
<li>If the transaction was aborted in the meantime, do not grant the lock and return false.</li>
</ul>
</li>
<li><p>MULTIPLE TRANSACTIONS:</p>
<ul>
<li>LockManager should maintain a queue for each resource; locks should be granted to transactions in a FIFO manner.</li>
<li>If there are multiple compatible lock requests, all should be granted at the same time</li>
<li>as long as FIFO is honoured.</li>
</ul>
</li>
<li><p>SUPPORTED LOCK MODES:</p>
<ul>
<li>Table locking should support all lock modes.</li>
<li>Row locking should not support Intention locks. Attempting this should set the TransactionState as</li>
<li>ABORTED and throw a TransactionAbortException (ATTEMPTED_INTENTION_LOCK_ON_ROW)</li>
</ul>
</li>
<li><p>ISOLATION LEVEL:</p>
<ul>
<li><p>REPEATABLE_READ:<br><br>  The transaction is required to take all locks.<br>  All locks are allowed in the GROWING state<br>  No locks are allowed in the SHRINKING state</p>
</li>
<li><p>READ_COMMITTED:<br><br> The transaction is required to take all locks.<br> All locks are allowed in the GROWING state<br> Only IS, S locks are allowed in the SHRINKING state</p>
</li>
<li><p>READ_UNCOMMITTED:<br><br> The transaction is required to take only IX, X locks.<br> X, IX locks are allowed in the GROWING state.<br> S, IS, SIX locks are never allowed</p>
</li>
</ul>
</li>
<li><p>MULTILEVEL LOCKING:</p>
<ul>
<li>While locking rows, Lock() should ensure that the transaction has an appropriate lock on the table which the row</li>
</ul>
<p> belongs to. For instance, if an exclusive lock is attempted on a row, the transaction must hold either X, IX, or SIX on the table. If such a lock does not exist on the table, Lock() should set the TransactionState as ABORTED and throw a TransactionAbortException (TABLE_LOCK_NOT_PRESENT)</p>
</li>
<li><p>LOCK UPGRADE:<br><br>Calling Lock() on a resource that is already locked should have the following behaviour:    </p>
<ul>
<li>If requested lock mode is the same as that of the lock presently held, Lock() should return true since it already has the lock.</li>
<li>If requested lock mode is different, Lock() should upgrade the lock held by the transaction.<br><br> While upgrading, only the following transitions should be allowed:<br><ol>
<li>IS -&gt; [S, X, IX, SIX]</li>
<li>S -&gt; [X, SIX]</li>
<li>IX -&gt; [X, SIX]</li>
<li>SIX -&gt; [X]</li>
</ol>
</li>
</ul>
<ul>
<li>Any other upgrade is considered incompatible, and such an attempt should set the TransactionState as ABORTED and throw a TransactionAbortException (INCOMPATIBLE_UPGRADE)</li>
<li>Furthermore, only one transaction should be allowed to upgrade its lock on a given resource. Multiple concurrent lock upgrades on the same resource should set the TransactionState as ABORTED and throw a TransactionAbortException (UPGRADE_CONFLICT).</li>
</ul>
</li>
</ol>
<h3 id="UNLOCK-NOTE"><a href="#UNLOCK-NOTE" class="headerlink" title="UNLOCK NOTE"></a>UNLOCK NOTE</h3><ol>
<li>GENERAL BEHAVIOUR:<ul>
<li>Both UnlockTable() and UnlockRow() should release the lock on the resource and return. Both should ensure that the transaction currently holds a lock on the resource it is attempting to unlock.</li>
</ul>
<p>If not, LockManager should set the TransactionState as ABORTED and throw a TransactionAbortException (ATTEMPTED_UNLOCK_BUT_NO_LOCK_HELD)</p>
<ul>
<li>Additionally, unlocking a table should only be allowed if the transaction does not hold locks on any row on that table. If the transaction holds locks on rows of the table, Unlock should set the Transaction State as ABORTED and throw a TransactionAbortException (TABLE_UNLOCKED_BEFORE_UNLOCKING_ROWS).</li>
<li>Finally, unlocking a resource should also grant any new lock requests for the resource (if possible).</li>
</ul>
</li>
<li>TRANSACTION STATE UPDATE<ul>
<li>REPEATABLE_READ:<br><br>   Unlocking S&#x2F;X locks should set the transaction state to SHRINKING</li>
<li>READ_COMMITTED:<br><br>   Unlocking X locks should set the transaction state to SHRINKING.<br><br>   Unlocking S locks does not affect transaction state.</li>
<li>READ_UNCOMMITTED:<br><br>   Unlocking X locks should set the transaction state to SHRINKING.<br><br>   S locks are not permitted under READ_UNCOMMITTED.<br><br>   The behaviour upon unlocking an S lock under this isolation level is undefined.</li>
</ul>
</li>
</ol>
<p><br><br><br></p>
<ul>
<li>LockTable(Transaction, LockMode, TableOID)</li>
<li>UnlockTable(Transction, TableOID)</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::LockTable</span><span class="params">(Transaction *txn, LockMode lock_mode, <span class="type">const</span> <span class="type">table_oid_t</span> &amp;oid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">LockTableDirectlyOrNot</span>(txn, lock_mode, oid, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::LockTableDirectlyOrNot</span><span class="params">(Transaction *txn, LockMode lock_mode, <span class="type">const</span> <span class="type">table_oid_t</span> &amp;oid, <span class="type">bool</span> directly)</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> txn_state = txn-&gt;<span class="built_in">GetState</span>();</span><br><span class="line">  <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">  <span class="keyword">if</span> (txn_state == TransactionState::COMMITTED || txn_state == TransactionState::ABORTED) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//事务已经提交或终止，返回false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (iso_level) &#123;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::REPEATABLE_READ:</span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;<span class="comment">//REPEATABLE_READ级别下,SHRINKING阶段不可加锁</span></span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, directly);<span class="comment">//抛出异常</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::READ_COMMITTED:</span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;</span><br><span class="line">        <span class="comment">//READ_COMMITTED级别下，SHRINGKING阶段只可加IS、S锁</span></span><br><span class="line">        <span class="keyword">if</span> (lock_mode != LockMode::INTENTION_SHARED &amp;&amp; lock_mode != LockMode::SHARED) &#123;</span><br><span class="line">          <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, directly);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::READ_UNCOMMITTED:</span><br><span class="line">      <span class="comment">//READ_UNCOMMITTED级别下,SHRINKING阶段不可加锁</span></span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;</span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, directly);<span class="comment">//抛出异常</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//READ_UNCOMMITTED级别下,只可以加IX和X锁</span></span><br><span class="line">      <span class="keyword">if</span> (lock_mode != LockMode::INTENTION_EXCLUSIVE &amp;&amp; lock_mode != LockMode::EXCLUSIVE) &#123;</span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_SHARED_ON_READ_UNCOMMITTED, directly);<span class="comment">//抛出异常</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>(<span class="string">&quot;wrong IsolationLevel&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  table_lock_map_latch_.<span class="built_in">lock</span>();</span><br><span class="line">  <span class="keyword">if</span> (table_lock_map_.<span class="built_in">count</span>(oid) == <span class="number">0</span>) &#123;</span><br><span class="line">    table_lock_map_[oid] = std::<span class="built_in">make_shared</span>&lt;LockRequestQueue&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> lrq = table_lock_map_[oid];<span class="comment">//拿到该table的LockRequestQueue</span></span><br><span class="line">  <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(lrq-&gt;latch_)</span></span>;</span><br><span class="line">  table_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查此锁的请求是否为一次锁升级</span></span><br><span class="line">  <span class="type">bool</span> upgrade = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); iter++) &#123;<span class="comment">//遍历LockRequestQueue</span></span><br><span class="line">    <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;  <span class="comment">// 同一个事务对相同table请求加锁</span></span><br><span class="line">      <span class="keyword">if</span> (lr-&gt;lock_mode_ == lock_mode) &#123;           <span class="comment">// 加锁的类型相同,直接返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (lrq-&gt;upgrading_ != INVALID_TXN_ID) &#123;  <span class="comment">// 有事务正在对该resource进行锁升级</span></span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::UPGRADE_CONFLICT, directly);<span class="comment">//抛出异常</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">CanLockUpgrade</span>(lr-&gt;lock_mode_, lock_mode)) &#123;  <span class="comment">// 不能够进行锁升级</span></span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::INCOMPATIBLE_UPGRADE, directly);<span class="comment">//抛出异常</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//锁升级</span></span><br><span class="line">      lrq-&gt;upgrading_ = txn-&gt;<span class="built_in">GetTransactionId</span>();</span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);<span class="comment">//将lr从LockRequestQueue中删除</span></span><br><span class="line">      <span class="built_in">RemoveFromTxnTableLockSet</span>(txn, lr-&gt;lock_mode_, oid);<span class="comment">//将txn事务持有该table的锁删除</span></span><br><span class="line">      <span class="keyword">delete</span> lr;  <span class="comment">// 防止内存泄露</span></span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">LockRequest</span>(txn-&gt;<span class="built_in">GetTransactionId</span>(), lock_mode, oid));<span class="comment">//加入LockRequest</span></span><br><span class="line">      upgrade = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 不是锁升级</span></span><br><span class="line">  <span class="keyword">if</span> (!upgrade) &#123;</span><br><span class="line">    lrq-&gt;request_queue_.<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">LockRequest</span>(txn-&gt;<span class="built_in">GetTransactionId</span>(), lock_mode, oid));<span class="comment">//加入LockRequest</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!<span class="built_in">CanTxnTakeLock</span>(txn, lock_mode, lrq)) &#123;<span class="comment">//判断是否可以给改Table加锁</span></span><br><span class="line">    lrq-&gt;cv_.<span class="built_in">wait</span>(lock);<span class="comment">//互斥阻塞</span></span><br><span class="line">    <span class="comment">// 可能死锁检测将该事务ABORTED 或者 手动ABORT该事务</span></span><br><span class="line">    <span class="keyword">if</span> (txn-&gt;<span class="built_in">GetState</span>() == TransactionState::ABORTED) &#123;</span><br><span class="line">      <span class="comment">// 删除该事务对该资源的request</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); iter++) &#123;</span><br><span class="line">        <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">        <span class="keyword">if</span> (lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">          lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);</span><br><span class="line">          <span class="keyword">delete</span> lr;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      lrq-&gt;cv_.<span class="built_in">notify_all</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AddIntoTxnTableLockSet</span>(txn, lock_mode, oid);<span class="comment">//该Table获得锁</span></span><br><span class="line">  <span class="comment">// LOG_DEBUG(&quot;txn:%d LockTable %d lock_mode:%d&quot;, txn-&gt;GetTransactionId(), oid, lock_mode);</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::CanTxnTakeLock</span><span class="params">(Transaction *txn, LockMode lock_mode,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 std::shared_ptr&lt;LockRequestQueue&gt; &amp;lock_request_queue)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> lr : lock_request_queue-&gt;request_queue_) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;granted_ &amp;&amp; !<span class="built_in">AreLocksCompatible</span>(lock_mode, lr-&gt;lock_mode_)) &#123;  <span class="comment">// 存在锁冲突</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 锁升级优先级最高</span></span><br><span class="line">  <span class="keyword">if</span> (lock_request_queue-&gt;upgrading_ != INVALID_TXN_ID) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lock_request_queue-&gt;upgrading_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;  <span class="comment">// 事务进行锁升级</span></span><br><span class="line">      lock_request_queue-&gt;upgrading_ = INVALID_TXN_ID;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> lr : lock_request_queue-&gt;request_queue_) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!lr-&gt;granted_ &amp;&amp; lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">          lr-&gt;granted_ = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// 进行锁升级的是其它事务,那么该事务需要等待</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 遵循FIFO规则</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> lr : lock_request_queue-&gt;request_queue_) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">      lr-&gt;granted_ = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!lr-&gt;granted_ &amp;&amp; !<span class="built_in">AreLocksCompatible</span>(lock_mode, lr-&gt;lock_mode_)) &#123;  <span class="comment">// 锁冲突</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::UnlockTable</span><span class="params">(Transaction *txn, <span class="type">const</span> <span class="type">table_oid_t</span> &amp;oid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">CheckAllRowsUnLock</span>(txn, oid)) &#123;<span class="comment">//检查该Table下的所有row的锁是否释放</span></span><br><span class="line">    <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::TABLE_UNLOCKED_BEFORE_UNLOCKING_ROWS, <span class="literal">true</span>);<span class="comment">//抛出异常</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  table_lock_map_latch_.<span class="built_in">lock</span>();</span><br><span class="line">  <span class="keyword">if</span> (table_lock_map_.<span class="built_in">count</span>(oid) == <span class="number">0</span>) &#123;</span><br><span class="line">    table_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line">    <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::ATTEMPTED_UNLOCK_BUT_NO_LOCK_HELD, <span class="literal">true</span>);<span class="comment">//该table未加锁</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> lrq = table_lock_map_[oid];</span><br><span class="line">  <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(lrq-&gt;latch_)</span></span>;</span><br><span class="line">  table_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); ++iter) &#123;</span><br><span class="line">    <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;granted_ &amp;&amp; lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;<span class="comment">//找到该事务对该table的LockRequest</span></span><br><span class="line">      <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">      <span class="keyword">switch</span> (iso_level) &#123;</span><br><span class="line">        <span class="keyword">case</span> IsolationLevel::REPEATABLE_READ:</span><br><span class="line">          <span class="keyword">if</span> (lr-&gt;lock_mode_ == LockMode::SHARED || lr-&gt;lock_mode_ == LockMode::EXCLUSIVE) &#123;</span><br><span class="line">            txn-&gt;<span class="built_in">SetState</span>(TransactionState::SHRINKING);</span><br><span class="line">            <span class="comment">// LOG_DEBUG(&quot;txn:%d be set SHRINGKING&quot;, txn-&gt;GetTransactionId());</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IsolationLevel::READ_COMMITTED:</span><br><span class="line">        <span class="keyword">case</span> IsolationLevel::READ_UNCOMMITTED:</span><br><span class="line">          <span class="keyword">if</span> (lr-&gt;lock_mode_ == LockMode::EXCLUSIVE) &#123;</span><br><span class="line">            txn-&gt;<span class="built_in">SetState</span>(TransactionState::SHRINKING);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="built_in">UNREACHABLE</span>(<span class="string">&quot;wrong IsolationLevel&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">RemoveFromTxnTableLockSet</span>(txn, lr-&gt;lock_mode_, oid);</span><br><span class="line">      <span class="comment">// LOG_DEBUG(&quot;txn:%d UnlockTable %d&quot;, txn-&gt;GetTransactionId(), oid);</span></span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);</span><br><span class="line">      <span class="keyword">delete</span> lr;</span><br><span class="line">      lrq-&gt;cv_.<span class="built_in">notify_all</span>();<span class="comment">//资源释放，cv_进行notify</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::ATTEMPTED_UNLOCK_BUT_NO_LOCK_HELD, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>LockRow(Transaction, LockMode, TableOID, RID)</li>
<li>UnlockRow(Transaction, TableOID, RID, force)<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::LockRow</span><span class="params">(Transaction *txn, LockMode lock_mode, <span class="type">const</span> <span class="type">table_oid_t</span> &amp;oid, <span class="type">const</span> RID &amp;rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">    <span class="comment">//row只能加S和E锁</span></span><br><span class="line">  <span class="keyword">if</span> (lock_mode != LockMode::SHARED &amp;&amp; lock_mode != LockMode::EXCLUSIVE) &#123;</span><br><span class="line">    <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::ATTEMPTED_INTENTION_LOCK_ON_ROW, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> txn_state = txn-&gt;<span class="built_in">GetState</span>();</span><br><span class="line">  <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">  <span class="keyword">if</span> (txn_state == TransactionState::COMMITTED || txn_state == TransactionState::ABORTED) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (iso_level) &#123;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::REPEATABLE_READ:</span><br><span class="line">    <span class="comment">//REPEATABLE_READ级别下SHRINKING阶段不可以加锁</span></span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;</span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, <span class="literal">true</span>);<span class="comment">//抛出异常</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::READ_COMMITTED:</span><br><span class="line">    <span class="comment">//READ_COMMITTED级别下SHRINKING阶段只能给row加SHARED锁</span></span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lock_mode != LockMode::SHARED) &#123;</span><br><span class="line">          <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, <span class="literal">true</span>);<span class="comment">//抛出异常</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::READ_UNCOMMITTED:</span><br><span class="line">    <span class="comment">//READ_UNCOMMITTED级别下SHRINKING阶段不能加锁</span></span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;</span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, <span class="literal">true</span>);<span class="comment">//抛出异常</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//READ_UNCOMMITTED级别下，只能给row加X锁</span></span><br><span class="line">      <span class="keyword">if</span> (lock_mode != LockMode::EXCLUSIVE) &#123;</span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_SHARED_ON_READ_UNCOMMITTED, <span class="literal">true</span>);<span class="comment">//抛出异常</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>(<span class="string">&quot;wrong IsolationLevel&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">CheckAppropriateLockOnTable</span>(txn, oid, lock_mode)) &#123;<span class="comment">//查看该row的Table是否加锁</span></span><br><span class="line">    <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::TABLE_LOCK_NOT_PRESENT, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  row_lock_map_latch_.<span class="built_in">lock</span>();</span><br><span class="line">  <span class="keyword">if</span> (row_lock_map_.<span class="built_in">count</span>(rid) == <span class="number">0</span>) &#123;</span><br><span class="line">    row_lock_map_[rid] = std::<span class="built_in">make_shared</span>&lt;LockRequestQueue&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> lrq = row_lock_map_[rid];</span><br><span class="line">  <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(lrq-&gt;latch_)</span></span>;</span><br><span class="line">  row_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查是否是一次锁升级(S-&gt;X)</span></span><br><span class="line">  <span class="type">bool</span> upgrade = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); iter++) &#123;</span><br><span class="line">    <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (lr-&gt;lock_mode_ == lock_mode) &#123;  <span class="comment">// 重复的锁</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (lrq-&gt;upgrading_ != INVALID_TXN_ID) &#123;  <span class="comment">// 抛出 UPGRADE_CONFLICT 异常</span></span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::UPGRADE_CONFLICT, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">CanLockUpgrade</span>(lr-&gt;lock_mode_, lock_mode)) &#123;  <span class="comment">// 抛 INCOMPATIBLE_UPGRADE 异常</span></span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::INCOMPATIBLE_UPGRADE, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      lrq-&gt;upgrading_ = txn-&gt;<span class="built_in">GetTransactionId</span>();</span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);</span><br><span class="line">      <span class="built_in">RemoveFromTxnRowLockSet</span>(txn, lr-&gt;lock_mode_, oid, rid);</span><br><span class="line">      <span class="keyword">delete</span> lr;</span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">LockRequest</span>(txn-&gt;<span class="built_in">GetTransactionId</span>(), lock_mode, oid, rid));</span><br><span class="line">      upgrade = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!upgrade) &#123;</span><br><span class="line">    lrq-&gt;request_queue_.<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">LockRequest</span>(txn-&gt;<span class="built_in">GetTransactionId</span>(), lock_mode, oid, rid));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!<span class="built_in">CanTxnTakeLock</span>(txn, lock_mode, lrq)) &#123;</span><br><span class="line">    lrq-&gt;cv_.<span class="built_in">wait</span>(lock);</span><br><span class="line">    <span class="comment">// LOG_DEBUG(&quot;txn:%d wake&quot;, txn-&gt;GetTransactionId());</span></span><br><span class="line">    <span class="comment">// 死锁检测ABORT该事务 或者 手动ABORT该事务</span></span><br><span class="line">    <span class="keyword">if</span> (txn-&gt;<span class="built_in">GetState</span>() == TransactionState::ABORTED) &#123;</span><br><span class="line">      <span class="comment">// LOG_DEBUG(&quot;txn:%d ABORT&quot;, txn-&gt;GetTransactionId());</span></span><br><span class="line">      <span class="comment">// 移除该事务对该资源的request</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); iter++) &#123;</span><br><span class="line">        <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">        <span class="keyword">if</span> (lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">          lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);</span><br><span class="line">          <span class="keyword">delete</span> lr;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      lrq-&gt;cv_.<span class="built_in">notify_all</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">AddIntoTxnRowLockSet</span>(txn, lock_mode, oid, rid);</span><br><span class="line">  <span class="comment">// LOG_DEBUG(&quot;txn:%d LockRow oid:%d rid:%d:%d lock_mode:%d&quot;, txn-&gt;GetTransactionId(), oid, rid.GetPageId(),</span></span><br><span class="line">  <span class="comment">// rid.GetSlotNum(), lock_mode);</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::UnlockRow</span><span class="params">(Transaction *txn, <span class="type">const</span> <span class="type">table_oid_t</span> &amp;oid, <span class="type">const</span> RID &amp;rid, <span class="type">bool</span> force)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  row_lock_map_latch_.<span class="built_in">lock</span>();</span><br><span class="line">  <span class="keyword">if</span> (row_lock_map_.<span class="built_in">count</span>(rid) == <span class="number">0</span>) &#123;</span><br><span class="line">    row_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line">    <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::ATTEMPTED_UNLOCK_BUT_NO_LOCK_HELD, <span class="literal">true</span>);<span class="comment">//该row未加锁抛出异常</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> lrq = row_lock_map_[rid];</span><br><span class="line">  <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(lrq-&gt;latch_)</span></span>;</span><br><span class="line">  row_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); ++iter) &#123;</span><br><span class="line">    <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;granted_ &amp;&amp; lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!force) &#123;</span><br><span class="line">        <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">        <span class="keyword">switch</span> (iso_level) &#123;</span><br><span class="line">          <span class="keyword">case</span> IsolationLevel::REPEATABLE_READ:</span><br><span class="line">            <span class="keyword">if</span> (lr-&gt;lock_mode_ == LockMode::SHARED || lr-&gt;lock_mode_ == LockMode::EXCLUSIVE) &#123;</span><br><span class="line">              txn-&gt;<span class="built_in">SetState</span>(TransactionState::SHRINKING);</span><br><span class="line">              <span class="comment">// LOG_DEBUG(&quot;txn:%d be set SHRINGKING&quot;, txn-&gt;GetTransactionId());</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> IsolationLevel::READ_COMMITTED:</span><br><span class="line">          <span class="keyword">case</span> IsolationLevel::READ_UNCOMMITTED:</span><br><span class="line">            <span class="keyword">if</span> (lr-&gt;lock_mode_ == LockMode::EXCLUSIVE) &#123;</span><br><span class="line">              txn-&gt;<span class="built_in">SetState</span>(TransactionState::SHRINKING);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">UNREACHABLE</span>(<span class="string">&quot;wrong IsolationLevel&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">RemoveFromTxnRowLockSet</span>(txn, lr-&gt;lock_mode_, oid, rid);</span><br><span class="line">      <span class="comment">// LOG_DEBUG(&quot;txn:%d UnlockRow oid:%d rid:%d:%d&quot;, txn-&gt;GetTransactionId(), oid, rid.GetPageId(),</span></span><br><span class="line">      <span class="comment">// rid.GetSlotNum());</span></span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);</span><br><span class="line">      <span class="keyword">delete</span> lr;</span><br><span class="line">      lrq-&gt;cv_.<span class="built_in">notify_all</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::ATTEMPTED_UNLOCK_BUT_NO_LOCK_HELD, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Task-2-Deadlock-Detection"><a href="#Task-2-Deadlock-Detection" class="headerlink" title="Task #2 - Deadlock Detection"></a>Task #2 - Deadlock Detection</h2><p>锁管理器应该在后台线程中运行死锁检测，定期构建等待图并根据需要中止事务以消除死锁。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//给LockManger添加死锁检测所需的数据成员</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LockManager</span> &#123;</span><br><span class="line">  std::atomic&lt;<span class="type">bool</span>&gt; enable_cycle_detection_;</span><br><span class="line">  std::thread *cycle_detection_thread_;</span><br><span class="line">  <span class="comment">/** Waits-for graph representation. */</span></span><br><span class="line">  std::map&lt;<span class="type">txn_id_t</span>, std::set&lt;<span class="type">txn_id_t</span>&gt;&gt; waits_for_;</span><br><span class="line">  <span class="comment">// std::unordered_map&lt;txn_id_t, int&gt; node_value_;</span></span><br><span class="line">  <span class="comment">// std::vector&lt;txn_id_t&gt; route_;</span></span><br><span class="line">  std::vector&lt;<span class="type">txn_id_t</span>&gt; stk_;</span><br><span class="line">  std::unordered_map&lt;<span class="type">txn_id_t</span>, <span class="type">bool</span>&gt; in_stk_;</span><br><span class="line">  std::unordered_map&lt;<span class="type">txn_id_t</span>, <span class="type">bool</span>&gt; has_search_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>开启死锁检测的后台线程<br><img src="/../images/cmu15445-project4/13.png" alt="img"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LockManager::RunCycleDetection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (enable_cycle_detection_) &#123;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(cycle_detection_interval);</span><br><span class="line">    &#123;</span><br><span class="line">      waits_for_.<span class="built_in">clear</span>();</span><br><span class="line">      <span class="built_in">BuildGraph</span>();<span class="comment">//构建等待图</span></span><br><span class="line">      <span class="comment">// PrintGraph();</span></span><br><span class="line">      <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        stk_.<span class="built_in">clear</span>();</span><br><span class="line">        in_stk_.<span class="built_in">clear</span>();</span><br><span class="line">        has_search_.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="type">txn_id_t</span> abort_tid;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">HasCycle</span>(&amp;abort_tid)) &#123;<span class="comment">//判断是否有环，如果有获取abort_id</span></span><br><span class="line">          <span class="comment">// LOG_DEBUG(&quot;abort_tid:%d&quot;, abort_tid);</span></span><br><span class="line">          <span class="keyword">auto</span> txn = txn_manager_-&gt;<span class="built_in">GetTransaction</span>(abort_tid);</span><br><span class="line">          txn-&gt;<span class="built_in">SetState</span>(TransactionState::ABORTED);</span><br><span class="line">          <span class="built_in">RemoveAllAboutAbortTxn</span>(abort_tid);<span class="comment">//删除有向图中该abort_tid的所有入边和出边</span></span><br><span class="line">          <span class="built_in">WakeAbortedTxn</span>(abort_tid);<span class="comment">//该abort_tid的事务所占有的资源的cv_进行notify_all</span></span><br><span class="line">          <span class="comment">// LOG_DEBUG(&quot;dead_detect notify all&quot;);</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//HasCycle函数判断是否有环，并且返回环中最大的txn_id</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::HasCycle</span><span class="params">(<span class="type">txn_id_t</span> *txn_id)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> std::<span class="built_in">any_of</span>(waits_for_.<span class="built_in">begin</span>(), waits_for_.<span class="built_in">end</span>(),</span><br><span class="line">                     [<span class="keyword">this</span>, txn_id](<span class="type">const</span> std::pair&lt;<span class="type">txn_id_t</span>, std::set&lt;<span class="type">txn_id_t</span>&gt;&gt; &amp;p) &#123;</span><br><span class="line">                       <span class="keyword">auto</span> k = p.first;</span><br><span class="line">                       <span class="keyword">if</span> (!<span class="keyword">this</span>-&gt;has_search_[k] &amp;&amp; <span class="built_in">DFS</span>(k)) &#123;</span><br><span class="line">                         <span class="keyword">auto</span> iter = std::<span class="built_in">find</span>(<span class="keyword">this</span>-&gt;stk_.<span class="built_in">begin</span>(), <span class="keyword">this</span>-&gt;stk_.<span class="built_in">end</span>() - <span class="number">1</span>, <span class="keyword">this</span>-&gt;stk_.<span class="built_in">back</span>());</span><br><span class="line">                         *txn_id = <span class="number">-1</span>;</span><br><span class="line">                         <span class="keyword">while</span> (iter != <span class="keyword">this</span>-&gt;stk_.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                           <span class="keyword">if</span> (*iter &gt; *txn_id) &#123;</span><br><span class="line">                             *txn_id = *iter;</span><br><span class="line">                           &#125;</span><br><span class="line">                           ++iter;</span><br><span class="line">                         &#125;</span><br><span class="line">                         <span class="keyword">this</span>-&gt;stk_.<span class="built_in">clear</span>();</span><br><span class="line">                         <span class="keyword">this</span>-&gt;in_stk_.<span class="built_in">clear</span>();</span><br><span class="line">                         <span class="keyword">this</span>-&gt;has_search_.<span class="built_in">clear</span>();</span><br><span class="line">                         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">this</span>-&gt;stk_.<span class="built_in">clear</span>();</span><br><span class="line">                       <span class="keyword">this</span>-&gt;in_stk_.<span class="built_in">clear</span>();</span><br><span class="line">                       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                     &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//DFS函数判断是否有环,txn_id为遍历的起始点</span></span><br><span class="line"><span class="comment">//有环返回true 无环返回false</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::DFS</span><span class="params">(<span class="type">txn_id_t</span> txn_id)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  has_search_[txn_id] = <span class="literal">true</span>;</span><br><span class="line">  stk_.<span class="built_in">push_back</span>(txn_id);</span><br><span class="line">  in_stk_[txn_id] = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> id : waits_for_[txn_id]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!has_search_[id]) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">DFS</span>(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (in_stk_[id]) &#123;</span><br><span class="line">      stk_.<span class="built_in">push_back</span>(id);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stk_.<span class="built_in">pop_back</span>();</span><br><span class="line">  in_stk_[txn_id] = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Task-3-Concurrent-Query-Execution"><a href="#Task-3-Concurrent-Query-Execution" class="headerlink" title="Task #3 - Concurrent Query Execution"></a>Task #3 - Concurrent Query Execution</h2><p>TransactionManager的Abort函数需要恢复Table和对应Index的原始状态</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TransactionManager::Commit</span><span class="params">(Transaction *txn)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Release all the locks.</span></span><br><span class="line">  <span class="built_in">ReleaseLocks</span>(txn);</span><br><span class="line"></span><br><span class="line">  txn-&gt;<span class="built_in">SetState</span>(TransactionState::COMMITTED);</span><br><span class="line">  <span class="function">std::unique_lock&lt;std::shared_mutex&gt; <span class="title">guard</span><span class="params">(txn_map_mutex_)</span></span>;</span><br><span class="line">  txn_map_.<span class="built_in">erase</span>(txn-&gt;<span class="built_in">GetTransactionId</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TransactionManager::Abort</span><span class="params">(Transaction *txn)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* <span class="doctag">TODO:</span> revert all the changes in write set */</span></span><br><span class="line">  <span class="keyword">while</span> (!txn-&gt;<span class="built_in">GetWriteSet</span>()-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="keyword">auto</span> twr = txn-&gt;<span class="built_in">GetWriteSet</span>()-&gt;<span class="built_in">back</span>();</span><br><span class="line">    <span class="keyword">if</span> (twr.wtype_ == WType::INSERT) &#123;</span><br><span class="line">      <span class="keyword">auto</span> tuple_meta = twr.table_heap_-&gt;<span class="built_in">GetTupleMeta</span>(twr.rid_);</span><br><span class="line">      tuple_meta.is_deleted_ = <span class="literal">true</span>;</span><br><span class="line">      twr.table_heap_-&gt;<span class="built_in">UpdateTupleMeta</span>(tuple_meta, twr.rid_);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (twr.wtype_ == WType::DELETE) &#123;</span><br><span class="line">      <span class="keyword">auto</span> tuple_meta = twr.table_heap_-&gt;<span class="built_in">GetTupleMeta</span>(twr.rid_);</span><br><span class="line">      tuple_meta.is_deleted_ = <span class="literal">false</span>;</span><br><span class="line">      twr.table_heap_-&gt;<span class="built_in">UpdateTupleMeta</span>(tuple_meta, twr.rid_);</span><br><span class="line">    &#125;</span><br><span class="line">    txn-&gt;<span class="built_in">GetWriteSet</span>()-&gt;<span class="built_in">pop_back</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!txn-&gt;<span class="built_in">GetIndexWriteSet</span>()-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="keyword">auto</span> iwr = txn-&gt;<span class="built_in">GetIndexWriteSet</span>()-&gt;<span class="built_in">back</span>();</span><br><span class="line">    <span class="keyword">if</span> (iwr.wtype_ == WType::INSERT) &#123;</span><br><span class="line">      iwr.catalog_-&gt;<span class="built_in">GetIndex</span>(iwr.index_oid_)-&gt;index_-&gt;<span class="built_in">DeleteEntry</span>(iwr.tuple_, iwr.rid_, txn);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (iwr.wtype_ == WType::DELETE) &#123;</span><br><span class="line">      iwr.catalog_-&gt;<span class="built_in">GetIndex</span>(iwr.index_oid_)-&gt;index_-&gt;<span class="built_in">InsertEntry</span>(iwr.tuple_, iwr.rid_, txn);</span><br><span class="line">    &#125;</span><br><span class="line">    txn-&gt;<span class="built_in">GetIndexWriteSet</span>()-&gt;<span class="built_in">pop_back</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ReleaseLocks</span>(txn);</span><br><span class="line"></span><br><span class="line">  txn-&gt;<span class="built_in">SetState</span>(TransactionState::ABORTED);</span><br><span class="line">  <span class="function">std::unique_lock&lt;std::shared_mutex&gt; <span class="title">guard</span><span class="params">(txn_map_mutex_)</span></span>;</span><br><span class="line">  txn_map_.<span class="built_in">erase</span>(txn-&gt;<span class="built_in">GetTransactionId</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SeqScanExecutor修改</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SeqScanExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> catalog = exec_ctx_-&gt;<span class="built_in">GetCatalog</span>();</span><br><span class="line">  table_info_ = catalog-&gt;<span class="built_in">GetTable</span>(plan_-&gt;table_oid_);</span><br><span class="line">  <span class="keyword">auto</span> txn = exec_ctx_-&gt;<span class="built_in">GetTransaction</span>();</span><br><span class="line">  <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (exec_ctx_-&gt;<span class="built_in">IsDelete</span>()) &#123;<span class="comment">//当前进行的sql操作是DELETE或者UPDATE</span></span><br><span class="line">      <span class="keyword">auto</span> res =</span><br><span class="line">          exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">LockTable</span>(txn, LockManager::LockMode::INTENTION_EXCLUSIVE, plan_-&gt;table_oid_);</span><br><span class="line">      <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockTable Failed&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!txn-&gt;<span class="built_in">IsTableIntentionExclusiveLocked</span>(plan_-&gt;table_oid_) &amp;&amp;  <span class="comment">// 避免反向升级</span></span><br><span class="line">               (iso_level == IsolationLevel::READ_COMMITTED || iso_level == IsolationLevel::REPEATABLE_READ)) &#123;</span><br><span class="line">      <span class="keyword">auto</span> res =</span><br><span class="line">          exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">LockTable</span>(txn, LockManager::LockMode::INTENTION_SHARED, plan_-&gt;table_oid_);</span><br><span class="line">      <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockTable Failed&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockTable Failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  iterator_ = std::<span class="built_in">make_unique</span>&lt;TableIterator&gt;(table_info_-&gt;table_-&gt;<span class="built_in">MakeEagerIterator</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">SeqScanExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  std::pair&lt;TupleMeta, Tuple&gt; pair;</span><br><span class="line">  <span class="keyword">auto</span> txn = exec_ctx_-&gt;<span class="built_in">GetTransaction</span>();</span><br><span class="line">  <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">  <span class="keyword">while</span> (!iterator_-&gt;<span class="built_in">IsEnd</span>()) &#123;</span><br><span class="line">    pair = iterator_-&gt;<span class="built_in">GetTuple</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (exec_ctx_-&gt;<span class="built_in">IsDelete</span>()) &#123;</span><br><span class="line">        <span class="keyword">auto</span> res = exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">LockRow</span>(txn, LockManager::LockMode::EXCLUSIVE, plan_-&gt;table_oid_, pair.second.<span class="built_in">GetRid</span>());</span><br><span class="line">        <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockRow Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!txn-&gt;<span class="built_in">IsRowExclusiveLocked</span>(plan_-&gt;table_oid_, pair.second.<span class="built_in">GetRid</span>()) &amp;&amp;  <span class="comment">// 避免反向升级</span></span><br><span class="line">                 (iso_level == IsolationLevel::READ_COMMITTED || iso_level == IsolationLevel::REPEATABLE_READ)) &#123;</span><br><span class="line">        <span class="keyword">auto</span> res = exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">LockRow</span>(txn, LockManager::LockMode::SHARED, plan_-&gt;table_oid_, pair.second.<span class="built_in">GetRid</span>());</span><br><span class="line">        <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockRow Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockRow Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iterator_-&gt;<span class="built_in">GetTuple</span>().first.is_deleted_ ||</span><br><span class="line">        (plan_-&gt;filter_predicate_ &amp;&amp;</span><br><span class="line">         plan_-&gt;filter_predicate_-&gt;<span class="built_in">Evaluate</span>(&amp;pair.second, table_info_-&gt;schema_)</span><br><span class="line">                 .<span class="built_in">CompareEquals</span>(ValueFactory::<span class="built_in">GetBooleanValue</span>(<span class="literal">false</span>)) == CmpBool::CmpTrue)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (exec_ctx_-&gt;<span class="built_in">IsDelete</span>() ||</span><br><span class="line">          (iso_level == IsolationLevel::READ_COMMITTED || iso_level == IsolationLevel::REPEATABLE_READ)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">auto</span> res = exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">UnlockRow</span>(txn, plan_-&gt;table_oid_, pair.second.<span class="built_in">GetRid</span>(), <span class="literal">true</span>);</span><br><span class="line">          <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor Force UnLockRow Failed&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor Force UnLockRow Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ++(*iterator_);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!exec_ctx_-&gt;<span class="built_in">IsDelete</span>() &amp;&amp; iso_level == IsolationLevel::READ_COMMITTED) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">auto</span> res = exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">UnlockRow</span>(txn, plan_-&gt;table_oid_, pair.second.<span class="built_in">GetRid</span>());</span><br><span class="line">        <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor UnLockRow Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor UnLockRow Failed&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++(*iterator_);</span><br><span class="line">    *tuple = std::<span class="built_in">move</span>(pair.second);</span><br><span class="line">    *rid = tuple-&gt;<span class="built_in">GetRid</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!exec_ctx_-&gt;<span class="built_in">IsDelete</span>() &amp;&amp; iso_level == IsolationLevel::READ_COMMITTED) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">auto</span> res = exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">UnlockTable</span>(txn, plan_-&gt;table_oid_);</span><br><span class="line">      <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor UnLockTable Failed&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor UnLockTable Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InsertExecutor修改，给table加IE锁，并且table和index插入记录需要被保存下来</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">InsertExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  child_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  <span class="keyword">auto</span> cata_log = exec_ctx_-&gt;<span class="built_in">GetCatalog</span>();</span><br><span class="line">  table_info_ = cata_log-&gt;<span class="built_in">GetTable</span>(plan_-&gt;table_oid_);</span><br><span class="line">  index_infos_ = cata_log-&gt;<span class="built_in">GetTableIndexes</span>(table_info_-&gt;name_);</span><br><span class="line">  successful_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">auto</span> txn = exec_ctx_-&gt;<span class="built_in">GetTransaction</span>();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">auto</span> res =</span><br><span class="line">        exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">LockTable</span>(txn, LockManager::LockMode::INTENTION_EXCLUSIVE, plan_-&gt;table_oid_);</span><br><span class="line">    <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;InsertExecutor LockTable Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;InsertExecutor LockTable Failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">InsertExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  TupleMeta meta;</span><br><span class="line">  <span class="keyword">if</span> (successful_) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  meta.insert_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  meta.delete_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  meta.is_deleted_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">auto</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (child_executor_-&gt;<span class="built_in">Next</span>(tuple, rid)) &#123;</span><br><span class="line">    <span class="keyword">auto</span> tuple_rid = table_info_-&gt;table_-&gt;<span class="built_in">InsertTuple</span>(meta, *tuple, exec_ctx_-&gt;<span class="built_in">GetLockManager</span>(), exec_ctx_-&gt;<span class="built_in">GetTransaction</span>(), table_info_-&gt;oid_);</span><br><span class="line">    <span class="keyword">if</span> (tuple_rid == std::<span class="literal">nullopt</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> twr = <span class="built_in">TableWriteRecord</span>(table_info_-&gt;oid_, tuple_rid.<span class="built_in">value</span>(), table_info_-&gt;table_.<span class="built_in">get</span>());</span><br><span class="line">    twr.wtype_ = WType::INSERT;</span><br><span class="line">    exec_ctx_-&gt;<span class="built_in">GetTransaction</span>()-&gt;<span class="built_in">GetWriteSet</span>()-&gt;<span class="built_in">push_back</span>(twr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> index_info : index_infos_) &#123;</span><br><span class="line">      <span class="keyword">auto</span> key = tuple-&gt;<span class="built_in">KeyFromTuple</span>(table_info_-&gt;schema_, index_info-&gt;key_schema_, index_info-&gt;index_-&gt;<span class="built_in">GetKeyAttrs</span>());</span><br><span class="line">      index_info-&gt;index_-&gt;<span class="built_in">InsertEntry</span>(key, *tuple_rid, exec_ctx_-&gt;<span class="built_in">GetTransaction</span>());</span><br><span class="line">      <span class="keyword">auto</span> iwr = <span class="built_in">IndexWriteRecord</span>(tuple_rid.<span class="built_in">value</span>(), table_info_-&gt;oid_, WType::INSERT, key, index_info-&gt;index_oid_,</span><br><span class="line">                                  exec_ctx_-&gt;<span class="built_in">GetCatalog</span>());</span><br><span class="line">      exec_ctx_-&gt;<span class="built_in">GetTransaction</span>()-&gt;<span class="built_in">GetIndexWriteSet</span>()-&gt;<span class="built_in">push_back</span>(iwr);</span><br><span class="line">    &#125;</span><br><span class="line">    ++count;</span><br><span class="line">  &#125;</span><br><span class="line">  std::vector&lt;Value&gt; values;</span><br><span class="line">  values.<span class="built_in">emplace_back</span>(TypeId::INTEGER, count);</span><br><span class="line">  *tuple = <span class="built_in">Tuple</span>(values, &amp;<span class="built_in">GetOutputSchema</span>());</span><br><span class="line">  successful_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DeleteExecutor修改，并且table和index删除记录需要被保存下来</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DeleteExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  child_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  successful_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">auto</span> catalog = exec_ctx_-&gt;<span class="built_in">GetCatalog</span>();</span><br><span class="line">  table_info_ = catalog-&gt;<span class="built_in">GetTable</span>(plan_-&gt;<span class="built_in">TableOid</span>());</span><br><span class="line">  index_infos_ = catalog-&gt;<span class="built_in">GetTableIndexes</span>(table_info_-&gt;name_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">DeleteExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  TupleMeta tuple_meta;</span><br><span class="line">  <span class="keyword">if</span> (successful_) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  tuple_meta.delete_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  tuple_meta.insert_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  tuple_meta.is_deleted_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">auto</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (child_executor_-&gt;<span class="built_in">Next</span>(tuple, rid)) &#123;</span><br><span class="line">    table_info_-&gt;table_-&gt;<span class="built_in">UpdateTupleMeta</span>(tuple_meta, *rid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> twr = <span class="built_in">TableWriteRecord</span>(table_info_-&gt;oid_, *rid, table_info_-&gt;table_.<span class="built_in">get</span>());</span><br><span class="line">    twr.wtype_ = WType::DELETE;</span><br><span class="line">    exec_ctx_-&gt;<span class="built_in">GetTransaction</span>()-&gt;<span class="built_in">GetWriteSet</span>()-&gt;<span class="built_in">push_back</span>(twr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> index_info : index_infos_) &#123;</span><br><span class="line">      <span class="keyword">auto</span> key = tuple-&gt;<span class="built_in">KeyFromTuple</span>(table_info_-&gt;schema_, index_info-&gt;key_schema_, index_info-&gt;index_-&gt;<span class="built_in">GetKeyAttrs</span>());</span><br><span class="line">      index_info-&gt;index_-&gt;<span class="built_in">DeleteEntry</span>(key, *rid, exec_ctx_-&gt;<span class="built_in">GetTransaction</span>());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">auto</span> iwr = <span class="built_in">IndexWriteRecord</span>(*rid, table_info_-&gt;oid_, WType::DELETE, key, index_info-&gt;index_oid_,</span><br><span class="line">                                  exec_ctx_-&gt;<span class="built_in">GetCatalog</span>());</span><br><span class="line">      exec_ctx_-&gt;<span class="built_in">GetTransaction</span>()-&gt;<span class="built_in">GetIndexWriteSet</span>()-&gt;<span class="built_in">push_back</span>(iwr);</span><br><span class="line">    &#125;</span><br><span class="line">    count++;</span><br><span class="line">  &#125;</span><br><span class="line">  std::vector&lt;Value&gt; values;</span><br><span class="line">  values.<span class="built_in">emplace_back</span>(TypeId::INTEGER, count);</span><br><span class="line">  *tuple = <span class="built_in">Tuple</span>(values, &amp;<span class="built_in">GetOutputSchema</span>());</span><br><span class="line">  successful_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>五种细粒度锁IS IX S SIX X相容矩阵</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">IS</th>
<th align="center">IX</th>
<th align="center">S</th>
<th align="center">SIX</th>
<th align="center">X</th>
</tr>
</thead>
<tbody><tr>
<td align="center">IS</td>
<td align="center">YES</td>
<td align="center">YES</td>
<td align="center">YES</td>
<td align="center">YES</td>
<td align="center">NO</td>
</tr>
<tr>
<td align="center">IX</td>
<td align="center">YES</td>
<td align="center">YES</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
</tr>
<tr>
<td align="center">S</td>
<td align="center">YES</td>
<td align="center">NO</td>
<td align="center">YES</td>
<td align="center">NO</td>
<td align="center">NO</td>
</tr>
<tr>
<td align="center">SIX</td>
<td align="center">YES</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
</tr>
<tr>
<td align="center">X</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
</tr>
</tbody></table>
<p>本地测试通过：<br><img src="/../images/cmu15445-project4/14.png" alt="img"><br><img src="/../images/cmu15445-project4/15.png" alt="img"><br><img src="/../images/cmu15445-project4/16.png" alt="img"><br><img src="/../images/cmu15445-project4/17.png" alt="img"><br><img src="/../images/cmu15445-project4/18.png" alt="img"></p>
<p>线上测试通过:<br><img src="/../images/cmu15445-project4/19.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="jingtao8a"
      src="/images/iverson.jpg">
  <p class="site-author-name" itemprop="name">jingtao8a</p>
  <div class="site-description" itemprop="description">this is life, full of ups and down</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jingtao8a</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>

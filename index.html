<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jingtao8a.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="this is life, full of ups and down">
<meta property="og:type" content="website">
<meta property="og:title" content="jingtao8a&#39;s blog">
<meta property="og:url" content="http://jingtao8a.github.io/index.html">
<meta property="og:site_name" content="jingtao8a&#39;s blog">
<meta property="og:description" content="this is life, full of ups and down">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="jingtao8a">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://jingtao8a.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>jingtao8a's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">jingtao8a's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/05/12/vue3%E5%AD%A6%E4%B9%A0%E2%80%94%E2%80%94Tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/12/vue3%E5%AD%A6%E4%B9%A0%E2%80%94%E2%80%94Tutorial/" class="post-title-link" itemprop="url">vue3Â≠¶‰π†‚Äî‚ÄîTutorial</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-05-12 21:00:54 / Modified: 23:18:12" itemprop="dateCreated datePublished" datetime="2024-05-12T21:00:54-07:00">2024-05-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/vue3/" itemprop="url" rel="index"><span itemprop="name">vue3</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="reactive-Âíå-ref"><a href="#reactive-Âíå-ref" class="headerlink" title="reactive() Âíå ref()"></a>reactive() Âíå ref()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; reactive, ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counter = <span class="title function_">reactive</span>(&#123; <span class="attr">count</span>: <span class="number">0</span> &#125;)</span><br><span class="line"><span class="keyword">const</span> message = <span class="title function_">ref</span>(<span class="string">&#x27;Hello World!&#x27;</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; message.split(&#x27;&#x27;).reverse().join(&#x27;&#x27;) &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>Count is: &#123;&#123; counter.count &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="v-bind"><a href="#v-bind" class="headerlink" title="v-bind"></a>v-bind</h3><p>v-bind:id&#x3D;‚Äù‚Äù<br><br>v-bind:class&#x3D;‚Äù‚Äù<br><br>v-bind:value&#x3D;‚Äù‚Äù<br></p>
<p>ÁÆÄÂåñ‰∏∫<br></p>
<p>:id&#x3D;‚Äù‚Äù<br><br>:class&#x3D;‚Äù‚Äù<br><br>:value&#x3D;‚Äù‚Äù<br></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> titleClass = <span class="title function_">ref</span>(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h1</span> <span class="attr">:class</span>=<span class="string">&quot;titleClass&quot;</span>&gt;</span>Make me red<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="selector-class">.title</span> &#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">color</span>: red;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="v-on"><a href="#v-on" class="headerlink" title="v-on"></a>v-on</h3><p>Event Listeners</p>
<p>v-on:click&#x3D;‚Äù‚Äù<br><br>v-on:input&#x3D;‚Äù‚Äù<br></p>
<p>ÁÆÄÂåñ‰∏∫<br></p>
<p>@click&#x3D;‚Äù‚Äù<br><br>@input&#x3D;‚Äù‚Äù<br></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">increment</span>(<span class="params"></span>) &#123;</span><br><span class="line">  count.<span class="property">value</span>++</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;increment&quot;</span>&gt;</span>Count is: &#123;&#123; count &#125;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a>v-model</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> text = <span class="title function_">ref</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Type here&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; text &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="v-if-Âíå-v-else"><a href="#v-if-Âíå-v-else" class="headerlink" title="v-if Âíå v-else"></a>v-if Âíå v-else</h3><p>Conditional Rendering</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> awesome = <span class="title function_">ref</span>(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toggle</span>(<span class="params"></span>) &#123;</span><br><span class="line">  awesome.<span class="property">value</span> = !awesome.<span class="property">value</span></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;toggle&quot;</span>&gt;</span>Toggle<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-if</span>=<span class="string">&quot;awesome&quot;</span>&gt;</span>Vue is awesome!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-else</span>&gt;</span>Oh no üò¢<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="v-for"><a href="#v-for" class="headerlink" title="v-for"></a>v-for</h3><p>List Rendering</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// give each todo a unique id</span></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newTodo = <span class="title function_">ref</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> todos = <span class="title function_">ref</span>([</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn HTML&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn JavaScript&#x27;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn Vue&#x27;</span> &#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">// const index = ref(&quot;123&quot;)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addTodo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  todos.<span class="property">value</span>.<span class="title function_">push</span>(&#123;<span class="attr">id</span>: id++, <span class="attr">text</span>: newTodo.<span class="property">value</span>&#125;);</span><br><span class="line">  newTodo.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeTodo</span>(<span class="params">todo</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// index.value</span></span><br><span class="line">  todos.<span class="property">value</span>.<span class="title function_">splice</span>(todos.<span class="property">value</span>.<span class="title function_">indexOf</span>(todo), <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">form</span> @<span class="attr">submit.prevent</span>=<span class="string">&quot;addTodo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">&quot;newTodo&quot;</span> <span class="attr">required</span> <span class="attr">placeholder</span>=<span class="string">&quot;new todo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">button</span>&gt;</span>Add Todo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!--   &lt;p&gt;</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">    &#123;&#123;index&#125;&#125;</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">  &lt;/p&gt; --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;todo in todos&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;todo.id&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;&#123; todo.text &#125;&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;removeTodo(todo)&quot;</span>&gt;</span>X<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>


<h3 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h3><blockquote>
<p>introducing computed().We can create a computed ref that computes its .value based on other reactive data sources:</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref, computed &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newTodo = <span class="title function_">ref</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> hideCompleted = <span class="title function_">ref</span>(<span class="literal">false</span>)</span><br><span class="line"><span class="keyword">const</span> todos = <span class="title function_">ref</span>([</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn HTML&#x27;</span>, <span class="attr">done</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn JavaScript&#x27;</span>, <span class="attr">done</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: <span class="string">&#x27;Learn Vue&#x27;</span>, <span class="attr">done</span>: <span class="literal">false</span> &#125;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> filteredTodos = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> hideCompleted.<span class="property">value</span></span><br><span class="line">    ? todos.<span class="property">value</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">t</span>) =&gt;</span> !t.<span class="property">done</span>)</span><br><span class="line">    : todos.<span class="property">value</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addTodo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  todos.<span class="property">value</span>.<span class="title function_">push</span>(&#123; <span class="attr">id</span>: id++, <span class="attr">text</span>: newTodo.<span class="property">value</span>, <span class="attr">done</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">  newTodo.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeTodo</span>(<span class="params">todo</span>) &#123;</span><br><span class="line">  todos.<span class="property">value</span> = todos.<span class="property">value</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">t</span>) =&gt;</span> t !== todo)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;form @submit.prevent=&quot;addTodo&quot;&gt;</span><br><span class="line">    &lt;input v-model=&quot;newTodo&quot; required placeholder=&quot;new todo&quot;&gt;</span><br><span class="line">    &lt;button&gt;Add Todo&lt;/button&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">  &lt;ul&gt;</span><br><span class="line">    &lt;li v-for=&quot;todo in filteredTodos&quot; :key=&quot;todo.id&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;checkbox&quot; v-model=&quot;todo.done&quot;&gt;</span><br><span class="line">      &lt;span :class=&quot;&#123; done: todo.done &#125;&quot;&gt;&#123;&#123; todo.text &#125;&#125;&lt;/span&gt;</span><br><span class="line">      &lt;button @click=&quot;removeTodo(todo)&quot;&gt;X&lt;/button&gt;</span><br><span class="line">    &lt;/li&gt;</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">  &lt;button @click=&quot;hideCompleted = !hideCompleted&quot;&gt;</span><br><span class="line">    &#123;&#123; hideCompleted ? &#x27;Show all&#x27; : &#x27;Hide completed&#x27; &#125;&#125;</span><br><span class="line">  &lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">.done &#123;</span><br><span class="line">  text-decoration: line-through;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Lifecycle-and-Template-Refs"><a href="#Lifecycle-and-Template-Refs" class="headerlink" title="Lifecycle and Template Refs"></a>Lifecycle and Template Refs</h3><blockquote>
<p>HookÂáΩÊï∞ onMounted onUpdated Á≠â ‚Ä¶</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref, onMounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pElementRef = <span class="title function_">ref</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">const</span> customValue = <span class="title function_">ref</span>(<span class="string">&quot;123&quot;</span>)</span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  customValue.<span class="property">value</span> = pElementRef.<span class="property">value</span>.<span class="property">textContent</span></span><br><span class="line">  pElementRef.<span class="property">value</span>.<span class="property">textContent</span> = <span class="string">&#x27;mounted!&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span>&gt;</span> &#123;&#123;customValue&#125;&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">ref</span>=<span class="string">&quot;pElementRef&quot;</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, watch &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_">watch</span>(count, <span class="function">(<span class="params">newCount</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// yes, console.log() is a side effect</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`new count is: <span class="subst">$&#123;newCount&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>watch() can directly watch a ref, and the callback gets fired whenever count‚Äôs value changes.</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref, watch &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoId = <span class="title function_">ref</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">const</span> todoData = <span class="title function_">ref</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params">id</span>) &#123;</span><br><span class="line">  todoData.<span class="property">value</span> = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(</span><br><span class="line">    <span class="string">`https://jsonplaceholder.typicode.com/todos/<span class="subst">$&#123;id.value&#125;</span>`</span></span><br><span class="line">  )</span><br><span class="line">  todoData.<span class="property">value</span> = <span class="keyword">await</span> res.<span class="title function_">json</span>()</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="title function_">fetchData</span>(todoId)</span><br><span class="line"><span class="title function_">watch</span>(todoId, <span class="function">(<span class="params">todoId</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">fetchData</span>(todoId);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>Todo id: &#123;&#123; todoId &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;todoId++&quot;</span> <span class="attr">:disabled</span>=<span class="string">&quot;!todoData&quot;</span>&gt;</span>Fetch next todo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-if</span>=<span class="string">&quot;!todoData&quot;</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">pre</span> <span class="attr">v-else</span>&gt;</span>&#123;&#123; todoData &#125;&#125;<span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Components"><a href="#Components" class="headerlink" title="Components"></a>Components</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ChildComp</span> <span class="keyword">from</span> <span class="string">&#x27;./ChildComp.vue&#x27;</span></span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- render child component --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">ChildComp</span>&gt;</span><span class="tag">&lt;/<span class="name">ChildComp</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Props"><a href="#Props" class="headerlink" title="Props"></a>Props</h3><blockquote>
<p>A child component can accept input from the parent via props. First, it needs to declare the props it accepts:</p>
</blockquote>
<p>App.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ChildComp</span> <span class="keyword">from</span> <span class="string">&#x27;./ChildComp.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> greeting = <span class="title function_">ref</span>(<span class="string">&#x27;Hello from parent&#x27;</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">ChildComp</span> <span class="attr">:msg</span>=<span class="string">&quot;greeting&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>ChildComp.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">const</span> props = <span class="title function_">defineProps</span>(&#123;</span><br><span class="line">  <span class="attr">msg</span>: <span class="title class_">String</span></span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123; msg || &#x27;No props passed yet&#x27; &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Emits"><a href="#Emits" class="headerlink" title="Emits"></a>Emits</h3><blockquote>
<p>In addition to receiving props, a child component can also emit events to the parent:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class="line">import ChildComp from &#x27;./ChildComp.vue&#x27;</span><br><span class="line"></span><br><span class="line">const childMsg = ref(&#x27;No child msg yet&#x27;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;ChildComp @response=&quot;(msg) =&gt; childMsg = msg &quot; @response1=&quot;(msg)=&gt; childMsg=msg&quot;/&gt;</span><br><span class="line">  &lt;p&gt;&#123;&#123; childMsg &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">const emit = defineEmits([&#x27;response&#x27;, &#x27;response1&#x27;])</span><br><span class="line"></span><br><span class="line">emit(&#x27;response&#x27;, &#x27;hello from child&#x27;)</span><br><span class="line">emit(&#x27;response1&#x27;, &quot;flafkjka&quot;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h2&gt;Child component&lt;/h2&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Slots"><a href="#Slots" class="headerlink" title="Slots"></a>Slots</h3><blockquote>
<p>In addition to passing data via props, the parent component can also pass down template fragments to the child via slots</p>
</blockquote>
<p>App.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ChildComp</span> <span class="keyword">from</span> <span class="string">&#x27;./ChildComp.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> msg = <span class="title function_">ref</span>(<span class="string">&#x27;from parent&#x27;</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">ChildComp</span>&gt;</span><span class="tag">&lt;/<span class="name">ChildComp</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>ChildComp.vue</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">slot</span>&gt;</span>Fallback content<span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/05/11/javascript%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/11/javascript%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/" class="post-title-link" itemprop="url">javascriptÂü∫Á°ÄËØ≠Ê≥ï</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-05-11 05:44:34 / Modified: 20:47:39" itemprop="dateCreated datePublished" datetime="2024-05-11T05:44:34-07:00">2024-05-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index"><span itemprop="name">javascript</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Êï∞ÊçÆÁ±ªÂûã"><a href="#Êï∞ÊçÆÁ±ªÂûã" class="headerlink" title="Êï∞ÊçÆÁ±ªÂûã"></a>Êï∞ÊçÆÁ±ªÂûã</h3><p><strong>ÂÄºÁ±ªÂûã(Âü∫Êú¨Á±ªÂûã)</strong>  ÔºöÂ≠óÁ¨¶‰∏≤ÔºàStringÔºâ„ÄÅÊï∞Â≠ó(Number)„ÄÅÂ∏ÉÂ∞î(Boolean)„ÄÅÁ©∫ÔºànullÔºâ„ÄÅÊú™ÂÆö‰πâÔºàUndefinedÔºâ„ÄÅSymbol„ÄÇ</p>
<blockquote>
<p>ÊâÄÊúâÁöÑÂÄºÁ±ªÂûã(Âü∫Êú¨Á±ªÂûã), Èô§‰∫ÜnullÂíåundefined, ÈÉΩÂèØ‰ª•Ë¢´ÁúãÂÅöÂØπË±°</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;abc&quot;</span>)</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">123</span>)</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>js‰∏≠‰∏ÄÂàáÁöÜÂØπË±°</p>
</blockquote>
<p><strong>ÂºïÁî®Êï∞ÊçÆÁ±ªÂûã(ÂØπË±°Á±ªÂûã)</strong> Ôºö ÂØπË±°(Object)„ÄÅÊï∞ÁªÑ(Array)„ÄÅÂáΩÊï∞(Function)„ÄÅÊ≠£ÂàôÔºàRegExpÔºâÂíåÊó•ÊúüÔºàDateÔºâ</p>
<p><img src="/../images/javascript%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/1.png" alt="img"></p>
<blockquote>
<p>ps: ÂÆö‰πâÂèòÈáèÂæó‰ΩøÁî® var ÊàñËÄÖ let<br>ÂèØ‰ª•Áî®typeof Êù•Êü•ÁúãÂèòÈáèÁöÑÁ±ªÂûã</p>
</blockquote>
<h3 id="ÂáΩÊï∞"><a href="#ÂáΩÊï∞" class="headerlink" title="ÂáΩÊï∞"></a>ÂáΩÊï∞</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">myFunction</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ÂéüÂûãÈìæ"><a href="#ÂéüÂûãÈìæ" class="headerlink" title="ÂéüÂûãÈìæ"></a>ÂéüÂûãÈìæ</h3><p>classÂÖ≥ÈîÆÂ≠óÊòØÂéüÂûãÁ≥ªÁªü‰∏äÁöÑ‰∏Ä‰∏™ËØ≠Ê≥ïÁ≥ñÔºåÂàõÈÄ†‰∫Ü‰∏ÄÁßçÂü∫‰∫éÁ±ªÁöÑËØ≠Ë®ÄÁöÑÈîôËßâ„ÄÇ</p>
<p><strong>proto</strong>, prototype, constructorÁöÑÂÖ≥Á≥ª</p>
<p><img src="/../images/javascript%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/3.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/04/02/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/02/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/" class="post-title-link" itemprop="url">DILIËÆ∫ÊñáÈáçÁÇπÈÉ®ÂàÜ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-02 05:08:10" itemprop="dateCreated datePublished" datetime="2024-04-02T05:08:10-07:00">2024-04-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-12 20:46:32" itemprop="dateModified" datetime="2024-04-12T20:46:32-07:00">2024-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Learned-Index/" itemprop="url" rel="index"><span itemprop="name">Learned Index</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="DILIÔºöA-Distribution-driven-Learned-Index"><a href="#DILIÔºöA-Distribution-driven-Learned-Index" class="headerlink" title="DILIÔºöA Distribution-driven Learned Index"></a>DILIÔºöA Distribution-driven Learned Index</h2><p>ÊëòË¶ÅÔºö<br><br>DILIÁöÑÊØè‰∏™ËäÇÁÇπÔºàinternal node Âíå leaf nodeÔºâÈÉΩÊúâ‰∏Ä‰∏™Linear modelÔºåÂπ∂‰∏îinternal nodeÁöÑkey‚Äôs rangeË¢´ÂÆÉÁöÑchild nodeÂùáÂàÜÔºåÂΩìËøõË°åkeyÊü•ÊâæÊó∂ÔºåÂèØ‰ª•ÂáÜÁ°ÆÂú∞ÊâæÂà∞ÂØπÂ∫îÁöÑleaf node„ÄÇÂú®leaf node‰∏≠ÁöÑlinear modelÊòØÂèØ‰ª•ÂáÜÁ°ÆÈ¢ÑÊµãkeyÁöÑ‰ΩçÁΩÆÁöÑ„ÄÇ</p>
<p>‰∏∫‰∫ÜÊûÑÂª∫DILIÔºåÈ¶ñÂÖàÊûÑÂª∫‰∏ÄÈ¢óbottom-up tree,ÁÑ∂Âêé‰ΩøÁî®Ëøô‰∏™bottom-up treeÔºåËá™È°∂Âêë‰∏ãÊûÑÂª∫‰∏Ä‰∏™DILIÊ†ë„ÄÇDILIÂú®the number of leaf nodesÂíåtree height‰πãÈó¥Êúâ‰∏Ä‰∏™ÂæàÂ•ΩÁöÑÂπ≥Ë°°Ôºàthe number of leaf nodes Âíå tree heightÊòØÂΩ±ÂìçkeyÊêúÁ¥¢Êó∂Èó¥ÁöÑÂÖ≥ÈîÆÂõ†Á¥†Ôºâ„ÄÇËÆæËÆ°‰∫ÜÁÅµÊ¥ªÁöÑÊèíÂÖ•ÂíåÂà†Èô§ÁÆóÊ≥ïÔºåÂπ∂Âú®ÂøÖË¶ÅÊó∂Ë∞ÉÊï¥Ê†ëÂΩ¢ÁªìÊûÑ„ÄÇ</p>
<p>ÂÆûÈ™åÁªìÊûúË°®ÊòéDILIÊØîÂÖ∂ÂÆÉbaselineÂú®‰∏çÂêåÁöÑworkloads‰∏äË¶ÅË°®Áé∞ÁöÑÊõ¥Â•Ω„ÄÇ</p>
<h3 id="1-INTRODUCTION"><a href="#1-INTRODUCTION" class="headerlink" title="1.INTRODUCTION"></a>1.INTRODUCTION<br></h3><p>RMIÔºö‰ªÖÊîØÊåÅÊü•Êâæ<br><br>ALEXÔºöÊâ©Â±ïRMIÔºåÂú®leaf node‰∏≠‰ΩøÁî® gapped arrayÔºå‰ΩøÁî® cost modelÂàùÂßãÂåñRMIÁªìÊûÑÂíåÂä®ÊÄÅÊõ¥Êñ∞RMIÁªìÊûÑ„ÄÇÂ≠òÂú®last-mileÈóÆÈ¢ò<br><br>LIPPÔºöËß£ÂÜ≥last-mileÈóÆÈ¢òÔºå‰ΩÜÊòØÊ≤°ÊúâÂà©Áî®data distribution<br><br>DILI-LOÔºöÊú™Ëß£ÂÜ≥last-mileÈóÆÈ¢òÔºåÂà©Áî®data distribution<br><br>DILIÔºöËß£ÂÜ≥last-mileÈóÆÈ¢òÔºåÂà©Áî®data distribution<br></p>
<p>ÊûÑÂª∫DILIÁöÑÁõÆÁöÑÊòØÂÆûÁé∞ÊúÄÂ•ΩÁöÑÊêúÁ¥¢ÊÄßËÉΩ ‚Äî&gt; ÊêúÁ¥¢ÁöÑÂºÄÈîÄÂèñÂÜ≥‰∫é(1)leaf nodeÁöÑÊ∑±Â∫¶(2)leaf  node‰∏≠ÁöÑlinear modelÈ¢ÑÊµãÁöÑaccuracy ‚Äî&gt; Ëøô‰∏§‰∏™factorsÈÉΩÂ∫îËØ•Âú®DILIÁöÑÊûÑÂª∫‰∏≠Ë¢´ËÄÉËôë</p>
<p>Âõ†Ê≠§ÔºåÊèêÂá∫‰∫Ü‰∏Ä‰∏™two-phase bulk loading ÊñπÊ≥ï<br><br><strong>Phase1</strong> -&gt; ‰ΩøÁî®greedy merging algorithmÔºàËÄÉËôëÂà∞‰∫Ü‰∏äÈù¢ÁöÑ‰∏§‰∏™factorsÔºâ ÊûÑÂª∫‰∏ÄÊ£µBU-treeÔºàBU-treeÁöÑinternal node‚ÄôsrangeÂπ∂‰∏çÊòØË¢´ÂÆÉÁöÑchild nodesÂùáÂàÜÁöÑÔºåÂõ†Ê≠§Âú®BU-treeËøõË°åkeyÊêúÁ¥¢Êó∂ÔºåÁ°ÆÂÆöchild nodeÈúÄË¶ÅÈ¢ùÂ§ñÁöÑÂºÄÈîÄÔºâ</p>
<p><strong>Phase2</strong> -&gt;  ÂÄüÈâ¥BU-treeÁöÑÁªìÊûÑÊûÑÂª∫DILI</p>
<h4 id="Contribution"><a href="#Contribution" class="headerlink" title="Contribution"></a>Contribution</h4><ul>
<li>ÊèêÂá∫DILIÔºåalgorithms ÂíåÂÆÉÁöÑcost analysis</li>
<li>ÊûÑÂª∫DILIÁöÑtwo-phase bulk loading ÊñπÊ≥ï</li>
<li>ÂØπDILIÁöÑleaf nodeÁöÑlocal optimizationÔºåËß£ÂÜ≥last-mileÈóÆÈ¢ò</li>
<li>ÂØπ‰∫éDILIÁöÑinsertionÂíådeletionÊìç‰ΩúÊèêÂá∫Áõ∏Â∫îÁöÑalgorithmÊù•Áª¥ÊåÅÊü•ÊâæÊÄßËÉΩ</li>
<li>Âú®synthetic dataÂíåreal data‰∏äËØÅÂÆûDILIÁöÑÊÄßËÉΩ</li>
</ul>
<h3 id="2-OVERVIEW-OF-DILI"><a href="#2-OVERVIEW-OF-DILI" class="headerlink" title="2.OVERVIEW OF DILI"></a>2.OVERVIEW OF DILI</h3><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/1.png" alt="img"><br>DILIÁöÑÁªìÊûÑÂ¶ÇFigure 1ÊâÄÁ§∫<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/2.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/3.png" alt="img"><br>DILIÂú®Ê≤°Êúâ‰ΩøÁî®local OptimizationÁöÑÊó∂ÂÄôSEARCHÁÆóÊ≥ïÂ¶Ç‰∏ãÔºåÊü•ÊâækeyÊó∂ÔºåÈîÅÂÆö‰∫Üleaf nodeÂêéÈúÄË¶ÅÂÜçËøõË°åÊåáÊï∞Êü•ÊâæÊù•Á°ÆÂÆöposition„ÄÇ<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/4.png" alt="img"></p>
<h4 id="Local-Optimization-strategy"><a href="#Local-Optimization-strategy" class="headerlink" title="Local Optimization strategy"></a>Local Optimization strategy</h4><p>Âú®leaf node‰∏≠ÔºåÂÖàÁî®Á∫øÊÄßÊ®°ÂûãÈ¢ÑÊµãkeyÁöÑpositionÔºå‰πãÂêéÁõ¥Êé•Â∞ÜkeyÊîæÂà∞È¢ÑÊµãÁöÑposition‰∏äÔºåÂ¶ÇÊûúÂèëÁîüÂÜ≤Á™ÅÔºåÂ∞±ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑnodeÔºåÂØπÂ∫îÁöÑentryËÆæÁΩÆ‰∏∫ÊåáÂêëÊñ∞nodeÁöÑÊåáÈíà</p>
<h4 id="Updates"><a href="#Updates" class="headerlink" title="Updates"></a>Updates</h4><p>ÂΩìÂØπDILIÊèíÂÖ•Êï∞ÊçÆÊó∂ÔºåÂ¶ÇÊûúÂèëÁîüconflictÔºå‰ºöÂàõÂª∫Êñ∞ÁöÑNodeÔºåÂΩìÂàõÂª∫ÁöÑÊñ∞NodeËøáÂ§öÂπ∂‰∏îÈÄÄÂåñ‰∫ÜÊü•ÊâæÊÄßËÉΩÊó∂ÔºåÈúÄË¶ÅËøõË°åË∞ÉÊï¥Á≠ñÁï•ÔºàÂú®section6‰ºöËØ¶ÁªÜÊèèËø∞Ôºâ</p>
<h3 id="3-SEARCH-COST-ANALYSIS"><a href="#3-SEARCH-COST-ANALYSIS" class="headerlink" title="3.SEARCH COST ANALYSIS"></a>3.SEARCH COST ANALYSIS</h3><p>Cost Analysis:<br>Êú™‰ΩøÁî®local optimization strategy<br>Algorithm1Áî±‰∏§Ê≠•ÁªÑÊàê(1)ÊâæÂà∞ÂåÖÂê´search keyÁöÑleaf node (2)leaf node‰∏≠ÁöÑlocal search<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/5.png" alt="img"></p>
<h3 id="4-CONSTRUCTION-OF-DILI"><a href="#4-CONSTRUCTION-OF-DILI" class="headerlink" title="4.CONSTRUCTION OF DILI"></a>4.CONSTRUCTION OF DILI</h3><h4 id="4-1Motivation-and-Overall-Idea-of-BU-Tree"><a href="#4-1Motivation-and-Overall-Idea-of-BU-Tree" class="headerlink" title="4.1Motivation and Overall Idea of BU-Tree"></a>4.1Motivation and Overall Idea of BU-Tree</h4><p>DILIÁöÑinternal nodeÁöÑÁ∫øÊÄßÊ®°ÂûãÊúâÁùÄÂÆåÁæéÁöÑÂáÜÁ°ÆÊÄßÔºåÂõ†‰∏∫internal nodeË¢´ÂÆÉÁöÑchild nodesÂùáÂàÜ„ÄÇ‚Äî-&gt; Áé∞Âú®Êúâ‰∏Ä‰∏™ÈóÆÈ¢òÔºåÂ¶Ç‰ΩïÁ°ÆÂÆöDILIÁöÑfanout</p>
<p>Â§ßËá¥ÊÄùË∑ØÔºö<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/6.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/7.png" alt="img"></p>
<h4 id="4-2-Building-BU-Tree"><a href="#4-2-Building-BU-Tree" class="headerlink" title="4.2 Building BU-Tree"></a>4.2 Building BU-Tree</h4><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/8.png" alt="img"></p>
<h5 id="4-2-1-Bottom-up-Node-and-Model-Creation"><a href="#4-2-1-Bottom-up-Node-and-Model-Creation" class="headerlink" title="4.2.1 Bottom-up Node and Model Creation"></a>4.2.1 Bottom-up Node and Model Creation</h5><p>ÊûÑÂª∫Á¨¨0Â±ÇÁöÑleaf node<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/9.png" alt="img"><br>Â∑≤Áü•h - 1Â±ÇÁöÑinternal node,ÊûÑÂª∫Á¨¨hÂ±ÇÁöÑinternal node<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/10.png" alt="img"></p>
<h5 id="4-2-2-Determining-Node-Layout-at-A-Height"><a href="#4-2-2-Determining-Node-Layout-at-A-Height" class="headerlink" title="4.2.2 Determining Node Layout at A Height"></a>4.2.2 Determining Node Layout at A Height</h5><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/11.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/12.png" alt="img"></p>
<p>‰ΩÜÊòØBU-TreeÊòØ‰ªé‰∏ãÂæÄ‰∏äÂàõÂª∫ÁöÑÔºåÂç≥‰ΩøÂàõÂª∫‰∫ÜÁ¨¨hÂ±ÇÁöÑnodeÔºåÊàë‰ª¨‰πü‰∏çÁü•ÈÅìBU-TreeÁöÑÈ´òÂ∫¶</p>
<p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/13.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/14.png" alt="img"></p>
<h4 id="4-3-BU-Tree-based-Bulk-loading-for-DILI"><a href="#4-3-BU-Tree-based-Bulk-loading-for-DILI" class="headerlink" title="4.3 BU-Tree based Bulk loading for DILI"></a>4.3 BU-Tree based Bulk loading for DILI</h4><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/15.png" alt="img"></p>
<h4 id="4-4-Remarks"><a href="#4-4-Remarks" class="headerlink" title="4.4 Remarks"></a>4.4 Remarks</h4><p>Skip ‚Ä¶‚Ä¶</p>
<h3 id="5-LOCAL-OPTIMIZATION-OF-DILI"><a href="#5-LOCAL-OPTIMIZATION-OF-DILI" class="headerlink" title="5. LOCAL OPTIMIZATION OF DILI"></a>5. LOCAL OPTIMIZATION OF DILI</h3><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/16.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/17.png" alt="img"><br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/18.png" alt="img"></p>
<h3 id="6-DATA-UPDATES-IN-DILI"><a href="#6-DATA-UPDATES-IN-DILI" class="headerlink" title="6. DATA UPDATES IN DILI"></a>6. DATA UPDATES IN DILI</h3><h4 id="6-1-Insertions"><a href="#6-1-Insertions" class="headerlink" title="6.1 Insertions"></a>6.1 Insertions</h4><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/19.png" alt="img"><br>P existsÊ†áÊ≥®ÁöÑÂú∞ÊñπÈîôËØØ		Â∫îËÆæÁΩÆ‰∏∫notExist  &lt;‚Äî  False</p>
<h4 id="6-2-Deletions"><a href="#6-2-Deletions" class="headerlink" title="6.2 Deletions"></a>6.2 Deletions</h4><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/20.png" alt="img"></p>
<h3 id="7-EXPERIMENTAL-STUDIES"><a href="#7-EXPERIMENTAL-STUDIES" class="headerlink" title="7.EXPERIMENTAL STUDIES"></a>7.EXPERIMENTAL STUDIES</h3><h4 id="7-1-Experimental-Settings"><a href="#7-1-Experimental-Settings" class="headerlink" title="7.1 Experimental Settings"></a>7.1 Experimental Settings</h4><p>Êï∞ÊçÆÈõÜÔºö‰ΩøÁî®‰∫ÜSOSD benchmark‰∏≠ÁöÑ4‰∏™ÁúüÂÆûÊï∞ÊçÆÈõÜ Âíå 1 ‰∏™ÂêàÊàêÊï∞ÊçÆÈõÜ</p>
<ul>
<li>FB : 200M Facebook Áî®Êà∑id</li>
<li>WikiTS : 200M Áª¥Âü∫ÁôæÁßëÁΩëÁ´ôÊó•ÂøóÊù°ÁõÆÁöÑÂîØ‰∏ÄËØ∑Ê±ÇÊó∂Èó¥Êà≥</li>
<li>OSM :  800M OpenStreetMapÂçïÂÖÉÊ†ºÁöÑid</li>
<li>Books : 800M AmazonÁöÑbooksÁöÑid</li>
<li>Logn : 200M ‰ªéÈáçÂ∞æÈááÊ†∑ÁöÑÁã¨ÁâπÂÄº N(0Ôºå 1) ÁöÑÂØπÊï∞Ê≠£ÊÄÅÂàÜÂ∏É</li>
</ul>
<p>ÊØîËæÉÁöÑbaselines:<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/21.png" alt="img"></p>
<p>Table 2 ÊÄªÁªì‰∫ÜÊâÄÊúâindexÁöÑÂ±ûÊÄßÁâπÁÇπÔºåÊõ¥Â•ΩÁöÑË°®Áé∞Ë¢´Âä†Á≤ó‰∫Ü<br><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/22.png" alt="img"></p>
<p>Evaluation Metrics : <br><br>Lookup ‚Äî&gt; Âπ≥ÂùáÊØèÊ¨°queryÊâÄÁî®ÁöÑÊó∂Èó¥ <br><br>Throughtput ‚Äî&gt; Âπ≥ÂùáÊØèsecondÊâßË°åÁöÑoperationsÁöÑÊ¨°Êï∞Ôºàquery„ÄÅinsertion„ÄÅdeletionÔºâ<br></p>
<h4 id="7-2-Overall-Query-Performance"><a href="#7-2-Overall-Query-Performance" class="headerlink" title="7.2 Overall Query Performance"></a>7.2 Overall Query Performance</h4><p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/23.png" alt="img"></p>
<p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/24.png" alt="img"></p>
<h4 id="7-3-Performance-on-Different-Workloads"><a href="#7-3-Performance-on-Different-Workloads" class="headerlink" title="7.3 Performance on Different Workloads"></a>7.3 Performance on Different Workloads</h4><p>(1)The Read-only workload: 100M point queries <br><br>(2)The Read-Heavy workload: 50M insertions and 100M point queries <br><br>(3)The Write-Heavy workload: 100M insertions and 50M point queries <br><br>(4)The Write-only workload: 100M insertions <br></p>
<p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/25.png" alt="img"></p>
<h4 id="7-4-Effect-of-Many-Deletions"><a href="#7-4-Effect-of-Many-Deletions" class="headerlink" title="7.4 Effect of Many Deletions"></a>7.4 Effect of Many Deletions</h4><p>(1)Read-Heavy workload : 100M lookups and 50M deletions<br>DILI achieves up to 3.6X, 2.3X, 7.0X and 2.3X higher throughput than B+ Tree,PGM,MassTree and ALEX,respectively.</p>
<p>(2)Deletion-Heavy workload : 100M deletions and 50M lookups<br>Only ALEX performs a little better than DILI on Logn dataset</p>
<p><img src="/../images/DILI%E8%AE%BA%E6%96%87%E9%87%8D%E7%82%B9%E9%83%A8%E5%88%86/26.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/03/16/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/16/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" class="post-title-link" itemprop="url">Â∏ÉÈöÜËøáÊª§Âô®</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-16 02:55:19" itemprop="dateCreated datePublished" datetime="2024-03-16T02:55:19-07:00">2024-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-02 05:03:05" itemprop="dateModified" datetime="2024-04-02T05:03:05-07:00">2024-04-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">Â∏ÉÈöÜËøáÊª§Âô®</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="‰ΩúÁî®"><a href="#‰ΩúÁî®" class="headerlink" title="‰ΩúÁî®"></a>‰ΩúÁî®</h3><p>Êü•ÊâæÊó∂ÔºåËøáÊª§Êéâ‰∏ÄÂÆö‰∏çÂ≠òÂú®ÁöÑkeyÔºåÊèêÈ´òÊü•ÊâæÊïàÁéá</p>
<h3 id="ÁÆÄ‰ªã"><a href="#ÁÆÄ‰ªã" class="headerlink" title="ÁÆÄ‰ªã"></a>ÁÆÄ‰ªã</h3><p>Âú®Êï∞ÁªÑÊàñËÄÖÂàóË°®‰∏≠ÊêúÁ¥¢Áõ∏Â∫îÂÄºÁöÑÊó∂ÂÄôÔºå‰Ω†ÂøÖÈ°ªÈÅçÂéÜÂ∑≤ÊúâÁöÑÈõÜÂêà„ÄÇËã•ÈõÜÂêà‰∏≠Â≠òÂú®Â§ßÈáèÁöÑÊï∞ÊçÆÔºåÂ∞±‰ºöÂΩ±ÂìçÊü•ÊâæÁöÑÊïàÁéá</p>
<p>ÈíàÂØπËøô‰∏™ÈóÆÈ¢òÔºåÂèØ‰ª•ËÄÉËôë‰ΩøÁî®ÂìàÂ∏åË°®ÔºåÂà©Áî®ÂìàÂ∏åË°®Êù•ÂØπ‚ÄùÂÄº‚ÄùËøõË°åÂìàÂ∏åÂ§ÑÁêÜÊù•Ëé∑ÂæóËØ•ÂÄºÂØπÂ∫îÁöÑÁ¥¢ÂºïÂÄºÔºåÁÑ∂ÂêéÂ∞ÜËØ•‚ÄùÂÄº‚ÄùÂ≠òÊîæÂà∞ÂàóË°®‰∏≠ÂØπÂ∫îÁöÑÁ¥¢Âºï‰ΩçÁΩÆ„ÄÇ<br>ËøôÊÑèÂë≥ÁùÄÂà§Êñ≠ÂàóË°®‰∏≠ÊòØÂê¶Â≠òÂú®ËØ•ÂÄºÊó∂ÔºåÂè™ÈúÄË¶ÅÂØπÂÄºËøõË°åÂìàÂ∏åÂ§ÑÁêÜÂπ∂Âú®Áõ∏Â∫îÁöÑÁ¥¢Âºï‰ΩçÁΩÆËøõË°åÊêúÁ¥¢Âç≥ÂèØÔºåËøôÊó∂ÁöÑÊêúÁ¥¢ÈÄüÂ∫¶ÊòØÈùûÂ∏∏Âø´ÁöÑ„ÄÇ</p>
<p><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/1.png" alt="img"></p>
<p>Bloom FilterÊú¨Ë¥®‰∏äÊòØÁî±ÈïøÂ∫¶‰∏∫mÁöÑ‰ΩçÂêëÈáèÔºà‰ªÖÂåÖÂê´0ÊàñËÄÖ1ÔºâÁªÑÊàêÔºåÊúÄÂàùÊâÄÊúâÂÄºÂùáËÆæÁΩÆ‰∏∫0ÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫Ôºö<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/2.png" alt="img"></p>
<p>‰∏∫‰∫ÜÂ∞ÜÊï∞ÊçÆÈ°πÊ∑ªÂä†Âà∞Â∏ÉÈöÜËøáÊª§Âô®‰∏≠Ôºå‰ΩøÁî®k‰∏™‰∏çÂêåÁöÑÂìàÂ∏åÂáΩÊï∞ÂØπÂÖ∂ËøõË°åÂìàÂ∏åÔºåÂπ∂Â∞ÜÁªìÊûú‰ΩçÁΩÆ‰∏äÂØπÂ∫î‰ΩçÁΩÆ‰∏∫1</p>
<h3 id="ÁÆÄÂçïÁöÑ‰æãÂ≠ê"><a href="#ÁÆÄÂçïÁöÑ‰æãÂ≠ê" class="headerlink" title="ÁÆÄÂçïÁöÑ‰æãÂ≠ê"></a>ÁÆÄÂçïÁöÑ‰æãÂ≠ê</h3><p>ËæìÂÖ•‚Äùsemlinker‚ÄùÔºåÈ¢ÑËÆæÁöÑ3‰∏™ÂìàÂ∏åÂáΩÊï∞Â∞ÜËæìÂá∫2„ÄÅ4„ÄÅ6,Êàë‰ª¨ÊääÁõ∏Â∫î‰ΩçÁΩÆ‰∏∫1<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/3.png" alt="img"><br>ÂÜçËæìÂÖ•‚Äùkakuqo‚ÄùÔºåÂìàÂ∏åÂáΩÊï∞ËæìÂá∫3„ÄÅ4„ÄÅ7,ÊääÂØπÂ∫î‰ΩçÁΩÆ‰∏∫1<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/4.png" alt="img"><br>ÂÜçËæìÂÖ•‚Äùfullstack‚Äù,ÂìàÂ∏åÂáΩÊï∞ËæìÂá∫2„ÄÅ3„ÄÅ7ÔºåËøôÊó∂ÂèëÁé∞Áõ∏Â∫îÁöÑÁ¥¢Âºï‰ΩçÈÉΩÂ∑≤ÁªèÁΩÆ‰∏∫‰∫Ü1ÔºåËøôÊÑèÂë≥ÁùÄÊàë‰ª¨ÂèØ‰ª•ËØ¥‚Äùfullstack‚ÄùÂèØËÉΩÂ∑≤ÁªèÊèíÂÖ•Âà∞ÈõÜÂêà‰∏≠„ÄÇËøôÊòØ‰∏ÄÁßçËØØÂà§ÊÉÖÂÜµ<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/5.png" alt="img"></p>
<p>Â∏ÉÈöÜËøáÊª§Âô®Êúâ‰∏Ä‰∏™ÂèØÈ¢ÑÊµãÁöÑËØØÂà§Áéá(FPP):<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/6.png" alt="img"></p>
<ul>
<li>nÊòØÂ∑≤ÁªèÊ∑ªÂä†ÂÖÉÁ¥†ÁöÑÊï∞Èáè</li>
<li>kÊòØÂìàÂ∏åÁöÑÊ¨°Êï∞</li>
<li>m‰∏∫Â∏ÉÈöÜËøáÊª§Âô®ÁöÑÈïøÂ∫¶(Â¶ÇÊØîÁâπÊï∞ÁªÑÁöÑÂ§ßÂ∞è)</li>
</ul>
<p>ÂÆûÈôÖÊÉÖÂÜµ‰∏≠ÔºåÂ∏ÉÈöÜËøáÊª§Âô®ÁöÑÈïøÂ∫¶mÂèØ‰ª•Ê†πÊçÆËØØÂà§Áéá(FFP)ÁöÑÂíåÊúüÊúõÊ∑ªÂä†ÁöÑÂÖÉÁ¥†‰∏™Êï∞nÁöÑÈÄöËøáÂ¶Ç‰∏ãÂÖ¨ÂºèËÆ°ÁÆó:<br><img src="/../images/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/7.png" alt="img"></p>
<blockquote>
<p>Âõ†Ê≠§ÔºåÊàë‰ª¨ÂæóÂá∫‰∏Ä‰∏™ÁªìËÆ∫ÔºåÂΩìÊàë‰ª¨ÊêúÁ¥¢‰∏Ä‰∏™ÂÄºÁöÑÊó∂ÂÄôÔºåËã•ËØ•ÂÄºÁªèËøák‰∏™ÂìàÂ∏åÂáΩÊï∞ËøêÁÆóÂêé‰ªª‰Ωï‰∏Ä‰∏™Á¥¢Âºï‰Ωç‰∏∫0ÔºåÈÇ£‰πàËØ•ÂÄºËÇØÂÆö‰∏çÂú®ÈõÜÂêà‰∏≠„ÄÇ‰ΩÜÂ¶ÇÊûúÊâÄÊúâÂìàÂ∏åÁ¥¢ÂºïÂÄºÂùá‰∏∫1ÔºåÂàôÂè™ËÉΩËØ¥ËØ•ÊêúÁ¥¢ÁöÑÂÄºÂèØËÉΩÂ≠òÂú®ÈõÜÂêà‰∏≠</p>
</blockquote>
<h3 id="Â∫îÁî®"><a href="#Â∫îÁî®" class="headerlink" title="Â∫îÁî®"></a>Â∫îÁî®</h3><p>Âú®ÂÆûÈôÖÂ∑•‰Ωú‰∏≠ÔºåÂ∏ÉÈöÜËøáÊª§Âô®Â∏∏ËßÅÁöÑÂ∫îÁî®Âú∫ÊôØÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>ÁΩëÈ°µÁà¨Ëô´ÂØπ URL ÂéªÈáçÔºåÈÅøÂÖçÁà¨ÂèñÁõ∏ÂêåÁöÑ URL Âú∞ÂùÄÔºõ</li>
<li>ÂèçÂûÉÂúæÈÇÆ‰ª∂Ôºå‰ªéÊï∞ÂçÅ‰∫ø‰∏™ÂûÉÂúæÈÇÆ‰ª∂ÂàóË°®‰∏≠Âà§Êñ≠ÊüêÈÇÆÁÆ±ÊòØÂê¶ÂûÉÂúæÈÇÆÁÆ±Ôºõ</li>
<li>Google Chrome ‰ΩøÁî®Â∏ÉÈöÜËøáÊª§Âô®ËØÜÂà´ÊÅ∂ÊÑè URLÔºõ</li>
<li>Medium ‰ΩøÁî®Â∏ÉÈöÜËøáÊª§Âô®ÈÅøÂÖçÊé®ËçêÁªôÁî®Êà∑Â∑≤ÁªèËØªËøáÁöÑÊñáÁ´†Ôºõ</li>
<li>Google BigTableÔºåApache HBbase Âíå Apache Cassandra ‰ΩøÁî®Â∏ÉÈöÜËøáÊª§Âô®ÂáèÂ∞ëÂØπ‰∏çÂ≠òÂú®ÁöÑË°åÂíåÂàóÁöÑÊü•Êâæ</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/03/04/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/04/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/" class="post-title-link" itemprop="url">GRE‰ΩøÁî®ÊâãÂÜå</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-03-04 06:02:31 / Modified: 07:12:51" itemprop="dateCreated datePublished" datetime="2024-03-04T06:02:31-08:00">2024-03-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Learned-Index/" itemprop="url" rel="index"><span itemprop="name">Learned Index</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="‰∏ãËΩΩÂÆòÁΩëÂú∞ÂùÄ"><a href="#‰∏ãËΩΩÂÆòÁΩëÂú∞ÂùÄ" class="headerlink" title="‰∏ãËΩΩÂÆòÁΩëÂú∞ÂùÄ:"></a>‰∏ãËΩΩÂÆòÁΩëÂú∞ÂùÄ:<br></h2><p><a target="_blank" rel="noopener" href="https://github.com/jingtao8a/GRE">https://github.com/jingtao8a/GRE</a></p>
<h2 id="ËΩØ‰ª∂ÁéØÂ¢É"><a href="#ËΩØ‰ª∂ÁéØÂ¢É" class="headerlink" title="ËΩØ‰ª∂ÁéØÂ¢É"></a>ËΩØ‰ª∂ÁéØÂ¢É</h2><p>Ubuntu 20.04.6 LTS<br><br>gcc 9.4.0<br><br>cmake 3.16.3</p>
<h2 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h2><h3 id="intel-mkl-2018-4-274"><a href="#intel-mkl-2018-4-274" class="headerlink" title="intel-mkl 2018.4.274"></a>intel-mkl 2018.4.274<br></h3><p>ËøôÈáåÂÆâË£Ö2024ÁöÑÁâàÊú¨‰πüÂèØ‰ª•<br><br>ËøõÂÖ•ÂÆòÁΩë <a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl-download.html">https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl-download.html</a><br></p>
<p>ÈÄâÊã©Linux Âíå APT Package Manager<br><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/3.png" alt="img"><br>‰æùÊ¨°ËæìÂÖ•ÂëΩ‰ª§<br><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/1.png" alt="img"><br><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/2.png" alt="img"></p>
<p>ÈªòËÆ§ÂÆâË£ÖË∑ØÂæÑÂ¶Ç‰∏ãÔºö<br><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/4.png" alt="img"></p>
<p>‰ΩøÁî®mklÂ∫ìÈúÄË¶ÅÈÖçÁΩÆÁéØÂ¢ÉÂèòÈáèÔºö<br></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ÂØπÊâÄÊúâÁî®Êà∑ÁîüÊïàÔºåÈúÄË¶ÅÈáçÂêØÁ≥ªÁªü</span><br><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure>
<p><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/5.png" alt="img"></p>
<h3 id="intel-tbb-2020-3"><a href="#intel-tbb-2020-3" class="headerlink" title="intel-tbb 2020.3"></a>intel-tbb 2020.3<br></h3><p>tbbÂ∫ìÁöÑÁâàÊú¨ÂøÖÈ°ª‰ΩøÁî®2020.3<br><br>‰∏ãËΩΩÂú∞ÂùÄ<a target="_blank" rel="noopener" href="https://github.com/oneapi-src/oneTBB/releases/tag/2020_U3">https://github.com/oneapi-src/oneTBB/releases/tag/2020_U3</a></p>
<h4 id="ÁºñËØë"><a href="#ÁºñËØë" class="headerlink" title="ÁºñËØë"></a>ÁºñËØë</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ëß£Âéã</span></span><br><span class="line">tar -zxvf oneTBB-2020_U3.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Âõ†‰∏∫Ë¶Å‰ΩøÁî® gcc-9 ËøõË°åÁºñËØëÔºåÊâÄ‰ª•ÈúÄË¶ÅÁºñËæëÊàê gcc-9 ÂΩ¢Âºè</span></span><br><span class="line">cp build/linux.gcc.inc build/linux.gcc-9.inc </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ÁºñËæë linux.gcc-9.inc Êñá‰ª∂Ôºö</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Á¨¨15„ÄÅ16Ë°åÂéüÊù•ÊòØ</span></span><br><span class="line">CPLUS ?= g++</span><br><span class="line">CONLY ?= gcc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">‰øÆÊîπ‰∏∫</span></span><br><span class="line">CPLUS ?= g++-9</span><br><span class="line">CONLY ?= gcc-9</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ÁÑ∂ÂêéÂú®Êñá‰ª∂Â§π oneTBB-2020_U3/ ‰∏≠ÁºñËØë</span></span><br><span class="line">cd oneTBB-2020_U3</span><br><span class="line">make compiler=gcc-9 stdver=c++17 tbb_build_prefix=my_tbb_build</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ÁºñËØëÂÆåÊàêÂêéÔºåÂú® builld/ Êñá‰ª∂Â§π‰∏ã‰ºöÁúãÂà∞ÁºñËØëÁîüÊàêÁöÑÊñá‰ª∂Â§π my_tbb_build_release/</span></span><br></pre></td></tr></table></figure>

<h4 id="ÂÆâË£Ö"><a href="#ÂÆâË£Ö" class="headerlink" title="ÂÆâË£Ö"></a>ÂÆâË£Ö</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /usr/local/tbb-2020_U3</span><br><span class="line"></span><br><span class="line">sudo cp -r oneTBB-2020_U3/include /usr/local/tbb-2020_U3/include</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Âª∫Á´ãÊñ∞ÂÆâË£ÖtbbÁâàÊú¨ÁöÑÁ¨¶Âè∑ÈìæÊé•</span></span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/include/tbb /usr/local/include/tbb</span><br><span class="line"></span><br><span class="line">sudo cp -r oneTBB-2020_U3/build/my_tbb_build_release /usr/local/tbb-2020_U3/lib</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Âª∫Á´ãÊñ∞ÂÆâË£ÖtbbÁâàÊú¨ÁöÑÁ¨¶Âè∑ÈìæÊé•</span></span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbb.so.2 /usr/local/lib/libtbb.so</span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbb.so.2 /usr/local/lib/libtbb.so2</span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbbmalloc.so.2 /usr/local/lib/libtbbmalloc.so</span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbbmalloc.so.2 /usr/local/lib/libtbbmalloc.so2</span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbbmalloc_proxy.so.2 /usr/local/lib/libtbbmalloc_proxy.so</span><br><span class="line">sudo ln -s /usr/local/tbb-2020_U3/lib/libtbbmalloc_proxy.so.2 /usr/local/lib/libtbbmalloc_proxy.so2</span><br></pre></td></tr></table></figure>

<p>ÁÑ∂ÂêéÊää Â∫ìÊñá‰ª∂ÁöÑË∑ØÂæÑÂÜôÂÖ•Âà∞ ~&#x2F;.bashrcÔºö</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;export LD_LIBRARY_PATH=/usr/local/tbb-2020_U3/lib:$LD_LIBRARY_PATH&#x27; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>ÂèÇËÄÉÈìæÊé•: <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39779233/article/details/126284595">https://blog.csdn.net/qq_39779233&#x2F;article&#x2F;details&#x2F;126284595</a></p>
<h3 id="jemalloc"><a href="#jemalloc" class="headerlink" title="jemalloc"></a>jemalloc</h3><p>‰∏ãËΩΩÂú∞ÂùÄ: <a target="_blank" rel="noopener" href="https://github.com/jemalloc/jemalloc/releases">https://github.com/jemalloc/jemalloc/releases</a></p>
<h4 id="ÁºñËØë‰∏éÂÆâË£Ö"><a href="#ÁºñËØë‰∏éÂÆâË£Ö" class="headerlink" title="ÁºñËØë‰∏éÂÆâË£Ö"></a>ÁºñËØë‰∏éÂÆâË£Ö</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">step 1</span></span><br><span class="line">./autogen.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">step 2</span></span><br><span class="line">make</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">step 3</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>ÂèÇËÄÉÈìæÊé•: <a target="_blank" rel="noopener" href="https://blog.csdn.net/SweeNeil/article/details/94648313">https://blog.csdn.net/SweeNeil/article/details/94648313</a></p>
<h2 id="USAGE"><a href="#USAGE" class="headerlink" title="USAGE"></a>USAGE</h2><h3 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git submodule update --init # only for the first time</span><br><span class="line">mkdir -p build</span><br><span class="line">cd build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=Release .. &amp;&amp; make</span><br></pre></td></tr></table></figure>
<h3 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./build/microbench \</span><br><span class="line">--keys_file=./data/dataset \  // Êï∞ÊçÆÂú∞ÂùÄ</span><br><span class="line">--keys_file_type=&#123;binary,text&#125; \  // ‰∫åËøõÂà∂ ÊàñËÄÖ ÊñáÊú¨</span><br><span class="line">--read=0.5 --insert=0.5 \ </span><br><span class="line">--operations_num=800000000 \ </span><br><span class="line">--table_size=-1 \ // ÊâÄ‰ΩøÁî®ÁöÑÊï∞ÊçÆÁöÑsize</span><br><span class="line">--init_table_ratio=0.5 \ //bulk_loadÊâÄ‰ΩøÁî®ÁöÑÊï∞ÊçÆÁöÑÁôæÂàÜÊØî</span><br><span class="line">--thread_num=24 \</span><br><span class="line">--index=index_name \ //ÊµãËØïÁöÑÁ¥¢ÂºïÂêçÁß∞</span><br></pre></td></tr></table></figure>

<p>ÂÖ∂ÂÆÉÂèÇÊï∞ËßÅÂÆòÁΩë:<br><a target="_blank" rel="noopener" href="https://github.com/jingtao8a/GRE">https://github.com/jingtao8a/GRE</a></p>
<h3 id="Â¶ÇÊûúË¶ÅÊµãËØïÊñ∞ÁöÑÁ¥¢ÂºïÁªìÊûÑ"><a href="#Â¶ÇÊûúË¶ÅÊµãËØïÊñ∞ÁöÑÁ¥¢ÂºïÁªìÊûÑ" class="headerlink" title="Â¶ÇÊûúË¶ÅÊµãËØïÊñ∞ÁöÑÁ¥¢ÂºïÁªìÊûÑ"></a>Â¶ÇÊûúË¶ÅÊµãËØïÊñ∞ÁöÑÁ¥¢ÂºïÁªìÊûÑ</h3><h4 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h4><p>src&#x2F;competitor&#x2F;competitor.h<br>get_indexÂáΩÊï∞‰∏≠Ê∑ªÂä†ÂØπÂ∫îÁöÑindex_type<br><img src="/../images/GRE%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C/6.png" alt="img"></p>
<h4 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h4><p>Âú® src&#x2F;competitor ‰∏ãÊîæÁΩÆÊ∫ê‰ª£Á†Å new_index_name&#x2F;src<br>ÁºñÂÜôÊé•Âè£Êñá‰ª∂ src&#x2F;competitor&#x2F;new_index_name.h</p>
<p>‰ª•lippÁöÑÊé•Âè£Êñá‰ª∂‰∏∫‰æãÔºö</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;./src/src/core/lipp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&quot;../indexInterface.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LIPPInterface</span> : <span class="keyword">public</span> indexInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(Param *param = <span class="literal">nullptr</span>)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">bulk_load</span><span class="params">(std::pair &lt;KEY_TYPE, PAYLOAD_TYPE&gt; *key_value, <span class="type">size_t</span> num, Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">get</span><span class="params">(KEY_TYPE key, PAYLOAD_TYPE &amp;val, Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">put</span><span class="params">(KEY_TYPE key, PAYLOAD_TYPE value, Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">update</span><span class="params">(KEY_TYPE key, PAYLOAD_TYPE value, Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">remove</span><span class="params">(KEY_TYPE key, Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">scan</span><span class="params">(KEY_TYPE key_low_bound, <span class="type">size_t</span> key_num, std::pair &lt;KEY_TYPE, PAYLOAD_TYPE&gt; *result,</span></span></span><br><span class="line"><span class="params"><span class="function">                Param *param = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">long</span> <span class="type">long</span> <span class="title">memory_consumption</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> lipp.<span class="built_in">total_size</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    LIPP &lt;KEY_TYPE, PAYLOAD_TYPE&gt; lipp;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">void</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">bulk_load</span>(std::pair &lt;KEY_TYPE, PAYLOAD_TYPE&gt; *key_value, <span class="type">size_t</span> num,</span><br><span class="line">                                                      Param *param) &#123;</span><br><span class="line">    lipp.<span class="built_in">bulk_load</span>(key_value, <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(num));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">bool</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">get</span>(KEY_TYPE key, PAYLOAD_TYPE &amp;val, Param *param) &#123;</span><br><span class="line">    <span class="type">bool</span> exist;</span><br><span class="line">    val = lipp.<span class="built_in">at</span>(key, <span class="literal">false</span>, exist);</span><br><span class="line">    <span class="keyword">return</span> exist;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">bool</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">put</span>(KEY_TYPE key, PAYLOAD_TYPE value, Param *param) &#123;</span><br><span class="line">    <span class="keyword">return</span> lipp.<span class="built_in">insert</span>(key, value);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">bool</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">update</span>(KEY_TYPE key, PAYLOAD_TYPE value, Param *param) &#123;</span><br><span class="line">    <span class="keyword">return</span> lipp.<span class="built_in">update</span>(key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">bool</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">remove</span>(KEY_TYPE key, Param *param) &#123;</span><br><span class="line">    <span class="keyword">return</span> lipp.<span class="built_in">remove</span>(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">KEY_TYPE</span>, <span class="keyword">class</span> <span class="title class_">PAYLOAD_TYPE</span>&gt;</span><br><span class="line"><span class="type">size_t</span> LIPPInterface&lt;KEY_TYPE, PAYLOAD_TYPE&gt;::<span class="built_in">scan</span>(KEY_TYPE key_low_bound, <span class="type">size_t</span> key_num,</span><br><span class="line">                                                   std::pair &lt;KEY_TYPE, PAYLOAD_TYPE&gt; *result,</span><br><span class="line">                                                   Param *param) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!result) &#123;</span><br><span class="line">        result = <span class="keyword">new</span> std::pair &lt;KEY_TYPE, PAYLOAD_TYPE&gt;[key_num];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lipp.<span class="built_in">range_query_len</span>(result, key_low_bound, key_num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/02/29/cmu15445-project4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/29/cmu15445-project4/" class="post-title-link" itemprop="url">cmu15445-project4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-29 04:11:36" itemprop="dateCreated datePublished" datetime="2024-02-29T04:11:36-08:00">2024-02-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-04 05:59:21" itemprop="dateModified" datetime="2024-03-04T05:59:21-08:00">2024-03-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cmu15445-2023/" itemprop="url" rel="index"><span itemprop="name">cmu15445-2023</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Concurrency-Control-Theory"><a href="#Concurrency-Control-Theory" class="headerlink" title="Concurrency Control Theory"></a>Concurrency Control Theory</h2><h3 id="formal-Definitions"><a href="#formal-Definitions" class="headerlink" title="formal Definitions"></a>formal Definitions</h3><p>Database: A fixed set of named data objects (e.g., A, B, C, ‚Ä¶)<br>Transaction: A sequence of read and write operations (e.g., R(A), W(B), ‚Ä¶)</p>
<p>transactionÁöÑÊ≠£Á°ÆÊÄßÊ†áÂáÜACIDÔºö</p>
<ul>
<li>Atomicity: ÂéüÂ≠êÊÄß ‚Äúall or nothing‚Äù</li>
<li>Consistency: ‰∏ÄËá¥ÊÄß ‚Äúit looks correct to me‚Äù</li>
<li>Isolation: ÈöîÁ¶ªÊÄß ‚Äúas if alone‚Äù</li>
<li>Durability: ÊåÅ‰πÖÊÄß ‚Äúsurvive failures‚Äù</li>
</ul>
<h3 id="Conflicting-Operations"><a href="#Conflicting-Operations" class="headerlink" title="Conflicting Operations"></a>Conflicting Operations</h3><p>Â§ö‰∏™transactionÂπ∂ÂèëÊâßË°åÊó∂‰ºöÂèëÁîüÂÜ≤Á™Å:</p>
<ul>
<li>ËØªÂÜôÂÜ≤Á™Å(R-W)</li>
<li>ÂÜôËØªÂÜ≤Á™Å(W-R)</li>
<li>ÂÜôÂÜôÂÜ≤Á™Å(W-W)</li>
</ul>
<p>ËØªÂÜôÂÜ≤Á™ÅÈÄ†ÊàêÁöÑÈóÆÈ¢òÔºö<br></p>
<ul>
<li>‰∏çÂèØÈáçÂ§çËØª(Âú®‰∏Ä‰∏™‰∫ãÂä°ÂÜÖÂ§öÊ¨°ËØªÂèñÂêå‰∏Ä‰∏™Êï∞ÊçÆÔºåÂ¶ÇÊûúÂá∫Áé∞ÂâçÂêé‰∏§Ê¨°ËØªÂà∞ÁöÑÊï∞ÊçÆ‰∏ç‰∏ÄÊ†∑ÁöÑÊÉÖÂÜµÔºåÂ∞±ÊÑèÂë≥ÁùÄÂèëÁîü‰∫Ü[‰∏çÂèØÈáçÂ§çËØª]ÁöÑÁé∞Ë±°)</li>
<li>ÂπªËØªÔºöÂú®‰∏Ä‰∏™‰∫ãÂä°ÂÜÖÂ§öÊ¨°Êü•ËØ¢Êüê‰∏™Á¨¶ÂêàÊü•ËØ¢Êù°‰ª∂ÁöÑ[ËÆ∞ÂΩïÊï∞Èáè]ÔºåÂá∫Áé∞ÂâçÂêé‰∏§Ê¨°Êü•ËØ¢Âà∞ÁöÑËÆ∞ÂΩïÊï∞Èáè‰∏ç‰∏ÄÊ†∑</li>
</ul>
<p>ÂÜôËØªÂÜ≤Á™ÅÈÄ†ÊàêÁöÑÈóÆÈ¢òÔºö<br></p>
<ul>
<li>ËÑèËØª(‰∏Ä‰∏™‰∫ãÂä°[ËØªÂà∞]‰∫ÜÂè¶‰∏Ä‰∏™[Êú™Êèê‰∫§‰∫ãÂä°‰øÆÊîπËøáÁöÑÊï∞ÊçÆ],Â∞±ÊÑèÂë≥ÁùÄÂèëÁîü‰∫Ü[ËÑèËØª]Áé∞Ë±°)</li>
</ul>
<p>ÂÜôÂÜôÂÜ≤Á™ÅÈÄ†ÊàêÁöÑÈóÆÈ¢ò: <br></p>
<ul>
<li>‰∏¢Â§±‰øÆÊîπ</li>
</ul>
<p><img src="/../images/cmu15445-project4/2.png" alt="img"><br><img src="/../images/cmu15445-project4/3.png" alt="img"><br><img src="/../images/cmu15445-project4/4.png" alt="img"></p>
<blockquote>
<p>MySQL InnoDBÂºïÊìéÁöÑÈªòËÆ§ÈöîÁ¶ªÁ∫ßÂà´ËôΩÁÑ∂ÊòØ[ÂèØÈáçÂ§çËØª]Ôºå‰ΩÜÊòØÂÆÉÂæàÂ§ßÁ®ãÂ∫¶‰∏äÈÅøÂÖçÂπªËØªÁé∞Ë±°ÔºåÂπ∂Ê≤°ÊúâËß£ÂÜ≥ÂπªËØª <a target="_blank" rel="noopener" href="https://xiaolincoding.com/mysql/transaction/phantom.html">ÂèÇËÄÉÊñáÁ´†</a><br></p>
</blockquote>
<hr>
<blockquote>
<p>Ëß£ÂÜ≥ÊñπÊ°àÊúâ‰∏§Áßç:</p>
<ul>
<li>ÊôÆÈÄöselectËØ≠Âè•(Âø´ÁÖßËØª),ÈÄöËøáMVCCÊñπÂºèËß£ÂÜ≥‰∫ÜÂπªËØªÈóÆÈ¢ò</li>
<li>select ‚Ä¶ for updateËØ≠Âè•(ÂΩìÂâçËØª)ÔºåÈÄöËøánext-key lock(ËÆ∞ÂΩïÈîÅ + Èó¥ÈöôÈîÅ)ÊñπÂºèËß£ÂÜ≥‰∫ÜÂπªËØª</li>
</ul>
</blockquote>
<h3 id="Read-ViewÂú®MVCCÈáåÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑ"><a href="#Read-ViewÂú®MVCCÈáåÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑ" class="headerlink" title="Read ViewÂú®MVCCÈáåÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑ?"></a>Read ViewÂú®MVCCÈáåÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑ?</h3><p>Read ViewÊúâÂõõ‰∏™ÈáçË¶ÅÁöÑÂ≠óÊÆµ<br><br>Âõõ‰∏™Â≠óÊÆµÂè™Êúâm_idsÊòØ‰∏Ä‰∏™ÈõÜÂêàÔºåcreator_trx_idÂú®m_idsÈõÜÂêà‰∏≠Ôºå<br>min_trx_idÊòØm_idsÈõÜÂêàÁöÑÊúÄÂ∞èÂÄº<br><img src="/../images/cmu15445-project4/5.png" alt="img"></p>
<p>ËÆ∞ÂΩïÁöÑ‰∏§‰∏™ÈöêËóèÂàó<br><img src="/../images/cmu15445-project4/6.png" alt="img"></p>
<ul>
<li>trx_idÔºåÂΩì‰∏Ä‰∏™‰∫ãÂä°ÂØπÊüêÊù°ËÅöÁ∞áÁ¥¢ÂºïËÆ∞ÂΩïËøõË°åÊîπÂä®Êó∂ÔºåÂ∞±‰ºöÊääËØ•‰∫ãÂä°ÁöÑ‰∫ãÂä° id ËÆ∞ÂΩïÂú® trx_id ÈöêËóèÂàóÈáåÔºõ</li>
<li>roll_pointerÔºåÊØèÊ¨°ÂØπÊüêÊù°ËÅöÁ∞áÁ¥¢ÂºïËÆ∞ÂΩïËøõË°åÊîπÂä®Êó∂ÔºåÈÉΩ‰ºöÊääÊóßÁâàÊú¨ÁöÑËÆ∞ÂΩïÂÜôÂÖ•Âà∞ undo Êó•Âøó‰∏≠ÔºåÁÑ∂ÂêéËøô‰∏™ÈöêËóèÂàóÊòØ‰∏™ÊåáÈíàÔºåÊåáÂêëÊØè‰∏Ä‰∏™ÊóßÁâàÊú¨ËÆ∞ÂΩïÔºå‰∫éÊòØÂ∞±ÂèØ‰ª•ÈÄöËøáÂÆÉÊâæÂà∞‰øÆÊîπÂâçÁöÑËÆ∞ÂΩï</li>
</ul>
<p>Âú®ÂàõÂª∫ReadViewÂêéÔºå‰∏Ä‰∏™‰∫ãÂä°ÂéªËÆøÈóÆËÆ∞ÂΩïÁöÑÊó∂ÂÄôÔºåÈô§‰∫ÜËá™Â∑±ÁöÑÊõ¥Êñ∞ËÆ∞ÂΩïÊÄªÊòØÂèØËßÅ‰πãÂ§ñÔºåËøòÊúâÂá†ÁßçÊÉÖÂÜµÔºö</p>
<ul>
<li>Â¶ÇÊûúËÆ∞ÂΩïÁöÑtrx_idÂ∞è‰∫éReadViewÁöÑmin_trx_idÔºåË°®Á§∫Ëøô‰∏™ÁâàÊú¨ÁöÑËÆ∞ÂΩïÊòØÂú®ÂàõÂª∫ Read View ÂâçÂ∑≤ÁªèÊèê‰∫§ÁöÑ‰∫ãÂä°ÁîüÊàêÁöÑÔºåÊâÄ‰ª•ËØ•ÁâàÊú¨ÁöÑËÆ∞ÂΩïÂØπÂΩìÂâç‰∫ãÂä°ÂèØËßÅ</li>
<li>Â¶ÇÊûúËÆ∞ÂΩïÁöÑtrx_idÂ§ß‰∫éÁ≠â‰∫éReadView‰∏≠ÁöÑmax_trx_id,Ë°®Á§∫Ëøô‰∏™ÁâàÊú¨ÁöÑËÆ∞ÂΩïÊòØÂú®ÂàõÂª∫ Read View ÂêéÊâçÂêØÂä®ÁöÑ‰∫ãÂä°ÁîüÊàêÁöÑÔºåÊâÄ‰ª•ËØ•ÁâàÊú¨ÁöÑËÆ∞ÂΩïÂØπÂΩìÂâç‰∫ãÂä°‰∏çÂèØËßÅ</li>
<li>Â¶ÇÊûúËÆ∞ÂΩïÁöÑ trx_id ÂÄºÂú® Read View ÁöÑ min_trx_id Âíå max_trx_id ‰πãÈó¥ÔºåÈúÄË¶ÅÂà§Êñ≠ trx_id ÊòØÂê¶Âú® m_ids ÂàóË°®‰∏≠Ôºö<ul>
<li>Â¶ÇÊûúËÆ∞ÂΩïÁöÑ trx_id Âú® m_ids ÂàóË°®‰∏≠ÔºåË°®Á§∫ÁîüÊàêËØ•ÁâàÊú¨ËÆ∞ÂΩïÁöÑÊ¥ªË∑É‰∫ãÂä°‰æùÁÑ∂Ê¥ªË∑ÉÁùÄÔºàËøòÊ≤°Êèê‰∫§‰∫ãÂä°ÔºâÔºåÊâÄ‰ª•ËØ•ÁâàÊú¨ÁöÑËÆ∞ÂΩïÂØπÂΩìÂâç‰∫ãÂä°‰∏çÂèØËßÅ„ÄÇ</li>
<li>Â¶ÇÊûúËÆ∞ÂΩïÁöÑ trx_id ‰∏çÂú® m_idsÂàóË°®‰∏≠ÔºåË°®Á§∫ÁîüÊàêËØ•ÁâàÊú¨ËÆ∞ÂΩïÁöÑÊ¥ªË∑É‰∫ãÂä°Â∑≤ÁªèË¢´Êèê‰∫§ÔºåÊâÄ‰ª•ËØ•ÁâàÊú¨ÁöÑËÆ∞ÂΩïÂØπÂΩìÂâç‰∫ãÂä°ÂèØËßÅ„ÄÇ</li>
</ul>
</li>
</ul>
<h3 id="Two-Phase-Locking-‰∏§Èò∂ÊÆµÈîÅ"><a href="#Two-Phase-Locking-‰∏§Èò∂ÊÆµÈîÅ" class="headerlink" title="Two Phase Locking ‰∏§Èò∂ÊÆµÈîÅ"></a>Two Phase Locking ‰∏§Èò∂ÊÆµÈîÅ</h3><p>2PLÂ∞Ü‰∫ãÂä°ÂàíÂàÜ‰∏∫‰∏§‰∏™Èò∂ÊÆµ:</p>
<ul>
<li>Growing Phase: Âè™Ëé∑ÂæóÈîÅ</li>
<li>Shrink Phase: Âè™ÈáäÊîæÈîÅ</li>
</ul>
<p><img src="/../images/cmu15445-project4/7.png" alt="img"><br>2PLÊú¨Ë∫´Â∑≤ÁªèË∂≥Â§ü‰øùËØÅscheduleÊòØseriableÁöÑÔºå‰ΩÜ2PLÂèØËÉΩÂØºËá¥cascading abortsÔºå‰∏æ‰æãÂ¶Ç‰∏ã:<br><img src="/../images/cmu15445-project4/8.png" alt="img"></p>
<p>‰∫éÊòØÂºïÂÖ•2PLÁöÑÂ¢ûÂº∫ÁâàÂèòÁßçÔºåRigorous 2PLÔºåÂêéËÄÖÊØè‰∏™‰∫ãÂä°Âú®ÁªìÊùü‰πãÂâçÔºåÂÖ∂ÂÜôËøáÁöÑÊï∞ÊçÆ‰∏çËÉΩË¢´ÂÖ∂ÂÆÉ‰∫ãÂä°ËØªÂèñÊàñËÄÖÈáçÂÜô</p>
<p><img src="/../images/cmu15445-project4/9.png" alt="img"></p>
<h3 id="Deadlock-Detection-Prevention"><a href="#Deadlock-Detection-Prevention" class="headerlink" title="Deadlock Detection &amp; Prevention"></a>Deadlock Detection &amp; Prevention</h3><p>2PL Êó†Ê≥ïÈÅøÂÖçÁöÑ‰∏Ä‰∏™ÈóÆÈ¢òÂ∞±ÊòØÊ≠ªÈîÅÔºåËß£ÂÜ≥ÊñπÊ°àÔºö<br></p>
<h4 id="Deadlock-Detection-‰∫ãÂêéÊ£ÄÊµã"><a href="#Deadlock-Detection-‰∫ãÂêéÊ£ÄÊµã" class="headerlink" title="Deadlock Detection ‰∫ãÂêéÊ£ÄÊµã"></a>Deadlock Detection ‰∫ãÂêéÊ£ÄÊµã</h4><p>‰∏∫‰∫ÜÊ£ÄÊµãÊ≠ªÈîÅÔºåDBMS ‰ºöÁª¥Êä§‰∏ÄÂº† waits-for graphÔºåÊù•Ë∑üË∏™ÊØè‰∏™‰∫ãÂä°Ê≠£Âú®Á≠âÂæÖ (ÈáäÊîæÈîÅ) ÁöÑÂÖ∂ÂÆÉ‰∫ãÂä°ÔºåÁÑ∂ÂêéÁ≥ªÁªü‰ºöÂÆöÊúüÂú∞Ê£ÄÊü• waits-for graphÔºåÁúãÂÖ∂‰∏≠ÊòØÂê¶ÊúâÊàêÁéØÔºåÂ¶ÇÊûúÊàêÁéØ‰∫ÜÂ∞±Ë¶ÅÂÜ≥ÂÆöÂ¶Ç‰ΩïÊâìÁ†¥Ëøô‰∏™ÁéØ„ÄÇ<br><br>waits-for graph ‰∏≠ÁöÑËäÇÁÇπÊòØ‰∫ãÂä°Ôºå‰ªé Ti Âà∞ Tj ÁöÑËæπÂ∞±Ë°®Á§∫ Ti Ê≠£Âú®Á≠âÂæÖ Tj ÈáäÊîæÈîÅÔºå‰∏æ‰æãÂ¶Ç‰∏ã<br><img src="/../images/cmu15445-project4/10.png" alt="img"><br>ÂΩì DBMS Ê£ÄÊµãÂà∞Ê≠ªÈîÅÊó∂ÔºåÂÆÉ‰ºöÈÄâÊã©‰∏Ä‰∏™ ‚ÄúÂèóÂÆ≥ËÄÖ‚Äù (‰∫ãÂä°)ÔºåÂ∞ÜËØ•‰∫ãÂä°ÂõûÊªöÔºåÊâìÁ†¥ÁéØÂΩ¢‰æùËµñÔºåËÄåËøô‰∏™ ‚ÄúÂèóÂÆ≥ËÄÖ‚Äù Â∞Ü‰æùÈù†ÈÖçÁΩÆÊàñËÄÖÂ∫îÁî®Â±ÇÈÄªËæëÈáçËØïÊàñ‰∏≠Ê≠¢„ÄÇËøôÈáåÊúâ‰∏§‰∏™ËÆæËÆ°ÂÜ≥ÂÆöÔºö</p>
<ol>
<li>Ê£ÄÊµãÊ≠ªÈîÅÁöÑÈ¢ëÁéá</li>
<li>Â¶Ç‰ΩïÈÄâÊã©ÂêàÈÄÇÁöÑ ‚ÄúÂèóÂÆ≥ËÄÖ‚Äù</li>
</ol>
<p>Ê£ÄÊµãÊ≠ªÈîÅÁöÑÈ¢ëÁéáË∂äÈ´òÔºåÈô∑ÂÖ•Ê≠ªÈîÅÁöÑ‰∫ãÂä°Á≠âÂæÖÁöÑÊó∂Èó¥Ë∂äÁü≠Ôºå‰ΩÜÊ∂àËÄóÁöÑ cpu ‰πüÂ∞±Ë∂äÂ§ö„ÄÇÊâÄ‰ª•ËøôÊòØ‰∏™ÂÖ∏ÂûãÁöÑ trade-offÔºåÈÄöÂ∏∏Êúâ‰∏Ä‰∏™Ë∞É‰ºòÁöÑÂèÇÊï∞‰æõÁî®Êà∑ÈÖçÁΩÆ„ÄÇ</p>
<p>ÈÄâÊã© ‚ÄúÂèóÂÆ≥ËÄÖ‚Äù ÁöÑÊåáÊ†áÂèØËÉΩÊúâÂæàÂ§öÔºö‰∫ãÂä°ÊåÅÁª≠Êó∂Èó¥„ÄÅ‰∫ãÂä°ÁöÑËøõÂ∫¶„ÄÅ‰∫ãÂä°ÈîÅ‰ΩèÁöÑÊï∞ÊçÆÊï∞Èáè„ÄÅÁ∫ßËÅî‰∫ãÂä°ÁöÑÊï∞Èáè„ÄÅ‰∫ãÂä°ÊõæÁªèÈáçÂêØÁöÑÊ¨°Êï∞Á≠âÁ≠â„ÄÇÂú®ÈÄâÊã©ÂÆå ‚ÄúÂèóÂÆ≥ËÄÖ‚Äù ÂêéÔºåDBMS ËøòÊúâ‰∏Ä‰∏™ËÆæËÆ°ÂÜ≥ÂÆöÈúÄË¶ÅÂÅöÔºöÂÆåÂÖ®ÂõûÊªöËøòÊòØÂõûÊªöÂà∞Ë∂≥Â§üÊ∂àÈô§ÁéØÂΩ¢‰æùËµñÂç≥ÂèØ„ÄÇ</p>
<h4 id="Deadlock-Prevention-‰∫ãÂâçÈòªÊ≠¢"><a href="#Deadlock-Prevention-‰∫ãÂâçÈòªÊ≠¢" class="headerlink" title="Deadlock Prevention ‰∫ãÂâçÈòªÊ≠¢"></a>Deadlock Prevention ‰∫ãÂâçÈòªÊ≠¢</h4><p>ÈÄöÂ∏∏ prevention ‰ºöÊåâÁÖß‰∫ãÂä°ÁöÑÂπ¥ÈæÑÊù•Ëµã‰∫à‰ºòÂÖàÁ∫ßÔºå‰∫ãÂä°ÁöÑÊó∂Èó¥Êà≥Ë∂äËÄÅÔºå‰ºòÂÖàÁ∫ßË∂äÈ´ò„ÄÇÊúâ‰∏§Áßç prevention ÁöÑÁ≠ñÁï•Ôºö <br></p>
<ul>
<li>Old Waits for YoungÔºöÂ¶ÇÊûú requesting txn ‰ºòÂÖàÁ∫ßÊØî holding txn Êõ¥È´òÂàôÁ≠âÂæÖÂêéËÄÖÈáäÊîæÈîÅÔºõÊõ¥‰ΩéÂàôËá™Ë°å‰∏≠Ê≠¢<br></li>
<li>Young Waits for OldÔºöÂ¶ÇÊûú requesting txn ‰ºòÂÖàÁ∫ßÊØî holding txn Êõ¥È´òÂàôÂêéËÄÖËá™Ë°å‰∏≠Ê≠¢ÈáäÊîæÈîÅÔºåËÆ©ÂâçËÄÖËé∑ÂèñÈîÅÔºåÂê¶Âàô requesting txn Á≠âÂæÖ holding txn ÈáäÊîæÈîÅ</li>
</ul>
<p>‰∏æ‰æãÂ¶Ç‰∏ã:</p>
<p><img src="/../images/cmu15445-project4/11.png" alt="img"></p>
<p>Ê≠ªÈîÅ‰∫ßÁîüÁöÑÂøÖË¶ÅÊù°‰ª∂ÊòØ<br><br>1.‰∫íÊñ• 2.ËØ∑Ê±Ç‰∏é‰øùÊåÅ 3.‰∏çÂèØÊä¢Âç† 4.Âæ™ÁéØÁ≠âÂæÖ<br></p>
<h2 id="Task-1-Lock-Manager"><a href="#Task-1-Lock-Manager" class="headerlink" title="Task#1 Lock Manager"></a>Task#1 Lock Manager</h2><p>‰∫îÁßçÈîÅ S X IS IX SIX<br><img src="/../images/cmu15445-project4/12.png" alt="img"><br>ËøôÈáåÂè™ÂÆûÁé∞‰∏âÁßçÈöîÁ¶ªÁ∫ßÂà´READ_UNCOMMITTED„ÄÅREAD_COMMITTED„ÄÅREPEATABLE_READ</p>
<h3 id="LOCK-NOTE"><a href="#LOCK-NOTE" class="headerlink" title="LOCK NOTE"></a>LOCK NOTE</h3><ol>
<li><p>GENERAL BEHAVIOUR:</p>
<ul>
<li>Both LockTable() and LockRow() are blocking methods; they should wait till the lock is granted and then return.</li>
<li>If the transaction was aborted in the meantime, do not grant the lock and return false.</li>
</ul>
</li>
<li><p>MULTIPLE TRANSACTIONS:</p>
<ul>
<li>LockManager should maintain a queue for each resource; locks should be granted to transactions in a FIFO manner.</li>
<li>If there are multiple compatible lock requests, all should be granted at the same time</li>
<li>as long as FIFO is honoured.</li>
</ul>
</li>
<li><p>SUPPORTED LOCK MODES:</p>
<ul>
<li>Table locking should support all lock modes.</li>
<li>Row locking should not support Intention locks. Attempting this should set the TransactionState as</li>
<li>ABORTED and throw a TransactionAbortException (ATTEMPTED_INTENTION_LOCK_ON_ROW)</li>
</ul>
</li>
<li><p>ISOLATION LEVEL:</p>
<ul>
<li><p>REPEATABLE_READ:<br><br>  The transaction is required to take all locks.<br>  All locks are allowed in the GROWING state<br>  No locks are allowed in the SHRINKING state</p>
</li>
<li><p>READ_COMMITTED:<br><br> The transaction is required to take all locks.<br> All locks are allowed in the GROWING state<br> Only IS, S locks are allowed in the SHRINKING state</p>
</li>
<li><p>READ_UNCOMMITTED:<br><br> The transaction is required to take only IX, X locks.<br> X, IX locks are allowed in the GROWING state.<br> S, IS, SIX locks are never allowed</p>
</li>
</ul>
</li>
<li><p>MULTILEVEL LOCKING:</p>
<ul>
<li>While locking rows, Lock() should ensure that the transaction has an appropriate lock on the table which the row</li>
</ul>
<p> belongs to. For instance, if an exclusive lock is attempted on a row, the transaction must hold either X, IX, or SIX on the table. If such a lock does not exist on the table, Lock() should set the TransactionState as ABORTED and throw a TransactionAbortException (TABLE_LOCK_NOT_PRESENT)</p>
</li>
<li><p>LOCK UPGRADE:<br><br>Calling Lock() on a resource that is already locked should have the following behaviour:    </p>
<ul>
<li>If requested lock mode is the same as that of the lock presently held, Lock() should return true since it already has the lock.</li>
<li>If requested lock mode is different, Lock() should upgrade the lock held by the transaction.<br><br> While upgrading, only the following transitions should be allowed:<br><ol>
<li>IS -&gt; [S, X, IX, SIX]</li>
<li>S -&gt; [X, SIX]</li>
<li>IX -&gt; [X, SIX]</li>
<li>SIX -&gt; [X]</li>
</ol>
</li>
</ul>
<ul>
<li>Any other upgrade is considered incompatible, and such an attempt should set the TransactionState as ABORTED and throw a TransactionAbortException (INCOMPATIBLE_UPGRADE)</li>
<li>Furthermore, only one transaction should be allowed to upgrade its lock on a given resource. Multiple concurrent lock upgrades on the same resource should set the TransactionState as ABORTED and throw a TransactionAbortException (UPGRADE_CONFLICT).</li>
</ul>
</li>
</ol>
<h3 id="UNLOCK-NOTE"><a href="#UNLOCK-NOTE" class="headerlink" title="UNLOCK NOTE"></a>UNLOCK NOTE</h3><ol>
<li>GENERAL BEHAVIOUR:<ul>
<li>Both UnlockTable() and UnlockRow() should release the lock on the resource and return. Both should ensure that the transaction currently holds a lock on the resource it is attempting to unlock.</li>
</ul>
<p>If not, LockManager should set the TransactionState as ABORTED and throw a TransactionAbortException (ATTEMPTED_UNLOCK_BUT_NO_LOCK_HELD)</p>
<ul>
<li>Additionally, unlocking a table should only be allowed if the transaction does not hold locks on any row on that table. If the transaction holds locks on rows of the table, Unlock should set the Transaction State as ABORTED and throw a TransactionAbortException (TABLE_UNLOCKED_BEFORE_UNLOCKING_ROWS).</li>
<li>Finally, unlocking a resource should also grant any new lock requests for the resource (if possible).</li>
</ul>
</li>
<li>TRANSACTION STATE UPDATE<ul>
<li>REPEATABLE_READ:<br><br>   Unlocking S&#x2F;X locks should set the transaction state to SHRINKING</li>
<li>READ_COMMITTED:<br><br>   Unlocking X locks should set the transaction state to SHRINKING.<br><br>   Unlocking S locks does not affect transaction state.</li>
<li>READ_UNCOMMITTED:<br><br>   Unlocking X locks should set the transaction state to SHRINKING.<br><br>   S locks are not permitted under READ_UNCOMMITTED.<br><br>   The behaviour upon unlocking an S lock under this isolation level is undefined.</li>
</ul>
</li>
</ol>
<p><br><br><br></p>
<ul>
<li>LockTable(Transaction, LockMode, TableOID)</li>
<li>UnlockTable(Transction, TableOID)</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::LockTable</span><span class="params">(Transaction *txn, LockMode lock_mode, <span class="type">const</span> <span class="type">table_oid_t</span> &amp;oid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">LockTableDirectlyOrNot</span>(txn, lock_mode, oid, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::LockTableDirectlyOrNot</span><span class="params">(Transaction *txn, LockMode lock_mode, <span class="type">const</span> <span class="type">table_oid_t</span> &amp;oid, <span class="type">bool</span> directly)</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> txn_state = txn-&gt;<span class="built_in">GetState</span>();</span><br><span class="line">  <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">  <span class="keyword">if</span> (txn_state == TransactionState::COMMITTED || txn_state == TransactionState::ABORTED) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//‰∫ãÂä°Â∑≤ÁªèÊèê‰∫§ÊàñÁªàÊ≠¢ÔºåËøîÂõûfalse</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (iso_level) &#123;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::REPEATABLE_READ:</span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;<span class="comment">//REPEATABLE_READÁ∫ßÂà´‰∏ã,SHRINKINGÈò∂ÊÆµ‰∏çÂèØÂä†ÈîÅ</span></span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, directly);<span class="comment">//ÊäõÂá∫ÂºÇÂ∏∏</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::READ_COMMITTED:</span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;</span><br><span class="line">        <span class="comment">//READ_COMMITTEDÁ∫ßÂà´‰∏ãÔºåSHRINGKINGÈò∂ÊÆµÂè™ÂèØÂä†IS„ÄÅSÈîÅ</span></span><br><span class="line">        <span class="keyword">if</span> (lock_mode != LockMode::INTENTION_SHARED &amp;&amp; lock_mode != LockMode::SHARED) &#123;</span><br><span class="line">          <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, directly);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::READ_UNCOMMITTED:</span><br><span class="line">      <span class="comment">//READ_UNCOMMITTEDÁ∫ßÂà´‰∏ã,SHRINKINGÈò∂ÊÆµ‰∏çÂèØÂä†ÈîÅ</span></span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;</span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, directly);<span class="comment">//ÊäõÂá∫ÂºÇÂ∏∏</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//READ_UNCOMMITTEDÁ∫ßÂà´‰∏ã,Âè™ÂèØ‰ª•Âä†IXÂíåXÈîÅ</span></span><br><span class="line">      <span class="keyword">if</span> (lock_mode != LockMode::INTENTION_EXCLUSIVE &amp;&amp; lock_mode != LockMode::EXCLUSIVE) &#123;</span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_SHARED_ON_READ_UNCOMMITTED, directly);<span class="comment">//ÊäõÂá∫ÂºÇÂ∏∏</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>(<span class="string">&quot;wrong IsolationLevel&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  table_lock_map_latch_.<span class="built_in">lock</span>();</span><br><span class="line">  <span class="keyword">if</span> (table_lock_map_.<span class="built_in">count</span>(oid) == <span class="number">0</span>) &#123;</span><br><span class="line">    table_lock_map_[oid] = std::<span class="built_in">make_shared</span>&lt;LockRequestQueue&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> lrq = table_lock_map_[oid];<span class="comment">//ÊãøÂà∞ËØ•tableÁöÑLockRequestQueue</span></span><br><span class="line">  <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(lrq-&gt;latch_)</span></span>;</span><br><span class="line">  table_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ê£ÄÊü•Ê≠§ÈîÅÁöÑËØ∑Ê±ÇÊòØÂê¶‰∏∫‰∏ÄÊ¨°ÈîÅÂçáÁ∫ß</span></span><br><span class="line">  <span class="type">bool</span> upgrade = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); iter++) &#123;<span class="comment">//ÈÅçÂéÜLockRequestQueue</span></span><br><span class="line">    <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;  <span class="comment">// Âêå‰∏Ä‰∏™‰∫ãÂä°ÂØπÁõ∏ÂêåtableËØ∑Ê±ÇÂä†ÈîÅ</span></span><br><span class="line">      <span class="keyword">if</span> (lr-&gt;lock_mode_ == lock_mode) &#123;           <span class="comment">// Âä†ÈîÅÁöÑÁ±ªÂûãÁõ∏Âêå,Áõ¥Êé•ËøîÂõû</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (lrq-&gt;upgrading_ != INVALID_TXN_ID) &#123;  <span class="comment">// Êúâ‰∫ãÂä°Ê≠£Âú®ÂØπËØ•resourceËøõË°åÈîÅÂçáÁ∫ß</span></span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::UPGRADE_CONFLICT, directly);<span class="comment">//ÊäõÂá∫ÂºÇÂ∏∏</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">CanLockUpgrade</span>(lr-&gt;lock_mode_, lock_mode)) &#123;  <span class="comment">// ‰∏çËÉΩÂ§üËøõË°åÈîÅÂçáÁ∫ß</span></span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::INCOMPATIBLE_UPGRADE, directly);<span class="comment">//ÊäõÂá∫ÂºÇÂ∏∏</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//ÈîÅÂçáÁ∫ß</span></span><br><span class="line">      lrq-&gt;upgrading_ = txn-&gt;<span class="built_in">GetTransactionId</span>();</span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);<span class="comment">//Â∞Ülr‰ªéLockRequestQueue‰∏≠Âà†Èô§</span></span><br><span class="line">      <span class="built_in">RemoveFromTxnTableLockSet</span>(txn, lr-&gt;lock_mode_, oid);<span class="comment">//Â∞Ütxn‰∫ãÂä°ÊåÅÊúâËØ•tableÁöÑÈîÅÂà†Èô§</span></span><br><span class="line">      <span class="keyword">delete</span> lr;  <span class="comment">// Èò≤Ê≠¢ÂÜÖÂ≠òÊ≥ÑÈú≤</span></span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">LockRequest</span>(txn-&gt;<span class="built_in">GetTransactionId</span>(), lock_mode, oid));<span class="comment">//Âä†ÂÖ•LockRequest</span></span><br><span class="line">      upgrade = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ‰∏çÊòØÈîÅÂçáÁ∫ß</span></span><br><span class="line">  <span class="keyword">if</span> (!upgrade) &#123;</span><br><span class="line">    lrq-&gt;request_queue_.<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">LockRequest</span>(txn-&gt;<span class="built_in">GetTransactionId</span>(), lock_mode, oid));<span class="comment">//Âä†ÂÖ•LockRequest</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!<span class="built_in">CanTxnTakeLock</span>(txn, lock_mode, lrq)) &#123;<span class="comment">//Âà§Êñ≠ÊòØÂê¶ÂèØ‰ª•ÁªôÊîπTableÂä†ÈîÅ</span></span><br><span class="line">    lrq-&gt;cv_.<span class="built_in">wait</span>(lock);<span class="comment">//‰∫íÊñ•ÈòªÂ°û</span></span><br><span class="line">    <span class="comment">// ÂèØËÉΩÊ≠ªÈîÅÊ£ÄÊµãÂ∞ÜËØ•‰∫ãÂä°ABORTED ÊàñËÄÖ ÊâãÂä®ABORTËØ•‰∫ãÂä°</span></span><br><span class="line">    <span class="keyword">if</span> (txn-&gt;<span class="built_in">GetState</span>() == TransactionState::ABORTED) &#123;</span><br><span class="line">      <span class="comment">// Âà†Èô§ËØ•‰∫ãÂä°ÂØπËØ•ËµÑÊ∫êÁöÑrequest</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); iter++) &#123;</span><br><span class="line">        <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">        <span class="keyword">if</span> (lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">          lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);</span><br><span class="line">          <span class="keyword">delete</span> lr;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      lrq-&gt;cv_.<span class="built_in">notify_all</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">AddIntoTxnTableLockSet</span>(txn, lock_mode, oid);<span class="comment">//ËØ•TableËé∑ÂæóÈîÅ</span></span><br><span class="line">  <span class="comment">// LOG_DEBUG(&quot;txn:%d LockTable %d lock_mode:%d&quot;, txn-&gt;GetTransactionId(), oid, lock_mode);</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::CanTxnTakeLock</span><span class="params">(Transaction *txn, LockMode lock_mode,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 std::shared_ptr&lt;LockRequestQueue&gt; &amp;lock_request_queue)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> lr : lock_request_queue-&gt;request_queue_) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;granted_ &amp;&amp; !<span class="built_in">AreLocksCompatible</span>(lock_mode, lr-&gt;lock_mode_)) &#123;  <span class="comment">// Â≠òÂú®ÈîÅÂÜ≤Á™Å</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ÈîÅÂçáÁ∫ß‰ºòÂÖàÁ∫ßÊúÄÈ´ò</span></span><br><span class="line">  <span class="keyword">if</span> (lock_request_queue-&gt;upgrading_ != INVALID_TXN_ID) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lock_request_queue-&gt;upgrading_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;  <span class="comment">// ‰∫ãÂä°ËøõË°åÈîÅÂçáÁ∫ß</span></span><br><span class="line">      lock_request_queue-&gt;upgrading_ = INVALID_TXN_ID;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> lr : lock_request_queue-&gt;request_queue_) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!lr-&gt;granted_ &amp;&amp; lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">          lr-&gt;granted_ = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;  <span class="comment">// ËøõË°åÈîÅÂçáÁ∫ßÁöÑÊòØÂÖ∂ÂÆÉ‰∫ãÂä°,ÈÇ£‰πàËØ•‰∫ãÂä°ÈúÄË¶ÅÁ≠âÂæÖ</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ÈÅµÂæ™FIFOËßÑÂàô</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> lr : lock_request_queue-&gt;request_queue_) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">      lr-&gt;granted_ = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!lr-&gt;granted_ &amp;&amp; !<span class="built_in">AreLocksCompatible</span>(lock_mode, lr-&gt;lock_mode_)) &#123;  <span class="comment">// ÈîÅÂÜ≤Á™Å</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::UnlockTable</span><span class="params">(Transaction *txn, <span class="type">const</span> <span class="type">table_oid_t</span> &amp;oid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">CheckAllRowsUnLock</span>(txn, oid)) &#123;<span class="comment">//Ê£ÄÊü•ËØ•Table‰∏ãÁöÑÊâÄÊúârowÁöÑÈîÅÊòØÂê¶ÈáäÊîæ</span></span><br><span class="line">    <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::TABLE_UNLOCKED_BEFORE_UNLOCKING_ROWS, <span class="literal">true</span>);<span class="comment">//ÊäõÂá∫ÂºÇÂ∏∏</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  table_lock_map_latch_.<span class="built_in">lock</span>();</span><br><span class="line">  <span class="keyword">if</span> (table_lock_map_.<span class="built_in">count</span>(oid) == <span class="number">0</span>) &#123;</span><br><span class="line">    table_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line">    <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::ATTEMPTED_UNLOCK_BUT_NO_LOCK_HELD, <span class="literal">true</span>);<span class="comment">//ËØ•tableÊú™Âä†ÈîÅ</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> lrq = table_lock_map_[oid];</span><br><span class="line">  <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(lrq-&gt;latch_)</span></span>;</span><br><span class="line">  table_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); ++iter) &#123;</span><br><span class="line">    <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;granted_ &amp;&amp; lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;<span class="comment">//ÊâæÂà∞ËØ•‰∫ãÂä°ÂØπËØ•tableÁöÑLockRequest</span></span><br><span class="line">      <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">      <span class="keyword">switch</span> (iso_level) &#123;</span><br><span class="line">        <span class="keyword">case</span> IsolationLevel::REPEATABLE_READ:</span><br><span class="line">          <span class="keyword">if</span> (lr-&gt;lock_mode_ == LockMode::SHARED || lr-&gt;lock_mode_ == LockMode::EXCLUSIVE) &#123;</span><br><span class="line">            txn-&gt;<span class="built_in">SetState</span>(TransactionState::SHRINKING);</span><br><span class="line">            <span class="comment">// LOG_DEBUG(&quot;txn:%d be set SHRINGKING&quot;, txn-&gt;GetTransactionId());</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IsolationLevel::READ_COMMITTED:</span><br><span class="line">        <span class="keyword">case</span> IsolationLevel::READ_UNCOMMITTED:</span><br><span class="line">          <span class="keyword">if</span> (lr-&gt;lock_mode_ == LockMode::EXCLUSIVE) &#123;</span><br><span class="line">            txn-&gt;<span class="built_in">SetState</span>(TransactionState::SHRINKING);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="built_in">UNREACHABLE</span>(<span class="string">&quot;wrong IsolationLevel&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">RemoveFromTxnTableLockSet</span>(txn, lr-&gt;lock_mode_, oid);</span><br><span class="line">      <span class="comment">// LOG_DEBUG(&quot;txn:%d UnlockTable %d&quot;, txn-&gt;GetTransactionId(), oid);</span></span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);</span><br><span class="line">      <span class="keyword">delete</span> lr;</span><br><span class="line">      lrq-&gt;cv_.<span class="built_in">notify_all</span>();<span class="comment">//ËµÑÊ∫êÈáäÊîæÔºåcv_ËøõË°ånotify</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::ATTEMPTED_UNLOCK_BUT_NO_LOCK_HELD, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>LockRow(Transaction, LockMode, TableOID, RID)</li>
<li>UnlockRow(Transaction, TableOID, RID, force)<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::LockRow</span><span class="params">(Transaction *txn, LockMode lock_mode, <span class="type">const</span> <span class="type">table_oid_t</span> &amp;oid, <span class="type">const</span> RID &amp;rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">    <span class="comment">//rowÂè™ËÉΩÂä†SÂíåEÈîÅ</span></span><br><span class="line">  <span class="keyword">if</span> (lock_mode != LockMode::SHARED &amp;&amp; lock_mode != LockMode::EXCLUSIVE) &#123;</span><br><span class="line">    <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::ATTEMPTED_INTENTION_LOCK_ON_ROW, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> txn_state = txn-&gt;<span class="built_in">GetState</span>();</span><br><span class="line">  <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">  <span class="keyword">if</span> (txn_state == TransactionState::COMMITTED || txn_state == TransactionState::ABORTED) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (iso_level) &#123;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::REPEATABLE_READ:</span><br><span class="line">    <span class="comment">//REPEATABLE_READÁ∫ßÂà´‰∏ãSHRINKINGÈò∂ÊÆµ‰∏çÂèØ‰ª•Âä†ÈîÅ</span></span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;</span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, <span class="literal">true</span>);<span class="comment">//ÊäõÂá∫ÂºÇÂ∏∏</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::READ_COMMITTED:</span><br><span class="line">    <span class="comment">//READ_COMMITTEDÁ∫ßÂà´‰∏ãSHRINKINGÈò∂ÊÆµÂè™ËÉΩÁªôrowÂä†SHAREDÈîÅ</span></span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lock_mode != LockMode::SHARED) &#123;</span><br><span class="line">          <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, <span class="literal">true</span>);<span class="comment">//ÊäõÂá∫ÂºÇÂ∏∏</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IsolationLevel::READ_UNCOMMITTED:</span><br><span class="line">    <span class="comment">//READ_UNCOMMITTEDÁ∫ßÂà´‰∏ãSHRINKINGÈò∂ÊÆµ‰∏çËÉΩÂä†ÈîÅ</span></span><br><span class="line">      <span class="keyword">if</span> (txn_state == TransactionState::SHRINKING) &#123;</span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_ON_SHRINKING, <span class="literal">true</span>);<span class="comment">//ÊäõÂá∫ÂºÇÂ∏∏</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//READ_UNCOMMITTEDÁ∫ßÂà´‰∏ãÔºåÂè™ËÉΩÁªôrowÂä†XÈîÅ</span></span><br><span class="line">      <span class="keyword">if</span> (lock_mode != LockMode::EXCLUSIVE) &#123;</span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::LOCK_SHARED_ON_READ_UNCOMMITTED, <span class="literal">true</span>);<span class="comment">//ÊäõÂá∫ÂºÇÂ∏∏</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">UNREACHABLE</span>(<span class="string">&quot;wrong IsolationLevel&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">CheckAppropriateLockOnTable</span>(txn, oid, lock_mode)) &#123;<span class="comment">//Êü•ÁúãËØ•rowÁöÑTableÊòØÂê¶Âä†ÈîÅ</span></span><br><span class="line">    <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::TABLE_LOCK_NOT_PRESENT, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  row_lock_map_latch_.<span class="built_in">lock</span>();</span><br><span class="line">  <span class="keyword">if</span> (row_lock_map_.<span class="built_in">count</span>(rid) == <span class="number">0</span>) &#123;</span><br><span class="line">    row_lock_map_[rid] = std::<span class="built_in">make_shared</span>&lt;LockRequestQueue&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> lrq = row_lock_map_[rid];</span><br><span class="line">  <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(lrq-&gt;latch_)</span></span>;</span><br><span class="line">  row_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Ê£ÄÊü•ÊòØÂê¶ÊòØ‰∏ÄÊ¨°ÈîÅÂçáÁ∫ß(S-&gt;X)</span></span><br><span class="line">  <span class="type">bool</span> upgrade = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); iter++) &#123;</span><br><span class="line">    <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (lr-&gt;lock_mode_ == lock_mode) &#123;  <span class="comment">// ÈáçÂ§çÁöÑÈîÅ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (lrq-&gt;upgrading_ != INVALID_TXN_ID) &#123;  <span class="comment">// ÊäõÂá∫ UPGRADE_CONFLICT ÂºÇÂ∏∏</span></span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::UPGRADE_CONFLICT, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">CanLockUpgrade</span>(lr-&gt;lock_mode_, lock_mode)) &#123;  <span class="comment">// Êäõ INCOMPATIBLE_UPGRADE ÂºÇÂ∏∏</span></span><br><span class="line">        <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::INCOMPATIBLE_UPGRADE, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      lrq-&gt;upgrading_ = txn-&gt;<span class="built_in">GetTransactionId</span>();</span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);</span><br><span class="line">      <span class="built_in">RemoveFromTxnRowLockSet</span>(txn, lr-&gt;lock_mode_, oid, rid);</span><br><span class="line">      <span class="keyword">delete</span> lr;</span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">LockRequest</span>(txn-&gt;<span class="built_in">GetTransactionId</span>(), lock_mode, oid, rid));</span><br><span class="line">      upgrade = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!upgrade) &#123;</span><br><span class="line">    lrq-&gt;request_queue_.<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">LockRequest</span>(txn-&gt;<span class="built_in">GetTransactionId</span>(), lock_mode, oid, rid));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!<span class="built_in">CanTxnTakeLock</span>(txn, lock_mode, lrq)) &#123;</span><br><span class="line">    lrq-&gt;cv_.<span class="built_in">wait</span>(lock);</span><br><span class="line">    <span class="comment">// LOG_DEBUG(&quot;txn:%d wake&quot;, txn-&gt;GetTransactionId());</span></span><br><span class="line">    <span class="comment">// Ê≠ªÈîÅÊ£ÄÊµãABORTËØ•‰∫ãÂä° ÊàñËÄÖ ÊâãÂä®ABORTËØ•‰∫ãÂä°</span></span><br><span class="line">    <span class="keyword">if</span> (txn-&gt;<span class="built_in">GetState</span>() == TransactionState::ABORTED) &#123;</span><br><span class="line">      <span class="comment">// LOG_DEBUG(&quot;txn:%d ABORT&quot;, txn-&gt;GetTransactionId());</span></span><br><span class="line">      <span class="comment">// ÁßªÈô§ËØ•‰∫ãÂä°ÂØπËØ•ËµÑÊ∫êÁöÑrequest</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); iter++) &#123;</span><br><span class="line">        <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">        <span class="keyword">if</span> (lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">          lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);</span><br><span class="line">          <span class="keyword">delete</span> lr;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      lrq-&gt;cv_.<span class="built_in">notify_all</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">AddIntoTxnRowLockSet</span>(txn, lock_mode, oid, rid);</span><br><span class="line">  <span class="comment">// LOG_DEBUG(&quot;txn:%d LockRow oid:%d rid:%d:%d lock_mode:%d&quot;, txn-&gt;GetTransactionId(), oid, rid.GetPageId(),</span></span><br><span class="line">  <span class="comment">// rid.GetSlotNum(), lock_mode);</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::UnlockRow</span><span class="params">(Transaction *txn, <span class="type">const</span> <span class="type">table_oid_t</span> &amp;oid, <span class="type">const</span> RID &amp;rid, <span class="type">bool</span> force)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  row_lock_map_latch_.<span class="built_in">lock</span>();</span><br><span class="line">  <span class="keyword">if</span> (row_lock_map_.<span class="built_in">count</span>(rid) == <span class="number">0</span>) &#123;</span><br><span class="line">    row_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line">    <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::ATTEMPTED_UNLOCK_BUT_NO_LOCK_HELD, <span class="literal">true</span>);<span class="comment">//ËØ•rowÊú™Âä†ÈîÅÊäõÂá∫ÂºÇÂ∏∏</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> lrq = row_lock_map_[rid];</span><br><span class="line">  <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(lrq-&gt;latch_)</span></span>;</span><br><span class="line">  row_lock_map_latch_.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> iter = lrq-&gt;request_queue_.<span class="built_in">begin</span>(); iter != lrq-&gt;request_queue_.<span class="built_in">end</span>(); ++iter) &#123;</span><br><span class="line">    <span class="keyword">auto</span> lr = *iter;</span><br><span class="line">    <span class="keyword">if</span> (lr-&gt;granted_ &amp;&amp; lr-&gt;txn_id_ == txn-&gt;<span class="built_in">GetTransactionId</span>()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!force) &#123;</span><br><span class="line">        <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">        <span class="keyword">switch</span> (iso_level) &#123;</span><br><span class="line">          <span class="keyword">case</span> IsolationLevel::REPEATABLE_READ:</span><br><span class="line">            <span class="keyword">if</span> (lr-&gt;lock_mode_ == LockMode::SHARED || lr-&gt;lock_mode_ == LockMode::EXCLUSIVE) &#123;</span><br><span class="line">              txn-&gt;<span class="built_in">SetState</span>(TransactionState::SHRINKING);</span><br><span class="line">              <span class="comment">// LOG_DEBUG(&quot;txn:%d be set SHRINGKING&quot;, txn-&gt;GetTransactionId());</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> IsolationLevel::READ_COMMITTED:</span><br><span class="line">          <span class="keyword">case</span> IsolationLevel::READ_UNCOMMITTED:</span><br><span class="line">            <span class="keyword">if</span> (lr-&gt;lock_mode_ == LockMode::EXCLUSIVE) &#123;</span><br><span class="line">              txn-&gt;<span class="built_in">SetState</span>(TransactionState::SHRINKING);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">UNREACHABLE</span>(<span class="string">&quot;wrong IsolationLevel&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">RemoveFromTxnRowLockSet</span>(txn, lr-&gt;lock_mode_, oid, rid);</span><br><span class="line">      <span class="comment">// LOG_DEBUG(&quot;txn:%d UnlockRow oid:%d rid:%d:%d&quot;, txn-&gt;GetTransactionId(), oid, rid.GetPageId(),</span></span><br><span class="line">      <span class="comment">// rid.GetSlotNum());</span></span><br><span class="line">      lrq-&gt;request_queue_.<span class="built_in">erase</span>(iter);</span><br><span class="line">      <span class="keyword">delete</span> lr;</span><br><span class="line">      lrq-&gt;cv_.<span class="built_in">notify_all</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">ABORT_FOR_REASON_DIRECTLY_OR_NOT</span>(AbortReason::ATTEMPTED_UNLOCK_BUT_NO_LOCK_HELD, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Task-2-Deadlock-Detection"><a href="#Task-2-Deadlock-Detection" class="headerlink" title="Task #2 - Deadlock Detection"></a>Task #2 - Deadlock Detection</h2><p>ÈîÅÁÆ°ÁêÜÂô®Â∫îËØ•Âú®ÂêéÂè∞Á∫øÁ®ã‰∏≠ËøêË°åÊ≠ªÈîÅÊ£ÄÊµãÔºåÂÆöÊúüÊûÑÂª∫Á≠âÂæÖÂõæÂπ∂Ê†πÊçÆÈúÄË¶Å‰∏≠Ê≠¢‰∫ãÂä°‰ª•Ê∂àÈô§Ê≠ªÈîÅ„ÄÇ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ÁªôLockMangerÊ∑ªÂä†Ê≠ªÈîÅÊ£ÄÊµãÊâÄÈúÄÁöÑÊï∞ÊçÆÊàêÂëò</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LockManager</span> &#123;</span><br><span class="line">  std::atomic&lt;<span class="type">bool</span>&gt; enable_cycle_detection_;</span><br><span class="line">  std::thread *cycle_detection_thread_;</span><br><span class="line">  <span class="comment">/** Waits-for graph representation. */</span></span><br><span class="line">  std::map&lt;<span class="type">txn_id_t</span>, std::set&lt;<span class="type">txn_id_t</span>&gt;&gt; waits_for_;</span><br><span class="line">  <span class="comment">// std::unordered_map&lt;txn_id_t, int&gt; node_value_;</span></span><br><span class="line">  <span class="comment">// std::vector&lt;txn_id_t&gt; route_;</span></span><br><span class="line">  std::vector&lt;<span class="type">txn_id_t</span>&gt; stk_;</span><br><span class="line">  std::unordered_map&lt;<span class="type">txn_id_t</span>, <span class="type">bool</span>&gt; in_stk_;</span><br><span class="line">  std::unordered_map&lt;<span class="type">txn_id_t</span>, <span class="type">bool</span>&gt; has_search_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ÂºÄÂêØÊ≠ªÈîÅÊ£ÄÊµãÁöÑÂêéÂè∞Á∫øÁ®ã<br><img src="/../images/cmu15445-project4/13.png" alt="img"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LockManager::RunCycleDetection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (enable_cycle_detection_) &#123;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(cycle_detection_interval);</span><br><span class="line">    &#123;</span><br><span class="line">      waits_for_.<span class="built_in">clear</span>();</span><br><span class="line">      <span class="built_in">BuildGraph</span>();<span class="comment">//ÊûÑÂª∫Á≠âÂæÖÂõæ</span></span><br><span class="line">      <span class="comment">// PrintGraph();</span></span><br><span class="line">      <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        stk_.<span class="built_in">clear</span>();</span><br><span class="line">        in_stk_.<span class="built_in">clear</span>();</span><br><span class="line">        has_search_.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="type">txn_id_t</span> abort_tid;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">HasCycle</span>(&amp;abort_tid)) &#123;<span class="comment">//Âà§Êñ≠ÊòØÂê¶ÊúâÁéØÔºåÂ¶ÇÊûúÊúâËé∑Âèñabort_id</span></span><br><span class="line">          <span class="comment">// LOG_DEBUG(&quot;abort_tid:%d&quot;, abort_tid);</span></span><br><span class="line">          <span class="keyword">auto</span> txn = txn_manager_-&gt;<span class="built_in">GetTransaction</span>(abort_tid);</span><br><span class="line">          txn-&gt;<span class="built_in">SetState</span>(TransactionState::ABORTED);</span><br><span class="line">          <span class="built_in">RemoveAllAboutAbortTxn</span>(abort_tid);<span class="comment">//Âà†Èô§ÊúâÂêëÂõæ‰∏≠ËØ•abort_tidÁöÑÊâÄÊúâÂÖ•ËæπÂíåÂá∫Ëæπ</span></span><br><span class="line">          <span class="built_in">WakeAbortedTxn</span>(abort_tid);<span class="comment">//ËØ•abort_tidÁöÑ‰∫ãÂä°ÊâÄÂç†ÊúâÁöÑËµÑÊ∫êÁöÑcv_ËøõË°ånotify_all</span></span><br><span class="line">          <span class="comment">// LOG_DEBUG(&quot;dead_detect notify all&quot;);</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//HasCycleÂáΩÊï∞Âà§Êñ≠ÊòØÂê¶ÊúâÁéØÔºåÂπ∂‰∏îËøîÂõûÁéØ‰∏≠ÊúÄÂ§ßÁöÑtxn_id</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::HasCycle</span><span class="params">(<span class="type">txn_id_t</span> *txn_id)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> std::<span class="built_in">any_of</span>(waits_for_.<span class="built_in">begin</span>(), waits_for_.<span class="built_in">end</span>(),</span><br><span class="line">                     [<span class="keyword">this</span>, txn_id](<span class="type">const</span> std::pair&lt;<span class="type">txn_id_t</span>, std::set&lt;<span class="type">txn_id_t</span>&gt;&gt; &amp;p) &#123;</span><br><span class="line">                       <span class="keyword">auto</span> k = p.first;</span><br><span class="line">                       <span class="keyword">if</span> (!<span class="keyword">this</span>-&gt;has_search_[k] &amp;&amp; <span class="built_in">DFS</span>(k)) &#123;</span><br><span class="line">                         <span class="keyword">auto</span> iter = std::<span class="built_in">find</span>(<span class="keyword">this</span>-&gt;stk_.<span class="built_in">begin</span>(), <span class="keyword">this</span>-&gt;stk_.<span class="built_in">end</span>() - <span class="number">1</span>, <span class="keyword">this</span>-&gt;stk_.<span class="built_in">back</span>());</span><br><span class="line">                         *txn_id = <span class="number">-1</span>;</span><br><span class="line">                         <span class="keyword">while</span> (iter != <span class="keyword">this</span>-&gt;stk_.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                           <span class="keyword">if</span> (*iter &gt; *txn_id) &#123;</span><br><span class="line">                             *txn_id = *iter;</span><br><span class="line">                           &#125;</span><br><span class="line">                           ++iter;</span><br><span class="line">                         &#125;</span><br><span class="line">                         <span class="keyword">this</span>-&gt;stk_.<span class="built_in">clear</span>();</span><br><span class="line">                         <span class="keyword">this</span>-&gt;in_stk_.<span class="built_in">clear</span>();</span><br><span class="line">                         <span class="keyword">this</span>-&gt;has_search_.<span class="built_in">clear</span>();</span><br><span class="line">                         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">this</span>-&gt;stk_.<span class="built_in">clear</span>();</span><br><span class="line">                       <span class="keyword">this</span>-&gt;in_stk_.<span class="built_in">clear</span>();</span><br><span class="line">                       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                     &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//DFSÂáΩÊï∞Âà§Êñ≠ÊòØÂê¶ÊúâÁéØ,txn_id‰∏∫ÈÅçÂéÜÁöÑËµ∑ÂßãÁÇπ</span></span><br><span class="line"><span class="comment">//ÊúâÁéØËøîÂõûtrue Êó†ÁéØËøîÂõûfalse</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LockManager::DFS</span><span class="params">(<span class="type">txn_id_t</span> txn_id)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  has_search_[txn_id] = <span class="literal">true</span>;</span><br><span class="line">  stk_.<span class="built_in">push_back</span>(txn_id);</span><br><span class="line">  in_stk_[txn_id] = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> id : waits_for_[txn_id]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!has_search_[id]) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">DFS</span>(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (in_stk_[id]) &#123;</span><br><span class="line">      stk_.<span class="built_in">push_back</span>(id);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stk_.<span class="built_in">pop_back</span>();</span><br><span class="line">  in_stk_[txn_id] = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Task-3-Concurrent-Query-Execution"><a href="#Task-3-Concurrent-Query-Execution" class="headerlink" title="Task #3 - Concurrent Query Execution"></a>Task #3 - Concurrent Query Execution</h2><p>TransactionManagerÁöÑAbortÂáΩÊï∞ÈúÄË¶ÅÊÅ¢Â§çTableÂíåÂØπÂ∫îIndexÁöÑÂéüÂßãÁä∂ÊÄÅ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TransactionManager::Commit</span><span class="params">(Transaction *txn)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Release all the locks.</span></span><br><span class="line">  <span class="built_in">ReleaseLocks</span>(txn);</span><br><span class="line"></span><br><span class="line">  txn-&gt;<span class="built_in">SetState</span>(TransactionState::COMMITTED);</span><br><span class="line">  <span class="function">std::unique_lock&lt;std::shared_mutex&gt; <span class="title">guard</span><span class="params">(txn_map_mutex_)</span></span>;</span><br><span class="line">  txn_map_.<span class="built_in">erase</span>(txn-&gt;<span class="built_in">GetTransactionId</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TransactionManager::Abort</span><span class="params">(Transaction *txn)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* <span class="doctag">TODO:</span> revert all the changes in write set */</span></span><br><span class="line">  <span class="keyword">while</span> (!txn-&gt;<span class="built_in">GetWriteSet</span>()-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="keyword">auto</span> twr = txn-&gt;<span class="built_in">GetWriteSet</span>()-&gt;<span class="built_in">back</span>();</span><br><span class="line">    <span class="keyword">if</span> (twr.wtype_ == WType::INSERT) &#123;</span><br><span class="line">      <span class="keyword">auto</span> tuple_meta = twr.table_heap_-&gt;<span class="built_in">GetTupleMeta</span>(twr.rid_);</span><br><span class="line">      tuple_meta.is_deleted_ = <span class="literal">true</span>;</span><br><span class="line">      twr.table_heap_-&gt;<span class="built_in">UpdateTupleMeta</span>(tuple_meta, twr.rid_);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (twr.wtype_ == WType::DELETE) &#123;</span><br><span class="line">      <span class="keyword">auto</span> tuple_meta = twr.table_heap_-&gt;<span class="built_in">GetTupleMeta</span>(twr.rid_);</span><br><span class="line">      tuple_meta.is_deleted_ = <span class="literal">false</span>;</span><br><span class="line">      twr.table_heap_-&gt;<span class="built_in">UpdateTupleMeta</span>(tuple_meta, twr.rid_);</span><br><span class="line">    &#125;</span><br><span class="line">    txn-&gt;<span class="built_in">GetWriteSet</span>()-&gt;<span class="built_in">pop_back</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!txn-&gt;<span class="built_in">GetIndexWriteSet</span>()-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="keyword">auto</span> iwr = txn-&gt;<span class="built_in">GetIndexWriteSet</span>()-&gt;<span class="built_in">back</span>();</span><br><span class="line">    <span class="keyword">if</span> (iwr.wtype_ == WType::INSERT) &#123;</span><br><span class="line">      iwr.catalog_-&gt;<span class="built_in">GetIndex</span>(iwr.index_oid_)-&gt;index_-&gt;<span class="built_in">DeleteEntry</span>(iwr.tuple_, iwr.rid_, txn);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (iwr.wtype_ == WType::DELETE) &#123;</span><br><span class="line">      iwr.catalog_-&gt;<span class="built_in">GetIndex</span>(iwr.index_oid_)-&gt;index_-&gt;<span class="built_in">InsertEntry</span>(iwr.tuple_, iwr.rid_, txn);</span><br><span class="line">    &#125;</span><br><span class="line">    txn-&gt;<span class="built_in">GetIndexWriteSet</span>()-&gt;<span class="built_in">pop_back</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ReleaseLocks</span>(txn);</span><br><span class="line"></span><br><span class="line">  txn-&gt;<span class="built_in">SetState</span>(TransactionState::ABORTED);</span><br><span class="line">  <span class="function">std::unique_lock&lt;std::shared_mutex&gt; <span class="title">guard</span><span class="params">(txn_map_mutex_)</span></span>;</span><br><span class="line">  txn_map_.<span class="built_in">erase</span>(txn-&gt;<span class="built_in">GetTransactionId</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SeqScanExecutor‰øÆÊîπ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SeqScanExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> catalog = exec_ctx_-&gt;<span class="built_in">GetCatalog</span>();</span><br><span class="line">  table_info_ = catalog-&gt;<span class="built_in">GetTable</span>(plan_-&gt;table_oid_);</span><br><span class="line">  <span class="keyword">auto</span> txn = exec_ctx_-&gt;<span class="built_in">GetTransaction</span>();</span><br><span class="line">  <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (exec_ctx_-&gt;<span class="built_in">IsDelete</span>()) &#123;<span class="comment">//ÂΩìÂâçËøõË°åÁöÑsqlÊìç‰ΩúÊòØDELETEÊàñËÄÖUPDATE</span></span><br><span class="line">      <span class="keyword">auto</span> res =</span><br><span class="line">          exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">LockTable</span>(txn, LockManager::LockMode::INTENTION_EXCLUSIVE, plan_-&gt;table_oid_);</span><br><span class="line">      <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockTable Failed&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!txn-&gt;<span class="built_in">IsTableIntentionExclusiveLocked</span>(plan_-&gt;table_oid_) &amp;&amp;  <span class="comment">// ÈÅøÂÖçÂèçÂêëÂçáÁ∫ß</span></span><br><span class="line">               (iso_level == IsolationLevel::READ_COMMITTED || iso_level == IsolationLevel::REPEATABLE_READ)) &#123;</span><br><span class="line">      <span class="keyword">auto</span> res =</span><br><span class="line">          exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">LockTable</span>(txn, LockManager::LockMode::INTENTION_SHARED, plan_-&gt;table_oid_);</span><br><span class="line">      <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockTable Failed&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockTable Failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  iterator_ = std::<span class="built_in">make_unique</span>&lt;TableIterator&gt;(table_info_-&gt;table_-&gt;<span class="built_in">MakeEagerIterator</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">SeqScanExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  std::pair&lt;TupleMeta, Tuple&gt; pair;</span><br><span class="line">  <span class="keyword">auto</span> txn = exec_ctx_-&gt;<span class="built_in">GetTransaction</span>();</span><br><span class="line">  <span class="keyword">auto</span> iso_level = txn-&gt;<span class="built_in">GetIsolationLevel</span>();</span><br><span class="line">  <span class="keyword">while</span> (!iterator_-&gt;<span class="built_in">IsEnd</span>()) &#123;</span><br><span class="line">    pair = iterator_-&gt;<span class="built_in">GetTuple</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (exec_ctx_-&gt;<span class="built_in">IsDelete</span>()) &#123;</span><br><span class="line">        <span class="keyword">auto</span> res = exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">LockRow</span>(txn, LockManager::LockMode::EXCLUSIVE, plan_-&gt;table_oid_, pair.second.<span class="built_in">GetRid</span>());</span><br><span class="line">        <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockRow Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!txn-&gt;<span class="built_in">IsRowExclusiveLocked</span>(plan_-&gt;table_oid_, pair.second.<span class="built_in">GetRid</span>()) &amp;&amp;  <span class="comment">// ÈÅøÂÖçÂèçÂêëÂçáÁ∫ß</span></span><br><span class="line">                 (iso_level == IsolationLevel::READ_COMMITTED || iso_level == IsolationLevel::REPEATABLE_READ)) &#123;</span><br><span class="line">        <span class="keyword">auto</span> res = exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">LockRow</span>(txn, LockManager::LockMode::SHARED, plan_-&gt;table_oid_, pair.second.<span class="built_in">GetRid</span>());</span><br><span class="line">        <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockRow Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor LockRow Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iterator_-&gt;<span class="built_in">GetTuple</span>().first.is_deleted_ ||</span><br><span class="line">        (plan_-&gt;filter_predicate_ &amp;&amp;</span><br><span class="line">         plan_-&gt;filter_predicate_-&gt;<span class="built_in">Evaluate</span>(&amp;pair.second, table_info_-&gt;schema_)</span><br><span class="line">                 .<span class="built_in">CompareEquals</span>(ValueFactory::<span class="built_in">GetBooleanValue</span>(<span class="literal">false</span>)) == CmpBool::CmpTrue)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (exec_ctx_-&gt;<span class="built_in">IsDelete</span>() ||</span><br><span class="line">          (iso_level == IsolationLevel::READ_COMMITTED || iso_level == IsolationLevel::REPEATABLE_READ)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">auto</span> res = exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">UnlockRow</span>(txn, plan_-&gt;table_oid_, pair.second.<span class="built_in">GetRid</span>(), <span class="literal">true</span>);</span><br><span class="line">          <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor Force UnLockRow Failed&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor Force UnLockRow Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ++(*iterator_);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!exec_ctx_-&gt;<span class="built_in">IsDelete</span>() &amp;&amp; iso_level == IsolationLevel::READ_COMMITTED) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">auto</span> res = exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">UnlockRow</span>(txn, plan_-&gt;table_oid_, pair.second.<span class="built_in">GetRid</span>());</span><br><span class="line">        <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor UnLockRow Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor UnLockRow Failed&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++(*iterator_);</span><br><span class="line">    *tuple = std::<span class="built_in">move</span>(pair.second);</span><br><span class="line">    *rid = tuple-&gt;<span class="built_in">GetRid</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!exec_ctx_-&gt;<span class="built_in">IsDelete</span>() &amp;&amp; iso_level == IsolationLevel::READ_COMMITTED) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">auto</span> res = exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">UnlockTable</span>(txn, plan_-&gt;table_oid_);</span><br><span class="line">      <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor UnLockTable Failed&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;SeqScanExecutor UnLockTable Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InsertExecutor‰øÆÊîπÔºåÁªôtableÂä†IEÈîÅÔºåÂπ∂‰∏îtableÂíåindexÊèíÂÖ•ËÆ∞ÂΩïÈúÄË¶ÅË¢´‰øùÂ≠ò‰∏ãÊù•</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">InsertExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  child_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  <span class="keyword">auto</span> cata_log = exec_ctx_-&gt;<span class="built_in">GetCatalog</span>();</span><br><span class="line">  table_info_ = cata_log-&gt;<span class="built_in">GetTable</span>(plan_-&gt;table_oid_);</span><br><span class="line">  index_infos_ = cata_log-&gt;<span class="built_in">GetTableIndexes</span>(table_info_-&gt;name_);</span><br><span class="line">  successful_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">auto</span> txn = exec_ctx_-&gt;<span class="built_in">GetTransaction</span>();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">auto</span> res =</span><br><span class="line">        exec_ctx_-&gt;<span class="built_in">GetLockManager</span>()-&gt;<span class="built_in">LockTable</span>(txn, LockManager::LockMode::INTENTION_EXCLUSIVE, plan_-&gt;table_oid_);</span><br><span class="line">    <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;InsertExecutor LockTable Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (TransactionAbortException &amp;exception) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">ExecutionException</span>(<span class="string">&quot;InsertExecutor LockTable Failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">InsertExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  TupleMeta meta;</span><br><span class="line">  <span class="keyword">if</span> (successful_) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  meta.insert_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  meta.delete_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  meta.is_deleted_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">auto</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (child_executor_-&gt;<span class="built_in">Next</span>(tuple, rid)) &#123;</span><br><span class="line">    <span class="keyword">auto</span> tuple_rid = table_info_-&gt;table_-&gt;<span class="built_in">InsertTuple</span>(meta, *tuple, exec_ctx_-&gt;<span class="built_in">GetLockManager</span>(), exec_ctx_-&gt;<span class="built_in">GetTransaction</span>(), table_info_-&gt;oid_);</span><br><span class="line">    <span class="keyword">if</span> (tuple_rid == std::<span class="literal">nullopt</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> twr = <span class="built_in">TableWriteRecord</span>(table_info_-&gt;oid_, tuple_rid.<span class="built_in">value</span>(), table_info_-&gt;table_.<span class="built_in">get</span>());</span><br><span class="line">    twr.wtype_ = WType::INSERT;</span><br><span class="line">    exec_ctx_-&gt;<span class="built_in">GetTransaction</span>()-&gt;<span class="built_in">GetWriteSet</span>()-&gt;<span class="built_in">push_back</span>(twr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> index_info : index_infos_) &#123;</span><br><span class="line">      <span class="keyword">auto</span> key = tuple-&gt;<span class="built_in">KeyFromTuple</span>(table_info_-&gt;schema_, index_info-&gt;key_schema_, index_info-&gt;index_-&gt;<span class="built_in">GetKeyAttrs</span>());</span><br><span class="line">      index_info-&gt;index_-&gt;<span class="built_in">InsertEntry</span>(key, *tuple_rid, exec_ctx_-&gt;<span class="built_in">GetTransaction</span>());</span><br><span class="line">      <span class="keyword">auto</span> iwr = <span class="built_in">IndexWriteRecord</span>(tuple_rid.<span class="built_in">value</span>(), table_info_-&gt;oid_, WType::INSERT, key, index_info-&gt;index_oid_,</span><br><span class="line">                                  exec_ctx_-&gt;<span class="built_in">GetCatalog</span>());</span><br><span class="line">      exec_ctx_-&gt;<span class="built_in">GetTransaction</span>()-&gt;<span class="built_in">GetIndexWriteSet</span>()-&gt;<span class="built_in">push_back</span>(iwr);</span><br><span class="line">    &#125;</span><br><span class="line">    ++count;</span><br><span class="line">  &#125;</span><br><span class="line">  std::vector&lt;Value&gt; values;</span><br><span class="line">  values.<span class="built_in">emplace_back</span>(TypeId::INTEGER, count);</span><br><span class="line">  *tuple = <span class="built_in">Tuple</span>(values, &amp;<span class="built_in">GetOutputSchema</span>());</span><br><span class="line">  successful_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DeleteExecutor‰øÆÊîπÔºåÂπ∂‰∏îtableÂíåindexÂà†Èô§ËÆ∞ÂΩïÈúÄË¶ÅË¢´‰øùÂ≠ò‰∏ãÊù•</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DeleteExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  child_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  successful_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">auto</span> catalog = exec_ctx_-&gt;<span class="built_in">GetCatalog</span>();</span><br><span class="line">  table_info_ = catalog-&gt;<span class="built_in">GetTable</span>(plan_-&gt;<span class="built_in">TableOid</span>());</span><br><span class="line">  index_infos_ = catalog-&gt;<span class="built_in">GetTableIndexes</span>(table_info_-&gt;name_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">DeleteExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  TupleMeta tuple_meta;</span><br><span class="line">  <span class="keyword">if</span> (successful_) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  tuple_meta.delete_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  tuple_meta.insert_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  tuple_meta.is_deleted_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">auto</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (child_executor_-&gt;<span class="built_in">Next</span>(tuple, rid)) &#123;</span><br><span class="line">    table_info_-&gt;table_-&gt;<span class="built_in">UpdateTupleMeta</span>(tuple_meta, *rid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> twr = <span class="built_in">TableWriteRecord</span>(table_info_-&gt;oid_, *rid, table_info_-&gt;table_.<span class="built_in">get</span>());</span><br><span class="line">    twr.wtype_ = WType::DELETE;</span><br><span class="line">    exec_ctx_-&gt;<span class="built_in">GetTransaction</span>()-&gt;<span class="built_in">GetWriteSet</span>()-&gt;<span class="built_in">push_back</span>(twr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> index_info : index_infos_) &#123;</span><br><span class="line">      <span class="keyword">auto</span> key = tuple-&gt;<span class="built_in">KeyFromTuple</span>(table_info_-&gt;schema_, index_info-&gt;key_schema_, index_info-&gt;index_-&gt;<span class="built_in">GetKeyAttrs</span>());</span><br><span class="line">      index_info-&gt;index_-&gt;<span class="built_in">DeleteEntry</span>(key, *rid, exec_ctx_-&gt;<span class="built_in">GetTransaction</span>());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">auto</span> iwr = <span class="built_in">IndexWriteRecord</span>(*rid, table_info_-&gt;oid_, WType::DELETE, key, index_info-&gt;index_oid_,</span><br><span class="line">                                  exec_ctx_-&gt;<span class="built_in">GetCatalog</span>());</span><br><span class="line">      exec_ctx_-&gt;<span class="built_in">GetTransaction</span>()-&gt;<span class="built_in">GetIndexWriteSet</span>()-&gt;<span class="built_in">push_back</span>(iwr);</span><br><span class="line">    &#125;</span><br><span class="line">    count++;</span><br><span class="line">  &#125;</span><br><span class="line">  std::vector&lt;Value&gt; values;</span><br><span class="line">  values.<span class="built_in">emplace_back</span>(TypeId::INTEGER, count);</span><br><span class="line">  *tuple = <span class="built_in">Tuple</span>(values, &amp;<span class="built_in">GetOutputSchema</span>());</span><br><span class="line">  successful_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>‰∫îÁßçÁªÜÁ≤íÂ∫¶ÈîÅIS IX S SIX XÁõ∏ÂÆπÁü©Èòµ</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">IS</th>
<th align="center">IX</th>
<th align="center">S</th>
<th align="center">SIX</th>
<th align="center">X</th>
</tr>
</thead>
<tbody><tr>
<td align="center">IS</td>
<td align="center">YES</td>
<td align="center">YES</td>
<td align="center">YES</td>
<td align="center">YES</td>
<td align="center">NO</td>
</tr>
<tr>
<td align="center">IX</td>
<td align="center">YES</td>
<td align="center">YES</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
</tr>
<tr>
<td align="center">S</td>
<td align="center">YES</td>
<td align="center">NO</td>
<td align="center">YES</td>
<td align="center">NO</td>
<td align="center">NO</td>
</tr>
<tr>
<td align="center">SIX</td>
<td align="center">YES</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
</tr>
<tr>
<td align="center">X</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
<td align="center">NO</td>
</tr>
</tbody></table>
<p>Êú¨Âú∞ÊµãËØïÈÄöËøáÔºö<br><img src="/../images/cmu15445-project4/14.png" alt="img"><br><img src="/../images/cmu15445-project4/15.png" alt="img"><br><img src="/../images/cmu15445-project4/16.png" alt="img"><br><img src="/../images/cmu15445-project4/17.png" alt="img"><br><img src="/../images/cmu15445-project4/18.png" alt="img"></p>
<p>Á∫ø‰∏äÊµãËØïÈÄöËøá:<br><img src="/../images/cmu15445-project4/19.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/02/28/ssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/28/ssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5/" class="post-title-link" itemprop="url">sshÂÖçÂØÜÁôªÂΩïÂ§±Ë¥•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-02-28 03:22:49 / Modified: 03:30:18" itemprop="dateCreated datePublished" datetime="2024-02-28T03:22:49-08:00">2024-02-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9A%8F%E7%AC%94/" itemprop="url" rel="index"><span itemprop="name">ÈöèÁ¨î</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="SSHÂÖçÂØÜÁ†ÅÂ§±Ë¥•ÂéüÂõ†ÂÆö‰ΩçÂàÜÊûê"><a href="#SSHÂÖçÂØÜÁ†ÅÂ§±Ë¥•ÂéüÂõ†ÂÆö‰ΩçÂàÜÊûê" class="headerlink" title="SSHÂÖçÂØÜÁ†ÅÂ§±Ë¥•ÂéüÂõ†ÂÆö‰ΩçÂàÜÊûê"></a>SSHÂÖçÂØÜÁ†ÅÂ§±Ë¥•ÂéüÂõ†ÂÆö‰ΩçÂàÜÊûê</h2><ol>
<li>ÊúçÂä°Âô®B‰∏ä.sshÁõÆÂΩïÁöÑÊùÉÈôêÂøÖÈ°ªÊòØ700</li>
<li>ÊúçÂä°Âô®B‰∏ä.authorized_keysÊñá‰ª∂ÊùÉÈôêÂøÖÈ°ªÊòØ600ÊàñËÄÖ644</li>
<li>ÊúçÂä°Âô®B‰∏äÁî®Êà∑ÂÆ∂ÁõÆÂΩïÊñá‰ª∂ÊùÉÈôêÂøÖÈ°ªÊòØ700ÔºåÊØîÂ¶ÇÁî®Êà∑ÂêçÊòØaischangÔºåÂàô&#x2F;home&#x2F;aischangËøô‰∏™ÁõÆÂΩïÊùÉÈôêÂøÖÈ°ªÊòØ700</li>
</ol>
<p>Â¶ÇÊûú‰∏çÊòØ700ÔºåÂú®ÊúçÂä°Âô®A‰∏äÊü•Áúã&#x2F;var&#x2F;log&#x2F;secureÊñá‰ª∂‰ºöÊä•Èîô</p>
<h2 id="ÂéüÂõ†Ôºö"><a href="#ÂéüÂõ†Ôºö" class="headerlink" title="ÂéüÂõ†Ôºö"></a>ÂéüÂõ†Ôºö</h2><p>sshd‰∏∫‰∫ÜÂÆâÂÖ®ÔºåÂØπÂ±û‰∏ªÁöÑÁõÆÂΩïÂíåÊñá‰ª∂ÊùÉÈôêÊúâÊâÄË¶ÅÊ±Ç„ÄÇÂ¶ÇÊûúÊùÉÈôê‰∏çÂØπÔºåÂàôsshÁöÑÂÖçÂØÜÁ†ÅÁôªÈôÜ‰∏çÁîüÊïà„ÄÇ</p>
<blockquote>
<ol>
<li>ÊúçÂä°Âô®B‰∏äSELinuxÂÖ≥Èó≠‰∏∫disabledÔºåÂèØ‰ª•‰ΩøÁî®ÂëΩ‰ª§‰øÆÊîπsetenforce 0 ÔºåÊü•ÁúãÁä∂ÊÄÅÁöÑÂëΩ‰ª§‰∏∫getenforceÊàñËÄÖ Êü•Áúã&#x2F;etc&#x2F;selinux&#x2F;config Êñá‰ª∂‰∏≠ÊòØÂê¶ÊòØdisabled</li>
</ol>
</blockquote>
<blockquote>
<ol start="2">
<li>ÊúâÂèØËÉΩÊòØStrictModesÈóÆÈ¢ò<br><br> ÁºñËæë vi &#x2F;etc&#x2F;ssh&#x2F;sshd_config<br><br> ÊâæÂà∞#StrictModes yesÊîπÊàêStrictModes no</li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li>ÊúâÂèØËÉΩÊòØPubkeyAuthenticationÈóÆÈ¢ò<br><br> ÁºñËæë vi &#x2F;etc&#x2F;ssh&#x2F;sshd_config<br><br> ÊâæÂà∞PubkeyAuthenticationÊîπÊàêyes</li>
</ol>
</blockquote>
<p>Â¶ÇÊûúËøò‰∏çË°åÔºåÂèØ‰ª•Âú®ÊúçÂä°Âô®A‰∏äÁî®ssh -vvv Êú∫Âô®BÁöÑip Êü•ÁúãËØ¶ÊÉÖÔºåÊ†πÊçÆËæìÂá∫ÂÜÖÂÆπÂÖ∑‰ΩìÈóÆÈ¢òÂÖ∑‰ΩìÂàÜÊûê‰∫Ü</p>
<p>ÂèÇËÄÉÈìæÊé•: <a target="_blank" rel="noopener" href="https://juejin.cn/s/ssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5%E5%8E%9F%E5%9B%A0">https://juejin.cn/s/ssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5%E5%8E%9F%E5%9B%A0</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/02/27/cmu15445-project3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/27/cmu15445-project3/" class="post-title-link" itemprop="url">cmu15445-project3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-27 19:38:43" itemprop="dateCreated datePublished" datetime="2024-02-27T19:38:43-08:00">2024-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-29 04:03:10" itemprop="dateModified" datetime="2024-02-29T04:03:10-08:00">2024-02-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cmu15445-2023/" itemprop="url" rel="index"><span itemprop="name">cmu15445-2023</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Query-Processing-Model"><a href="#Query-Processing-Model" class="headerlink" title="Query Processing Model"></a>Query Processing Model</h2><p>OLAP‰∏éOLTPÊï∞ÊçÆÂ∫ì</p>
<ul>
<li>OLAPÊï∞ÊçÆÂ∫ìÊû∂ÊûÑÂ∞ÜÊï∞ÊçÆËØªÂèñ‰ºòÂÖà‰∫éÊï∞ÊçÆÂÜôÂÖ•Êìç‰Ωú„ÄÇÂèØ‰ª•Âø´ÈÄüÂú∞ÂØπÂ§ßÈáèÊï∞ÊçÆÊâßË°åÂ§çÊùÇÁöÑÊü•ËØ¢</li>
<li>OLTPÊï∞ÊçÆÂ∫ìÊû∂ÊûÑÂ∞ÜÊï∞ÊçÆÂÜôÂÖ•‰ºòÂÖà‰∫éÊï∞ÊçÆËØªÂèñÊìç‰Ωú„ÄÇÂÆÉÈíàÂØπÂÜôÂÖ•ÂØÜÈõÜÂûãÂ∑•‰ΩúË¥üËΩΩËøõË°å‰∫Ü‰ºòÂåñ</li>
</ul>
<p>example:<br><br>‰ª•‰∏ÄÂÆ∂Â§ßÂûãÈõ∂ÂîÆÂÖ¨Âè∏‰∏∫‰æã„ÄÇËØ•ÂÖ¨Âè∏Êúâ‰∏Ä‰∏™Â∫ûÂ§ßÁöÑÊï∞ÊçÆÂ∫ìÔºåÁî®‰∫éË∑üË∏™ÈîÄÂîÆ„ÄÅÂ∫ìÂ≠ò„ÄÅÂÆ¢Êà∑Êï∞ÊçÆÁ≠â</p>
<ul>
<li>‰ΩøÁî®OLTPÊï∞ÊçÆÂ∫ìÂÆûÊó∂Â§ÑÁêÜ‰∫§Êòì„ÄÅÊõ¥Êñ∞Â∫ìÂ≠òÊ∞¥Âπ≥ÂíåÁÆ°ÁêÜÂÆ¢Êà∑Ë¥¶Êà∑</li>
<li>‰ΩøÁî®OLAPÊï∞ÊçÆÂ∫ìÊù•ÂàÜÊûêÊúâÂÖ≥ÈîÄÂîÆË∂ãÂäø„ÄÅÂ∫ìÂ≠òÊ∞¥Âπ≥„ÄÅÂÆ¢Êà∑‰∫∫Âè£ÁªüËÆ°Á≠â</li>
</ul>
<hr>
<p>DBMSÁöÑProcessing ModelÂÆö‰πâ‰∫ÜÁ≥ªÁªüÂ¶Ç‰ΩïÊâßË°å‰∏Ä‰∏™query plan,ÁõÆÂâç‰∏ªË¶ÅÊúâ‰∏âÁßçÊ®°Âûã</p>
<ul>
<li>Iterator Model</li>
<li>Materialization Model</li>
<li>Vectorized&#x2F;Batch Model</li>
</ul>
<h3 id="Iterator-Model"><a href="#Iterator-Model" class="headerlink" title="Iterator Model"></a>Iterator Model</h3><p>query plan ‰∏≠ÁöÑÊØèÊ≠• operator ÈÉΩÂÆûÁé∞‰∏Ä‰∏™ next ÂáΩÊï∞ÔºåÊØèÊ¨°Ë∞ÉÁî®Êó∂Ôºåoperator ËøîÂõû‰∏Ä‰∏™ tuple ÊàñËÄÖ nullÔºåÂêéËÄÖË°®Á§∫Êï∞ÊçÆÂ∑≤ÁªèÈÅçÂéÜÂÆåÊØï„ÄÇoperator Êú¨Ë∫´ÂÆûÁé∞‰∏Ä‰∏™Âæ™ÁéØÔºåÊØèÊ¨°Ë∞ÉÁî®ÂÖ∂ child operators ÁöÑ next ÂáΩÊï∞Ôºå‰ªéÂÆÉ‰ª¨ÈÇ£ËæπËé∑Âèñ‰∏ã‰∏ÄÊù°Êï∞ÊçÆ‰æõËá™Â∑±Êìç‰ΩúÔºåËøôÊ†∑Êï¥‰∏™ query plan Â∞±Ë¢´‰ªé‰∏äËá≥‰∏ãÂú∞‰∏≤ËÅîËµ∑Êù•ÔºåÂÆÉ‰πüÁß∞‰∏∫ Volcano&#x2F;Pipeline ModelÔºö<br><img src="/../images/cmu15445-project3/1.png" alt="img"><br>Iterator Âá†‰πéË¢´Áî®Âú®ÊØè‰∏™ DBMS ‰∏≠ÔºåÂåÖÊã¨ sqlite„ÄÅMySQL„ÄÅPostgreSQL Á≠âÁ≠âÔºåÂÖ∂ÂÆÉÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØ:</p>
<ul>
<li>Êúâ‰∫õ operators ‰ºöÁ≠âÂæÖ children ËøîÂõûÊâÄÊúâ tuples ÂêéÊâçÊâßË°åÔºåÂ¶Ç Joins, Subqueries Âíå Order By</li>
<li>Output Control Âú® Iterator Model ‰∏≠ÊØîËæÉÂÆπÊòìÔºåÂ¶Ç LimitÔºåÂè™ÊåâÈúÄË∞ÉÁî® next Âç≥ÂèØ</li>
</ul>
<h3 id="Materialization-Model"><a href="#Materialization-Model" class="headerlink" title="Materialization Model"></a>Materialization Model</h3><p>ÊØè‰∏™ operator Â§ÑÁêÜÂÆåÊâÄÊúâËæìÂÖ•ÂêéÔºåÂ∞ÜÊâÄÊúâÁªìÊûú‰∏ÄÊ¨°ÊÄßËæìÂá∫ÔºåDBMS ‰ºöÂ∞Ü‰∏Ä‰∫õÂèÇÊï∞‰º†ÈÄíÂà∞ operator ‰∏≠Èò≤Ê≠¢Â§ÑÁêÜËøáÂ§öÁöÑÊï∞ÊçÆÔºåËøôÊòØ‰∏ÄÁßç‰ªé‰∏ãËá≥‰∏äÁöÑÊÄùË∑ØÔºåÁ§∫ÊÑèÂ¶Ç‰∏ãÔºö<br><img src="/../images/cmu15445-project3/2.png" alt="img"><br>materialization modelÔºö</p>
<ul>
<li>Êõ¥ÈÄÇÂêà OLTP Âú∫ÊôØÔºåÂõ†‰∏∫ÂêéËÄÖÈÄöÂ∏∏ÊåáÈúÄË¶ÅÂ§ÑÁêÜÂ∞ëÈáèÁöÑ tuplesÔºåËøôÊ†∑ËÉΩÂáèÂ∞ë‰∏çÂøÖË¶ÅÁöÑÊâßË°å„ÄÅË∞ÉÂ∫¶ÊàêÊú¨</li>
<li>‰∏çÂ§™ÈÄÇÂêà‰ºö‰∫ßÁîüÂ§ßÈáè‰∏≠Èó¥ÁªìÊûúÁöÑ OLAP Êü•ËØ¢</li>
</ul>
<h3 id="Vectorization-Model"><a href="#Vectorization-Model" class="headerlink" title="Vectorization Model"></a>Vectorization Model</h3><p>Vectorization Model ÊòØ Iterator ‰∏é Materialization Model ÊäòË°∑ÁöÑ‰∏ÄÁßçÊ®°ÂûãÔºö</p>
<ul>
<li>ÊØè‰∏™ operator ÂÆûÁé∞‰∏Ä‰∏™ next ÂáΩÊï∞Ôºå‰ΩÜÊØèÊ¨° next Ë∞ÉÁî®ËøîÂõû‰∏ÄÊâπ tuplesÔºåËÄå‰∏çÊòØÂçï‰∏™ tuple</li>
<li>operator ÂÜÖÈÉ®ÁöÑÂæ™ÁéØÊØèÊ¨°‰πüÊòØ‰∏ÄÊâπ‰∏ÄÊâπ tuples Âú∞Â§ÑÁêÜ</li>
<li>batch ÁöÑÂ§ßÂ∞èÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅÊîπÂèòÔºàhardware„ÄÅquery properties)<br><br><img src="/../images/cmu15445-project3/3.png" alt="img"></li>
</ul>
<p>vectorization model ÊòØ OLAP Êü•ËØ¢ÁöÑÁêÜÊÉ≥Ê®°Âûã:</p>
<ul>
<li>ÊûÅÂ§ßÂú∞ÂáèÂ∞ëÊØè‰∏™ operator ÁöÑË∞ÉÁî®Ê¨°Êï∞</li>
<li>ÂÖÅËÆ∏ operators ‰ΩøÁî® vectorized instructions (SIMD) Êù•ÊâπÈáèÂ§ÑÁêÜ tuples</li>
</ul>
<h2 id="BACKGROUNDÔºöQUERY-PROCESSING"><a href="#BACKGROUNDÔºöQUERY-PROCESSING" class="headerlink" title="BACKGROUNDÔºöQUERY PROCESSING"></a>BACKGROUNDÔºöQUERY PROCESSING</h2><p>BusTubÊû∂ÊûÑÂ¶Ç‰∏ã<br><img src="/../images/cmu15445-project3/4.png" alt="img"></p>
<h3 id="note"><a href="#note" class="headerlink" title="note:"></a>note:</h3><ul>
<li>BusTubÂè™ÊîØÊåÅSQLÁöÑ‰∏Ä‰∏™Â∞èÂ≠êÈõÜÔºåÂèØ‰ª•ÈÄöËøátests&#x2F;sql‰∏≠ÁöÑSQLLogicTestÊñá‰ª∂Êù•Êü•ÁúãÂÆÉÊâÄÊîØÊåÅÁöÑSQLËØ≠Âè•</li>
<li>Â¶ÇÊûú‰Ω†‰ΩøÁî®ClionÊù•ËøêË°åBustub shellÔºåÊ∑ªÂä†‚Äìdisable-ttyÂèÇÊï∞</li>
<li>SQLËØ≠Âè•‰ΩøÁî®;ÁªìÂ∞æ</li>
<li>BusTubÂè™ÊîØÊåÅINTÂíåVARCHAR(n)Á±ªÂûãÔºåÂ≠óÁ¨¶‰∏≤‰ΩøÁî®ÂçïÂºïÂè∑</li>
<li>Bustub‰ΩøÁî®Iterator Porcessing Model</li>
</ul>
<h3 id="Inspecting-SQL-query-plans"><a href="#Inspecting-SQL-query-plans" class="headerlink" title="Inspecting SQL query plans"></a>Inspecting SQL query plans</h3><p>BusTubÊîØÊåÅEXPLAINÊù•ÊâìÂç∞SQLÊü•ËØ¢ËÆ°Âàí<br><img src="/../images/cmu15445-project3/5.png" alt="img"><br>EXPLAIN‰ºöÂ±ïÁ§∫query processingËøô‰∏ÄÂ±ÇÁöÑËΩ¨Êç¢ËøáÁ®ã Parser -&gt; Binder -&gt; Planner -&gt; Optimizer<br><br>ParserËß£ÊûêSQLËØ≠Âè•ÁîüÊàêBinder ASTËØ≠Ê≥ïÊ†ëÔºåÊé•ÁùÄÁîüÊàêquery planÔºåÁÑ∂ÂêéÁî±Optimizer‰ºòÂåñquery planÁîüÊàêexecutorÊ†ë</p>
<h2 id="Task-1-Access-Method-Executors"><a href="#Task-1-Access-Method-Executors" class="headerlink" title="Task#1 Access Method Executors"></a>Task#1 Access Method Executors</h2><p>Êàë‰ª¨Âπ∂‰∏çÈúÄË¶ÅÂÖ≥ÂøÉquery planÊòØÂ¶Ç‰ΩïÂàõÂª∫ÁöÑÔºõ‰ΩÜÊúâÂøÖË¶ÅÁêÜËß£query planÁöÑÁªÑÊàêÁªìÊûÑ:ËøôÊòØÊ£µÊ†ëÔºåÊØè‰∏™planËäÇÁÇπÈÉΩÂØπÂ∫îÂÖ∑‰ΩìÁöÑÁÆóÂ≠êÔºåBustubÈááÁî®iterator procesing modelÔºå‰πüÂ∞±ÊòØTop-to-BottomÁöÑÁÅ´Â±±Ê®°ÂûãÔºåÂõ†Ê≠§query planÁöÑÊâßË°åÂ∞±ÊòØ‰ªéÊ†πËäÇÁÇπÂºÄÂßãÔºåÂ∞ÜplanËäÇÁÇπËΩ¨Êç¢‰∏∫ÂØπÂ∫îÁöÑÁÆóÂ≠ê</p>
<p>PlanËäÇÁÇπÁöÑÁ±ªÂûãÂ¶Ç‰∏ã<br><img src="/../images/cmu15445-project3/6.png" alt="img"><br>ËøòÊòØÊúâÂøÖË¶ÅÈòÖËØª‰∏Ä‰∫õÁõ∏ÂÖ≥‰ª£Á†Å<br></p>
<p>Ë°®TableÁöÑÂÖÉ‰ø°ÊÅØ</p>
<blockquote>
<p>ÂÖ∂‰∏≠TableHeap‰ª£Ë°®Á£ÅÁõò‰∏äÁöÑ‰∏ÄÂº†Ë°®ÔºåÊòØ‰∏Ä‰∏™doubly-linked of pages</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TableInfo</span> &#123;</span><br><span class="line">  <span class="comment">/** The table schema */</span></span><br><span class="line">  Schema schema_;</span><br><span class="line">  <span class="comment">/** The table name */</span></span><br><span class="line">  <span class="type">const</span> std::string name_;</span><br><span class="line">  <span class="comment">/** An owning pointer to the table heap */</span></span><br><span class="line">  std::unique_ptr&lt;TableHeap&gt; table_;</span><br><span class="line">  <span class="comment">/** The table OID */</span></span><br><span class="line">  <span class="type">const</span> <span class="type">table_oid_t</span> oid_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TableHeap</span> &#123;</span><br><span class="line">  <span class="type">page_id_t</span> first_page_id_&#123;INVALID_PAGE_ID&#125;;</span><br><span class="line">  <span class="type">page_id_t</span> last_page_id_&#123;INVALID_PAGE_ID&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Á¥¢ÂºïIndexÁöÑÂÖÉ‰ø°ÊÅØ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">IndexInfo</span> &#123;</span><br><span class="line">  <span class="comment">/** The schema for the index key */</span></span><br><span class="line">  Schema key_schema_;</span><br><span class="line">  <span class="comment">/** The name of the index */</span></span><br><span class="line">  std::string name_;</span><br><span class="line">  <span class="comment">/** An owning pointer to the index */</span></span><br><span class="line">  std::unique_ptr&lt;Index&gt; index_;</span><br><span class="line">  <span class="comment">/** The unique OID for the index */</span></span><br><span class="line">  <span class="type">index_oid_t</span> index_oid_;</span><br><span class="line">  <span class="comment">/** The name of the table on which the index is created */</span></span><br><span class="line">  std::string table_name_;</span><br><span class="line">  <span class="comment">/** The size of the index key, in bytes */</span></span><br><span class="line">  <span class="type">const</span> <span class="type">size_t</span> key_size_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>catalog<br></p>
<blockquote>
<p>ËÆ∞ÂΩïÊâÄÊúâTableInfoÂíåIndexInfo</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Catalog</span> &#123;</span><br><span class="line">  std::unordered_map&lt;<span class="type">table_oid_t</span>, std::unique_ptr&lt;TableInfo&gt;&gt; tables_;</span><br><span class="line">  <span class="comment">/** Map table name -&gt; table identifiers. */</span></span><br><span class="line">  std::unordered_map&lt;std::string, <span class="type">table_oid_t</span>&gt; table_names_;</span><br><span class="line">  </span><br><span class="line">  std::unordered_map&lt;<span class="type">index_oid_t</span>, std::unique_ptr&lt;IndexInfo&gt;&gt; indexes_;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Map table name -&gt; index names -&gt; index identifiers. */</span></span><br><span class="line">  std::unordered_map&lt;std::string, std::unordered_map&lt;std::string, <span class="type">index_oid_t</span>&gt;&gt; index_names_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="SeqScanExecutorÂÆûÁé∞"><a href="#SeqScanExecutorÂÆûÁé∞" class="headerlink" title="SeqScanExecutorÂÆûÁé∞"></a>SeqScanExecutorÂÆûÁé∞</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Ê∑ªÂä†Êï∞ÊçÆÊàêÂëò</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SeqScanExecutor</span> &#123;</span><br><span class="line">  <span class="type">const</span> SeqScanPlanNode *plan_;<span class="comment">//ÂØπÂ∫îÁöÑSeqScanPlanNode</span></span><br><span class="line">  TableInfo *table_info_;<span class="comment">//Êâ´ÊèèÁöÑtable</span></span><br><span class="line">  std::unique_ptr&lt;TableIterator&gt; iterator_;<span class="comment">//TableIterator</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SeqScanExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> catalog = exec_ctx_-&gt;<span class="built_in">GetCatalog</span>();</span><br><span class="line">  table_info_ = catalog-&gt;<span class="built_in">GetTable</span>(plan_-&gt;table_oid_);<span class="comment">//Ëé∑ÂèñTableInfo</span></span><br><span class="line">  iterator_ = std::<span class="built_in">make_unique</span>&lt;TableIterator&gt;(table_info_-&gt;table_-&gt;<span class="built_in">MakeIterator</span>());<span class="comment">//Ëé∑ÂèñÂØπÂ∫îTableÁöÑTableIterator</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">SeqScanExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  std::pair&lt;TupleMeta, Tuple&gt; pair;</span><br><span class="line">  <span class="keyword">while</span> (!iterator_-&gt;<span class="built_in">IsEnd</span>()) &#123;<span class="comment">//Â¶ÇÊûúÊú™ÈÅçÂéÜÂÆåTable</span></span><br><span class="line">    pair = iterator_-&gt;<span class="built_in">GetTuple</span>();<span class="comment">//Ëé∑Âèñ‰∏Ä‰∏™TupleMeta-Tuple pair</span></span><br><span class="line">    <span class="keyword">if</span> (pair.first.is_deleted_) &#123;<span class="comment">//Â¶ÇÊûúËØ•TupleMetaÊ†áËÆ∞Tuple‰∏∫Â∑≤Âà†Èô§</span></span><br><span class="line">      ++(*iterator_);<span class="comment">//Ë∑≥Ëøá</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (plan_-&gt;filter_predicate_) &#123;<span class="comment">//Â¶ÇÊûúËØ•ÁÆóÂ≠êÂØπÂ∫îÁöÑSeqScanPlanNodeÂê´Êúâfilter_predicateË°®ËææÂºè</span></span><br><span class="line">      <span class="keyword">auto</span> res = plan_-&gt;filter_predicate_-&gt;<span class="built_in">Evaluate</span>(&amp;pair.second, table_info_-&gt;schema_);</span><br><span class="line">      <span class="keyword">if</span> (!(!res.<span class="built_in">IsNull</span>() &amp;&amp; res.<span class="built_in">GetAs</span>&lt;<span class="type">bool</span>&gt;())) &#123;<span class="comment">//Â¶ÇÊûúËØ•Tuple‰∏çÊª°Ë∂≥ËØ•filter_predicateË°®ËææÂºè</span></span><br><span class="line">        ++(*iterator_);<span class="comment">//Ë∑≥Ëøá</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++(*iterator_);<span class="comment">//Ëø≠‰ª£Âô®ÂâçËøõ‰∏ÄÊ≠•</span></span><br><span class="line">    *tuple = std::<span class="built_in">move</span>(pair.second);</span><br><span class="line">    *rid = tuple-&gt;<span class="built_in">GetRid</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="InsertExecutorÂÆûÁé∞"><a href="#InsertExecutorÂÆûÁé∞" class="headerlink" title="InsertExecutorÂÆûÁé∞"></a>InsertExecutorÂÆûÁé∞</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Ê∑ªÂä†Êï∞ÊçÆÊàêÂëò</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InsertExecutor</span> &#123;</span><br><span class="line">  <span class="type">const</span> InsertPlanNode *plan_;<span class="comment">//ÂØπÂ∫îÁöÑInsertPlanNode</span></span><br><span class="line">  <span class="type">bool</span> successful_;<span class="comment">//ÊòØÂê¶ÊèíÂÖ•ÊàêÂäü</span></span><br><span class="line">  TableInfo *table_info_;<span class="comment">//ÊèíÂÖ•ÁöÑTable</span></span><br><span class="line">  std::vector&lt;IndexInfo *&gt; index_infos_;<span class="comment">//ËØ•TableÂØπÂ∫îÁöÑIndexÔºåÂ¶ÇÊûúTableÂèòÊõ¥ÔºåÁ¥¢Âºï‰πüÈúÄÊõ¥Êîπ</span></span><br><span class="line">  std::unique_ptr&lt;AbstractExecutor&gt; child_executor_;<span class="comment">//‰∏Ä‰∏™Â≠©Â≠êexecutor</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">InsertExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  child_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  <span class="keyword">auto</span> cata_log = exec_ctx_-&gt;<span class="built_in">GetCatalog</span>();</span><br><span class="line">  table_info_ = cata_log-&gt;<span class="built_in">GetTable</span>(plan_-&gt;table_oid_);</span><br><span class="line">  index_infos_ = cata_log-&gt;<span class="built_in">GetTableIndexes</span>(table_info_-&gt;name_);</span><br><span class="line">  successful_ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">InsertExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  TupleMeta meta;</span><br><span class="line">  <span class="keyword">if</span> (successful_) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  meta.insert_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  meta.delete_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  meta.is_deleted_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">auto</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (child_executor_-&gt;<span class="built_in">Next</span>(tuple, rid)) &#123;<span class="comment">//‰ªéÂ≠©Â≠êexecutorËé∑Âèñtuple</span></span><br><span class="line">    <span class="keyword">auto</span> tuple_rid = table_info_-&gt;table_-&gt;<span class="built_in">InsertTuple</span>(meta, *tuple, exec_ctx_-&gt;<span class="built_in">GetLockManager</span>(), exec_ctx_-&gt;<span class="built_in">GetTransaction</span>(), table_info_-&gt;oid_);<span class="comment">//ÊèíÂÖ•Table</span></span><br><span class="line">    <span class="keyword">if</span> (tuple_rid == std::<span class="literal">nullopt</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Êõ¥Êñ∞ËØ•TableÁöÑÊâÄÊúâÁ¥¢ÂºïÁªìÊûÑ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> index_info : index_infos_) &#123;</span><br><span class="line">      <span class="keyword">auto</span> key = tuple-&gt;<span class="built_in">KeyFromTuple</span>(table_info_-&gt;schema_, index_info-&gt;key_schema_, index_info-&gt;index_-&gt;<span class="built_in">GetKeyAttrs</span>());</span><br><span class="line">      index_info-&gt;index_-&gt;<span class="built_in">InsertEntry</span>(key, *tuple_rid, exec_ctx_-&gt;<span class="built_in">GetTransaction</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    ++count;<span class="comment">//ÊèíÂÖ•ËÆ∞ÂΩïcount++</span></span><br><span class="line">  &#125;</span><br><span class="line">  std::vector&lt;Value&gt; values;</span><br><span class="line">  values.<span class="built_in">emplace_back</span>(TypeId::INTEGER, count);</span><br><span class="line">  *tuple = <span class="built_in">Tuple</span>(values, &amp;<span class="built_in">GetOutputSchema</span>());<span class="comment">//ÂÖ•ÂèÇtupleËøîÂõûÊèíÂÖ•ÁöÑËÆ∞ÂΩïÁöÑÊï∞Èáè</span></span><br><span class="line">  successful_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="UpdateExecutorÂÆûÁé∞"><a href="#UpdateExecutorÂÆûÁé∞" class="headerlink" title="UpdateExecutorÂÆûÁé∞"></a>UpdateExecutorÂÆûÁé∞</h3><blockquote>
<p>ËøôÈáåÂÆûÁé∞ÁöÑÊÄùË∑ØÂ∞±ÊòØÂ∞ÜÊóßÁöÑTupleÂà†Èô§ÔºåÊèíÂÖ•Êñ∞ÁöÑTuple</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Ê∑ªÂä†Êï∞ÊçÆÊàêÂëò</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UpdateExecutor</span> &#123;</span><br><span class="line">  <span class="type">const</span> UpdatePlanNode *plan_;<span class="comment">//ÂØπÂ∫îÁöÑUpdatePlanNode</span></span><br><span class="line">  <span class="comment">/** Metadata identifying the table that should be updated */</span></span><br><span class="line">  <span class="type">const</span> TableInfo *table_info_;<span class="comment">//Ë¶ÅupdateÁöÑtable</span></span><br><span class="line">  <span class="comment">/** The child executor to obtain value from */</span></span><br><span class="line">  std::unique_ptr&lt;AbstractExecutor&gt; child_executor_;<span class="comment">//Â≠©Â≠êexecutor</span></span><br><span class="line"></span><br><span class="line">  std::vector&lt;IndexInfo *&gt; index_infos_;<span class="comment">//ËØ•Table‰∏äÁöÑÊâÄÊúâindex</span></span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> successful_;<span class="comment">//Êõ¥Êñ∞ÊòØÂê¶ÊàêÂäü</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UpdateExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  child_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  successful_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">auto</span> cata_log = exec_ctx_-&gt;<span class="built_in">GetCatalog</span>();</span><br><span class="line">  table_info_ = cata_log-&gt;<span class="built_in">GetTable</span>(plan_-&gt;<span class="built_in">TableOid</span>());</span><br><span class="line">  index_infos_ = cata_log-&gt;<span class="built_in">GetTableIndexes</span>(table_info_-&gt;name_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">UpdateExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  TupleMeta tuple_meta;</span><br><span class="line">  <span class="keyword">if</span> (successful_) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  tuple_meta.delete_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  tuple_meta.insert_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  <span class="keyword">auto</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (child_executor_-&gt;<span class="built_in">Next</span>(tuple, rid)) &#123;<span class="comment">//‰ªéÂ≠©Â≠êexecutorÊãøÂà∞ÈúÄË¶ÅÊõ¥Êñ∞ÁöÑtuple</span></span><br><span class="line">    <span class="comment">// Âà†Èô§tuple</span></span><br><span class="line">    tuple_meta.is_deleted_ = <span class="literal">true</span>;</span><br><span class="line">    table_info_-&gt;table_-&gt;<span class="built_in">UpdateTupleMeta</span>(tuple_meta, *rid);<span class="comment">//Â∞ÜTable‰∏≠Áõ∏ÂêåridÁöÑTupleÊ†áËÆ∞‰∏∫Âà†Èô§</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> index_info : index_infos_) &#123;<span class="comment">//Â∞ÜTableÂØπÂ∫îÁöÑIndex‰∏≠‰∏éËØ•TupleÂØπÂ∫îÁöÑkeyÂà†Èô§</span></span><br><span class="line">      <span class="keyword">auto</span> key = tuple-&gt;<span class="built_in">KeyFromTuple</span>(table_info_-&gt;schema_, index_info-&gt;key_schema_, index_info-&gt;index_-&gt;<span class="built_in">GetKeyAttrs</span>());</span><br><span class="line">      index_info-&gt;index_-&gt;<span class="built_in">DeleteEntry</span>(key, *rid, exec_ctx_-&gt;<span class="built_in">GetTransaction</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ËÆ°ÁÆóÊñ∞ÁöÑtuple</span></span><br><span class="line">    std::vector&lt;Value&gt; values;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;expresssion : plan_-&gt;target_expressions_) &#123;</span><br><span class="line">      values.<span class="built_in">emplace_back</span>(expresssion-&gt;<span class="built_in">Evaluate</span>(tuple, child_executor_-&gt;<span class="built_in">GetOutputSchema</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> new_tuple = <span class="built_in">Tuple</span>(values, &amp;child_executor_-&gt;<span class="built_in">GetOutputSchema</span>());</span><br><span class="line">    <span class="comment">// ÊèíÂÖ•Êñ∞ÁöÑtuple</span></span><br><span class="line">    tuple_meta.is_deleted_ = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">auto</span> tuple_rid = table_info_-&gt;table_-&gt;<span class="built_in">InsertTuple</span>(tuple_meta, new_tuple, exec_ctx_-&gt;<span class="built_in">GetLockManager</span>(), exec_ctx_-&gt;<span class="built_in">GetTransaction</span>(), table_info_-&gt;oid_);</span><br><span class="line">    <span class="keyword">if</span> (tuple_rid == std::<span class="literal">nullopt</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> index_info : index_infos_) &#123;</span><br><span class="line">      <span class="keyword">auto</span> key = new_tuple.<span class="built_in">KeyFromTuple</span>(table_info_-&gt;schema_, index_info-&gt;key_schema_, index_info-&gt;index_-&gt;<span class="built_in">GetKeyAttrs</span>());</span><br><span class="line">      index_info-&gt;index_-&gt;<span class="built_in">InsertEntry</span>(key, *tuple_rid, exec_ctx_-&gt;<span class="built_in">GetTransaction</span>());<span class="comment">//IndexÊèíÂÖ•key</span></span><br><span class="line">    &#125;</span><br><span class="line">    ++count;</span><br><span class="line">  &#125;</span><br><span class="line">  std::vector&lt;Value&gt; values;</span><br><span class="line">  values.<span class="built_in">emplace_back</span>(TypeId::INTEGER, count);</span><br><span class="line">  *tuple = &#123;values, &amp;<span class="built_in">GetOutputSchema</span>()&#125;;<span class="comment">//ÂÖ•ÂèÇtupleËøîÂõûupdateÁöÑÂèÇÊï∞‰∏™Êï∞</span></span><br><span class="line">  successful_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DeleteExecutorÂÆûÁé∞"><a href="#DeleteExecutorÂÆûÁé∞" class="headerlink" title="DeleteExecutorÂÆûÁé∞"></a>DeleteExecutorÂÆûÁé∞</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DeleteExecutor</span> &#123;</span><br><span class="line">  <span class="type">const</span> DeletePlanNode *plan_;<span class="comment">//ÂØπÂ∫îÁöÑDeletePlanNode</span></span><br><span class="line">  <span class="comment">/** The child executor from which RIDs for deleted tuples are pulled */</span></span><br><span class="line">  std::unique_ptr&lt;AbstractExecutor&gt; child_executor_;<span class="comment">//Â≠©Â≠êDeleteExecutor</span></span><br><span class="line">  <span class="type">bool</span> successful_;<span class="comment">//Âà§Êñ≠Âà†Èô§ÊòØÂê¶ÊàêÂäü</span></span><br><span class="line">  TableInfo *table_info_;<span class="comment">//Âà†Èô§ÁöÑTable</span></span><br><span class="line">  std::vector&lt;IndexInfo *&gt; index_infos_;<span class="comment">//TableÂØπÂ∫îÁöÑÊâÄÊúâIndex</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DeleteExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  child_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  successful_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">auto</span> catalog = exec_ctx_-&gt;<span class="built_in">GetCatalog</span>();</span><br><span class="line">  table_info_ = catalog-&gt;<span class="built_in">GetTable</span>(plan_-&gt;<span class="built_in">TableOid</span>());</span><br><span class="line">  index_infos_ = catalog-&gt;<span class="built_in">GetTableIndexes</span>(table_info_-&gt;name_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">DeleteExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  TupleMeta tuple_meta;</span><br><span class="line">  <span class="keyword">if</span> (successful_) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  tuple_meta.delete_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  tuple_meta.insert_txn_id_ = INVALID_TXN_ID;</span><br><span class="line">  tuple_meta.is_deleted_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">auto</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (child_executor_-&gt;<span class="built_in">Next</span>(tuple, rid)) &#123;<span class="comment">//‰ªéÂ≠©Â≠êËäÇÁÇπËé∑Âèñtuple</span></span><br><span class="line">    table_info_-&gt;table_-&gt;<span class="built_in">UpdateTupleMeta</span>(tuple_meta, *rid);<span class="comment">//Âà†Èô§Table‰∏≠ÂØπÂ∫îÁöÑTupleÔºåÊ†áËÆ∞‰∏∫Âà†Èô§</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> index_info : index_infos_) &#123;<span class="comment">//Âà†Èô§ËØ•Table‰∏äÊâÄÊúâIndex‰∏≠‰∏éËØ•TupleÂØπÂ∫îÁöÑkey</span></span><br><span class="line">      <span class="keyword">auto</span> key = tuple-&gt;<span class="built_in">KeyFromTuple</span>(table_info_-&gt;schema_, index_info-&gt;key_schema_, index_info-&gt;index_-&gt;<span class="built_in">GetKeyAttrs</span>());</span><br><span class="line">      index_info-&gt;index_-&gt;<span class="built_in">DeleteEntry</span>(key, *rid, exec_ctx_-&gt;<span class="built_in">GetTransaction</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    count++;<span class="comment">//Âà†Èô§ËÆ°Êï∞count++</span></span><br><span class="line">  &#125;</span><br><span class="line">  std::vector&lt;Value&gt; values;</span><br><span class="line">  values.<span class="built_in">emplace_back</span>(TypeId::INTEGER, count);</span><br><span class="line">  *tuple = <span class="built_in">Tuple</span>(values, &amp;<span class="built_in">GetOutputSchema</span>());<span class="comment">//ÂÖ•ÂèÇtupleËøîÂõûÂà†Èô§ÁöÑtupleÊï∞Èáè</span></span><br><span class="line">  successful_ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IndexScanExecutorÂÆûÁé∞"><a href="#IndexScanExecutorÂÆûÁé∞" class="headerlink" title="IndexScanExecutorÂÆûÁé∞"></a>IndexScanExecutorÂÆûÁé∞</h3><p>SELECT FROM <table> ORDER BY <index column>‰∏≠ÁöÑORDER BY‰ºöË¢´ËΩ¨‰∏∫IndexScan<br></index></table></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Ê∑ªÂä†Êï∞ÊçÆÊàêÂëò</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IndexScanExecutor</span> &#123;</span><br><span class="line">  <span class="type">const</span> IndexScanPlanNode *plan_;<span class="comment">//ÂØπÂ∫îÁöÑIndexScanPlanNode</span></span><br><span class="line">  IndexInfo *index_info_;<span class="comment">//IndexInfo</span></span><br><span class="line">  TableInfo *table_info_;<span class="comment">//TableInfo</span></span><br><span class="line">  BPlusTreeIndexForTwoIntegerColumn *index_;<span class="comment">//Êâ´ÊèèÁöÑIndex</span></span><br><span class="line">  std::unique_ptr&lt;BPlusTreeIndexIteratorForTwoIntegerColumn&gt; index_iterator_;<span class="comment">//Êâ´ÊèèÁöÑIndexÁöÑIndexIterator</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IndexScanExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> catalog = exec_ctx_-&gt;<span class="built_in">GetCatalog</span>();</span><br><span class="line">  index_info_ = catalog-&gt;<span class="built_in">GetIndex</span>(plan_-&gt;index_oid_);<span class="comment">//Ëé∑ÂèñÂØπÂ∫îÁöÑIndex_Info</span></span><br><span class="line">  table_info_ = catalog-&gt;<span class="built_in">GetTable</span>(index_info_-&gt;table_name_);<span class="comment">//Ëé∑ÂèñÂØπÂ∫îÁöÑTable_Info</span></span><br><span class="line">  index_ = <span class="built_in">dynamic_cast</span>&lt;BPlusTreeIndexForTwoIntegerColumn *&gt;(index_info_-&gt;index_.<span class="built_in">get</span>());</span><br><span class="line">  index_iterator_ = std::<span class="built_in">make_unique</span>&lt;BPlusTreeIndexIteratorForTwoIntegerColumn&gt;(index_-&gt;<span class="built_in">GetBeginIterator</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">IndexScanExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (!index_iterator_-&gt;<span class="built_in">IsEnd</span>()) &#123;<span class="comment">//ÈÅçÂéÜIndex</span></span><br><span class="line">    <span class="keyword">auto</span> map = *(*index_iterator_);</span><br><span class="line">    *rid = map.second;<span class="comment">//ÊãøÂà∞rid</span></span><br><span class="line">    <span class="keyword">if</span> (!table_info_-&gt;table_-&gt;<span class="built_in">GetTupleMeta</span>(*rid).is_deleted_) &#123;  <span class="comment">// Êú™Ë¢´Âà†Èô§</span></span><br><span class="line">      index_iterator_-&gt;<span class="keyword">operator</span>++();</span><br><span class="line">      *tuple = table_info_-&gt;table_-&gt;<span class="built_in">GetTuple</span>(*rid).second;<span class="comment">//ÂÖ•ÂèÇtupleËøîÂõûridÊåáÂêëÁöÑtuple</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    index_iterator_-&gt;<span class="keyword">operator</span>++();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ËøôÈáåÈÄöËøáSQLLogicTests#1 to #6<br><img src="/../images/cmu15445-project3/10.png" alt="img"><br><img src="/../images/cmu15445-project3/11.png" alt="img"><br><img src="/../images/cmu15445-project3/12.png" alt="img"><br><img src="/../images/cmu15445-project3/13.png" alt="img"><br><img src="/../images/cmu15445-project3/14.png" alt="img"><br><img src="/../images/cmu15445-project3/15.png" alt="img"></p>
<h2 id="Task-2-Aggregation-Join-Executors"><a href="#Task-2-Aggregation-Join-Executors" class="headerlink" title="Task#2 Aggregation &amp; Join Executors"></a>Task#2 Aggregation &amp; Join Executors</h2><h3 id="AggregationExecutorÂÆûÁé∞"><a href="#AggregationExecutorÂÆûÁé∞" class="headerlink" title="AggregationExecutorÂÆûÁé∞"></a>AggregationExecutorÂÆûÁé∞</h3><blockquote>
<p>AggregationExecutorÁî®Êù•ÊîØÊåÅ‰ª•‰∏ãÁöÑsqlÊü•ËØ¢ÔºåÁ¨¨ÂõõÊù°sqlËØ≠Âè•ÁöÑDISTINCTÁõ∏ÂΩì‰∫éGROUP BY<br><br>AggregationExecutor‰∏çÈúÄË¶ÅÂ§ÑÁêÜHAVINGËØ≠Âè•Ôºåplanner‰ºöËÆ©AggregationPlanNodeË∑üÁùÄ‰∏Ä‰∏™FilterPlanNode<br><img src="/../images/cmu15445-project3/7.png" alt="img"></p>
</blockquote>
<p>Ë°•ÂÖÖÂÆåÊàêSimpleAggregationHashTableÔºåÂÖ∂‰∏≠ÂìàÂ∏åË°®ÁöÑÈîÆAggregateKeyÂ∞±ÊòØGROUP BYÁöÑcolumns<br></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleAggregationHashTable</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">/** The hash table is just a map from aggregate keys to aggregate values */</span></span><br><span class="line">  std::unordered_map&lt;AggregateKey, AggregateValue&gt; ht_&#123;&#125;;</span><br><span class="line">  <span class="comment">/** The aggregate expressions that we have */</span></span><br><span class="line">  <span class="type">const</span> std::vector&lt;AbstractExpressionRef&gt; &amp;agg_exprs_;</span><br><span class="line">  <span class="comment">/** The types of aggregations that we have */</span></span><br><span class="line">  <span class="type">const</span> std::vector&lt;AggregationType&gt; &amp;agg_types_;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">auto</span> <span class="title">GenerateInitialAggregateValue</span><span class="params">()</span> -&gt; AggregateValue </span>&#123;</span><br><span class="line">    std::vector&lt;Value&gt; values&#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp;agg_type : agg_types_) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (agg_type) &#123;</span><br><span class="line">        <span class="keyword">case</span> AggregationType::CountStarAggregate:</span><br><span class="line">          <span class="comment">// Count start starts at zero.</span></span><br><span class="line">          values.<span class="built_in">emplace_back</span>(ValueFactory::<span class="built_in">GetIntegerValue</span>(<span class="number">0</span>));</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AggregationType::CountAggregate:</span><br><span class="line">        <span class="keyword">case</span> AggregationType::SumAggregate:</span><br><span class="line">        <span class="keyword">case</span> AggregationType::MinAggregate:</span><br><span class="line">        <span class="keyword">case</span> AggregationType::MaxAggregate:</span><br><span class="line">          <span class="comment">// Others starts at null.</span></span><br><span class="line">          values.<span class="built_in">emplace_back</span>(ValueFactory::<span class="built_in">GetNullValueByType</span>(TypeId::INTEGER));</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;values&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">CombineAggregateValues</span><span class="params">(AggregateValue *result, <span class="type">const</span> AggregateValue &amp;input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; agg_exprs_.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (agg_types_[i]) &#123;</span><br><span class="line">        <span class="keyword">case</span> AggregationType::CountStarAggregate:<span class="comment">//count(*)ÁªüËÆ°nullÊï∞Èáè</span></span><br><span class="line">          result-&gt;aggregates_[i] = &#123;INTEGER, result-&gt;aggregates_[i].<span class="built_in">GetAs</span>&lt;<span class="type">int32_t</span>&gt;() + <span class="number">1</span>&#125;;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AggregationType::CountAggregate:<span class="comment">//count()‰∏çÁªüËÆ°nullÊï∞Èáè</span></span><br><span class="line">          <span class="keyword">if</span> (input.aggregates_[i].<span class="built_in">IsNull</span>()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (result-&gt;aggregates_[i].<span class="built_in">IsNull</span>()) &#123;</span><br><span class="line">            result-&gt;aggregates_[i] = &#123;INTEGER, <span class="number">1</span>&#125;;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result-&gt;aggregates_[i] = &#123;INTEGER, result-&gt;aggregates_[i].<span class="built_in">GetAs</span>&lt;<span class="type">int32_t</span>&gt;() + <span class="number">1</span>&#125;;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AggregationType::SumAggregate:</span><br><span class="line">          <span class="keyword">if</span> (input.aggregates_[i].<span class="built_in">IsNull</span>()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (result-&gt;aggregates_[i].<span class="built_in">IsNull</span>()) &#123;</span><br><span class="line">            result-&gt;aggregates_[i] = input.aggregates_[i];</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result-&gt;aggregates_[i] = result-&gt;aggregates_[i].<span class="built_in">Add</span>((input.aggregates_[i]));</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AggregationType::MinAggregate:</span><br><span class="line">          <span class="keyword">if</span> (input.aggregates_[i].<span class="built_in">IsNull</span>()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (result-&gt;aggregates_[i].<span class="built_in">IsNull</span>()) &#123;</span><br><span class="line">            result-&gt;aggregates_[i] = input.aggregates_[i];</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result-&gt;aggregates_[i] = result-&gt;aggregates_[i].<span class="built_in">Min</span>(input.aggregates_[i]);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AggregationType::MaxAggregate:</span><br><span class="line">          <span class="keyword">if</span> (input.aggregates_[i].<span class="built_in">IsNull</span>()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (result-&gt;aggregates_[i].<span class="built_in">IsNull</span>()) &#123;</span><br><span class="line">            result-&gt;aggregates_[i] = input.aggregates_[i];</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result-&gt;aggregates_[i] = result-&gt;aggregates_[i].<span class="built_in">Max</span>(input.aggregates_[i]);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">InsertCombine</span><span class="params">(<span class="type">const</span> AggregateKey &amp;agg_key, <span class="type">const</span> AggregateValue &amp;agg_val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ht_.<span class="built_in">count</span>(agg_key) == <span class="number">0</span>) &#123;</span><br><span class="line">      ht_.<span class="built_in">insert</span>(&#123;agg_key, <span class="built_in">GenerateInitialAggregateValue</span>()&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CombineAggregateValues</span>(&amp;ht_[agg_key], agg_val);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Insert</span><span class="params">(<span class="type">const</span> AggregateKey &amp;agg_key, <span class="type">const</span> AggregateValue &amp;agg_val)</span> </span>&#123; ht_.<span class="built_in">insert</span>(&#123;agg_key, agg_val&#125;); &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AggregationExecutor</span> &#123;</span><br><span class="line">  <span class="comment">// Ê∑ªÂä†Êï∞ÊçÆÊàêÂëò</span></span><br><span class="line">  <span class="type">const</span> AggregationPlanNode *plan_;</span><br><span class="line">  <span class="comment">/** The child executor that produces tuples over which the aggregation is computed */</span></span><br><span class="line">  std::unique_ptr&lt;AbstractExecutor&gt; child_;</span><br><span class="line">  <span class="comment">/** Simple aggregation hash table */</span></span><br><span class="line">  SimpleAggregationHashTable aht_;</span><br><span class="line">  <span class="comment">/** Simple aggregation hash table iterator */</span></span><br><span class="line">  std::unique_ptr&lt;SimpleAggregationHashTable::Iterator&gt; aht_iterator_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AggregationExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  child_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  Tuple tuple;</span><br><span class="line">  RID rid;</span><br><span class="line">  <span class="keyword">while</span> (child_-&gt;<span class="built_in">Next</span>(&amp;tuple, &amp;rid)) &#123;<span class="comment">//ÈÅçÂéÜÂ≠©Â≠êexecutor‰∏≠ÊâÄÊúâÁöÑtuple</span></span><br><span class="line">    <span class="comment">//ÊûÑÂª∫AggregateKey Âíå AggregateValue ÊèíÂÖ•ÂìàÂ∏åË°®</span></span><br><span class="line">    AggregateKey key = <span class="built_in">MakeAggregateKey</span>(&amp;tuple);</span><br><span class="line">    AggregateValue value = <span class="built_in">MakeAggregateValue</span>(&amp;tuple);</span><br><span class="line">    aht_.<span class="built_in">InsertCombine</span>(key, value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (aht_.<span class="built_in">Begin</span>() == aht_.<span class="built_in">End</span>() &amp;&amp; plan_-&gt;<span class="built_in">GetGroupBys</span>().<span class="built_in">empty</span>()) &#123;  <span class="comment">// hashË°®‰∏∫Á©∫,</span></span><br><span class="line">    AggregateKey key;</span><br><span class="line">    aht_.<span class="built_in">Insert</span>(key, aht_.<span class="built_in">GenerateInitialAggregateValue</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  aht_iterator_ = std::<span class="built_in">make_unique</span>&lt;SimpleAggregationHashTable::Iterator&gt;(aht_.<span class="built_in">Begin</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">AggregationExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ((*aht_iterator_) == aht_.<span class="built_in">End</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> key = aht_iterator_-&gt;<span class="built_in">Key</span>();</span><br><span class="line">  <span class="keyword">auto</span> value = aht_iterator_-&gt;<span class="built_in">Val</span>();</span><br><span class="line">  ++(*aht_iterator_);<span class="comment">//Ëø≠‰ª£Âô®++</span></span><br><span class="line">  key.group_bys_.<span class="built_in">insert</span>(key.group_bys_.<span class="built_in">end</span>(), value.aggregates_.<span class="built_in">begin</span>(), value.aggregates_.<span class="built_in">end</span>());</span><br><span class="line">  *tuple = &#123;key.group_bys_, &amp;<span class="built_in">GetOutputSchema</span>()&#125;;<span class="comment">//keyÂíåvalueÂêàÂπ∂ÂêéÁî±ÂÖ•ÂèÇtupleËøîÂõû</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="NestedLoopJoinExecutorÂÆûÁé∞"><a href="#NestedLoopJoinExecutorÂÆûÁé∞" class="headerlink" title="NestedLoopJoinExecutorÂÆûÁé∞"></a>NestedLoopJoinExecutorÂÆûÁé∞</h3><p>NestedLoopJoinExecutorÂ∞ÜÊîØÊåÅinner joinÂíåleft joinÔºå‰ΩøÁî®simple nested loop joinÁÆóÊ≥ï<br><img src="/../images/cmu15445-project3/8.png" alt="img"></p>
<h4 id="NestedLoopJoinÊòØÊµÅÊ∞¥Á∫øÁ†¥ÂùèËÄÖÂêóÔºü"><a href="#NestedLoopJoinÊòØÊµÅÊ∞¥Á∫øÁ†¥ÂùèËÄÖÂêóÔºü" class="headerlink" title="NestedLoopJoinÊòØÊµÅÊ∞¥Á∫øÁ†¥ÂùèËÄÖÂêóÔºü"></a>NestedLoopJoinÊòØÊµÅÊ∞¥Á∫øÁ†¥ÂùèËÄÖÂêóÔºü</h4><p>BusTubÈááÁî®ÁÅ´Â±±Ê®°Âûã(iterator processing<br> model)ÊâßË°åÁÆóÂ≠ê„ÄÇ‰ΩÜÊòØÊüê‰∫õÁÆóÂ≠êÁõ¥Âà∞Â≠êÁÆóÂ≠êÊèê‰∫§ÊâÄÊúâÂÖÉÁªÑÁöÑËÆ°ÁÆóÁªìÊûúÔºåÊâç‰ºöËß£Èô§ÈòªÂ°û„ÄÇÂ¶ÇJoin„ÄÅSubQueries„ÄÅOrderingÁ≠âÔºåÊ≠§Á±ªÊìç‰ΩúÂ∞±Ë¢´Áß∞‰∏∫Pipeline Breaker„ÄÇÂú®Task2‰∏≠ÔºåAggregation„ÄÅHashJoinÈÉΩÂ§áÊ≥®‰∫ÜÊòØPipeline BreakerÔºå‰ΩÜNestedLoopJoinÂπ∂Ê≤°ÊúâËøô‰πàËØ¥ÊòéÔºåÂ¶ÇÊûúÊääÂÆÉÂΩìÂÅöPipeline BreakerÔºåÂàôÊó†Ê≥ïÈÄöËøáÊµãËØïÔºåSpring2023Ë¶ÅÊ±ÇNestedLoopJoinÂ∑¶Â≠êËäÇÁÇπÊØèÊ¨°Ë∞ÉÁî®‰∏ÄÊ¨°Next()ÊñπÊ≥ï,Âè≥Â≠êËäÇÁÇπÈÉΩÈúÄË¶ÅInit()‰∏ÄÊ¨°ÔºåÂõ†Ê≠§Âπ∂ÈùûPipeline Breaker„ÄÇËøô‰πüÊÑèÂë≥ÁùÄNestedLoopJoinÁöÑÊÄßËÉΩÈùûÂ∏∏Á≥üÁ≥ï„ÄÇ</p>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NestedLoopJoinExecutor</span> &#123; </span><br><span class="line">  <span class="type">const</span> NestedLoopJoinPlanNode *plan_;</span><br><span class="line">  std::unique_ptr&lt;AbstractExecutor&gt; left_executor_;<span class="comment">//Â∑¶Â≠©Â≠ê</span></span><br><span class="line">  std::unique_ptr&lt;AbstractExecutor&gt; right_executor_;<span class="comment">//Âè≥Â≠©Â≠ê</span></span><br><span class="line">  std::vector&lt;Tuple&gt; right_tuples_;</span><br><span class="line">  <span class="type">int</span> index_;</span><br><span class="line">  Tuple left_tuple_;</span><br><span class="line">  <span class="type">bool</span> is_match_;<span class="comment">//Ë°®Á§∫ÂΩìÂâçleft_tuple_ÊòØÂê¶ÊúâÂåπÈÖçÈ°π</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NestedLoopJoinExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  left_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  right_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  Tuple right_tuple;</span><br><span class="line">  RID right_rid;</span><br><span class="line">  <span class="comment">//Â∞ÜÂè≥Â≠©Â≠êÁöÑÊâÄÊúâTupleÈÅçÂéÜÂá∫Êù•ÊîæÂú®right_tuples‰∏≠</span></span><br><span class="line">  <span class="keyword">while</span> (right_executor_-&gt;<span class="built_in">Next</span>(&amp;right_tuple, &amp;right_rid)) &#123;</span><br><span class="line">    right_tuples_.<span class="built_in">emplace_back</span>(right_tuple);</span><br><span class="line">  &#125;</span><br><span class="line">  index_ = <span class="number">0</span>;</span><br><span class="line">  is_match_ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">NestedLoopJoinExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  RID left_rid;</span><br><span class="line">  <span class="keyword">if</span> (index_ != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// ‰∏äÊ¨°Âè≥‰æßÂæ™ÁéØËøòÊú™ÁªìÊùü</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NestedLoop</span>(tuple, rid)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//Ëé∑ÂèñÂ∑¶Â≠©Â≠êÁöÑ‰∏Ä‰∏™tupleÂ≠òÂÇ®Âú®left_tuple_‰∏≠</span></span><br><span class="line">  <span class="keyword">while</span> (left_executor_-&gt;<span class="built_in">Next</span>(&amp;left_tuple_, &amp;left_rid)) &#123;</span><br><span class="line">    right_executor_-&gt;<span class="built_in">Init</span>();  <span class="comment">// no use ÂçïÁ∫Ø‰∏∫‰∫ÜÈÄöËøáÊµãËØï</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NestedLoop</span>(tuple, rid)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">NestedLoopJoinExecutor::NestedLoop</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (index_ &lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(right_tuples_.<span class="built_in">size</span>())) &#123;</span><br><span class="line">    <span class="keyword">if</span> (plan_-&gt;predicate_) &#123;</span><br><span class="line">      <span class="keyword">auto</span> res = plan_-&gt;predicate_-&gt;<span class="built_in">EvaluateJoin</span>(&amp;left_tuple_, left_executor_-&gt;<span class="built_in">GetOutputSchema</span>(), &amp;right_tuples_[index_], right_executor_-&gt;<span class="built_in">GetOutputSchema</span>());</span><br><span class="line">      <span class="keyword">if</span> (!(!res.<span class="built_in">IsNull</span>() &amp;&amp; res.<span class="built_in">GetAs</span>&lt;<span class="type">bool</span>&gt;())) &#123;  <span class="comment">// ‰∏çÁ¨¶ÂêàÊù°‰ª∂</span></span><br><span class="line">        index_++;</span><br><span class="line">        <span class="keyword">continue</span>;  <span class="comment">// ËøáÊª§</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Á¨¶ÂêàÊù°‰ª∂</span></span><br><span class="line">    <span class="built_in">MergeTuple</span>(tuple);</span><br><span class="line">    index_ = (index_ + <span class="number">1</span>) % right_tuples_.<span class="built_in">size</span>();</span><br><span class="line">    is_match_ = (index_ != <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  index_ = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (!is_match_ &amp;&amp; plan_-&gt;<span class="built_in">GetJoinType</span>() == JoinType::LEFT) &#123;</span><br><span class="line">    <span class="comment">// left join</span></span><br><span class="line">    std::vector&lt;Value&gt; values;</span><br><span class="line">    values.<span class="built_in">reserve</span>(<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(left_executor_-&gt;<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>()); ++i) &#123;</span><br><span class="line">      values.<span class="built_in">emplace_back</span>(left_tuple_.<span class="built_in">GetValue</span>(&amp;left_executor_-&gt;<span class="built_in">GetOutputSchema</span>(), i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(right_executor_-&gt;<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>()); ++i) &#123;</span><br><span class="line">      values.<span class="built_in">emplace_back</span>(ValueFactory::<span class="built_in">GetNullValueByType</span>(right_executor_-&gt;<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumn</span>(i).<span class="built_in">GetType</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">    *tuple = &#123;values, &amp;<span class="built_in">GetOutputSchema</span>()&#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  is_match_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">NestedLoopJoinExecutor::MergeTuple</span><span class="params">(Tuple *tuple)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// inner join</span></span><br><span class="line">  std::vector&lt;Value&gt; values;</span><br><span class="line">  values.<span class="built_in">reserve</span>(<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>());</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(left_executor_-&gt;<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>()); ++i) &#123;</span><br><span class="line">    values.<span class="built_in">emplace_back</span>(left_tuple_.<span class="built_in">GetValue</span>(&amp;left_executor_-&gt;<span class="built_in">GetOutputSchema</span>(), i));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(right_executor_-&gt;<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>()); ++i) &#123;</span><br><span class="line">    values.<span class="built_in">emplace_back</span>(right_tuples_[index_].<span class="built_in">GetValue</span>(&amp;right_executor_-&gt;<span class="built_in">GetOutputSchema</span>(), i));</span><br><span class="line">  &#125;</span><br><span class="line">  *tuple = &#123;values, &amp;<span class="built_in">GetOutputSchema</span>()&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Âà∞ËøôÈáå‰∏∫Ê≠¢ÔºåÈÄöËøáSQLLogicTests #7 to #12<br><img src="/../images/cmu15445-project3/16.png" alt="img"><br><img src="/../images/cmu15445-project3/17.png" alt="img"><br><img src="/../images/cmu15445-project3/18.png" alt="img"><br><img src="/../images/cmu15445-project3/19.png" alt="img"><br><img src="/../images/cmu15445-project3/20.png" alt="img"><br><img src="/../images/cmu15445-project3/21.png" alt="img"></p>
<h3 id="HashJoinExecutorÂÆûÁé∞"><a href="#HashJoinExecutorÂÆûÁé∞" class="headerlink" title="HashJoinExecutorÂÆûÁé∞"></a>HashJoinExecutorÂÆûÁé∞</h3><p> ‰Ω†Â∞ÜË¶Å‰∏∫HashJoinExecutorÂÆûÁé∞inner joinÂíåleft joinÔºå‰ΩøÁî®hash joinÁÆóÊ≥ï<br> <img src="/../images/cmu15445-project3/9.png" alt="img"><br> ÂíåNestedLoopJoinÁõ∏ÂêåÔºåHashJoinË¶ÅÂ§ÑÁêÜinner joinÂíåleft join‰∏§ÁßçÊÉÖÂÜµÔºåËÄåËøôÂ∞±‰ºöÂΩ±ÂìçHashJoinÂª∫Ë°®ÁöÑÈÄâÊã©‚Äî‚Äî‚ÄîÂØπ‰∫éLeft joinÔºåÈúÄË¶ÅÂú®Âè≥Ë°®‰∏çÂ≠òÂú®ÂØπÂ∫îÂåπÈÖçÊó∂ÔºåËøîÂõûÂ∞ÜÂè≥Ë°®Â≠óÊÆµÁî®NULLÂ°´ÂÖÖÁöÑËÆ∞ÂΩï„ÄÇÂõ†Ê≠§ÂØπLeft JoinÔºåÂú®ÂàõÂª∫ÂìàÂ∏åË°®Êó∂Â∫îËØ•ÈÄâÊã©Âè≥Ë°®„ÄÇ</p>
<p>ÂÆûÁé∞ÊÄùË∑ØÔºö<br><br>ÂÖàÈÅçÂéÜÂè≥Ë°®ÁöÑÊâÄÊúâtupleÔºåÊî∂ÈõÜÂè≥Ë°®ÁöÑHashJoinKeyÔºåÂä†ÂÖ•ÂìàÂ∏åË°®(ÈîÆÂÄºÂØπ‰∏∫HashJoinKey-tuple)<br><br>ÁÑ∂ÂêéÈÅçÂéÜÂ∑¶Ë°®ÁöÑÊâÄÊúâtupleÔºåÊî∂ÈõÜÂ∑¶Ë°®ÁöÑHashJoinKeyÔºåÂú®ÂìàÂ∏åË°®‰∏≠Êü•ÊâæÊòØÂê¶ÊúâÂåπÈÖçÁöÑHashJoinKeyÔºåÂ¶ÇÊûúÂåπÈÖçÊàêÂäüÔºåÊãºÊé•<br><br>Â¶ÇÊûúÂåπÈÖçÂ§±Ë¥•ÔºåÂπ∂‰∏îÊòØleft joinÔºåÂ∑¶Ë°®ÁöÑtupleÊãºÊé•null<br><br>ÊãºÊé•Â•ΩÁöÑÁªìÊûú‰øùÂ≠òÂú®result_‰∏≠ÔºåÁî±index_‰∏ãÊ†áÈÅçÂéÜ<br></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">class</span> <span class="title class_">HashJoinExecutor</span> &#123;</span><br><span class="line">  <span class="type">const</span> HashJoinPlanNode *plan_;</span><br><span class="line">  std::unique_ptr&lt;AbstractExecutor&gt; left_child_;</span><br><span class="line">  std::unique_ptr&lt;AbstractExecutor&gt; right_child_;</span><br><span class="line">  std::unordered_map&lt;HashJoinKey, std::vector&lt;Tuple&gt;&gt; map_;</span><br><span class="line">  std::vector&lt;Tuple&gt; result_;</span><br><span class="line">  <span class="type">int</span> index_;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="type">void</span> <span class="title">HashJoinExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  left_child_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  right_child_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  Tuple right_tuple;</span><br><span class="line">  RID right_rid;</span><br><span class="line">  <span class="keyword">while</span> (right_child_-&gt;<span class="built_in">Next</span>(&amp;right_tuple, &amp;right_rid)) &#123;</span><br><span class="line">    HashJoinKey key;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;expression : plan_-&gt;<span class="built_in">RightJoinKeyExpressions</span>()) &#123;</span><br><span class="line">      key.column_values_.<span class="built_in">emplace_back</span>(expression-&gt;<span class="built_in">Evaluate</span>(&amp;right_tuple, right_child_-&gt;<span class="built_in">GetOutputSchema</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Âä†ÂÖ•ÂìàÂ∏åË°®</span></span><br><span class="line">    <span class="keyword">if</span> (map_.<span class="built_in">count</span>(key) != <span class="number">0</span>) &#123;</span><br><span class="line">      map_[key].<span class="built_in">emplace_back</span>(right_tuple);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      map_[key] = &#123;right_tuple&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ÈÅçÂéÜÂ∑¶‰æßÊü•ËØ¢,ÂæóÂà∞Êü•ËØ¢ÁªìÊûú</span></span><br><span class="line">  Tuple left_tuple;</span><br><span class="line">  RID left_rid;</span><br><span class="line">  <span class="keyword">while</span> (left_child_-&gt;<span class="built_in">Next</span>(&amp;left_tuple, &amp;left_rid)) &#123;</span><br><span class="line">    HashJoinKey key;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;expression : plan_-&gt;<span class="built_in">LeftJoinKeyExpressions</span>()) &#123;</span><br><span class="line">      key.column_values_.<span class="built_in">emplace_back</span>(expression-&gt;<span class="built_in">Evaluate</span>(&amp;left_tuple, left_child_-&gt;<span class="built_in">GetOutputSchema</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (map_.<span class="built_in">count</span>(key) != <span class="number">0</span>) &#123;  <span class="comment">// ÂåπÈÖçÊàêÂäü</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;t : map_[key]) &#123;</span><br><span class="line">        std::vector&lt;Value&gt; values;</span><br><span class="line">        values.<span class="built_in">reserve</span>(<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(left_child_-&gt;<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>()); ++i) &#123;</span><br><span class="line">          values.<span class="built_in">emplace_back</span>(left_tuple.<span class="built_in">GetValue</span>(&amp;left_child_-&gt;<span class="built_in">GetOutputSchema</span>(), i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(right_child_-&gt;<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>()); ++i) &#123;</span><br><span class="line">          values.<span class="built_in">emplace_back</span>(t.<span class="built_in">GetValue</span>(&amp;right_child_-&gt;<span class="built_in">GetOutputSchema</span>(), i));</span><br><span class="line">        &#125;</span><br><span class="line">        result_.<span class="built_in">emplace_back</span>(values, &amp;<span class="built_in">GetOutputSchema</span>());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (plan_-&gt;<span class="built_in">GetJoinType</span>() == JoinType::LEFT) &#123;  <span class="comment">// ÂåπÈÖçÂ§±Ë¥•,‰ΩÜÊòØ‰∏∫LEFT JOIN</span></span><br><span class="line">      std::vector&lt;Value&gt; values;</span><br><span class="line">      values.<span class="built_in">reserve</span>(<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>());</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(left_child_-&gt;<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>()); ++i) &#123;</span><br><span class="line">        values.<span class="built_in">emplace_back</span>(left_tuple.<span class="built_in">GetValue</span>(&amp;left_child_-&gt;<span class="built_in">GetOutputSchema</span>(), i));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(right_child_-&gt;<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumnCount</span>()); ++i) &#123;</span><br><span class="line">        values.<span class="built_in">emplace_back</span>(ValueFactory::<span class="built_in">GetNullValueByType</span>(right_child_-&gt;<span class="built_in">GetOutputSchema</span>().<span class="built_in">GetColumn</span>(i).<span class="built_in">GetType</span>()));</span><br><span class="line">      &#125;</span><br><span class="line">      result_.<span class="built_in">emplace_back</span>(values, &amp;<span class="built_in">GetOutputSchema</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  index_ = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">HashJoinExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (index_ &gt;= <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(result_.<span class="built_in">size</span>())) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *tuple = result_[index_];</span><br><span class="line">  index_++;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Optimizing-NestedLoopJoin-to-HashJoin"><a href="#Optimizing-NestedLoopJoin-to-HashJoin" class="headerlink" title="Optimizing NestedLoopJoin to HashJoin"></a>Optimizing NestedLoopJoin to HashJoin</h3><p>ÂÖ∑‰ΩìÊù•ËØ¥ÔºåÂΩìËøûÊé•Ë∞ìËØçÊòØ‰∏§Âàó‰πãÈó¥Á≠âÊù°‰ª∂ÁöÑÂêàÂèñÊó∂ÔºåÂèØ‰ª•‰ΩøÁî®Êï£ÂàóËøûÊé•ÁÆóÊ≥ï„ÄÇÂ∞±Êú¨È°πÁõÆËÄåË®ÄÔºåÂ§ÑÁêÜÂçï‰∏™Á≠âÂÄºÊù°‰ª∂‰ª•ÂèäÈÄöËøá AND ËøûÊé•ÁöÑ‰∏§‰∏™Á≠âÂÄºÊù°‰ª∂Â∞ÜËé∑ÂæóÊª°ÂàÜ<br><br>‰ª£Á†ÅÂÆûÁé∞</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">Optimizer::OptimizeNLJAsHashJoin</span><span class="params">(<span class="type">const</span> AbstractPlanNodeRef &amp;plan)</span> -&gt; AbstractPlanNodeRef </span>&#123;</span><br><span class="line">  <span class="comment">// TODO(student): implement NestedLoopJoin -&gt; HashJoin optimizer rule</span></span><br><span class="line">  <span class="comment">// Note for 2023 Spring: You should at least support join keys of the form:</span></span><br><span class="line">  <span class="comment">// 1. &lt;column expr&gt; = &lt;column expr&gt;</span></span><br><span class="line">  <span class="comment">// 2. &lt;column expr&gt; = &lt;column expr&gt; AND &lt;column expr&gt; = &lt;column expr&gt;</span></span><br><span class="line">  std::vector&lt;AbstractPlanNodeRef&gt; children;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;child : plan-&gt;<span class="built_in">GetChildren</span>()) &#123;<span class="comment">//ÈÄíÂΩí‰ºòÂåñ</span></span><br><span class="line">    children.<span class="built_in">emplace_back</span>(<span class="built_in">OptimizeNLJAsHashJoin</span>(child));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> optimized_plan = plan-&gt;<span class="built_in">CloneWithChildren</span>(std::<span class="built_in">move</span>(children));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (optimized_plan-&gt;<span class="built_in">GetType</span>() == PlanType::NestedLoopJoin) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> nlj_plan = <span class="built_in">dynamic_cast</span>&lt;<span class="type">const</span> NestedLoopJoinPlanNode &amp;&gt;(*optimized_plan);</span><br><span class="line">    <span class="built_in">BUSTUB_ENSURE</span>(nlj_plan.children_.<span class="built_in">size</span>() == <span class="number">2</span>, <span class="string">&quot;NLJ should have exactly 2 children.&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> *expr = <span class="built_in">dynamic_cast</span>&lt;ComparisonExpression *&gt;(nlj_plan.<span class="built_in">Predicate</span>().<span class="built_in">get</span>()); expr != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (expr-&gt;comp_type_ == ComparisonType::Equal) &#123; <span class="comment">// Â¶ÇÊûúË°®ËææÂºèÁöÑType‰∏∫ ComparisonType::Equal</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">auto</span> *left_expr = <span class="built_in">dynamic_cast</span>&lt;ColumnValueExpression *&gt;(expr-&gt;children_[<span class="number">0</span>].<span class="built_in">get</span>()); left_expr != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">auto</span> *right_expr = <span class="built_in">dynamic_cast</span>&lt;ColumnValueExpression *&gt;(expr-&gt;children_[<span class="number">1</span>].<span class="built_in">get</span>());</span><br><span class="line">              right_expr != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            std::vector&lt;AbstractExpressionRef&gt; left_key_expressions;</span><br><span class="line">            std::vector&lt;AbstractExpressionRef&gt; right_key_expressions;</span><br><span class="line">            <span class="keyword">if</span> (left_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">0</span> &amp;&amp; right_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">1</span>) &#123;</span><br><span class="line">              left_key_expressions.<span class="built_in">emplace_back</span>(</span><br><span class="line">                  std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(<span class="number">0</span>, left_expr-&gt;<span class="built_in">GetColIdx</span>(), left_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">              right_key_expressions.<span class="built_in">emplace_back</span>(</span><br><span class="line">                  std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(<span class="number">1</span>, right_expr-&gt;<span class="built_in">GetColIdx</span>(), right_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (left_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">1</span> &amp;&amp; right_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">              left_key_expressions.<span class="built_in">emplace_back</span>(</span><br><span class="line">                  std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(<span class="number">0</span>, right_expr-&gt;<span class="built_in">GetColIdx</span>(), right_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">              right_key_expressions.<span class="built_in">emplace_back</span>(</span><br><span class="line">                  std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(<span class="number">1</span>, left_expr-&gt;<span class="built_in">GetColIdx</span>(), left_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> std::<span class="built_in">make_shared</span>&lt;HashJoinPlanNode&gt;(nlj_plan.output_schema_, nlj_plan.<span class="built_in">GetLeftPlan</span>(),</span><br><span class="line">                                                      nlj_plan.<span class="built_in">GetRightPlan</span>(), std::<span class="built_in">move</span>(left_key_expressions),</span><br><span class="line">                                                      std::<span class="built_in">move</span>(right_key_expressions), nlj_plan.<span class="built_in">GetJoinType</span>());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> *expr = <span class="built_in">dynamic_cast</span>&lt;LogicExpression *&gt;(nlj_plan.<span class="built_in">Predicate</span>().<span class="built_in">get</span>()); expr != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (expr-&gt;logic_type_ == LogicType::And) &#123;<span class="comment">//Â¶ÇÊûúË°®ËææÂºèÁöÑ Type‰∏∫ LogicType::And</span></span><br><span class="line">        <span class="built_in">BUSTUB_ASSERT</span>(expr-&gt;<span class="built_in">GetChildren</span>().<span class="built_in">size</span>() == <span class="number">2</span>, <span class="string">&quot;LogicExpression has two children&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">auto</span> *expr1 = <span class="built_in">dynamic_cast</span>&lt;ComparisonExpression *&gt;(expr-&gt;children_[<span class="number">0</span>].<span class="built_in">get</span>()); expr1 != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">auto</span> *expr2 = <span class="built_in">dynamic_cast</span>&lt;ComparisonExpression *&gt;(expr-&gt;children_[<span class="number">1</span>].<span class="built_in">get</span>()); expr2 != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (expr1-&gt;comp_type_ == ComparisonType::Equal &amp;&amp; expr2-&gt;comp_type_ == ComparisonType::Equal) &#123; <span class="comment">// ‰∏§‰∏™Â≠êË°®ËææÂºèÁöÑTypeÂùá‰∏∫ ComparisonType::Equal</span></span><br><span class="line">              std::vector&lt;AbstractExpressionRef&gt; left_key_expressions;</span><br><span class="line">              std::vector&lt;AbstractExpressionRef&gt; right_key_expressions;</span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">auto</span> *left_expr = <span class="built_in">dynamic_cast</span>&lt;ColumnValueExpression *&gt;(expr1-&gt;children_[<span class="number">0</span>].<span class="built_in">get</span>());</span><br><span class="line">                  left_expr != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">auto</span> *right_expr = <span class="built_in">dynamic_cast</span>&lt;ColumnValueExpression *&gt;(expr1-&gt;children_[<span class="number">1</span>].<span class="built_in">get</span>());</span><br><span class="line">                    right_expr != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (left_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">0</span> &amp;&amp; right_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">1</span>) &#123;</span><br><span class="line">                    left_key_expressions.<span class="built_in">emplace_back</span>(</span><br><span class="line">                        std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(<span class="number">0</span>, left_expr-&gt;<span class="built_in">GetColIdx</span>(), left_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">                    right_key_expressions.<span class="built_in">emplace_back</span>(std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(</span><br><span class="line">                        <span class="number">1</span>, right_expr-&gt;<span class="built_in">GetColIdx</span>(), right_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (left_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">1</span> &amp;&amp; right_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">                    left_key_expressions.<span class="built_in">emplace_back</span>(std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(</span><br><span class="line">                        <span class="number">0</span>, right_expr-&gt;<span class="built_in">GetColIdx</span>(), right_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">                    right_key_expressions.<span class="built_in">emplace_back</span>(</span><br><span class="line">                        std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(<span class="number">1</span>, left_expr-&gt;<span class="built_in">GetColIdx</span>(), left_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">auto</span> *left_expr = <span class="built_in">dynamic_cast</span>&lt;ColumnValueExpression *&gt;(expr2-&gt;children_[<span class="number">0</span>].<span class="built_in">get</span>());</span><br><span class="line">                  left_expr != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">auto</span> *right_expr = <span class="built_in">dynamic_cast</span>&lt;ColumnValueExpression *&gt;(expr2-&gt;children_[<span class="number">1</span>].<span class="built_in">get</span>());</span><br><span class="line">                    right_expr != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (left_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">0</span> &amp;&amp; right_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">1</span>) &#123;</span><br><span class="line">                    left_key_expressions.<span class="built_in">emplace_back</span>(</span><br><span class="line">                        std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(<span class="number">0</span>, left_expr-&gt;<span class="built_in">GetColIdx</span>(), left_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">                    right_key_expressions.<span class="built_in">emplace_back</span>(std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(</span><br><span class="line">                        <span class="number">1</span>, right_expr-&gt;<span class="built_in">GetColIdx</span>(), right_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (left_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">1</span> &amp;&amp; right_expr-&gt;<span class="built_in">GetTupleIdx</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">                    left_key_expressions.<span class="built_in">emplace_back</span>(std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(</span><br><span class="line">                        <span class="number">0</span>, right_expr-&gt;<span class="built_in">GetColIdx</span>(), right_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">                    right_key_expressions.<span class="built_in">emplace_back</span>(</span><br><span class="line">                        std::<span class="built_in">make_shared</span>&lt;ColumnValueExpression&gt;(<span class="number">1</span>, left_expr-&gt;<span class="built_in">GetColIdx</span>(), left_expr-&gt;<span class="built_in">GetReturnType</span>()));</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> std::<span class="built_in">make_shared</span>&lt;HashJoinPlanNode&gt;(nlj_plan.output_schema_, nlj_plan.<span class="built_in">GetLeftPlan</span>(),</span><br><span class="line">                                                        nlj_plan.<span class="built_in">GetRightPlan</span>(), std::<span class="built_in">move</span>(left_key_expressions),</span><br><span class="line">                                                        std::<span class="built_in">move</span>(right_key_expressions), nlj_plan.<span class="built_in">GetJoinType</span>());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> optimized_plan;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Âà∞ËøôÈáå‰∏∫Ê≠¢ÔºåÈÄöËøáSQLLogicTests #14 to #15<br><img src="/../images/cmu15445-project3/22.png" alt="img"><br><img src="/../images/cmu15445-project3/23.png" alt="img"><br><img src="/../images/cmu15445-project3/24.png" alt="img"></p>
<h2 id="Task-3-Sort-Limit-Executors-and-Top-N-Optimization"><a href="#Task-3-Sort-Limit-Executors-and-Top-N-Optimization" class="headerlink" title="Task#3 Sort + Limit Executors and Top-N Optimization"></a>Task#3 Sort + Limit Executors and Top-N Optimization</h2><h3 id="SortExecutorÂÆûÁé∞Ôºö"><a href="#SortExecutorÂÆûÁé∞Ôºö" class="headerlink" title="SortExecutorÂÆûÁé∞Ôºö"></a>SortExecutorÂÆûÁé∞Ôºö</h3><p>Â¶ÇÊûúÊü•ËØ¢ÁöÑORDER BYÂ±ûÊÄß‰∏éÁ¥¢ÂºïÁöÑkey‰∏çÂåπÈÖçÔºåBusTubÂ∞Ü‰∏∫Êü•ËØ¢ÁîüÊàê‰∏Ä‰∏™SortPlanNode<br><br>Â¶ÇÊûúÊü•ËØ¢‰∏çÂåÖÂê´ÊéíÂ∫èÊñπÂêë(Âç≥ASC„ÄÅDESC)ÔºåÂàôÊéíÂ∫èÊ®°ÂºèÂ∞Ü‰∏∫ÈªòËÆ§(Âç≥ASC)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SortExecutor</span> &#123;</span><br><span class="line">  <span class="comment">//Ê∑ªÂä†Êï∞ÊçÆÊàêÂëò</span></span><br><span class="line">  <span class="type">const</span> SortPlanNode *plan_;</span><br><span class="line">  std::unique_ptr&lt;AbstractExecutor&gt; child_executor_;</span><br><span class="line">  std::vector&lt;Tuple&gt; result_;</span><br><span class="line">  <span class="type">int</span> index_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SortExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Tuple tuple;</span><br><span class="line">  RID rid;</span><br><span class="line">  child_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  <span class="keyword">while</span> (child_executor_-&gt;<span class="built_in">Next</span>(&amp;tuple, &amp;rid)) &#123;<span class="comment">//ÈÅçÂéÜÂ≠©Â≠êexecutorÁöÑÊâÄÊúâtupleÊîæÂÖ•result_</span></span><br><span class="line">    result_.<span class="built_in">emplace_back</span>(tuple);</span><br><span class="line">  &#125;</span><br><span class="line">  std::<span class="built_in">sort</span>(result_.<span class="built_in">begin</span>(), result_.<span class="built_in">end</span>(),</span><br><span class="line">            [<span class="keyword">this</span>](<span class="type">const</span> Tuple &amp;left, <span class="type">const</span> Tuple &amp;right) -&gt; <span class="type">bool</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">TupleComparator</span>(left, right); &#125;);<span class="comment">//ÂØπresult_ËøõË°åÊéíÂ∫è</span></span><br><span class="line">  index_ = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">SortExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (index_ &gt;= <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(result_.<span class="built_in">size</span>())) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *tuple = result_[index_];</span><br><span class="line">  index_++;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Ëá™ÂÆö‰πâÊéíÂ∫èÂáΩÊï∞</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">SortExecutor::TupleComparator</span><span class="params">(<span class="type">const</span> Tuple &amp;left, <span class="type">const</span> Tuple &amp;right)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> &amp;order_by = plan_-&gt;<span class="built_in">GetOrderBy</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;p : order_by) &#123;</span><br><span class="line">    <span class="keyword">auto</span> order = p.first;</span><br><span class="line">    <span class="keyword">auto</span> &amp;exp = p.second;</span><br><span class="line">    <span class="keyword">auto</span> lvalue = exp-&gt;<span class="built_in">Evaluate</span>(&amp;left, child_executor_-&gt;<span class="built_in">GetOutputSchema</span>());</span><br><span class="line">    <span class="keyword">auto</span> rvalue = exp-&gt;<span class="built_in">Evaluate</span>(&amp;right, child_executor_-&gt;<span class="built_in">GetOutputSchema</span>());</span><br><span class="line">    <span class="keyword">if</span> (order == OrderByType::DESC) &#123;</span><br><span class="line">      <span class="keyword">if</span> (lvalue.<span class="built_in">CompareGreaterThan</span>(rvalue) == CmpBool::CmpTrue) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (lvalue.<span class="built_in">CompareLessThan</span>(rvalue) == CmpBool::CmpTrue) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (lvalue.<span class="built_in">CompareLessThan</span>(rvalue) == CmpBool::CmpTrue) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (lvalue.<span class="built_in">CompareGreaterThan</span>(rvalue) == CmpBool::CmpTrue) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">UNREACHABLE</span>(<span class="string">&quot;duplicate key is not allowed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LimitExecutorÂÆûÁé∞"><a href="#LimitExecutorÂÆûÁé∞" class="headerlink" title="LimitExecutorÂÆûÁé∞:"></a>LimitExecutorÂÆûÁé∞:</h3><p>LimitExectutorÈôêÂà∂ÂÖ∂Â≠êexecutorÁöÑËæìÂá∫tupleÊï∞Èáè„ÄÇÂ¶ÇÊûúÂÖ∂Â≠êexecutorÁîüÊàêÁöÑÂÖÉÁªÑÊï∞ÈáèÂ∞è‰∫éLimitExecutor‰∏≠ÊåáÂÆöÁöÑÈôêÂà∂ÔºåÂàôËØ•executorÊó†ÊïàÂπ∂ÁîüÊàêÂÆÉÊé•ÂèóÂà∞ÁöÑÊâÄÊúâtuple</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LimitExecutor</span> &#123;</span><br><span class="line">  <span class="comment">//Ê∑ªÂä†Êï∞ÊçÆÊàêÂëò</span></span><br><span class="line">  <span class="type">const</span> LimitPlanNode *plan_;</span><br><span class="line">  <span class="comment">/** The child executor from which tuples are obtained */</span></span><br><span class="line">  std::unique_ptr&lt;AbstractExecutor&gt; child_executor_;</span><br><span class="line">  <span class="type">size_t</span> num_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LimitExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  child_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  num_ = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LimitExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (num_ &gt;= plan_-&gt;<span class="built_in">GetLimit</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (child_executor_-&gt;<span class="built_in">Next</span>(tuple, rid)) &#123;</span><br><span class="line">    num_++;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Top-N-Optimization-Rule"><a href="#Top-N-Optimization-Rule" class="headerlink" title="Top-N Optimization Rule"></a>Top-N Optimization Rule</h3><p>Áî®‰∏Ä‰∏™‰ºòÂÖàÈòüÂàóÁª¥Êä§top n Êù°tuple</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TopNExecutor</span> &#123;</span><br><span class="line">  <span class="comment">//Êï∞ÊçÆÊàêÂëò</span></span><br><span class="line">  <span class="type">const</span> TopNPlanNode *plan_;</span><br><span class="line">  <span class="comment">/** The child executor from which tuples are obtained */</span></span><br><span class="line">  std::unique_ptr&lt;AbstractExecutor&gt; child_executor_;</span><br><span class="line">  std::priority_queue&lt;HeapKeyType&gt; heap_;<span class="comment">//‰∏Ä‰∏™‰ºòÂÖàÈòüÂàó</span></span><br><span class="line">  std::deque&lt;Tuple&gt; result_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TopNExecutor::Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  child_executor_-&gt;<span class="built_in">Init</span>();</span><br><span class="line">  Tuple tuple;</span><br><span class="line">  RID rid;</span><br><span class="line">  <span class="keyword">while</span> (child_executor_-&gt;<span class="built_in">Next</span>(&amp;tuple, &amp;rid)) &#123;<span class="comment">//child_executor_ÈÅçÂéÜÊâÄÊúâÁöÑtuple</span></span><br><span class="line">    <span class="function">HeapKeyType <span class="title">key</span><span class="params">(tuple, plan_-&gt;GetOrderBy(), child_executor_.get())</span></span>;</span><br><span class="line">    heap_.<span class="built_in">emplace</span>(tuple, plan_-&gt;<span class="built_in">GetOrderBy</span>(), child_executor_.<span class="built_in">get</span>());<span class="comment">//Âä†ÂÖ•‰ºòÂÖàÈòüÂàó‰∏≠</span></span><br><span class="line">    <span class="keyword">if</span> (heap_.<span class="built_in">size</span>() &gt; plan_-&gt;<span class="built_in">GetN</span>()) &#123;<span class="comment">//‰øùËØÅ‰ºòÂÖàÈòüÂàó‰∏≠ÁöÑsize‰∏çË∂ÖËøáN</span></span><br><span class="line">      heap_.<span class="built_in">pop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!heap_.<span class="built_in">empty</span>()) &#123;<span class="comment">//Â∞Üheap‰∏≠ÁöÑtuple_ÈÉΩÊîæÂÖ•result_</span></span><br><span class="line">    result_.<span class="built_in">emplace_front</span>(heap_.<span class="built_in">top</span>().tuple_);</span><br><span class="line">    heap_.<span class="built_in">pop</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">TopNExecutor::Next</span><span class="params">(Tuple *tuple, RID *rid)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">GetNumInHeap</span>() != <span class="number">0</span>) &#123;</span><br><span class="line">    *tuple = result_.<span class="built_in">front</span>();</span><br><span class="line">    result_.<span class="built_in">pop_front</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">TopNExecutor::GetNumInHeap</span><span class="params">()</span> -&gt; <span class="type">size_t</span> </span>&#123; <span class="keyword">return</span> result_.<span class="built_in">size</span>(); &#125;</span><br></pre></td></tr></table></figure>

<p>Âà∞ËøôÈáå‰∏∫Ê≠¢ÔºåÈÄöËøáSQLLogicTests #16 to #19<br><img src="/../images/cmu15445-project3/25.png" alt="img"><br><img src="/../images/cmu15445-project3/26.png" alt="img"><br><img src="/../images/cmu15445-project3/27.png" alt="img"><br><img src="/../images/cmu15445-project3/28.png" alt="img"></p>
<p>ÈÄöËøáÁ∫ø‰∏äÊµãËØï:<br><img src="/../images/cmu15445-project3/29.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/02/26/cmu15445-project2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/26/cmu15445-project2/" class="post-title-link" itemprop="url">cmu15445-project2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-26 22:16:24" itemprop="dateCreated datePublished" datetime="2024-02-26T22:16:24-08:00">2024-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-27 19:25:45" itemprop="dateModified" datetime="2024-02-27T19:25:45-08:00">2024-02-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cmu15445-2023/" itemprop="url" rel="index"><span itemprop="name">cmu15445-2023</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B+ Tree"></a>B+ Tree</h1><p>B+ TreeÊòØ‰∏ÄÁßçËá™Âπ≥Ë°°Ê†ëÔºåÂÆÉÂ∞ÜÊï∞ÊçÆÊúâÂ∫èÂú∞Â≠òÂÇ®ÔºåÂπ∂‰∏îÂú®search„ÄÅsequential access„ÄÅinsertions‰ª•ÂèädeletionsÊìç‰ΩúÁöÑÂ§çÊùÇÂ∫¶‰∏äÈÉΩÊª°Ë∂≥O(logn),ÂÖ∂‰∏≠sequential accessÁöÑÊúÄÁªàÂ§çÊùÇÂ∫¶Ëøò‰∏éÊâÄÈúÄÊï∞ÊçÆÊÄªÈáèÊúâÂÖ≥<br><img src="/../images/cmu15445-project2/1.png" alt="img"><br>‰ª•M‚Äîway B+tree‰∏∫‰æãÔºåÂÆÉÁöÑÁâπÁÇπÊÄªÁªìÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>ÊØè‰∏™ËäÇÁÇπÊúÄÂ§öÂ≠òÂÇ®M‰∏™keyÔºåÊúâM+1‰∏™children</li>
<li>B+ TreeÊòØperfectly balancedÔºåÂç≥ÊØè‰∏™leaf nodeÁöÑÊ∑±Â∫¶ÈÉΩ‰∏ÄÊ†∑</li>
<li>Èô§‰∫ÜrootËäÇÁÇπÔºåÊâÄÊúâËäÇÁÇπÂøÖÈ°ªËá≥Â∞ëÂ§Ñ‰∫éÂçäÊª°Áä∂ÊÄÅÔºåÂç≥ M&#x2F;2 - 1 &lt;&#x3D; #keys &lt;&#x3D; M - 1</li>
<li>ÂÅáËÆæÊØè‰∏™inner node‰∏≠ÂåÖÂê´k‰∏™keysÔºåÈÇ£‰πàÂÆÉÂøÖÁÑ∂Êúâk + 1‰∏™children</li>
</ul>
<h1 id="B-Tree-Operations"><a href="#B-Tree-Operations" class="headerlink" title="B+ Tree Operations"></a>B+ Tree Operations</h1><p>Insert</p>
<blockquote>
<ol>
<li>ÊâæÂà∞ÂØπÂ∫îÁöÑleafNode L</li>
<li>Â∞Ükey&#x2F;value pairÊåâÈ°∫Â∫èÊèíÂÖ•Âà∞ L ‰∏≠</li>
<li>Â¶ÇÊûúL ËøòÊúâË∂≥Â§üÁöÑÁ©∫Èó¥ÔºåÊìç‰ΩúÁªìÊùüÔºõÂ¶ÇÊûúÁ©∫Èó¥‰∏çË∂≥ÔºåÂàôÈúÄË¶ÅÂ∞ÜLÂàÜË£ÇÊàê‰∏§‰∏™ËäÇÁÇπÔºåÂêåÊó∂Âú®parent node‰∏äÊñ∞Â¢ûentryÔºåËã•parent node‰πüÁ©∫Èó¥‰∏çË∂≥ÔºåÂàôÈÄíÂΩíÂú∞ÂàÜË£ÇÔºåÁõ¥Âà∞root node‰∏∫Ê≠¢</li>
</ol>
</blockquote>
<p>Max.degree &#x3D; 5Êó∂<br><br>‰ªé1ÊèíÂÖ•Âà∞13ÁöÑÊÉÖÂÜµ  <a target="_blank" rel="noopener" href="https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html">BPlusTreeÂèØËßÜÂåñÁΩëÁ´ô</a><br><img src="/../images/cmu15445-project2/2.png" alt="img"></p>
<p>Delete</p>
<blockquote>
<ol>
<li>‰ªérootÂºÄÂßãÔºåÊâæÂà∞ÁõÆÊ†áentryÊâÄÂú®ÁöÑleaf node L</li>
<li>Âà†Èô§ËØ•entry</li>
<li>Â¶ÇÊûúL‰ªçÁÑ∂Â§ÑÂú®ÂçäÊª°Áä∂ÊÄÅÔºåÊìç‰ΩúÁªìÊùüÔºõÂê¶ÂàôÂÖàÂ∞ùËØï‰ªésiblingsÈÇ£ÈáåÂÄüentriesÔºåÂ¶ÇÊûúÂ§±Ë¥•ÔºåÂàôÂ∞ÜL ‰∏éÁõ∏Â∫îÁöÑsiblingÂêàÂπ∂</li>
<li>Â¶ÇÊûúÂêàÂπ∂ÂèëÁîü‰∫ÜÔºåÂàôÂèØËÉΩÈúÄË¶ÅÈÄíÂΩíÂú∞Âà†Èô§parent node‰∏≠ÁöÑentry</li>
</ol>
</blockquote>
<h1 id="CheckPoint-1"><a href="#CheckPoint-1" class="headerlink" title="CheckPoint#1"></a>CheckPoint#1</h1><h2 id="Task-1-B-Tree-Pages"><a href="#Task-1-B-Tree-Pages" class="headerlink" title="Task #1 B+ Tree Pages"></a>Task #1 B+ Tree Pages</h2><h3 id="class-BPlusTreePageÁöÑ3‰∏™Á±ªÊàêÂëò"><a href="#class-BPlusTreePageÁöÑ3‰∏™Á±ªÊàêÂëò" class="headerlink" title="class BPlusTreePageÁöÑ3‰∏™Á±ªÊàêÂëò"></a>class BPlusTreePageÁöÑ3‰∏™Á±ªÊàêÂëò</h3><p><img src="/../images/cmu15445-project2/3.png" alt="img"><br>GetMinSizeÂáΩÊï∞ÂÆûÁé∞:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPlusTreePage::GetMinSize</span><span class="params">()</span> <span class="type">const</span> -&gt; <span class="type">int</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsLeafPage</span>()) &#123;<span class="comment">// Âè∂Â≠êËäÇÁÇπ</span></span><br><span class="line">    <span class="keyword">return</span> max_size_ / <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (max_size_ + <span class="number">1</span>) / <span class="number">2</span>; <span class="comment">//ÂÜÖÈÉ®ËäÇÁÇπ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="class-BPlusTreeInternalPage-public-BPlusTreePage"><a href="#class-BPlusTreeInternalPage-public-BPlusTreePage" class="headerlink" title="class BPlusTreeInternalPage : public BPlusTreePage "></a>class BPlusTreeInternalPage : public BPlusTreePage <br></h3><blockquote>
<p>‰∏Ä‰∏™Internal PageÂ≠òÂÇ® m ‰∏™È°∫Â∫è key Âíå m + 1 ‰∏™child pointers(ÂÖ∂ÂÆÉBPlusTreePageÁöÑpage_ids)<br><br>‰ΩøÁî®‰∏Ä‰∏™Êï∞ÁªÑÂ≠òÂÇ®key&#x2F;page_id pairsÔºåÂπ∂‰∏îÁ¨¨‰∏Ä‰∏™keyË¢´ËÆæÁΩÆ‰∏∫invalidÔºåÂπ∂‰∏îÊü•ÊâæË¶Å‰ªéÁ¨¨‰∫å‰∏™keyÂºÄÂßãÊü•Êâæ</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">B_PLUS_TREE_INTERNAL_PAGE_TYPE::Init</span><span class="params">(<span class="type">int</span> max_size, <span class="type">int</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">SetPageType</span>(IndexPageType::INTERNAL_PAGE);</span><br><span class="line">  <span class="built_in">SetMaxSize</span>(max_size);</span><br><span class="line">  <span class="built_in">SetSize</span>(size);<span class="comment">//size ÈªòËÆ§‰∏∫1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">B_PLUS_TREE_INTERNAL_PAGE_TYPE::ValueIndex</span><span class="params">(<span class="type">const</span> ValueType &amp;value)</span> <span class="type">const</span> -&gt; <span class="type">int</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="built_in">GetSize</span>(); ++i) &#123;<span class="comment">//È°∫Â∫èÊü•Êâæ</span></span><br><span class="line">    <span class="keyword">if</span> (array_[i].second == value) &#123;</span><br><span class="line">      <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">B_PLUS_TREE_INTERNAL_PAGE_TYPE::LookUp</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">const</span> KeyComparator &amp;comparator)</span> <span class="type">const</span> -&gt; ValueType </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="built_in">GetSize</span>(); ++i) &#123;  <span class="comment">// È°∫Â∫èÊü•Êâæ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">comparator</span>(key, array_[i].first) &lt; <span class="number">0</span>) &#123;<span class="comment">//ÊâæÂà∞Á¨¨‰∏Ä‰∏™Â§ß‰∫ékeyÁöÑarray_[i].first</span></span><br><span class="line">      <span class="keyword">return</span> array_[i - <span class="number">1</span>].second;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> array_[<span class="built_in">GetSize</span>() - <span class="number">1</span>].second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">B_PLUS_TREE_INTERNAL_PAGE_TYPE::Insert</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">const</span> ValueType &amp;value, <span class="type">const</span> KeyComparator &amp;comparator)</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">GetSize</span>() == <span class="built_in">GetMaxSize</span>()) &#123;<span class="comment">//Â∑≤ÁªèÊª°‰∫ÜËøîÂõûfalse</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// upper_bound</span></span><br><span class="line">  <span class="type">int</span> l = <span class="number">1</span>;</span><br><span class="line">  <span class="type">int</span> r = <span class="built_in">GetSize</span>();</span><br><span class="line">  <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">    <span class="type">int</span> mid = (l + r) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">comparator</span>(array_[mid].first, key) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      r = mid;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="built_in">GetSize</span>() - <span class="number">1</span>; i &gt;= l; --i) &#123;<span class="comment">//ÂÖÉÁ¥†Áßª‰Ωç</span></span><br><span class="line">    array_[i + <span class="number">1</span>] = array_[i];</span><br><span class="line">  &#125;</span><br><span class="line">  array_[l] = &#123;key, value&#125;;<span class="comment">//Â≠òÂÇ®ÊèíÂÖ•ÁöÑkey-value</span></span><br><span class="line">  <span class="built_in">IncreaseSize</span>(<span class="number">1</span>);<span class="comment">//size ++</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="class-BPlusTreeLeafPage-public-BPlusTreePage"><a href="#class-BPlusTreeLeafPage-public-BPlusTreePage" class="headerlink" title="class BPlusTreeLeafPage : public BPlusTreePage"></a>class BPlusTreeLeafPage : public BPlusTreePage</h3><blockquote>
<p>‰∏Ä‰∏™Leaf PageÂ≠òÂÇ® m ‰∏™È°∫Â∫è key Âíå m ‰∏™ÂØπÂ∫îÁöÑvalue.valueÂ∫îËØ•‰∏∫ 64-bit record_id Áî®‰∫éË°®Á§∫ÂÆûÈôÖÁöÑtupleÂ≠òÂÇ®ÁöÑÂú∞Êñπ(src&#x2F;include&#x2F;common&#x2F;rid.h)</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">B_PLUS_TREE_LEAF_PAGE_TYPE::Init</span><span class="params">(<span class="type">int</span> max_size, <span class="type">int</span> size, <span class="type">page_id_t</span> next_page_id)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">SetPageType</span>(IndexPageType::LEAF_PAGE);</span><br><span class="line">  <span class="built_in">SetMaxSize</span>(max_size);</span><br><span class="line">  <span class="built_in">SetSize</span>(size);<span class="comment">//size ÈªòËÆ§‰∏∫0</span></span><br><span class="line">  <span class="built_in">SetNextPageId</span>(next_page_id);<span class="comment">//next_page_idÈªòËÆ§‰∏∫INVALID_PAGE_ID</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">B_PLUS_TREE_LEAF_PAGE_TYPE::KeyIndex</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">const</span> KeyComparator &amp;comparator, <span class="type">int</span> &amp;index)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="comment">// lower_bound</span></span><br><span class="line">  <span class="type">int</span> l = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> r = <span class="built_in">GetSize</span>();</span><br><span class="line">  <span class="keyword">if</span> (l &gt;= r) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">    <span class="type">int</span> mid = (l + r) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">comparator</span>(array_[mid].first, key) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      r = mid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  index = l;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;<span class="type">bool</span>&gt;(l != <span class="built_in">GetSize</span>() &amp;&amp; <span class="built_in">comparator</span>(<span class="built_in">KeyAt</span>(l), key) == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">B_PLUS_TREE_LEAF_PAGE_TYPE::Insert</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">const</span> ValueType &amp;value, <span class="type">const</span> KeyComparator &amp;comparator)</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> pos = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">KeyIndex</span>(key, comparator, pos)) &#123;  <span class="comment">// duplicate key</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//ÈáçÂ§çÁöÑkeyÔºåÁõ¥Êé•ËøîÂõûfalse</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// move</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="built_in">GetSize</span>() - <span class="number">1</span>; i &gt;= pos; --i) &#123;<span class="comment">//ÁßªÂä®array_ÂÖÉÁ¥†</span></span><br><span class="line">    array_[i + <span class="number">1</span>] = array_[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// insert</span></span><br><span class="line">  array_[pos] = &#123;key, value&#125;;<span class="comment">//ÊèíÂÖ•key-value</span></span><br><span class="line">  <span class="built_in">IncreaseSize</span>(<span class="number">1</span>);<span class="comment">//size ++</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Class-BplusTreeHeaderPage"><a href="#Class-BplusTreeHeaderPage" class="headerlink" title="Class BplusTreeHeaderPage"></a>Class BplusTreeHeaderPage</h3><blockquote>
<p>Â§¥ËäÇÁÇπÔºåÂ≠òÂÇ®‰∫Üroot page idÔºå‰ΩøÂæóÊ†πËäÇÁÇπÂíåÈùûÊ†πËäÇÁÇπ‰∏ÄÊ†∑Êã•ÊúâÁà∂ËäÇÁÇπ</p>
</blockquote>
<h2 id="Task-2a-B-Tree-Data-Structure-Insertion-Point-Search"><a href="#Task-2a-B-Tree-Data-Structure-Insertion-Point-Search" class="headerlink" title="Task #2a B+ Tree Data Structure(Insertion, Point Search)"></a>Task #2a B+ Tree Data Structure(Insertion, Point Search)</h2><p>GetRootPageIdÂáΩÊï∞ÂÆûÁé∞:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS <span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::GetRootPageId</span><span class="params">()</span> <span class="type">const</span> -&gt; <span class="type">page_id_t</span> </span>&#123;</span><br><span class="line">  ReadPageGuard guard = bpm_-&gt;<span class="built_in">FetchPageRead</span>(header_page_id_);</span><br><span class="line">  <span class="keyword">auto</span> page = guard.<span class="built_in">As</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">  <span class="keyword">return</span> page-&gt;root_page_id_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SearchÊìç‰Ωú</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::GetValue</span><span class="params">(<span class="type">const</span> KeyType &amp;key, std::vector&lt;ValueType&gt; *result, Transaction *txn)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Declaration of context instance.</span></span><br><span class="line">  Context ctx;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//ÂÖàÁªôheader_pageÂä†ËØªÈîÅÂà§Êñ≠root_pageÊòØÂê¶Â≠òÂú®ÔºåÂ¶ÇÊûúÂ≠òÂú®ÔºåÁªôroot_pageÂä†ËØªÈîÅÔºåÊîæÂÖ•Context‰∏≠</span></span><br><span class="line">    <span class="keyword">auto</span> header_page_guard = bpm_-&gt;<span class="built_in">FetchPageRead</span>(header_page_id_);</span><br><span class="line">    <span class="keyword">auto</span> header_page = header_page_guard.<span class="built_in">As</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">    <span class="keyword">if</span> (header_page-&gt;root_page_id_ == INVALID_PAGE_ID) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.root_page_id_ = header_page-&gt;root_page_id_;</span><br><span class="line">    ctx.read_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageRead</span>(ctx.root_page_id_));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//Êü•ÊâæÂà∞ÂØπÂ∫îÁöÑleafPage</span></span><br><span class="line">  <span class="built_in">FindLeafPage</span>(key, Operation::Search, ctx);</span><br><span class="line">  <span class="keyword">auto</span> leaf_page = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;LeafPage&gt;();</span><br><span class="line">  <span class="type">int</span> index = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (leaf_page-&gt;<span class="built_in">KeyIndex</span>(key, comparator_, index)) &#123;</span><br><span class="line">    result-&gt;<span class="built_in">push_back</span>(leaf_page-&gt;<span class="built_in">ValueAt</span>(index));<span class="comment">//Êü•ÊâæÊàêÂäü</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//Êü•ÊâæÂ§±Ë¥•</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::FindLeafPage</span><span class="params">(<span class="type">const</span> KeyType &amp;key, Operation op, Context &amp;ctx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (op == Operation::Search) &#123;</span><br><span class="line">    <span class="comment">//SearchÁöÑÂä†ÈîÅÁ≠ñÁï•</span></span><br><span class="line">    <span class="comment">//‰ªérootÂæÄ‰∏ãÔºå‰∏çÊñ≠Âú∞</span></span><br><span class="line">    <span class="comment">// - Ëé∑ÂèñchildÁöÑread latch</span></span><br><span class="line">    <span class="comment">// - ÈáäÊîæparentÁöÑread latch</span></span><br><span class="line">    <span class="keyword">auto</span> page = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">    <span class="keyword">while</span> (!page-&gt;<span class="built_in">IsLeafPage</span>()) &#123;</span><br><span class="line">      <span class="keyword">auto</span> internal = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;InternalPage&gt;();</span><br><span class="line">      <span class="keyword">auto</span> next_page_id = internal-&gt;<span class="built_in">LookUp</span>(key, comparator_);</span><br><span class="line">      ctx.read_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageRead</span>(next_page_id));</span><br><span class="line">      ctx.read_set_.<span class="built_in">pop_front</span>();</span><br><span class="line">      page = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (op == Operation::Insert || op == Operation::Remove) &#123;</span><br><span class="line">    <span class="comment">//InsertÂíåRemoveÁöÑÂä†ÈîÅÁ≠ñÁï•</span></span><br><span class="line">    <span class="comment">//‰ªérootÂæÄ‰∏ãÔºåÊåâÁÖßÈúÄË¶ÅËé∑Âèñwrite latchÔºå‰∏ÄÊó¶Ëé∑ÂèñÂà∞‰∫ÜchildÁöÑwrite latchÔºåÊ£ÄÊü•</span></span><br><span class="line">    <span class="comment">//ÂÆÉÊòØÂê¶ÂÆâÂÖ®ÔºåÂ¶ÇÊûúÂÆâÂÖ®ÔºåÂàôÈáäÊîæ‰πãÂâçËé∑ÂèñÁöÑÊâÄÊúâwrite latch</span></span><br><span class="line">    <span class="keyword">auto</span> page = ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">    <span class="keyword">while</span> (!page-&gt;<span class="built_in">IsLeafPage</span>()) &#123;</span><br><span class="line">      <span class="keyword">auto</span> internal = ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;InternalPage&gt;();</span><br><span class="line">      <span class="keyword">auto</span> next_page_id = internal-&gt;<span class="built_in">LookUp</span>(key, comparator_);</span><br><span class="line">      ctx.write_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageWrite</span>(next_page_id));</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">IsSafePage</span>(ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;(), op, <span class="literal">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">while</span> (ctx.write_set_.<span class="built_in">size</span>() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">          ctx.write_set_.<span class="built_in">pop_front</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      page = ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::IsSafePage</span><span class="params">(<span class="type">const</span> BPlusTreePage *tree_page, Operation op, <span class="type">bool</span> isRootPage)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (op == Operation::Search) &#123;<span class="comment">//no use</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (op == Operation::Insert) &#123;<span class="comment">//ÊèíÂÖ•Êìç‰Ωú</span></span><br><span class="line">    <span class="comment">//Ëã•‰ºöÂèëÁîü‰∏äÊ∫¢ÔºåË°®Á§∫‰∏çÂÆâÂÖ®</span></span><br><span class="line">    <span class="keyword">if</span> (tree_page-&gt;<span class="built_in">IsLeafPage</span>()) &#123;</span><br><span class="line">      <span class="comment">//Âè∂Â≠êËäÇÁÇπ‰∏≠ÔºåsizeÊúÄÂ§ß‰∏∫tree_page-&gt;GetMaxSize() - 1;</span></span><br><span class="line">      <span class="keyword">return</span> tree_page-&gt;<span class="built_in">GetSize</span>() + <span class="number">1</span> &lt; tree_page-&gt;<span class="built_in">GetMaxSize</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ÂÜÖÈÉ®ËäÇÁÇπ‰∏≠ÔºåsizeÊúÄÂ§ß‰∏∫tree_page-&gt;GetMaxSize()</span></span><br><span class="line">    <span class="keyword">return</span> tree_page-&gt;<span class="built_in">GetSize</span>() &lt; tree_page-&gt;<span class="built_in">GetMaxSize</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (op == Operation::Remove) &#123;<span class="comment">//Âà†Èô§Êìç‰Ωú</span></span><br><span class="line">    <span class="comment">//Ëã•‰ºöÂèëÁîü‰∏ãÊ∫¢ÔºåË°®Á§∫‰∏çÂÆâÂÖ®</span></span><br><span class="line">    <span class="keyword">if</span> (isRootPage) &#123;<span class="comment">//ÂØπRootPageËøõË°åRemoveÊìç‰Ωú</span></span><br><span class="line">      <span class="keyword">if</span> (tree_page-&gt;<span class="built_in">IsLeafPage</span>()) &#123;</span><br><span class="line">        <span class="comment">//Â¶ÇÊûú‰∏∫Âè∂Â≠êËäÇÁÇπÔºåsizeËá≥Â∞ë‰∏∫2</span></span><br><span class="line">        <span class="keyword">return</span> tree_page-&gt;<span class="built_in">GetSize</span>() &gt; <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//Â¶ÇÊûú‰∏∫ÂÜÖÈÉ®ËäÇÁÇπÔºåsizeËá≥Â∞ë‰∏∫3</span></span><br><span class="line">      <span class="keyword">return</span> tree_page-&gt;<span class="built_in">GetSize</span>() &gt; <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tree_page-&gt;<span class="built_in">GetSize</span>() &gt; tree_page-&gt;<span class="built_in">GetMinSize</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InsertÊìç‰Ωú</p>
<blockquote>
<p>ÊèíÂÖ•Âà∞leafËäÇÁÇπ‰∏≠ÔºåÊèíÂÖ•ÂâçÔºåÂ¶ÇÊûúsize &#x3D;&#x3D; max_sizeË°®Á§∫Ê∫¢Âá∫ÔºåÈúÄË¶ÅËøõË°åÂàÜË£Ç<br>ÊèíÂÖ•Âà∞internalËäÇÁÇπ‰∏≠ÔºåÊèíÂÖ•ÂâçÔºåÂ¶ÇÊûúsize &#x3D;&#x3D; max_sizeË°®Á§∫Ê∫¢Âá∫ÔºåÈúÄË¶ÅËøõË°åÂàÜË£Ç </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS <span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::Insert</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">const</span> ValueType &amp;value, Transaction *txn)</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Declaration of context instance.</span></span><br><span class="line">  Context ctx;</span><br><span class="line">  ctx.header_page_ = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(header_page_id_);<span class="comment">//ÂÖàÁªôheader_page_idÂÜôÈîÅ</span></span><br><span class="line">  <span class="keyword">auto</span> header_page = ctx.header_page_-&gt;<span class="built_in">AsMut</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (header_page-&gt;root_page_id_ == INVALID_PAGE_ID) &#123;  <span class="comment">// root not exist,start a new tree</span></span><br><span class="line">    <span class="keyword">auto</span> root_guard = bpm_-&gt;<span class="built_in">NewPageGuarded</span>(&amp;ctx.root_page_id_);<span class="comment">//Áî≥ËØ∑root_page</span></span><br><span class="line">    header_page-&gt;root_page_id_ = ctx.root_page_id_;</span><br><span class="line">    <span class="keyword">auto</span> leaf_page = root_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line">    leaf_page-&gt;<span class="built_in">Init</span>(leaf_max_size_, <span class="number">1</span>);</span><br><span class="line">    leaf_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>] = &#123;key, value&#125;;<span class="comment">//ÊèíÂÖ•key-value</span></span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.root_page_id_ = header_page-&gt;root_page_id_;</span><br><span class="line">  ctx.write_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageWrite</span>(ctx.root_page_id_));</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsSafePage</span>(ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;(), Operation::Insert, <span class="literal">true</span>)) &#123;<span class="comment">//Â¶ÇÊûúroot_pageÂÆâÂÖ®ÔºåÈáäÊîæheader_pageÁöÑÂÜôÈîÅ</span></span><br><span class="line">    ctx.header_page_ = std::<span class="literal">nullopt</span>;  <span class="comment">// unlock header_page</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">FindLeafPage</span>(key, Operation::Insert, ctx);</span><br><span class="line">  <span class="keyword">auto</span> &amp;leaf_page_guard = ctx.write_set_.<span class="built_in">back</span>();</span><br><span class="line">  <span class="keyword">auto</span> leaf_page = leaf_page_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (!leaf_page-&gt;<span class="built_in">Insert</span>(key, value, comparator_)) &#123;  <span class="comment">// duplicate key, ÊèíÂÖ•Â§±Ë¥•</span></span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (leaf_page-&gt;<span class="built_in">GetSize</span>() &lt; leaf_page-&gt;<span class="built_in">GetMaxSize</span>()) &#123;  <span class="comment">// Âè∂Â≠êËäÇÁÇπÊú™Ê∫¢Âá∫Ôºå‰∏çÈúÄË¶ÅÂàÜË£Ç</span></span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ÂèëÁîüÊ∫¢Âá∫,Âè∂Â≠êËäÇÁÇπÂàÜË£Ç</span></span><br><span class="line">  <span class="keyword">auto</span> new_page_id = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">auto</span> new_leaf_page_guard = bpm_-&gt;<span class="built_in">NewPageGuarded</span>(&amp;new_page_id);</span><br><span class="line">  <span class="keyword">auto</span> new_leaf_page = new_leaf_page_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line">  std::<span class="built_in">copy</span>(leaf_page-&gt;<span class="built_in">GetArray</span>() + leaf_page-&gt;<span class="built_in">GetMinSize</span>(), leaf_page-&gt;<span class="built_in">GetArray</span>() + leaf_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">            new_leaf_page-&gt;<span class="built_in">GetArray</span>());</span><br><span class="line">  new_leaf_page-&gt;<span class="built_in">Init</span>(leaf_max_size_, leaf_page-&gt;<span class="built_in">GetSize</span>() - leaf_page-&gt;<span class="built_in">GetMinSize</span>(), leaf_page-&gt;<span class="built_in">GetNextPageId</span>());</span><br><span class="line">  leaf_page-&gt;<span class="built_in">SetNextPageId</span>(new_leaf_page_guard.<span class="built_in">PageId</span>());</span><br><span class="line">  leaf_page-&gt;<span class="built_in">SetSize</span>(leaf_page-&gt;<span class="built_in">GetMinSize</span>());</span><br><span class="line">  KeyType split_key = new_leaf_page-&gt;<span class="built_in">KeyAt</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="comment">// Â∞Üsplit_keyÊèíÂÖ•Áà∂ËäÇÁÇπ</span></span><br><span class="line">  <span class="built_in">InsertIntoParent</span>(split_key, new_leaf_page_guard.<span class="built_in">PageId</span>(), ctx, ctx.write_set_.<span class="built_in">size</span>() - <span class="number">2</span>);</span><br><span class="line">  ctx.<span class="built_in">Drop</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BPLUSTREE_TYPE::InsertIntoParent</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">page_id_t</span> right_child_id, Context &amp;ctx, <span class="type">int</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;  <span class="comment">// parent‰∏∫header_page</span></span><br><span class="line">    <span class="comment">//ÂàõÂª∫Êñ∞ÁöÑroot_pageÔºåÂπ∂Êõ¥Êñ∞header_page‰∏≠ÁöÑroot_page_id_</span></span><br><span class="line">    <span class="keyword">auto</span> new_root_page_id = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">auto</span> new_root_page_guard = bpm_-&gt;<span class="built_in">NewPageGuarded</span>(&amp;new_root_page_id);</span><br><span class="line">    <span class="keyword">auto</span> new_root_page = new_root_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">    new_root_page-&gt;<span class="built_in">Init</span>(internal_max_size_, <span class="number">2</span>);</span><br><span class="line">    new_root_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].second = ctx.write_set_[index + <span class="number">1</span>].<span class="built_in">PageId</span>();</span><br><span class="line">    new_root_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">1</span>] = &#123;key, right_child_id&#125;;</span><br><span class="line">    <span class="keyword">auto</span> header_page = ctx.header_page_-&gt;<span class="built_in">AsMut</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">    header_page-&gt;root_page_id_ = new_root_page_id;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> parent_page = ctx.write_set_[index].<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (parent_page-&gt;<span class="built_in">Insert</span>(key, right_child_id, comparator_)) &#123;  <span class="comment">// Áà∂ËäÇÁÇπ‰∏çÈúÄË¶ÅÂàÜË£Ç</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Áà∂ËäÇÁÇπÈúÄË¶ÅÂàÜË£Ç</span></span><br><span class="line">  <span class="keyword">auto</span> new_parent_page_id = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">auto</span> new_parent_page_guard = bpm_-&gt;<span class="built_in">NewPageGuarded</span>(&amp;new_parent_page_id);</span><br><span class="line">  <span class="keyword">auto</span> new_parent_page = new_parent_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">  <span class="keyword">auto</span> array = <span class="keyword">new</span> std::pair&lt;KeyType, <span class="type">page_id_t</span>&gt;[parent_page-&gt;<span class="built_in">GetMaxSize</span>() + <span class="number">1</span>];</span><br><span class="line">  std::<span class="built_in">copy</span>(parent_page-&gt;<span class="built_in">GetArray</span>(), parent_page-&gt;<span class="built_in">GetArray</span>() + parent_page-&gt;<span class="built_in">GetMaxSize</span>(), array);</span><br><span class="line">  <span class="comment">// upper_bound</span></span><br><span class="line">  <span class="type">int</span> l = <span class="number">1</span>;</span><br><span class="line">  <span class="type">int</span> r = parent_page-&gt;<span class="built_in">GetMaxSize</span>();</span><br><span class="line">  <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">    <span class="type">int</span> mid = (l + r) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">comparator_</span>(array[mid].first, key) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      r = mid;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Âè≥Áßª‰∏Ä‰ΩçÔºåËÖæÂá∫Á©∫Èó¥</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = parent_page-&gt;<span class="built_in">GetMaxSize</span>() - <span class="number">1</span>; i &gt;= l; --i) &#123;</span><br><span class="line">    array[i + <span class="number">1</span>] = array[i];</span><br><span class="line">  &#125;</span><br><span class="line">  array[l] = &#123;key, right_child_id&#125;;</span><br><span class="line">  std::<span class="built_in">copy</span>(array, array + parent_page-&gt;<span class="built_in">GetMinSize</span>(), parent_page-&gt;<span class="built_in">GetArray</span>());</span><br><span class="line">  std::<span class="built_in">copy</span>(array + parent_page-&gt;<span class="built_in">GetMinSize</span>(), array + parent_page-&gt;<span class="built_in">GetMaxSize</span>() + <span class="number">1</span>, new_parent_page-&gt;<span class="built_in">GetArray</span>());</span><br><span class="line">  new_parent_page-&gt;<span class="built_in">Init</span>(internal_max_size_, parent_page-&gt;<span class="built_in">GetMaxSize</span>() + <span class="number">1</span> - parent_page-&gt;<span class="built_in">GetMinSize</span>());</span><br><span class="line">  parent_page-&gt;<span class="built_in">SetSize</span>(parent_page-&gt;<span class="built_in">GetMinSize</span>());</span><br><span class="line">  <span class="keyword">delete</span>[] array;</span><br><span class="line">  <span class="built_in">InsertIntoParent</span>(new_parent_page-&gt;<span class="built_in">KeyAt</span>(<span class="number">0</span>), new_parent_page_id, ctx, index - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CheckPoint#1Êú¨Âú∞ÊµãËØï<br><br><img src="/../images/cmu15445-project2/4.png" alt="img"><br><img src="/../images/cmu15445-project2/5.png" alt="img"></p>
<p>Á∫ø‰∏äÊµãËØï<br><br><img src="/../images/cmu15445-project2/6.png" alt="img"></p>
<h1 id="CheckPoint-2"><a href="#CheckPoint-2" class="headerlink" title="CheckPoint#2"></a>CheckPoint#2</h1><h2 id="Task-2b-B-Tree-Data-Structure-Deletion"><a href="#Task-2b-B-Tree-Data-Structure-Deletion" class="headerlink" title="Task #2b B+ Tree Data Structure(Deletion)"></a>Task #2b B+ Tree Data Structure(Deletion)</h2><p>DeletionÊìç‰Ωú:</p>
<blockquote>
<p>Â¶ÇÊûúÂà†Èô§ÁöÑleafËäÇÁÇπÊòØrootËäÇÁÇπÔºåÈÇ£‰πàÂà†Èô§ÂêéÁöÑsize &#x3D;&#x3D; 0,Ë°®Á§∫‰∏ãÊ∫¢ÔºåÈúÄË¶ÅÂ∞Üheader_page‰∏≠ÁöÑroot_pageËÆæÁΩÆ‰∏∫INVALID_PAGE_ID<br><br>Â¶ÇÊûúÂà†Èô§ÁöÑleafËäÇÁÇπ‰∏çÊòØrootËäÇÁÇπÔºåÈÇ£‰πàÂà†Èô§ÂêéÁöÑsize &lt; min_sizeË°®Á§∫‰∏ãÊ∫¢<br><br>1.Â¶ÇÊûúÊúâÂè≥Â≠©Â≠ê<br></p>
<blockquote>
<p>2.Âà§Êñ≠ÊòØÂê¶ËÉΩmerge(merge_size &lt; max_size),ËÉΩÂàômergeÔºåÂê¶ÂàôËΩ¨3<br><br>3.ÂêëÂè≥Â≠©Â≠êËøõË°åborrow<br></p>
</blockquote>
</blockquote>
<blockquote>
<p>4.Â¶ÇÊûúÊúâÂ∑¶Â≠©Â≠ê<br></p>
<blockquote>
<p>5.Âà§Êñ≠ÊòØÂê¶ËÉΩmerge(merge_size &lt; min_size),ËÉΩÂàômergeÔºåÂê¶ÂàôËΩ¨6<br><br>6.ÂêëÂ∑¶Â≠©Â≠êËøõË°åborrow<br></p>
</blockquote>
</blockquote>
<blockquote>
<p>mergeÊìç‰ΩúÂêéÈúÄË¶ÅÂà†Èô§internalËäÇÁÇπ‰∏≠ÁöÑentry, ‰∏éÂà†Èô§leafËäÇÁÇπ‰∏≠ÁöÑentryÂçÅÂàÜÁõ∏‰ºº<br></p>
</blockquote>
<blockquote>
<p>Â¶ÇÊûúÂà†Èô§ÁöÑinternalËäÇÁÇπÊòØrootËäÇÁÇπÔºåÈÇ£‰πàÂà†Èô§ÂêéÁöÑsize&#x3D;&#x3D;1Ë°®Á§∫‰∏ãÊ∫¢ÔºåÈúÄË¶ÅÂ∞Üheader_page_‰∏≠ÁöÑroot_page_id_ËÆæÁΩÆ‰∏∫page-&gt;GetArray()[0].second<br><br>Â¶ÇÊûúÂà†Èô§ÁöÑinternalËäÇÁÇπ‰∏çÊòØrootËäÇÁÇπÔºåÈÇ£‰πàÂà†Èô§ÂêéÁöÑsize &lt; min_sizeË°®Á§∫‰∏ãÊ∫¢<br><br>1.Â¶ÇÊûúÊúâÂè≥Â≠©Â≠ê<br></p>
<blockquote>
<p>2.Âà§Êñ≠ÊòØÂê¶ËÉΩmerge(merge_size &lt;&#x3D; max_size),ËÉΩÂàômergeÔºåÂê¶ÂàôËΩ¨3<br><br>3.ÂêëÂè≥Â≠©Â≠êËøõË°åborrow<br></p>
</blockquote>
</blockquote>
<blockquote>
<p>4.Â¶ÇÊûúÊúâÂ∑¶Â≠©Â≠ê<br></p>
<blockquote>
<p>5.Âà§Êñ≠ÊòØÂê¶ËÉΩmerge(merge_size &lt;&#x3D; max_size),ËÉΩÂàômergeÔºåÂê¶ÂàôËΩ¨6<br><br>6.ÂêëÂ∑¶Â≠©Â≠êËøõË°åborrow<br></p>
</blockquote>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BPLUSTREE_TYPE::Remove</span><span class="params">(<span class="type">const</span> KeyType &amp;key, Transaction *txn)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Declaration of context instance.</span></span><br><span class="line">  Context ctx;</span><br><span class="line">  ctx.header_page_ = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(header_page_id_);</span><br><span class="line">  <span class="keyword">auto</span> header_page = ctx.header_page_-&gt;<span class="built_in">AsMut</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (header_page-&gt;root_page_id_ == INVALID_PAGE_ID) &#123;  <span class="comment">// root not exist</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.root_page_id_ = header_page-&gt;root_page_id_;</span><br><span class="line">  ctx.write_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageWrite</span>(ctx.root_page_id_));</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsSafePage</span>(ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;(), Operation::Remove, <span class="literal">true</span>)) &#123;</span><br><span class="line">    ctx.header_page_ = std::<span class="literal">nullopt</span>;  <span class="comment">// unlock header_page</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">FindLeafPage</span>(key, Operation::Remove, ctx);</span><br><span class="line">  <span class="keyword">auto</span> &amp;leaf_page_guard = ctx.write_set_.<span class="built_in">back</span>();</span><br><span class="line">  <span class="keyword">auto</span> leaf_page = leaf_page_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line">  <span class="type">int</span> pos = <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">// key‰∏çÂ≠òÂú®</span></span><br><span class="line">  <span class="keyword">if</span> (!leaf_page-&gt;<span class="built_in">KeyIndex</span>(key, comparator_, pos)) &#123;</span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// keyÂ≠òÂú®,Â∞ÜÂÖ∂‰ªéleaf‰∏≠Âà†Èô§</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = pos + <span class="number">1</span>; i &lt; leaf_page-&gt;<span class="built_in">GetSize</span>(); ++i) &#123;</span><br><span class="line">    leaf_page-&gt;<span class="built_in">GetArray</span>()[i - <span class="number">1</span>] = leaf_page-&gt;<span class="built_in">GetArray</span>()[i];</span><br><span class="line">  &#125;</span><br><span class="line">  leaf_page-&gt;<span class="built_in">SetSize</span>(leaf_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);  <span class="comment">// Êõ¥Êñ∞leaf_pageÁöÑsize</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (leaf_page-&gt;<span class="built_in">GetSize</span>() &gt;= leaf_page-&gt;<span class="built_in">GetMinSize</span>()) &#123;  <span class="comment">// Êó†underflow Áõ¥Êé•ËøîÂõû</span></span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// underflow</span></span><br><span class="line">  <span class="keyword">if</span> (ctx.<span class="built_in">IsRootPage</span>(leaf_page_guard.<span class="built_in">PageId</span>())) &#123;  <span class="comment">// ËØ•Âè∂Â≠êËäÇÁÇπÊòØÊ†πËäÇÁÇπ</span></span><br><span class="line">    <span class="keyword">if</span> (leaf_page-&gt;<span class="built_in">GetSize</span>() == <span class="number">0</span>) &#123;               <span class="comment">// size‰∏∫0</span></span><br><span class="line">      header_page-&gt;root_page_id_ = INVALID_PAGE_ID;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> &amp;parent_page_guard = ctx.write_set_[ctx.write_set_.<span class="built_in">size</span>() - <span class="number">2</span>];</span><br><span class="line">  <span class="keyword">auto</span> parent_page = parent_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">  <span class="keyword">auto</span> index = parent_page-&gt;<span class="built_in">ValueIndex</span>(leaf_page_guard.<span class="built_in">PageId</span>());</span><br><span class="line">  <span class="built_in">BUSTUB_ASSERT</span>(index != <span class="number">-1</span>, <span class="string">&quot;index must not be -1&quot;</span>);</span><br><span class="line">  <span class="comment">// Â¶ÇÊûúÊúâÂè≥brother</span></span><br><span class="line">  <span class="keyword">if</span> (index &lt; parent_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">page_id_t</span> right_brother_page_id = parent_page-&gt;<span class="built_in">GetArray</span>()[index + <span class="number">1</span>].second;</span><br><span class="line">    <span class="keyword">auto</span> right_brother_page_guard = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(right_brother_page_id);</span><br><span class="line">    <span class="keyword">auto</span> right_brother_page = right_brother_page_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> merge_size = right_brother_page-&gt;<span class="built_in">GetSize</span>() + leaf_page-&gt;<span class="built_in">GetSize</span>();</span><br><span class="line">    <span class="keyword">if</span> (merge_size &lt; leaf_page-&gt;<span class="built_in">GetMaxSize</span>()) &#123;  <span class="comment">// ÂèØ‰ª•ÂêàÂπ∂</span></span><br><span class="line">      <span class="comment">// merge</span></span><br><span class="line">      std::<span class="built_in">copy</span>(right_brother_page-&gt;<span class="built_in">GetArray</span>(), right_brother_page-&gt;<span class="built_in">GetArray</span>() + right_brother_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                leaf_page-&gt;<span class="built_in">GetArray</span>() + leaf_page-&gt;<span class="built_in">GetSize</span>());</span><br><span class="line">      leaf_page-&gt;<span class="built_in">SetSize</span>(merge_size);</span><br><span class="line">      leaf_page-&gt;<span class="built_in">SetNextPageId</span>(right_brother_page-&gt;<span class="built_in">GetNextPageId</span>());</span><br><span class="line">      <span class="built_in">RemoveFromParent</span>(index + <span class="number">1</span>, ctx, ctx.write_set_.<span class="built_in">size</span>() - <span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// borrow</span></span><br><span class="line">      leaf_page-&gt;<span class="built_in">GetArray</span>()[leaf_page-&gt;<span class="built_in">GetSize</span>()] = right_brother_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>];</span><br><span class="line">      std::<span class="built_in">copy</span>(right_brother_page-&gt;<span class="built_in">GetArray</span>() + <span class="number">1</span>, right_brother_page-&gt;<span class="built_in">GetArray</span>() + right_brother_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                right_brother_page-&gt;<span class="built_in">GetArray</span>());</span><br><span class="line">      leaf_page-&gt;<span class="built_in">IncreaseSize</span>(<span class="number">1</span>);</span><br><span class="line">      right_brother_page-&gt;<span class="built_in">SetSize</span>(right_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);</span><br><span class="line">      parent_page-&gt;<span class="built_in">SetKeyAt</span>(index + <span class="number">1</span>, right_brother_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].first);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Â∑¶brother</span></span><br><span class="line">    <span class="built_in">BUSTUB_ASSERT</span>(index - <span class="number">1</span> &gt;= <span class="number">0</span>, <span class="string">&quot;left brother must exist&quot;</span>);</span><br><span class="line">    <span class="type">page_id_t</span> left_brother_page_id = parent_page-&gt;<span class="built_in">GetArray</span>()[index - <span class="number">1</span>].second;</span><br><span class="line">    <span class="keyword">auto</span> left_brother_page_guard = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(left_brother_page_id);</span><br><span class="line">    <span class="keyword">auto</span> left_brother_page = left_brother_page_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> merge_size = left_brother_page-&gt;<span class="built_in">GetSize</span>() + leaf_page-&gt;<span class="built_in">GetSize</span>();</span><br><span class="line">    <span class="keyword">if</span> (merge_size &lt; left_brother_page-&gt;<span class="built_in">GetMaxSize</span>()) &#123;  <span class="comment">// ÂèØ‰ª•ÂêàÂπ∂</span></span><br><span class="line">      <span class="comment">// merge</span></span><br><span class="line">      std::<span class="built_in">copy</span>(leaf_page-&gt;<span class="built_in">GetArray</span>(), leaf_page-&gt;<span class="built_in">GetArray</span>() + leaf_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                left_brother_page-&gt;<span class="built_in">GetArray</span>() + left_brother_page-&gt;<span class="built_in">GetSize</span>());</span><br><span class="line">      left_brother_page-&gt;<span class="built_in">SetSize</span>(merge_size);</span><br><span class="line">      left_brother_page-&gt;<span class="built_in">SetNextPageId</span>(leaf_page-&gt;<span class="built_in">GetNextPageId</span>());</span><br><span class="line">      <span class="built_in">RemoveFromParent</span>(index, ctx, ctx.write_set_.<span class="built_in">size</span>() - <span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// borrow</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> i = leaf_page-&gt;<span class="built_in">GetSize</span>(); i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">        leaf_page-&gt;<span class="built_in">GetArray</span>()[i] = leaf_page-&gt;<span class="built_in">GetArray</span>()[i - <span class="number">1</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      leaf_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>] = left_brother_page-&gt;<span class="built_in">GetArray</span>()[left_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>];</span><br><span class="line">      leaf_page-&gt;<span class="built_in">IncreaseSize</span>(<span class="number">1</span>);</span><br><span class="line">      left_brother_page-&gt;<span class="built_in">SetSize</span>(left_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);</span><br><span class="line">      parent_page-&gt;<span class="built_in">SetKeyAt</span>(index, leaf_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].first);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.<span class="built_in">Drop</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BPLUSTREE_TYPE::RemoveFromParent</span><span class="params">(<span class="type">int</span> valueIndex, Context &amp;ctx, <span class="type">int</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> &amp;page_guard = ctx.write_set_[index];</span><br><span class="line">  <span class="keyword">auto</span> page = page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = valueIndex + <span class="number">1</span>; i &lt; page-&gt;<span class="built_in">GetSize</span>(); ++i) &#123;  <span class="comment">// Âà†Èô§key value</span></span><br><span class="line">    page-&gt;<span class="built_in">GetArray</span>()[i - <span class="number">1</span>] = page-&gt;<span class="built_in">GetArray</span>()[i];</span><br><span class="line">  &#125;</span><br><span class="line">  page-&gt;<span class="built_in">SetSize</span>(page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);  <span class="comment">// Êõ¥Êñ∞pageÁöÑsize</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (page-&gt;<span class="built_in">GetSize</span>() &gt;= page-&gt;<span class="built_in">GetMinSize</span>()) &#123;  <span class="comment">// Êó†underflow</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// underflow</span></span><br><span class="line">  <span class="keyword">if</span> (ctx.<span class="built_in">IsRootPage</span>(page_guard.<span class="built_in">PageId</span>())) &#123;  <span class="comment">// ËØ•pageÊòØÊ†πËäÇÁÇπ</span></span><br><span class="line">    <span class="keyword">if</span> (page-&gt;<span class="built_in">GetSize</span>() == <span class="number">1</span>) &#123;               <span class="comment">// Ê†πËäÇÁÇπÈúÄË¶ÅÊõ¥Êç¢‰∫Ü</span></span><br><span class="line">      <span class="built_in">BUSTUB_ASSERT</span>(ctx.header_page_ != std::<span class="literal">nullopt</span>, <span class="string">&quot;ctx.header_page must exist&quot;</span>);</span><br><span class="line">      <span class="keyword">auto</span> header_page = ctx.header_page_-&gt;<span class="built_in">AsMut</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">      header_page-&gt;root_page_id_ = page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].second;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">BUSTUB_ASSERT</span>(index - <span class="number">1</span> &gt;= <span class="number">0</span>, <span class="string">&quot;parent_page_guard must exist&quot;</span>);</span><br><span class="line">  <span class="keyword">auto</span> &amp;parent_page_guard = ctx.write_set_[index - <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">auto</span> parent_page = parent_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">  <span class="keyword">auto</span> pos = parent_page-&gt;<span class="built_in">ValueIndex</span>(page_guard.<span class="built_in">PageId</span>());</span><br><span class="line">  <span class="built_in">BUSTUB_ASSERT</span>(pos != <span class="number">-1</span>, <span class="string">&quot;pos must not be -1&quot;</span>);</span><br><span class="line">  <span class="comment">// Â¶ÇÊûúÊúâÂè≥brother</span></span><br><span class="line">  <span class="keyword">if</span> (pos &lt; parent_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">page_id_t</span> right_brother_page_id = parent_page-&gt;<span class="built_in">GetArray</span>()[pos + <span class="number">1</span>].second;</span><br><span class="line">    <span class="keyword">auto</span> right_brother_page_guard = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(right_brother_page_id);</span><br><span class="line">    <span class="keyword">auto</span> right_brother_page = right_brother_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> merge_size = right_brother_page-&gt;<span class="built_in">GetSize</span>() + page-&gt;<span class="built_in">GetSize</span>();</span><br><span class="line">    <span class="keyword">if</span> (merge_size &lt;= page-&gt;<span class="built_in">GetMaxSize</span>()) &#123;  <span class="comment">// ÂèØ‰ª•ÂêàÂπ∂</span></span><br><span class="line">      <span class="comment">// merge</span></span><br><span class="line">      std::<span class="built_in">copy</span>(right_brother_page-&gt;<span class="built_in">GetArray</span>(), right_brother_page-&gt;<span class="built_in">GetArray</span>() + right_brother_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                page-&gt;<span class="built_in">GetArray</span>() + page-&gt;<span class="built_in">GetSize</span>());</span><br><span class="line">      page-&gt;<span class="built_in">SetSize</span>(merge_size);</span><br><span class="line">      <span class="built_in">RemoveFromParent</span>(pos + <span class="number">1</span>, ctx, index - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// borrow</span></span><br><span class="line">      page-&gt;<span class="built_in">GetArray</span>()[page-&gt;<span class="built_in">GetSize</span>()] = right_brother_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>];</span><br><span class="line">      std::<span class="built_in">copy</span>(right_brother_page-&gt;<span class="built_in">GetArray</span>() + <span class="number">1</span>, right_brother_page-&gt;<span class="built_in">GetArray</span>() + right_brother_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                right_brother_page-&gt;<span class="built_in">GetArray</span>());</span><br><span class="line">      page-&gt;<span class="built_in">IncreaseSize</span>(<span class="number">1</span>);</span><br><span class="line">      right_brother_page-&gt;<span class="built_in">SetSize</span>(right_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);</span><br><span class="line">      parent_page-&gt;<span class="built_in">SetKeyAt</span>(pos + <span class="number">1</span>, right_brother_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].first);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Â∑¶brother</span></span><br><span class="line">    <span class="built_in">BUSTUB_ASSERT</span>(pos - <span class="number">1</span> &gt;= <span class="number">0</span>, <span class="string">&quot;left brother must exist&quot;</span>);</span><br><span class="line">    <span class="type">page_id_t</span> left_brother_page_id = parent_page-&gt;<span class="built_in">GetArray</span>()[pos - <span class="number">1</span>].second;</span><br><span class="line">    <span class="keyword">auto</span> left_brother_page_guard = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(left_brother_page_id);</span><br><span class="line">    <span class="keyword">auto</span> left_brother_page = left_brother_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> merge_size = left_brother_page-&gt;<span class="built_in">GetSize</span>() + page-&gt;<span class="built_in">GetSize</span>();</span><br><span class="line">    <span class="keyword">if</span> (merge_size &lt;= left_brother_page-&gt;<span class="built_in">GetMaxSize</span>()) &#123;  <span class="comment">// ÂèØ‰ª•ÂêàÂπ∂</span></span><br><span class="line">      <span class="comment">// merge</span></span><br><span class="line">      std::<span class="built_in">copy</span>(page-&gt;<span class="built_in">GetArray</span>(), page-&gt;<span class="built_in">GetArray</span>() + page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                left_brother_page-&gt;<span class="built_in">GetArray</span>() + left_brother_page-&gt;<span class="built_in">GetSize</span>());</span><br><span class="line">      left_brother_page-&gt;<span class="built_in">SetSize</span>(merge_size);</span><br><span class="line">      <span class="built_in">RemoveFromParent</span>(pos, ctx, index - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// borrow</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> i = page-&gt;<span class="built_in">GetSize</span>(); i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">        page-&gt;<span class="built_in">GetArray</span>()[i] = page-&gt;<span class="built_in">GetArray</span>()[i - <span class="number">1</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>] = left_brother_page-&gt;<span class="built_in">GetArray</span>()[left_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>];</span><br><span class="line">      page-&gt;<span class="built_in">IncreaseSize</span>(<span class="number">1</span>);</span><br><span class="line">      left_brother_page-&gt;<span class="built_in">SetSize</span>(left_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);</span><br><span class="line">      parent_page-&gt;<span class="built_in">SetKeyAt</span>(pos, page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].first);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Task-3-Index-Iterator"><a href="#Task-3-Index-Iterator" class="headerlink" title="Task #3 Index Iterator"></a>Task #3 Index Iterator</h2><p>Index Iterator ‰ª£Á†ÅÂÆûÁé∞Ôºö</p>
<blockquote>
<p>Index IteratorÁöÑÂÆûÁé∞Âè™ÈúÄË¶ÅÊîØÊåÅÂçïÁ∫øÁ®ã</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">INDEXITERATOR_TYPE::IsEnd</span><span class="params">()</span> <span class="type">const</span> -&gt; <span class="type">bool</span> </span>&#123; <span class="keyword">return</span> read_guard_ == std::<span class="literal">nullopt</span>; &#125;</span><br><span class="line"></span><br><span class="line">INDEX_TEMPLATE_ARGUMENTS</span><br><span class="line"><span class="keyword">auto</span> INDEXITERATOR_TYPE::<span class="keyword">operator</span>*() -&gt; <span class="type">const</span> MappingType &amp; &#123;</span><br><span class="line">  <span class="keyword">auto</span> page = read_guard_-&gt;<span class="built_in">As</span>&lt;B_PLUS_TREE_LEAF_PAGE_TYPE&gt;();</span><br><span class="line">  <span class="built_in">BUSTUB_ASSERT</span>(page-&gt;<span class="built_in">GetSize</span>() &gt; index_, <span class="string">&quot;index_ must be valid&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> page-&gt;<span class="built_in">GetArray</span>()[index_];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">INDEX_TEMPLATE_ARGUMENTS</span><br><span class="line"><span class="keyword">auto</span> INDEXITERATOR_TYPE::<span class="keyword">operator</span>++() -&gt; INDEXITERATOR_TYPE &amp; &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsEnd</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> leaf_page = read_guard_-&gt;<span class="built_in">As</span>&lt;B_PLUS_TREE_LEAF_PAGE_TYPE&gt;();</span><br><span class="line">  <span class="keyword">if</span> (index_ + <span class="number">1</span> &lt; leaf_page-&gt;<span class="built_in">GetSize</span>()) &#123;</span><br><span class="line">    index_++;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (leaf_page-&gt;<span class="built_in">GetNextPageId</span>() != INVALID_PAGE_ID) &#123;</span><br><span class="line">    read_guard_ = bpm_-&gt;<span class="built_in">FetchPageRead</span>(leaf_page-&gt;<span class="built_in">GetNextPageId</span>());</span><br><span class="line">    index_ = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  read_guard_ = std::<span class="literal">nullopt</span>;</span><br><span class="line">  index_ = INVALID_PAGE_ID;</span><br><span class="line">  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> <span class="keyword">operator</span>==(<span class="type">const</span> IndexIterator &amp;itr) <span class="type">const</span> -&gt; <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsEnd</span>() &amp;&amp; itr.<span class="built_in">IsEnd</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsEnd</span>() || itr.<span class="built_in">IsEnd</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> read_guard_-&gt;<span class="built_in">PageId</span>() == itr.read_guard_-&gt;<span class="built_in">PageId</span>() &amp;&amp; index_ == itr.index_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> <span class="keyword">operator</span>!=(<span class="type">const</span> IndexIterator &amp;itr) <span class="type">const</span> -&gt; <span class="type">bool</span> &#123; <span class="keyword">return</span> !(*<span class="keyword">this</span> == itr); &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>BplusTreeÂÆûÁé∞BeginÂíåEndÂáΩÊï∞</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::Begin</span><span class="params">()</span> -&gt; INDEXITERATOR_TYPE </span>&#123;</span><br><span class="line">  Context ctx;</span><br><span class="line">  <span class="keyword">auto</span> header_page_guard = bpm_-&gt;<span class="built_in">FetchPageRead</span>(header_page_id_);</span><br><span class="line">  <span class="keyword">auto</span> header_page = header_page_guard.<span class="built_in">As</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (header_page-&gt;root_page_id_ == INVALID_PAGE_ID) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">INDEXITERATOR_TYPE</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.root_page_id_ = header_page-&gt;root_page_id_;</span><br><span class="line">  ctx.read_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageRead</span>(ctx.root_page_id_));</span><br><span class="line">  header_page_guard.<span class="built_in">Drop</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> page = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">  <span class="keyword">while</span> (!page-&gt;<span class="built_in">IsLeafPage</span>()) &#123;</span><br><span class="line">    <span class="keyword">auto</span> internal = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;InternalPage&gt;();</span><br><span class="line">    <span class="type">page_id_t</span> id = internal-&gt;<span class="built_in">ValueAt</span>(<span class="number">0</span>);</span><br><span class="line">    ctx.read_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageRead</span>(id));</span><br><span class="line">    ctx.read_set_.<span class="built_in">pop_front</span>();</span><br><span class="line">    page = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">INDEXITERATOR_TYPE</span>(bpm_, std::<span class="built_in">move</span>(ctx.read_set_.<span class="built_in">back</span>()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::Begin</span><span class="params">(<span class="type">const</span> KeyType &amp;key)</span> -&gt; INDEXITERATOR_TYPE </span>&#123;</span><br><span class="line">  Context ctx;</span><br><span class="line">  <span class="keyword">auto</span> header_page_guard = bpm_-&gt;<span class="built_in">FetchPageRead</span>(header_page_id_);</span><br><span class="line">  <span class="keyword">auto</span> header_page = header_page_guard.<span class="built_in">As</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (header_page-&gt;root_page_id_ == INVALID_PAGE_ID) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">INDEXITERATOR_TYPE</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.root_page_id_ = header_page-&gt;root_page_id_;</span><br><span class="line">  ctx.read_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageRead</span>(ctx.root_page_id_));</span><br><span class="line">  header_page_guard.<span class="built_in">Drop</span>();</span><br><span class="line">  <span class="built_in">FindLeafPage</span>(key, Operation::Search, ctx);</span><br><span class="line">  <span class="type">int</span> pos = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (!ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;LeafPage&gt;()-&gt;<span class="built_in">KeyIndex</span>(key, comparator_, pos)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">Exception</span>(<span class="string">&quot;key not exist&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">INDEXITERATOR_TYPE</span>(bpm_, std::<span class="built_in">move</span>(ctx.read_set_.<span class="built_in">back</span>()), pos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::End</span><span class="params">()</span> -&gt; INDEXITERATOR_TYPE </span>&#123; <span class="keyword">return</span> <span class="built_in">INDEXITERATOR_TYPE</span>(); &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Task-4-Concurrency-Control"><a href="#Task-4-Concurrency-Control" class="headerlink" title="Task #4 Concurrency Control"></a>Task #4 Concurrency Control</h2><h3 id="Latch-Crabbing-Coupling"><a href="#Latch-Crabbing-Coupling" class="headerlink" title="Latch Crabbing&#x2F;Coupling"></a>Latch Crabbing&#x2F;Coupling<br></h3><p>Latch Crabbing ÁöÑÂü∫Êú¨ÊÄùÊÉ≥Â¶Ç‰∏ãÔºö<br></p>
<ol>
<li>Ëé∑Âèñ parent ÁöÑ latch<br></li>
<li>Ëé∑Âèñ child ÁöÑ latch<br></li>
<li>Â¶ÇÊûúÂÆâÂÖ®ÔºåÂàôÂèØ‰ª•ÈáäÊîæ parent ÁöÑ latch</li>
</ol>
<p>ËøôÈáåÁöÑ‚ÄúÂÆâÂÖ®‚ÄùÊåáÁöÑÊòØÔºåÂΩìÂèëÁîüÊõ¥Êñ∞Êìç‰ΩúÊó∂ÔºåËØ•ËäÇÁÇπ‰∏ç‰ºöÂèëÁîü split Êàñ merge ÁöÑÊìç‰ΩúÔºåÂç≥Ôºö</p>
<ul>
<li>Âú®ÊèíÂÖ•ÂÖÉÁ¥†Êó∂ÔºåËäÇÁÇπÊú™Êª°</li>
<li>Âú®Âà†Èô§ÂÖÉÁ¥†Êó∂ÔºåËäÇÁÇπË∂ÖËøáÂçäÊª°</li>
</ul>
<p>Search<br>‰ªé root ÂæÄ‰∏ãÔºå‰∏çÊñ≠Âú∞Ôºö</p>
<ul>
<li>Ëé∑Âèñ child ÁöÑ read latch</li>
<li>ÈáäÊîæ parent ÁöÑ read latch</li>
</ul>
<p><img src="/../images/cmu15445-project2/8.png" alt="img"><br><img src="/../images/cmu15445-project2/9.png" alt="img"><br><img src="/../images/cmu15445-project2/10.png" alt="img"><br><img src="/../images/cmu15445-project2/11.png" alt="img"><br><img src="/../images/cmu15445-project2/12.png" alt="img"></p>
<p>Insert&#x2F;Delete<br><br>‰ªé root ÂæÄ‰∏ãÔºåÊåâÁÖßÈúÄË¶ÅËé∑Âèñ write latchÔºå‰∏ÄÊó¶Ëé∑Âèñ‰∫Ü child ÁöÑ write latchÔºåÊ£ÄÊü•ÂÆÉÊòØÂê¶ÂÆâÂÖ®ÔºåÂ¶ÇÊûúÂÆâÂÖ®ÔºåÂàôÈáäÊîæ‰πãÂâçËé∑ÂèñÁöÑÊâÄÊúâ write latch„ÄÇ<br>ÂÆâÂÖ®Âà§Êñ≠ÂáΩÊï∞ÈÄªËæëËßÅÂáΩÊï∞IsSafePage<br></p>
<h3 id="Better-Latching-Algorithm"><a href="#Better-Latching-Algorithm" class="headerlink" title="Better Latching Algorithm"></a>Better Latching Algorithm<br></h3><ul>
<li>SearchÔºö‰∏é Latch Crabbing Áõ∏Âêå<br></li>
<li>Insert&#x2F;Delete:<br><ul>
<li>‰ΩøÁî®‰∏é Search Áõ∏ÂêåÁöÑÊñπÂºèÂú®Êü•ËØ¢Ë∑ØÂæÑ‰∏äËé∑Âèñ„ÄÅÈáäÊîæ latchÔºåÂú® leaf node ‰∏äËé∑Âèñ write latch<br></li>
<li>Â¶ÇÊûú leaf node ‰∏çÂÆâÂÖ®ÔºåÂèØËÉΩ‰ºöÂºïËµ∑ÂÖ∂ÂÆÉËäÇÁÇπÁöÑÂèòÂä®ÔºåÂàô‰ΩøÁî® Latch Crabbing ÁöÑÁ≠ñÁï•ÂÜçÊâßË°å‰∏ÄÈÅç<br></li>
</ul>
</li>
</ul>
<p>ËØ•ÊñπÊ≥ï‰πêËßÇÂú∞ÂÅáËÆæÊï¥‰∏™Êìç‰ΩúÂè™‰ºöÂºïËµ∑ leaf node ÁöÑÂèòÂåñÔºåËã•ÂÅáËÆæÈîôËØØÔºåÂàô‰ΩøÁî® Latch Crabbing ÁöÑÂéüÂßãÊñπÊ°à„ÄÇ<br></p>
<p>CheckPoint#2Êú¨Âú∞ÊµãËØï<br><br><img src="/../images/cmu15445-project2/13.png" alt="img"><br><img src="/../images/cmu15445-project2/14.png" alt="img"><br><img src="/../images/cmu15445-project2/15.png" alt="img"><br><img src="/../images/cmu15445-project2/16.png" alt="img"></p>
<p><a target="_blank" rel="noopener" href="https://15445.courses.cs.cmu.edu/spring2023/bpt-printer/">Bustub Tree printer</a><br></p>
<p>CheckPoint#2Á∫ø‰∏äÊµãËØï<br><br><img src="/../images/cmu15445-project2/7.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/02/26/cmu15445-project1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/26/cmu15445-project1/" class="post-title-link" itemprop="url">cmu15445-project1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-02-26 03:58:49 / Modified: 21:28:57" itemprop="dateCreated datePublished" datetime="2024-02-26T03:58:49-08:00">2024-02-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cmu15445-2023/" itemprop="url" rel="index"><span itemprop="name">cmu15445-2023</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="project1ÁöÑ‰ªªÂä°Â∞±ÊòØÂÆûÁé∞‰∏Ä‰∏™Buffer-Pool-Manager"><a href="#project1ÁöÑ‰ªªÂä°Â∞±ÊòØÂÆûÁé∞‰∏Ä‰∏™Buffer-Pool-Manager" class="headerlink" title="project1ÁöÑ‰ªªÂä°Â∞±ÊòØÂÆûÁé∞‰∏Ä‰∏™Buffer Pool Manager"></a>project1ÁöÑ‰ªªÂä°Â∞±ÊòØÂÆûÁé∞‰∏Ä‰∏™Buffer Pool Manager<br></h2><p>DBMSÂêØÂä®Êó∂‰ºö‰ªéOSÁî≥ËØ∑‰∏ÄÁâáÂÜÖÂ≠òÂå∫ÂüüÔºåÂç≥Buffer PoolÔºåÂπ∂Â∞ÜËøôÂùóÂå∫ÂüüÂàíÂàÜÊàêÂ§ßÂ∞èÁõ∏ÂêåÁöÑpagesÔºå‰∏∫‰∫Ü‰∏édisk pagesÂå∫Âà´ÔºåÈÄöÂ∏∏Áß∞‰∏∫framesÔºåÂΩìDBMSËØ∑Ê±Ç‰∏Ä‰∏™disk pageÊó∂ÔºåÂÆÉÈ¶ñÂÖàÈúÄË¶ÅË¢´Â§çÂà∂Âà∞Buffer PoolÁöÑ‰∏Ä‰∏™frame‰∏≠„ÄÇÂΩìBuffer PoolÁ©∫Èó¥‰∏çË∂≥Êó∂ÔºåÈúÄË¶ÅÈááÂèñÊüêÁßçreplacement policyÔºåÊ∑òÊ±∞Â∑≤ÊúâÁöÑpage„ÄÇ<br><img src="/../images/cmu15445-project1/1.png" alt="img"></p>
<p>question 1:<br>‰∏∫‰ªÄ‰πà‰∏ç‰ΩøÁî®OSËá™Â∏¶ÁöÑÁ£ÅÁõòÁÆ°ÁêÜÊ®°ÂùóÔºåOS‰∏∫ÂºÄÂèëËÄÖÊèê‰æõ‰∫ÜmmapËøôÊ†∑ÁöÑË∞ÉÁî®Ôºå‰ΩøÂºÄÂèëËÄÖËÉΩÂ§ü‰æùËµñOSËá™Âä®ÁÆ°ÁêÜÊï∞ÊçÆÂú®ÂÜÖÂ§ñÂ≠ò‰πãÈó¥ÁöÑÁßªÂä®Ôºü</p>
<blockquote>
<p>DBMSÊØîOSÊã•ÊúâÊõ¥Â§ö„ÄÅÊõ¥ÂÖÖÂàÜÁöÑÁü•ËØÜÊù•ÂÜ≥ÂÆöÊï∞ÊçÆÁßªÂä®ÁöÑÁßªÂä®ÂíåÊï∞ÈáèÔºåÂÖ∑‰ΩìÂåÖÊã¨</p>
<ol>
<li>Â∞Üdirty pagesÊåâÊ≠£Á°ÆÁöÑÈ°∫Â∫èÂÜôÂà∞Á£ÅÁõò</li>
<li>Ê†πÊçÆÂÖ∑‰ΩìÊÉÖÂÜµÈ¢ÑËé∑ÂèñÊï∞ÊçÆ</li>
<li>ÂÆöÂà∂ÂåñÁºìÂ≠òÁΩÆÊç¢Á≠ñÁï•</li>
</ol>
</blockquote>
<p>ÂêåÊó∂DBMS‰ºöÁª¥Êä§‰∏Ä‰∏™page tableÔºåË¥üË¥£ËÆ∞ÂΩïÊØè‰∏™pageÂú®ÂÜÖÂ≠ò‰∏≠ÁöÑ‰ΩçÁΩÆÔºå‰ª•ÂèäÊòØÂê¶Ë¢´ÂÜôËøá(Dirty Flag),ÊòØÂê¶Ë¢´ÂºïÁî®ÊàñÂºïÁî®ËÆ°Êï∞(Pin&#x2F;Reference Counter)Á≠âÂÖÉ‰ø°ÊÅØÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫:</p>
<p><img src="/../images/cmu15445-project1/2.png" alt="img"></p>
<p>ÂΩìpage table‰∏≠ÁöÑÊüêpageË¢´ÂºïÁî®Êó∂Ôºå‰ºöËÆ∞ÂΩïÂºïÁî®Êï∞(pin&#x2F;reference),Ë°®Á§∫ËØ•pageÊ≠£Âú®Ë¢´‰ΩøÁî®ÔºåÁ©∫Èó¥‰∏çÂ§üÊó∂‰∏çÂ∫îËØ•Ë¢´ÁßªÈô§ÔºõÂΩìË¢´ËØ∑Ê±ÇÁöÑpage‰∏çÂÜçpage table‰∏≠Êó∂ÔºåDBMS‰ºöÁî≥ËØ∑‰∏Ä‰∏™latch(lockÁöÑÂà´Âêç)ÔºåË°®Á§∫ËØ•entryË¢´Âç†Áî®ÔºåÁÑ∂Âêé‰ªédisk‰∏≠ËØªÂèñÁõ∏ÂÖ≥pageÂà∞buffer poolÔºåÈáäÊîælatch</p>
<p><img src="/../images/cmu15445-project1/3.png" alt="img"></p>
<h2 id="Buffer-Replacement-Policies"><a href="#Buffer-Replacement-Policies" class="headerlink" title="Buffer Replacement Policies"></a>Buffer Replacement Policies</h2><h3 id="LRU"><a href="#LRU" class="headerlink" title="LRU"></a>LRU</h3><p>Áª¥Êä§ÊØè‰∏™page‰∏ä‰∏ÄÊ¨°Ë¢´ËÆøÈóÆÁöÑÊó∂Èó¥Êà≥ÔºåÊØèÊ¨°ÁßªÈô§Êó∂Èó¥Êà≥ÊúÄÊó©ÁöÑpage</p>
<h3 id="Clock"><a href="#Clock" class="headerlink" title="Clock"></a>Clock</h3><p>ClockÊòØLRUÁöÑËøë‰ººÁ≠ñÁï•ÔºåÂÆÉ‰∏çÈúÄË¶ÅÊØè‰∏™page‰∏äÊ¨°Ë¢´ËÆøÈóÆÁöÑÊó∂Èó¥Êà≥ÔºåËÄåÊòØ‰∏∫ÊØè‰∏™page‰øùÂ≠ò‰∏Ä‰∏™reference</p>
<ul>
<li>ÊØèÂΩìpageË¢´ËÆøÈóÆÊó∂Ôºåreference bitËÆæÁΩÆ‰∏∫1</li>
<li>ÊØèÂΩìÈúÄË¶ÅÁßªÂä®pageÊó∂Ôºå‰ªé‰∏äÊ¨°ËÆøÈóÆÁöÑ‰ΩçÁΩÆÂºÄÂßãÔºåÊåâÈ°∫Â∫èËΩÆËØ¢ÔºåÊØè‰∏™pageÁöÑreference bitÔºåËã•ËØ•bit‰∏∫1ÔºåÂàôÈáçÁΩÆ‰∏∫0ÔºõËã•ËØ•bit‰∏∫0ÔºåÂàôÁßªÈô§ËØ•page</li>
</ul>
<h3 id="LRU-K"><a href="#LRU-K" class="headerlink" title="LRU-K"></a>LRU-K</h3><p>‰øùÂ≠òÊØè‰∏™pageÁöÑÊúÄÂêéKÊ¨°ËÆøÈóÆÊó∂Èó¥Êà≥ÔºåÂà©Áî®Ëøô‰∫õÊó∂Èó¥Êà≥Êù•‰º∞ËÆ°ÂÆÉ‰ª¨‰∏ãÊ¨°Ë¢´ËÆøÈóÆÁöÑÊó∂Èó¥ÔºåÈÄöÂ∏∏KÂèñ1Â∞±ËÉΩËé∑ÂæóÂæàÂ•ΩÁöÑÊïàÊûú„ÄÇ</p>
<h2 id="Task-1-LRU-K-Replacement-Policy"><a href="#Task-1-LRU-K-Replacement-Policy" class="headerlink" title="Task#1 LRU-K Replacement Policy"></a>Task#1 LRU-K Replacement Policy</h2><p>ÂÆûÁé∞LRUKReplacer<br>ÂÆûÁé∞Á≠ñÁï•:</p>
<blockquote>
<p>LRU-KÁÆóÊ≥ïÈ©±ÈÄêreplacerÁöÑÊâÄÊúâframe‰∏≠backward k-distanceÊúÄÂ§ßÁöÑframe<br><br>backward k-distanceËÆ°ÁÆóÊñπÂºè:ÂΩìÂâçÊó∂Èó¥Êà≥‰∏é‰πãÂâçkÊ¨°ËÆøÈóÆÁöÑÊó∂Èó¥Êà≥‰πãÈó¥ÁöÑÊó∂Èó¥Â∑Æ„ÄÇ<br><br>ÂéÜÂè≤ËÆøÈóÆÊ¨°Êï∞Â∞ë‰∫ékÁöÑÂ∏ßË¢´Ëµã‰∫à+inf‰Ωú‰∏∫ÂÖ∂backward k-distance,ÂΩìÂ§ö‰∏™frameÂÖ∑Êúâ+inf backward k-distanceÊó∂ÔºåreplacerÂ∞ÜÈ©±ÈÄêÂÖ∑ÊúâÊúÄÊó©ÊÄª‰ΩìÊó∂Èó¥Êà≥ÁöÑframe<br></p>
</blockquote>
<h3 id="‰ª£Á†ÅÂÆûÁé∞Ôºö"><a href="#‰ª£Á†ÅÂÆûÁé∞Ôºö" class="headerlink" title="‰ª£Á†ÅÂÆûÁé∞Ôºö"></a>‰ª£Á†ÅÂÆûÁé∞Ôºö<br></h3><p>‰∏Ä‰∏™LRUKNodeÂØπÂ∫î‰∏Ä‰∏™frame</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LRUKNode</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/** History of last seen K timestamps of this page. Least recent timestamp stored in front. */</span></span><br><span class="line">  std::list&lt;<span class="type">size_t</span>&gt; history_;<span class="comment">//ËÆ∞ÂΩï‰∏ÄÊâπÊó∂Èó¥Êà≥</span></span><br><span class="line">  <span class="type">frame_id_t</span> fid_;<span class="comment">//</span></span><br><span class="line">  <span class="type">bool</span> is_evictable_&#123;<span class="literal">false</span>&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LRUKReplacer</span> &#123;</span><br><span class="line">  std::unordered_map&lt;<span class="type">frame_id_t</span>, LRUKNode&gt; node_store_;<span class="comment">//frame LRUKNode couple</span></span><br><span class="line">  <span class="type">size_t</span> current_timestamp_&#123;<span class="number">0</span>&#125;;<span class="comment">//ÂΩìÂâçÊó∂Èó¥Êà≥</span></span><br><span class="line">  <span class="comment">//replacer_size_ &gt;= curr_size</span></span><br><span class="line">  <span class="type">size_t</span> curr_size_&#123;<span class="number">0</span>&#125;;<span class="comment">//curr_size‰∏∫ÂΩìÂâçis_evictableË¢´Ê†áËÆ∞‰∏∫trueÁöÑframeÊï∞Èáè</span></span><br><span class="line">  <span class="type">size_t</span> replacer_size_;<span class="comment">//replacer_size == num_frames</span></span><br><span class="line">  <span class="type">size_t</span> k_;</span><br><span class="line">  std::mutex latch_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>EvictÂáΩÊï∞</p>
<blockquote>
<p>È©±ÈÄê‰∏Ä‰∏™frameÔºåÈ©±ÈÄêÊàêÂäüËøîÂõûtrueÔºåÂê¶ÂàôËøîÂõûfalse</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">LRUKReplacer::Evict</span><span class="params">(<span class="type">frame_id_t</span> *frame_id)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">guard</span><span class="params">(latch_)</span></span>;</span><br><span class="line">  *frame_id = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;p : node_store_) &#123;</span><br><span class="line">    <span class="keyword">if</span> (p.second.is_evictable_) &#123;<span class="comment">//ÈÄöËøáJudgeÂáΩÊï∞ÈÄâÊã©backward k-distance‰∏≠ÊúÄÂ§ßÁöÑframe</span></span><br><span class="line">      <span class="keyword">if</span> (*frame_id == <span class="number">-1</span> || <span class="built_in">Judge</span>(p.second, node_store_[*frame_id])) &#123;</span><br><span class="line">        *frame_id = p.second.fid_;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (*frame_id != <span class="number">-1</span>) &#123;</span><br><span class="line">    node_store_.<span class="built_in">erase</span>(*frame_id);</span><br><span class="line">    --curr_size_;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JudgeÂáΩÊï∞ÂÆûÁé∞Â¶Ç‰∏ã</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lhsÁöÑbackward k-distanceÂ§ß‰∫érhsÁöÑbackward k-distance ËøîÂõûtrue Âê¶ÂàôËøîÂõûfalse</span></span><br><span class="line">  <span class="function"><span class="keyword">auto</span> <span class="title">Judge</span><span class="params">(<span class="type">const</span> LRUKNode &amp;lhs, <span class="type">const</span> LRUKNode &amp;rhs)</span> <span class="type">const</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rhs.history_.<span class="built_in">size</span>() == k_ &amp;&amp; lhs.history_.<span class="built_in">size</span>() &lt; k_) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rhs.history_.<span class="built_in">size</span>() &lt; k_ &amp;&amp; lhs.history_.<span class="built_in">size</span>() == k_) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ÊØîËæÉÊúÄÊó©ÁöÑÊó∂Èó¥Êà≥,Ëã•lhsÁöÑÊó∂Èó¥Êà≥Êõ¥Â∞èÔºåÂàôËøîÂõûtrue Âê¶ÂàôËøîÂõûfalse</span></span><br><span class="line">    <span class="keyword">return</span> lhs.history_.<span class="built_in">back</span>() &lt; rhs.history_.<span class="built_in">back</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>RecordAccessÂáΩÊï∞</p>
<blockquote>
<ol>
<li>Â¶ÇÊûúËÆøÈóÆÁöÑframe_idÂ§ß‰∫éÁ≠â‰∫éreplacer_sizeÊäõÂá∫ÂºÇÂ∏∏</li>
<li>Âê¶ÂàôÔºåÂØπËØ•frameÂØπÂ∫îÁöÑLRUKNodeÊ∑ªÂä†Êó∂Èó¥Êà≥ÔºåÂπ∂‰∏î‰øùËØÅhistory_ÂàóË°®ÈïøÂ∫¶‰∏çË∂ÖËøák_</li>
</ol>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LRUKReplacer::RecordAccess</span><span class="params">(<span class="type">frame_id_t</span> frame_id, [[maybe_unused]] AccessType access_type)</span> </span>&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock_guard</span><span class="params">(latch_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (frame_id &gt;= <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(replacer_size_)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">Exception</span>(<span class="string">&quot;frame_id is larger than or equal to replacer_size_&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (node_store_.<span class="built_in">count</span>(frame_id) == <span class="number">0</span>) &#123;</span><br><span class="line">    node_store_[frame_id] = <span class="built_in">LRUKNode</span>();</span><br><span class="line">    node_store_[frame_id].fid_ = frame_id;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> &amp;node = node_store_[frame_id];</span><br><span class="line">  node.history_.<span class="built_in">push_front</span>(current_timestamp_++);</span><br><span class="line">  <span class="keyword">while</span> (node.history_.<span class="built_in">size</span>() &gt; k_) &#123;</span><br><span class="line">    node.history_.<span class="built_in">pop_back</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SetEvictableÂáΩÊï∞</p>
<blockquote>
<p>Â∞ÜÊüê‰∏™frameÁöÑis_evictableÊ†áËÆ∞‰∏∫set_evictable,Â¶ÇÊûúËØ•frameÊú™Ë¢´Âç†Áî®ÔºåÊäõÂá∫ÂºÇÂ∏∏<br>false-&gt;true   curr_size_++<br>true-&gt;false   curr_size_‚Äì</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LRUKReplacer::SetEvictable</span><span class="params">(<span class="type">frame_id_t</span> frame_id, <span class="type">bool</span> set_evictable)</span> </span>&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock_guard</span><span class="params">(latch_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (node_store_.<span class="built_in">count</span>(frame_id) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">Exception</span>(<span class="string">&quot;frame_id should be used&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!node_store_[frame_id].is_evictable_ &amp;&amp; set_evictable) &#123;  <span class="comment">// false -&gt; true</span></span><br><span class="line">    curr_size_++;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node_store_[frame_id].is_evictable_ &amp;&amp; !set_evictable) &#123;  <span class="comment">// true -&gt; false</span></span><br><span class="line">    curr_size_--;</span><br><span class="line">  &#125;</span><br><span class="line">  node_store_[frame_id].is_evictable_ = set_evictable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RemoveÂáΩÊï∞</p>
<blockquote>
<p>Â¶ÇÊûúÂà†Èô§ÁöÑframe‰∏çÂ≠òÂú®Áõ¥Êé•ËøîÂõû<br>Â¶ÇÊûúÂà†Èô§ÁöÑframeÁöÑis_evictable_Êú™Ë¢´ËÆæÁΩÆ‰∏∫trueÔºåÊäõÂá∫ÂºÇÂ∏∏<br>Âà†Èô§frameÔºå‚Äìcurr_size_</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">LRUKReplacer::Remove</span><span class="params">(<span class="type">frame_id_t</span> frame_id)</span> </span>&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock_guard</span><span class="params">(latch_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (node_store_.<span class="built_in">count</span>(frame_id) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!node_store_[frame_id].is_evictable_) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">Exception</span>(<span class="string">&quot;Remove a non-evictable frame&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  node_store_.<span class="built_in">erase</span>(frame_id);</span><br><span class="line">  --curr_size_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>task1Êú¨Âú∞ÊµãËØïÔºö<br><img src="/../images/cmu15445-project1/5.png" alt="img"></p>
<h2 id="Task-2-Buffer-Pool-Manager"><a href="#Task-2-Buffer-Pool-Manager" class="headerlink" title="Task#2 -Buffer Pool Manager"></a>Task#2 -Buffer Pool Manager</h2><p>ÂÆåÊàêLRU-KÊõøÊç¢Á≠ñÁï•‰πãÂêéÔºåÊé•‰∏ãÊù•ÈúÄË¶ÅÂÆûÁé∞Buffer PoolÁöÑÂü∫Êú¨ÂäüËÉΩ„ÄÇÂØπ‰∫éDBMSÊù•ËØ¥ÔºåBuffer PoolÂèØ‰ª•ÈöêËóèÂÜÖÂ≠òÂíåÁ£ÅÁõò‰∫§‰∫íÁöÑÁªÜËäÇÔºåÂåÖÊã¨ËÑèÈ°µÈù¢ÂÜôÂõûÁ£ÅÁõòÁöÑËøáÁ®ã„ÄÇ</p>
<p>Page</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Page</span> &#123;</span><br><span class="line">  <span class="type">char</span> *data_;<span class="comment">//4096Â≠óËäÇ</span></span><br><span class="line">  <span class="type">page_id_t</span> page_id;<span class="comment">//physical page id</span></span><br><span class="line">  <span class="type">int</span> pin_count_;<span class="comment">//ËØ•PageÂØπË±°ÁöÑÂºïÁî®ËÆ°Êï∞</span></span><br><span class="line">  <span class="type">bool</span> is_dirty_;<span class="comment">//ËÑè‰Ωç</span></span><br><span class="line">  ReaderWriterLatch rwlatch_;<span class="comment">//ËØªÂÜôÈîÅ</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>BufferPoolManager</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BufferPoolManager</span> &#123;</span><br><span class="line">    <span class="comment">/** Number of pages in the buffer pool. */</span></span><br><span class="line">  <span class="type">const</span> <span class="type">size_t</span> pool_size_;</span><br><span class="line">  <span class="comment">/** The next page id to be allocated  */</span></span><br><span class="line">  std::atomic&lt;<span class="type">page_id_t</span>&gt; next_page_id_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Array of buffer pool pages. */</span></span><br><span class="line">  Page *pages_;</span><br><span class="line">  <span class="comment">/** Pointer to the disk manager. */</span></span><br><span class="line">  DiskManager *disk_manager_ __attribute__((__unused__));</span><br><span class="line">  <span class="comment">/** Pointer to the log manager. Please ignore this for P1. */</span></span><br><span class="line">  LogManager *log_manager_ __attribute__((__unused__));</span><br><span class="line">  <span class="comment">/** Page table for keeping track of buffer pool pages. */</span></span><br><span class="line">  std::unordered_map&lt;<span class="type">page_id_t</span>, <span class="type">frame_id_t</span>&gt; page_table_;</span><br><span class="line">  <span class="comment">/** Replacer to find unpinned pages for replacement. */</span></span><br><span class="line">  std::unique_ptr&lt;LRUKReplacer&gt; replacer_;</span><br><span class="line">  <span class="comment">/** List of free frames that don&#x27;t have any pages on them. */</span></span><br><span class="line">  std::list&lt;<span class="type">frame_id_t</span>&gt; free_list_;</span><br><span class="line">  <span class="comment">/** This latch protects shared data structures. We recommend updating this comment to describe what it protects. */</span></span><br><span class="line">  std::mutex latch_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>BufferPoolManagerÂàùÂßãÂåñÊó∂ÔºåÂàÜÈÖçpool_size_‰∏™PageÂØπË±°ÔºåLRUKReplacerÁöÑnum_frame‰πüËÆæÁΩÆ‰∏∫pool_size_</p>
<h3 id="‰ª£Á†ÅÂÆûÁé∞Ôºö-1"><a href="#‰ª£Á†ÅÂÆûÁé∞Ôºö-1" class="headerlink" title="‰ª£Á†ÅÂÆûÁé∞Ôºö"></a>‰ª£Á†ÅÂÆûÁé∞Ôºö<br></h3><p>NewPageÂáΩÊï∞ÂÆûÁé∞Ôºö</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BufferPoolManager::NewPage</span><span class="params">(<span class="type">page_id_t</span> *page_id)</span> -&gt; Page * </span>&#123;</span><br><span class="line">  <span class="type">frame_id_t</span> free_frame_id = <span class="number">-1</span>;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">guard</span><span class="params">(latch_)</span></span>;</span><br><span class="line">  <span class="comment">//Ëé∑Âèñ‰∏Ä‰∏™Á©∫Èó≤ÁöÑframe</span></span><br><span class="line">  <span class="keyword">if</span> (!free_list_.<span class="built_in">empty</span>()) &#123;<span class="comment">//Â≠òÂú®Á©∫ÁöÑframe</span></span><br><span class="line">    free_frame_id = free_list_.<span class="built_in">front</span>();</span><br><span class="line">    free_list_.<span class="built_in">pop_front</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;<span class="comment">//‰∏çÂ≠òÂú®Á©∫ÁöÑframe</span></span><br><span class="line">    <span class="keyword">if</span> (!replacer_-&gt;<span class="built_in">Evict</span>(&amp;free_frame_id)) &#123;<span class="comment">//ÈÄöËøáLRUKReplacerÂæóÂà∞‰∏Ä‰∏™Á©∫Èó≤ÁöÑframe</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pages_[free_frame_id].<span class="built_in">IsDirty</span>()) &#123;<span class="comment">//Â¶ÇÊûúË¢´È©±ÈÄêÁöÑframeÂØπÂ∫îÁöÑpage‰∏∫ËÑèÈ°µÔºåÈúÄË¶ÅËøõË°åÂÜôÂõûÊìç‰Ωú</span></span><br><span class="line">      disk_manager_-&gt;<span class="built_in">WritePage</span>(pages_[free_frame_id].page_id_, pages_[free_frame_id].data_);</span><br><span class="line">    &#125;</span><br><span class="line">    page_table_.<span class="built_in">erase</span>(pages_[free_frame_id].page_id_);<span class="comment">//Â∞Üpage_table_‰∏≠ËØ•frameÂØπÂ∫îÁöÑpage_id_Âà†Èô§</span></span><br><span class="line">    pages_[free_frame_id].<span class="built_in">ResetMemory</span>();<span class="comment">//ÈáçÁΩÆËØ•ÊîπframeÂØπÂ∫îÁöÑÂÜÖÂ≠ò</span></span><br><span class="line">  &#125;</span><br><span class="line">  *page_id = <span class="built_in">AllocatePage</span>();</span><br><span class="line">  pages_[free_frame_id].page_id_ = *page_id;</span><br><span class="line">  pages_[free_frame_id].pin_count_ = <span class="number">1</span>;</span><br><span class="line">  pages_[free_frame_id].is_dirty_ = <span class="literal">false</span>;</span><br><span class="line">  page_table_[*page_id] = free_frame_id;</span><br><span class="line"></span><br><span class="line">  replacer_-&gt;<span class="built_in">RecordAccess</span>(free_frame_id);</span><br><span class="line">  replacer_-&gt;<span class="built_in">SetEvictable</span>(free_frame_id, <span class="literal">false</span>);  <span class="comment">// no use</span></span><br><span class="line">  <span class="keyword">return</span> pages_ + free_frame_id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FetchPageÂáΩÊï∞ÂÆûÁé∞:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BufferPoolManager::FetchPage</span><span class="params">(<span class="type">page_id_t</span> page_id, [[maybe_unused]] AccessType access_type)</span> -&gt; Page * </span>&#123;</span><br><span class="line">  <span class="built_in">BUSTUB_ASSERT</span>(page_id != INVALID_PAGE_ID, <span class="string">&quot;page_id is equal to INVALID_PAGE_ID&quot;</span>);</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">guard</span><span class="params">(latch_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (page_table_.<span class="built_in">count</span>(page_id) != <span class="number">0</span>) &#123;<span class="comment">//Â¶ÇÊûúpage_table_‰∏≠Â≠òÂú®ËØ•page_id</span></span><br><span class="line">    pages_[page_table_[page_id]].pin_count_++;<span class="comment">//ËØ•pageÁöÑÂºïÁî®ËÆ°Êï∞Â¢ûÂä†</span></span><br><span class="line">    replacer_-&gt;<span class="built_in">RecordAccess</span>(page_table_[page_id]);<span class="comment">//Â¢ûÂä†ËØ•pageÂØπÂ∫îÁöÑframeÁöÑËÆøÈóÆÊó∂Èó¥Êà≥</span></span><br><span class="line">    replacer_-&gt;<span class="built_in">SetEvictable</span>(page_table_[page_id], <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> pages_ + page_table_[page_id];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">frame_id_t</span> free_frame_id = <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">//Ëé∑Âèñ‰∏Ä‰∏™Á©∫Èó≤ÁöÑframe</span></span><br><span class="line">  <span class="keyword">if</span> (!free_list_.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    free_frame_id = free_list_.<span class="built_in">front</span>();</span><br><span class="line">    free_list_.<span class="built_in">pop_front</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!replacer_-&gt;<span class="built_in">Evict</span>(&amp;free_frame_id)) &#123;<span class="comment">//ÈÄöËøáLRUKReplacerÂæóÂà∞‰∏Ä‰∏™Á©∫Èó≤ÁöÑframe</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pages_[free_frame_id].<span class="built_in">IsDirty</span>()) &#123;<span class="comment">//Â¶ÇÊûúË¢´È©±ÈÄêÁöÑframeÂØπÂ∫îÁöÑpage‰∏∫ËÑèÈ°µÔºåÈúÄË¶ÅËøõË°åÂÜôÂõûÊìç‰Ωú</span></span><br><span class="line">      disk_manager_-&gt;<span class="built_in">WritePage</span>(pages_[free_frame_id].page_id_, pages_[free_frame_id].data_);</span><br><span class="line">    &#125;</span><br><span class="line">    page_table_.<span class="built_in">erase</span>(pages_[free_frame_id].page_id_);<span class="comment">//Â∞Üpage_table_‰∏≠ËØ•frameÂØπÂ∫îÁöÑpage_id_Âà†Èô§</span></span><br><span class="line">    pages_[free_frame_id].<span class="built_in">ResetMemory</span>();<span class="comment">//ÈáçÁΩÆËØ•ÊîπframeÂØπÂ∫îÁöÑÂÜÖÂ≠ò</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pages_[free_frame_id].page_id_ = page_id;</span><br><span class="line">  pages_[free_frame_id].pin_count_ = <span class="number">1</span>;</span><br><span class="line">  pages_[free_frame_id].is_dirty_ = <span class="literal">false</span>;</span><br><span class="line">  page_table_[page_id] = free_frame_id;</span><br><span class="line">  disk_manager_-&gt;<span class="built_in">ReadPage</span>(page_id, pages_[free_frame_id].data_);<span class="comment">//ËØªÂèñËØ•page_idÂØπÂ∫îÁöÑÁâ©ÁêÜÈ°µ</span></span><br><span class="line"></span><br><span class="line">  replacer_-&gt;<span class="built_in">RecordAccess</span>(free_frame_id);<span class="comment">//Â¢ûÂä†ËØ•frameÁöÑËÆøÈóÆÊó∂Èó¥Êà≥</span></span><br><span class="line">  replacer_-&gt;<span class="built_in">SetEvictable</span>(free_frame_id, <span class="literal">false</span>);  <span class="comment">// no use</span></span><br><span class="line">  <span class="keyword">return</span> pages_ + free_frame_id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UnpinPageÂáΩÊï∞ÂÆûÁé∞Ôºö<br><br>ÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÂÖ•ÂèÇis_dirty‰∏çËÉΩÁ†¥ÂùèÂ∑≤ÁªèÁΩÆ‰∏∫ËÑèÁöÑÁä∂ÊÄÅÔºåËøôÈáåÁî® | ËøêÁÆóÁ¨¶Êù•ÂÆûÁé∞</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BufferPoolManager::UnpinPage</span><span class="params">(<span class="type">page_id_t</span> page_id, <span class="type">bool</span> is_dirty, [[maybe_unused]] AccessType access_type)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">guard</span><span class="params">(latch_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (page_table_.<span class="built_in">count</span>(page_id) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">frame_id_t</span> frame_id = page_table_[page_id];</span><br><span class="line">  <span class="keyword">if</span> (pages_[frame_id].pin_count_ == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (--pages_[frame_id].pin_count_ == <span class="number">0</span>) &#123;<span class="comment">//ÂºïÁî®ËÆ°Êï∞Âáè‰∏∫0Êó∂ÔºåÂ∞ÜËØ•frameËÆæÁΩÆ‰∏∫evictable</span></span><br><span class="line">    replacer_-&gt;<span class="built_in">SetEvictable</span>(frame_id, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  pages_[frame_id].is_dirty_ |= is_dirty;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FlushPageÂáΩÊï∞ÂÆûÁé∞:<br><br>Âº∫Âà∂Â∞Üpage_idÂØπÂ∫îÁöÑPageÁöÑÂÜÖÂÆπÂÜôÂõûÁ£ÅÁõòÔºåÂπ∂Â∞ÜËØ•PageÂØπÂ∫îËÑè‰ΩçÁΩÆ‰∏∫false</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BufferPoolManager::FlushPage</span><span class="params">(<span class="type">page_id_t</span> page_id)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">guard</span><span class="params">(latch_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (page_table_.<span class="built_in">count</span>(page_id) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">frame_id_t</span> frame_id = page_table_[page_id];</span><br><span class="line">  disk_manager_-&gt;<span class="built_in">WritePage</span>(page_id, pages_[frame_id].data_);</span><br><span class="line">  pages_[frame_id].is_dirty_ = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FlushAllPagesÂáΩÊï∞ÂÆûÁé∞:<br>ÂÜôÂõûÊâÄÊúâÂú®ÂÜÖÂ≠ò‰∏≠ÁöÑPage</p>
<p>DeletePageÂáΩÊï∞ÂÆûÁé∞Ôºö</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BufferPoolManager::DeletePage</span><span class="params">(<span class="type">page_id_t</span> page_id)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">guard</span><span class="params">(latch_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (page_table_.<span class="built_in">count</span>(page_id) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">frame_id_t</span> frame_id = page_table_[page_id];</span><br><span class="line">  <span class="keyword">if</span> (pages_[frame_id].pin_count_ != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//Âè™ÊúâÂΩìËØ•page_idÂØπÂ∫îÁöÑPageÁöÑÂºïÁî®ËÆ°Êï∞‰∏∫0Êó∂ÂèØ‰ª•ËøõË°åÂà†Èô§</span></span><br><span class="line">  page_table_.<span class="built_in">erase</span>(page_id);<span class="comment">//page_table_Âà†Èô§ËØ•page_id</span></span><br><span class="line">  replacer_-&gt;<span class="built_in">SetEvictable</span>(frame_id, <span class="literal">true</span>);<span class="comment">//replacerÈ©±ÈÄêËØ•frame</span></span><br><span class="line">  replacer_-&gt;<span class="built_in">Remove</span>(frame_id);</span><br><span class="line">  free_list_.<span class="built_in">push_back</span>(frame_id);<span class="comment">//Â∞ÜËØ•frameÂä†ÂÖ•free_list</span></span><br><span class="line">  <span class="comment">//ËØ•PageÂàùÂßãÂåñ</span></span><br><span class="line">  pages_[frame_id].is_dirty_ = <span class="literal">false</span>;</span><br><span class="line">  pages_[frame_id].page_id_ = INVALID_PAGE_ID;</span><br><span class="line">  pages_[frame_id].<span class="built_in">ResetMemory</span>();</span><br><span class="line">  <span class="built_in">DeallocatePage</span>(page_id);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>task2Êú¨Âú∞ÊµãËØï:<br><img src="/../images/cmu15445-project1/6.png" alt="img"></p>
<h2 id="Task-3-Read-Write-Page-Guards"><a href="#Task-3-Read-Write-Page-Guards" class="headerlink" title="Task#3 Read&#x2F;Write Page Guards"></a>Task#3 Read&#x2F;Write Page Guards</h2><p>FetchPageÂíåNewPageÂáΩÊï∞ËøîÂõûÊåáÂêëpagesÁöÑÊåáÈíàÔºåÂπ∂‰∏îpagesÂ∑≤ÁªèË¢´pinnedÔºåÂπ∂‰∏îÂΩì‰∏Ä‰∏™page‰∏çÂÜçÈúÄË¶ÅÊó∂ÔºåË¶ÅË∞ÉÁî®UnpinPage„ÄÇÂè¶‰∏ÄÊñπÈù¢ÔºåÂ¶ÇÊûúÂøòËÆ∞Ë∞ÉÁî®UnPinPageÔºåËØ•PageÂ∞ÜÊ∞∏Ëøú‰∏ç‰ºöË¢´evict„ÄÇ‰∫éÊòØPageGuardÂ∞±Ê¥æ‰∏äÁî®Âú∫‰∫Ü</p>
<p>BasicPageGuard<br>ÊÄùË∑ØÔºöBasicPageGuardÊûêÊûÑÊó∂Ë∞ÉÁî®PageÁöÑUnpinPageÂáΩÊï∞ÔºåÂπ∂‰∏îBasicPageGuard‰∏≠‰øùÂ≠òÂèòÈáèis_dirty_,Ë∞ÉÁî®AsMutÊàñGetDataMutÂáΩÊï∞Êó∂Â∞Üis_dirty_ËÆæÁΩÆ‰∏∫true</p>
<p>WritePageGuardÂíåReadPageGuard<br>ÊÄùË∑ØÔºö‰∏éBasicPageGuardÊÄùË∑ØÁõ∏‰ººÔºåÊûêÊûÑÂáΩÊï∞Ë∞ÉÁî®UnpinPageÂ§ö‰∫Ü‰∏ÄÊ≠•ÈáäÊîæPageÁöÑÂÜôÈîÅÂíåËØªÈîÅ</p>
<p>FetchPageBasic„ÄÅFetchPageRead„ÄÅFetchPageWriteÂíåNewPageGuardedÁöÑÂÆûÁé∞‰ª£Á†ÅÂ¶Ç‰∏ã:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BufferPoolManager::FetchPageBasic</span><span class="params">(<span class="type">page_id_t</span> page_id)</span> -&gt; BasicPageGuard </span>&#123; <span class="keyword">return</span> &#123;<span class="keyword">this</span>, <span class="built_in">FetchPage</span>(page_id)&#125;; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BufferPoolManager::FetchPageRead</span><span class="params">(<span class="type">page_id_t</span> page_id)</span> -&gt; ReadPageGuard </span>&#123;</span><br><span class="line">  Page *page = <span class="built_in">FetchPage</span>(page_id);</span><br><span class="line">  <span class="keyword">if</span> (page != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    page-&gt;<span class="built_in">RLatch</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;<span class="keyword">this</span>, page&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BufferPoolManager::FetchPageWrite</span><span class="params">(<span class="type">page_id_t</span> page_id)</span> -&gt; WritePageGuard </span>&#123;</span><br><span class="line">  Page *page = <span class="built_in">FetchPage</span>(page_id);</span><br><span class="line">  <span class="keyword">if</span> (page != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    page-&gt;<span class="built_in">WLatch</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;<span class="keyword">this</span>, page&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BufferPoolManager::NewPageGuarded</span><span class="params">(<span class="type">page_id_t</span> *page_id)</span> -&gt; BasicPageGuard </span>&#123; <span class="keyword">return</span> &#123;<span class="keyword">this</span>, <span class="built_in">NewPage</span>(page_id)&#125;; &#125;</span><br></pre></td></tr></table></figure>
<p>task3Êú¨Âú∞ÊµãËØïÔºö<br><img src="/../images/cmu15445-project1/7.png" alt="img"></p>
<p>ÊµãËØïÈÄöËøáÊà™ÂõæÔºö<br><img src="/../images/cmu15445-project1/4.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="jingtao8a"
      src="/images/iverson.jpg">
  <p class="site-author-name" itemprop="name">jingtao8a</p>
  <div class="site-description" itemprop="description">this is life, full of ups and down</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jingtao8a</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>

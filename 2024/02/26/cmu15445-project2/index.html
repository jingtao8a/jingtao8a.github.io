<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jingtao8a.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="B+ TreeB+ Tree是一种自平衡树，它将数据有序地存储，并且在search、sequential access、insertions以及deletions操作的复杂度上都满足O(logn),其中sequential access的最终复杂度还与所需数据总量有关以M—way B+tree为例，它的特点总结如下：  每个节点最多存储M个key，有M+1个children B+ Tree是per">
<meta property="og:type" content="article">
<meta property="og:title" content="cmu15445-project2">
<meta property="og:url" content="http://jingtao8a.github.io/2024/02/26/cmu15445-project2/index.html">
<meta property="og:site_name" content="jingtao8a&#39;s blog">
<meta property="og:description" content="B+ TreeB+ Tree是一种自平衡树，它将数据有序地存储，并且在search、sequential access、insertions以及deletions操作的复杂度上都满足O(logn),其中sequential access的最终复杂度还与所需数据总量有关以M—way B+tree为例，它的特点总结如下：  每个节点最多存储M个key，有M+1个children B+ Tree是per">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/1.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/2.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/3.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/4.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/5.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/6.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/8.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/9.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/10.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/11.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/12.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/13.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/14.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/15.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/16.png">
<meta property="og:image" content="http://jingtao8a.github.io/images/cmu15445-project2/7.png">
<meta property="article:published_time" content="2024-02-27T06:16:24.000Z">
<meta property="article:modified_time" content="2024-02-28T03:25:45.481Z">
<meta property="article:author" content="jingtao8a">
<meta property="article:tag" content="cmu15445—2023">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://jingtao8a.github.io/images/cmu15445-project2/1.png">

<link rel="canonical" href="http://jingtao8a.github.io/2024/02/26/cmu15445-project2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>cmu15445-project2 | jingtao8a's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">jingtao8a's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jingtao8a.github.io/2024/02/26/cmu15445-project2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/iverson.jpg">
      <meta itemprop="name" content="jingtao8a">
      <meta itemprop="description" content="this is life, full of ups and down">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jingtao8a's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          cmu15445-project2
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-02-26 22:16:24" itemprop="dateCreated datePublished" datetime="2024-02-26T22:16:24-08:00">2024-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-02-27 19:25:45" itemprop="dateModified" datetime="2024-02-27T19:25:45-08:00">2024-02-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cmu15445-2023/" itemprop="url" rel="index"><span itemprop="name">cmu15445-2023</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B+ Tree"></a>B+ Tree</h1><p>B+ Tree是一种自平衡树，它将数据有序地存储，并且在search、sequential access、insertions以及deletions操作的复杂度上都满足O(logn),其中sequential access的最终复杂度还与所需数据总量有关<br><img src="/../images/cmu15445-project2/1.png" alt="img"><br>以M—way B+tree为例，它的特点总结如下：</p>
<ul>
<li>每个节点最多存储M个key，有M+1个children</li>
<li>B+ Tree是perfectly balanced，即每个leaf node的深度都一样</li>
<li>除了root节点，所有节点必须至少处于半满状态，即 M&#x2F;2 - 1 &lt;&#x3D; #keys &lt;&#x3D; M - 1</li>
<li>假设每个inner node中包含k个keys，那么它必然有k + 1个children</li>
</ul>
<h1 id="B-Tree-Operations"><a href="#B-Tree-Operations" class="headerlink" title="B+ Tree Operations"></a>B+ Tree Operations</h1><p>Insert</p>
<blockquote>
<ol>
<li>找到对应的leafNode L</li>
<li>将key&#x2F;value pair按顺序插入到 L 中</li>
<li>如果L 还有足够的空间，操作结束；如果空间不足，则需要将L分裂成两个节点，同时在parent node上新增entry，若parent node也空间不足，则递归地分裂，直到root node为止</li>
</ol>
</blockquote>
<p>Max.degree &#x3D; 5时<br><br>从1插入到13的情况  <a target="_blank" rel="noopener" href="https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html">BPlusTree可视化网站</a><br><img src="/../images/cmu15445-project2/2.png" alt="img"></p>
<p>Delete</p>
<blockquote>
<ol>
<li>从root开始，找到目标entry所在的leaf node L</li>
<li>删除该entry</li>
<li>如果L仍然处在半满状态，操作结束；否则先尝试从siblings那里借entries，如果失败，则将L 与相应的sibling合并</li>
<li>如果合并发生了，则可能需要递归地删除parent node中的entry</li>
</ol>
</blockquote>
<h1 id="CheckPoint-1"><a href="#CheckPoint-1" class="headerlink" title="CheckPoint#1"></a>CheckPoint#1</h1><h2 id="Task-1-B-Tree-Pages"><a href="#Task-1-B-Tree-Pages" class="headerlink" title="Task #1 B+ Tree Pages"></a>Task #1 B+ Tree Pages</h2><h3 id="class-BPlusTreePage的3个类成员"><a href="#class-BPlusTreePage的3个类成员" class="headerlink" title="class BPlusTreePage的3个类成员"></a>class BPlusTreePage的3个类成员</h3><p><img src="/../images/cmu15445-project2/3.png" alt="img"><br>GetMinSize函数实现:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPlusTreePage::GetMinSize</span><span class="params">()</span> <span class="type">const</span> -&gt; <span class="type">int</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsLeafPage</span>()) &#123;<span class="comment">// 叶子节点</span></span><br><span class="line">    <span class="keyword">return</span> max_size_ / <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (max_size_ + <span class="number">1</span>) / <span class="number">2</span>; <span class="comment">//内部节点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="class-BPlusTreeInternalPage-public-BPlusTreePage"><a href="#class-BPlusTreeInternalPage-public-BPlusTreePage" class="headerlink" title="class BPlusTreeInternalPage : public BPlusTreePage "></a>class BPlusTreeInternalPage : public BPlusTreePage <br></h3><blockquote>
<p>一个Internal Page存储 m 个顺序 key 和 m + 1 个child pointers(其它BPlusTreePage的page_ids)<br><br>使用一个数组存储key&#x2F;page_id pairs，并且第一个key被设置为invalid，并且查找要从第二个key开始查找</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">B_PLUS_TREE_INTERNAL_PAGE_TYPE::Init</span><span class="params">(<span class="type">int</span> max_size, <span class="type">int</span> size)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">SetPageType</span>(IndexPageType::INTERNAL_PAGE);</span><br><span class="line">  <span class="built_in">SetMaxSize</span>(max_size);</span><br><span class="line">  <span class="built_in">SetSize</span>(size);<span class="comment">//size 默认为1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">B_PLUS_TREE_INTERNAL_PAGE_TYPE::ValueIndex</span><span class="params">(<span class="type">const</span> ValueType &amp;value)</span> <span class="type">const</span> -&gt; <span class="type">int</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="built_in">GetSize</span>(); ++i) &#123;<span class="comment">//顺序查找</span></span><br><span class="line">    <span class="keyword">if</span> (array_[i].second == value) &#123;</span><br><span class="line">      <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">B_PLUS_TREE_INTERNAL_PAGE_TYPE::LookUp</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">const</span> KeyComparator &amp;comparator)</span> <span class="type">const</span> -&gt; ValueType </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="built_in">GetSize</span>(); ++i) &#123;  <span class="comment">// 顺序查找</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">comparator</span>(key, array_[i].first) &lt; <span class="number">0</span>) &#123;<span class="comment">//找到第一个大于key的array_[i].first</span></span><br><span class="line">      <span class="keyword">return</span> array_[i - <span class="number">1</span>].second;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> array_[<span class="built_in">GetSize</span>() - <span class="number">1</span>].second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">B_PLUS_TREE_INTERNAL_PAGE_TYPE::Insert</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">const</span> ValueType &amp;value, <span class="type">const</span> KeyComparator &amp;comparator)</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">GetSize</span>() == <span class="built_in">GetMaxSize</span>()) &#123;<span class="comment">//已经满了返回false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// upper_bound</span></span><br><span class="line">  <span class="type">int</span> l = <span class="number">1</span>;</span><br><span class="line">  <span class="type">int</span> r = <span class="built_in">GetSize</span>();</span><br><span class="line">  <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">    <span class="type">int</span> mid = (l + r) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">comparator</span>(array_[mid].first, key) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      r = mid;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="built_in">GetSize</span>() - <span class="number">1</span>; i &gt;= l; --i) &#123;<span class="comment">//元素移位</span></span><br><span class="line">    array_[i + <span class="number">1</span>] = array_[i];</span><br><span class="line">  &#125;</span><br><span class="line">  array_[l] = &#123;key, value&#125;;<span class="comment">//存储插入的key-value</span></span><br><span class="line">  <span class="built_in">IncreaseSize</span>(<span class="number">1</span>);<span class="comment">//size ++</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="class-BPlusTreeLeafPage-public-BPlusTreePage"><a href="#class-BPlusTreeLeafPage-public-BPlusTreePage" class="headerlink" title="class BPlusTreeLeafPage : public BPlusTreePage"></a>class BPlusTreeLeafPage : public BPlusTreePage</h3><blockquote>
<p>一个Leaf Page存储 m 个顺序 key 和 m 个对应的value.value应该为 64-bit record_id 用于表示实际的tuple存储的地方(src&#x2F;include&#x2F;common&#x2F;rid.h)</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">B_PLUS_TREE_LEAF_PAGE_TYPE::Init</span><span class="params">(<span class="type">int</span> max_size, <span class="type">int</span> size, <span class="type">page_id_t</span> next_page_id)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">SetPageType</span>(IndexPageType::LEAF_PAGE);</span><br><span class="line">  <span class="built_in">SetMaxSize</span>(max_size);</span><br><span class="line">  <span class="built_in">SetSize</span>(size);<span class="comment">//size 默认为0</span></span><br><span class="line">  <span class="built_in">SetNextPageId</span>(next_page_id);<span class="comment">//next_page_id默认为INVALID_PAGE_ID</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">B_PLUS_TREE_LEAF_PAGE_TYPE::KeyIndex</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">const</span> KeyComparator &amp;comparator, <span class="type">int</span> &amp;index)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="comment">// lower_bound</span></span><br><span class="line">  <span class="type">int</span> l = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> r = <span class="built_in">GetSize</span>();</span><br><span class="line">  <span class="keyword">if</span> (l &gt;= r) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">    <span class="type">int</span> mid = (l + r) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">comparator</span>(array_[mid].first, key) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      r = mid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  index = l;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;<span class="type">bool</span>&gt;(l != <span class="built_in">GetSize</span>() &amp;&amp; <span class="built_in">comparator</span>(<span class="built_in">KeyAt</span>(l), key) == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">B_PLUS_TREE_LEAF_PAGE_TYPE::Insert</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">const</span> ValueType &amp;value, <span class="type">const</span> KeyComparator &amp;comparator)</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> pos = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">KeyIndex</span>(key, comparator, pos)) &#123;  <span class="comment">// duplicate key</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//重复的key，直接返回false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// move</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="built_in">GetSize</span>() - <span class="number">1</span>; i &gt;= pos; --i) &#123;<span class="comment">//移动array_元素</span></span><br><span class="line">    array_[i + <span class="number">1</span>] = array_[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// insert</span></span><br><span class="line">  array_[pos] = &#123;key, value&#125;;<span class="comment">//插入key-value</span></span><br><span class="line">  <span class="built_in">IncreaseSize</span>(<span class="number">1</span>);<span class="comment">//size ++</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Class-BplusTreeHeaderPage"><a href="#Class-BplusTreeHeaderPage" class="headerlink" title="Class BplusTreeHeaderPage"></a>Class BplusTreeHeaderPage</h3><blockquote>
<p>头节点，存储了root page id，使得根节点和非根节点一样拥有父节点</p>
</blockquote>
<h2 id="Task-2a-B-Tree-Data-Structure-Insertion-Point-Search"><a href="#Task-2a-B-Tree-Data-Structure-Insertion-Point-Search" class="headerlink" title="Task #2a B+ Tree Data Structure(Insertion, Point Search)"></a>Task #2a B+ Tree Data Structure(Insertion, Point Search)</h2><p>GetRootPageId函数实现:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS <span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::GetRootPageId</span><span class="params">()</span> <span class="type">const</span> -&gt; <span class="type">page_id_t</span> </span>&#123;</span><br><span class="line">  ReadPageGuard guard = bpm_-&gt;<span class="built_in">FetchPageRead</span>(header_page_id_);</span><br><span class="line">  <span class="keyword">auto</span> page = guard.<span class="built_in">As</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">  <span class="keyword">return</span> page-&gt;root_page_id_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Search操作</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::GetValue</span><span class="params">(<span class="type">const</span> KeyType &amp;key, std::vector&lt;ValueType&gt; *result, Transaction *txn)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Declaration of context instance.</span></span><br><span class="line">  Context ctx;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//先给header_page加读锁判断root_page是否存在，如果存在，给root_page加读锁，放入Context中</span></span><br><span class="line">    <span class="keyword">auto</span> header_page_guard = bpm_-&gt;<span class="built_in">FetchPageRead</span>(header_page_id_);</span><br><span class="line">    <span class="keyword">auto</span> header_page = header_page_guard.<span class="built_in">As</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">    <span class="keyword">if</span> (header_page-&gt;root_page_id_ == INVALID_PAGE_ID) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.root_page_id_ = header_page-&gt;root_page_id_;</span><br><span class="line">    ctx.read_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageRead</span>(ctx.root_page_id_));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//查找到对应的leafPage</span></span><br><span class="line">  <span class="built_in">FindLeafPage</span>(key, Operation::Search, ctx);</span><br><span class="line">  <span class="keyword">auto</span> leaf_page = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;LeafPage&gt;();</span><br><span class="line">  <span class="type">int</span> index = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (leaf_page-&gt;<span class="built_in">KeyIndex</span>(key, comparator_, index)) &#123;</span><br><span class="line">    result-&gt;<span class="built_in">push_back</span>(leaf_page-&gt;<span class="built_in">ValueAt</span>(index));<span class="comment">//查找成功</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//查找失败</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::FindLeafPage</span><span class="params">(<span class="type">const</span> KeyType &amp;key, Operation op, Context &amp;ctx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (op == Operation::Search) &#123;</span><br><span class="line">    <span class="comment">//Search的加锁策略</span></span><br><span class="line">    <span class="comment">//从root往下，不断地</span></span><br><span class="line">    <span class="comment">// - 获取child的read latch</span></span><br><span class="line">    <span class="comment">// - 释放parent的read latch</span></span><br><span class="line">    <span class="keyword">auto</span> page = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">    <span class="keyword">while</span> (!page-&gt;<span class="built_in">IsLeafPage</span>()) &#123;</span><br><span class="line">      <span class="keyword">auto</span> internal = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;InternalPage&gt;();</span><br><span class="line">      <span class="keyword">auto</span> next_page_id = internal-&gt;<span class="built_in">LookUp</span>(key, comparator_);</span><br><span class="line">      ctx.read_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageRead</span>(next_page_id));</span><br><span class="line">      ctx.read_set_.<span class="built_in">pop_front</span>();</span><br><span class="line">      page = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (op == Operation::Insert || op == Operation::Remove) &#123;</span><br><span class="line">    <span class="comment">//Insert和Remove的加锁策略</span></span><br><span class="line">    <span class="comment">//从root往下，按照需要获取write latch，一旦获取到了child的write latch，检查</span></span><br><span class="line">    <span class="comment">//它是否安全，如果安全，则释放之前获取的所有write latch</span></span><br><span class="line">    <span class="keyword">auto</span> page = ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">    <span class="keyword">while</span> (!page-&gt;<span class="built_in">IsLeafPage</span>()) &#123;</span><br><span class="line">      <span class="keyword">auto</span> internal = ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;InternalPage&gt;();</span><br><span class="line">      <span class="keyword">auto</span> next_page_id = internal-&gt;<span class="built_in">LookUp</span>(key, comparator_);</span><br><span class="line">      ctx.write_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageWrite</span>(next_page_id));</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">IsSafePage</span>(ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;(), op, <span class="literal">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">while</span> (ctx.write_set_.<span class="built_in">size</span>() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">          ctx.write_set_.<span class="built_in">pop_front</span>();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      page = ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::IsSafePage</span><span class="params">(<span class="type">const</span> BPlusTreePage *tree_page, Operation op, <span class="type">bool</span> isRootPage)</span> -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (op == Operation::Search) &#123;<span class="comment">//no use</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (op == Operation::Insert) &#123;<span class="comment">//插入操作</span></span><br><span class="line">    <span class="comment">//若会发生上溢，表示不安全</span></span><br><span class="line">    <span class="keyword">if</span> (tree_page-&gt;<span class="built_in">IsLeafPage</span>()) &#123;</span><br><span class="line">      <span class="comment">//叶子节点中，size最大为tree_page-&gt;GetMaxSize() - 1;</span></span><br><span class="line">      <span class="keyword">return</span> tree_page-&gt;<span class="built_in">GetSize</span>() + <span class="number">1</span> &lt; tree_page-&gt;<span class="built_in">GetMaxSize</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//内部节点中，size最大为tree_page-&gt;GetMaxSize()</span></span><br><span class="line">    <span class="keyword">return</span> tree_page-&gt;<span class="built_in">GetSize</span>() &lt; tree_page-&gt;<span class="built_in">GetMaxSize</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (op == Operation::Remove) &#123;<span class="comment">//删除操作</span></span><br><span class="line">    <span class="comment">//若会发生下溢，表示不安全</span></span><br><span class="line">    <span class="keyword">if</span> (isRootPage) &#123;<span class="comment">//对RootPage进行Remove操作</span></span><br><span class="line">      <span class="keyword">if</span> (tree_page-&gt;<span class="built_in">IsLeafPage</span>()) &#123;</span><br><span class="line">        <span class="comment">//如果为叶子节点，size至少为2</span></span><br><span class="line">        <span class="keyword">return</span> tree_page-&gt;<span class="built_in">GetSize</span>() &gt; <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//如果为内部节点，size至少为3</span></span><br><span class="line">      <span class="keyword">return</span> tree_page-&gt;<span class="built_in">GetSize</span>() &gt; <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tree_page-&gt;<span class="built_in">GetSize</span>() &gt; tree_page-&gt;<span class="built_in">GetMinSize</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Insert操作</p>
<blockquote>
<p>插入到leaf节点中，插入前，如果size &#x3D;&#x3D; max_size表示溢出，需要进行分裂<br>插入到internal节点中，插入前，如果size &#x3D;&#x3D; max_size表示溢出，需要进行分裂 </p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS <span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::Insert</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">const</span> ValueType &amp;value, Transaction *txn)</span></span></span><br><span class="line"><span class="function">    -&gt; <span class="type">bool</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Declaration of context instance.</span></span><br><span class="line">  Context ctx;</span><br><span class="line">  ctx.header_page_ = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(header_page_id_);<span class="comment">//先给header_page_id写锁</span></span><br><span class="line">  <span class="keyword">auto</span> header_page = ctx.header_page_-&gt;<span class="built_in">AsMut</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (header_page-&gt;root_page_id_ == INVALID_PAGE_ID) &#123;  <span class="comment">// root not exist,start a new tree</span></span><br><span class="line">    <span class="keyword">auto</span> root_guard = bpm_-&gt;<span class="built_in">NewPageGuarded</span>(&amp;ctx.root_page_id_);<span class="comment">//申请root_page</span></span><br><span class="line">    header_page-&gt;root_page_id_ = ctx.root_page_id_;</span><br><span class="line">    <span class="keyword">auto</span> leaf_page = root_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line">    leaf_page-&gt;<span class="built_in">Init</span>(leaf_max_size_, <span class="number">1</span>);</span><br><span class="line">    leaf_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>] = &#123;key, value&#125;;<span class="comment">//插入key-value</span></span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.root_page_id_ = header_page-&gt;root_page_id_;</span><br><span class="line">  ctx.write_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageWrite</span>(ctx.root_page_id_));</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsSafePage</span>(ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;(), Operation::Insert, <span class="literal">true</span>)) &#123;<span class="comment">//如果root_page安全，释放header_page的写锁</span></span><br><span class="line">    ctx.header_page_ = std::<span class="literal">nullopt</span>;  <span class="comment">// unlock header_page</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">FindLeafPage</span>(key, Operation::Insert, ctx);</span><br><span class="line">  <span class="keyword">auto</span> &amp;leaf_page_guard = ctx.write_set_.<span class="built_in">back</span>();</span><br><span class="line">  <span class="keyword">auto</span> leaf_page = leaf_page_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (!leaf_page-&gt;<span class="built_in">Insert</span>(key, value, comparator_)) &#123;  <span class="comment">// duplicate key, 插入失败</span></span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (leaf_page-&gt;<span class="built_in">GetSize</span>() &lt; leaf_page-&gt;<span class="built_in">GetMaxSize</span>()) &#123;  <span class="comment">// 叶子节点未溢出，不需要分裂</span></span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 发生溢出,叶子节点分裂</span></span><br><span class="line">  <span class="keyword">auto</span> new_page_id = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">auto</span> new_leaf_page_guard = bpm_-&gt;<span class="built_in">NewPageGuarded</span>(&amp;new_page_id);</span><br><span class="line">  <span class="keyword">auto</span> new_leaf_page = new_leaf_page_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line">  std::<span class="built_in">copy</span>(leaf_page-&gt;<span class="built_in">GetArray</span>() + leaf_page-&gt;<span class="built_in">GetMinSize</span>(), leaf_page-&gt;<span class="built_in">GetArray</span>() + leaf_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">            new_leaf_page-&gt;<span class="built_in">GetArray</span>());</span><br><span class="line">  new_leaf_page-&gt;<span class="built_in">Init</span>(leaf_max_size_, leaf_page-&gt;<span class="built_in">GetSize</span>() - leaf_page-&gt;<span class="built_in">GetMinSize</span>(), leaf_page-&gt;<span class="built_in">GetNextPageId</span>());</span><br><span class="line">  leaf_page-&gt;<span class="built_in">SetNextPageId</span>(new_leaf_page_guard.<span class="built_in">PageId</span>());</span><br><span class="line">  leaf_page-&gt;<span class="built_in">SetSize</span>(leaf_page-&gt;<span class="built_in">GetMinSize</span>());</span><br><span class="line">  KeyType split_key = new_leaf_page-&gt;<span class="built_in">KeyAt</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="comment">// 将split_key插入父节点</span></span><br><span class="line">  <span class="built_in">InsertIntoParent</span>(split_key, new_leaf_page_guard.<span class="built_in">PageId</span>(), ctx, ctx.write_set_.<span class="built_in">size</span>() - <span class="number">2</span>);</span><br><span class="line">  ctx.<span class="built_in">Drop</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BPLUSTREE_TYPE::InsertIntoParent</span><span class="params">(<span class="type">const</span> KeyType &amp;key, <span class="type">page_id_t</span> right_child_id, Context &amp;ctx, <span class="type">int</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;  <span class="comment">// parent为header_page</span></span><br><span class="line">    <span class="comment">//创建新的root_page，并更新header_page中的root_page_id_</span></span><br><span class="line">    <span class="keyword">auto</span> new_root_page_id = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">auto</span> new_root_page_guard = bpm_-&gt;<span class="built_in">NewPageGuarded</span>(&amp;new_root_page_id);</span><br><span class="line">    <span class="keyword">auto</span> new_root_page = new_root_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">    new_root_page-&gt;<span class="built_in">Init</span>(internal_max_size_, <span class="number">2</span>);</span><br><span class="line">    new_root_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].second = ctx.write_set_[index + <span class="number">1</span>].<span class="built_in">PageId</span>();</span><br><span class="line">    new_root_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">1</span>] = &#123;key, right_child_id&#125;;</span><br><span class="line">    <span class="keyword">auto</span> header_page = ctx.header_page_-&gt;<span class="built_in">AsMut</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">    header_page-&gt;root_page_id_ = new_root_page_id;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> parent_page = ctx.write_set_[index].<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (parent_page-&gt;<span class="built_in">Insert</span>(key, right_child_id, comparator_)) &#123;  <span class="comment">// 父节点不需要分裂</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 父节点需要分裂</span></span><br><span class="line">  <span class="keyword">auto</span> new_parent_page_id = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">auto</span> new_parent_page_guard = bpm_-&gt;<span class="built_in">NewPageGuarded</span>(&amp;new_parent_page_id);</span><br><span class="line">  <span class="keyword">auto</span> new_parent_page = new_parent_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">  <span class="keyword">auto</span> array = <span class="keyword">new</span> std::pair&lt;KeyType, <span class="type">page_id_t</span>&gt;[parent_page-&gt;<span class="built_in">GetMaxSize</span>() + <span class="number">1</span>];</span><br><span class="line">  std::<span class="built_in">copy</span>(parent_page-&gt;<span class="built_in">GetArray</span>(), parent_page-&gt;<span class="built_in">GetArray</span>() + parent_page-&gt;<span class="built_in">GetMaxSize</span>(), array);</span><br><span class="line">  <span class="comment">// upper_bound</span></span><br><span class="line">  <span class="type">int</span> l = <span class="number">1</span>;</span><br><span class="line">  <span class="type">int</span> r = parent_page-&gt;<span class="built_in">GetMaxSize</span>();</span><br><span class="line">  <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">    <span class="type">int</span> mid = (l + r) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">comparator_</span>(array[mid].first, key) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      r = mid;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 右移一位，腾出空间</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = parent_page-&gt;<span class="built_in">GetMaxSize</span>() - <span class="number">1</span>; i &gt;= l; --i) &#123;</span><br><span class="line">    array[i + <span class="number">1</span>] = array[i];</span><br><span class="line">  &#125;</span><br><span class="line">  array[l] = &#123;key, right_child_id&#125;;</span><br><span class="line">  std::<span class="built_in">copy</span>(array, array + parent_page-&gt;<span class="built_in">GetMinSize</span>(), parent_page-&gt;<span class="built_in">GetArray</span>());</span><br><span class="line">  std::<span class="built_in">copy</span>(array + parent_page-&gt;<span class="built_in">GetMinSize</span>(), array + parent_page-&gt;<span class="built_in">GetMaxSize</span>() + <span class="number">1</span>, new_parent_page-&gt;<span class="built_in">GetArray</span>());</span><br><span class="line">  new_parent_page-&gt;<span class="built_in">Init</span>(internal_max_size_, parent_page-&gt;<span class="built_in">GetMaxSize</span>() + <span class="number">1</span> - parent_page-&gt;<span class="built_in">GetMinSize</span>());</span><br><span class="line">  parent_page-&gt;<span class="built_in">SetSize</span>(parent_page-&gt;<span class="built_in">GetMinSize</span>());</span><br><span class="line">  <span class="keyword">delete</span>[] array;</span><br><span class="line">  <span class="built_in">InsertIntoParent</span>(new_parent_page-&gt;<span class="built_in">KeyAt</span>(<span class="number">0</span>), new_parent_page_id, ctx, index - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CheckPoint#1本地测试<br><br><img src="/../images/cmu15445-project2/4.png" alt="img"><br><img src="/../images/cmu15445-project2/5.png" alt="img"></p>
<p>线上测试<br><br><img src="/../images/cmu15445-project2/6.png" alt="img"></p>
<h1 id="CheckPoint-2"><a href="#CheckPoint-2" class="headerlink" title="CheckPoint#2"></a>CheckPoint#2</h1><h2 id="Task-2b-B-Tree-Data-Structure-Deletion"><a href="#Task-2b-B-Tree-Data-Structure-Deletion" class="headerlink" title="Task #2b B+ Tree Data Structure(Deletion)"></a>Task #2b B+ Tree Data Structure(Deletion)</h2><p>Deletion操作:</p>
<blockquote>
<p>如果删除的leaf节点是root节点，那么删除后的size &#x3D;&#x3D; 0,表示下溢，需要将header_page中的root_page设置为INVALID_PAGE_ID<br><br>如果删除的leaf节点不是root节点，那么删除后的size &lt; min_size表示下溢<br><br>1.如果有右孩子<br></p>
<blockquote>
<p>2.判断是否能merge(merge_size &lt; max_size),能则merge，否则转3<br><br>3.向右孩子进行borrow<br></p>
</blockquote>
</blockquote>
<blockquote>
<p>4.如果有左孩子<br></p>
<blockquote>
<p>5.判断是否能merge(merge_size &lt; min_size),能则merge，否则转6<br><br>6.向左孩子进行borrow<br></p>
</blockquote>
</blockquote>
<blockquote>
<p>merge操作后需要删除internal节点中的entry, 与删除leaf节点中的entry十分相似<br></p>
</blockquote>
<blockquote>
<p>如果删除的internal节点是root节点，那么删除后的size&#x3D;&#x3D;1表示下溢，需要将header_page_中的root_page_id_设置为page-&gt;GetArray()[0].second<br><br>如果删除的internal节点不是root节点，那么删除后的size &lt; min_size表示下溢<br><br>1.如果有右孩子<br></p>
<blockquote>
<p>2.判断是否能merge(merge_size &lt;&#x3D; max_size),能则merge，否则转3<br><br>3.向右孩子进行borrow<br></p>
</blockquote>
</blockquote>
<blockquote>
<p>4.如果有左孩子<br></p>
<blockquote>
<p>5.判断是否能merge(merge_size &lt;&#x3D; max_size),能则merge，否则转6<br><br>6.向左孩子进行borrow<br></p>
</blockquote>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BPLUSTREE_TYPE::Remove</span><span class="params">(<span class="type">const</span> KeyType &amp;key, Transaction *txn)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Declaration of context instance.</span></span><br><span class="line">  Context ctx;</span><br><span class="line">  ctx.header_page_ = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(header_page_id_);</span><br><span class="line">  <span class="keyword">auto</span> header_page = ctx.header_page_-&gt;<span class="built_in">AsMut</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (header_page-&gt;root_page_id_ == INVALID_PAGE_ID) &#123;  <span class="comment">// root not exist</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.root_page_id_ = header_page-&gt;root_page_id_;</span><br><span class="line">  ctx.write_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageWrite</span>(ctx.root_page_id_));</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsSafePage</span>(ctx.write_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;(), Operation::Remove, <span class="literal">true</span>)) &#123;</span><br><span class="line">    ctx.header_page_ = std::<span class="literal">nullopt</span>;  <span class="comment">// unlock header_page</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">FindLeafPage</span>(key, Operation::Remove, ctx);</span><br><span class="line">  <span class="keyword">auto</span> &amp;leaf_page_guard = ctx.write_set_.<span class="built_in">back</span>();</span><br><span class="line">  <span class="keyword">auto</span> leaf_page = leaf_page_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line">  <span class="type">int</span> pos = <span class="number">-1</span>;</span><br><span class="line">  <span class="comment">// key不存在</span></span><br><span class="line">  <span class="keyword">if</span> (!leaf_page-&gt;<span class="built_in">KeyIndex</span>(key, comparator_, pos)) &#123;</span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// key存在,将其从leaf中删除</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = pos + <span class="number">1</span>; i &lt; leaf_page-&gt;<span class="built_in">GetSize</span>(); ++i) &#123;</span><br><span class="line">    leaf_page-&gt;<span class="built_in">GetArray</span>()[i - <span class="number">1</span>] = leaf_page-&gt;<span class="built_in">GetArray</span>()[i];</span><br><span class="line">  &#125;</span><br><span class="line">  leaf_page-&gt;<span class="built_in">SetSize</span>(leaf_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);  <span class="comment">// 更新leaf_page的size</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (leaf_page-&gt;<span class="built_in">GetSize</span>() &gt;= leaf_page-&gt;<span class="built_in">GetMinSize</span>()) &#123;  <span class="comment">// 无underflow 直接返回</span></span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// underflow</span></span><br><span class="line">  <span class="keyword">if</span> (ctx.<span class="built_in">IsRootPage</span>(leaf_page_guard.<span class="built_in">PageId</span>())) &#123;  <span class="comment">// 该叶子节点是根节点</span></span><br><span class="line">    <span class="keyword">if</span> (leaf_page-&gt;<span class="built_in">GetSize</span>() == <span class="number">0</span>) &#123;               <span class="comment">// size为0</span></span><br><span class="line">      header_page-&gt;root_page_id_ = INVALID_PAGE_ID;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.<span class="built_in">Drop</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> &amp;parent_page_guard = ctx.write_set_[ctx.write_set_.<span class="built_in">size</span>() - <span class="number">2</span>];</span><br><span class="line">  <span class="keyword">auto</span> parent_page = parent_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">  <span class="keyword">auto</span> index = parent_page-&gt;<span class="built_in">ValueIndex</span>(leaf_page_guard.<span class="built_in">PageId</span>());</span><br><span class="line">  <span class="built_in">BUSTUB_ASSERT</span>(index != <span class="number">-1</span>, <span class="string">&quot;index must not be -1&quot;</span>);</span><br><span class="line">  <span class="comment">// 如果有右brother</span></span><br><span class="line">  <span class="keyword">if</span> (index &lt; parent_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">page_id_t</span> right_brother_page_id = parent_page-&gt;<span class="built_in">GetArray</span>()[index + <span class="number">1</span>].second;</span><br><span class="line">    <span class="keyword">auto</span> right_brother_page_guard = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(right_brother_page_id);</span><br><span class="line">    <span class="keyword">auto</span> right_brother_page = right_brother_page_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> merge_size = right_brother_page-&gt;<span class="built_in">GetSize</span>() + leaf_page-&gt;<span class="built_in">GetSize</span>();</span><br><span class="line">    <span class="keyword">if</span> (merge_size &lt; leaf_page-&gt;<span class="built_in">GetMaxSize</span>()) &#123;  <span class="comment">// 可以合并</span></span><br><span class="line">      <span class="comment">// merge</span></span><br><span class="line">      std::<span class="built_in">copy</span>(right_brother_page-&gt;<span class="built_in">GetArray</span>(), right_brother_page-&gt;<span class="built_in">GetArray</span>() + right_brother_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                leaf_page-&gt;<span class="built_in">GetArray</span>() + leaf_page-&gt;<span class="built_in">GetSize</span>());</span><br><span class="line">      leaf_page-&gt;<span class="built_in">SetSize</span>(merge_size);</span><br><span class="line">      leaf_page-&gt;<span class="built_in">SetNextPageId</span>(right_brother_page-&gt;<span class="built_in">GetNextPageId</span>());</span><br><span class="line">      <span class="built_in">RemoveFromParent</span>(index + <span class="number">1</span>, ctx, ctx.write_set_.<span class="built_in">size</span>() - <span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// borrow</span></span><br><span class="line">      leaf_page-&gt;<span class="built_in">GetArray</span>()[leaf_page-&gt;<span class="built_in">GetSize</span>()] = right_brother_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>];</span><br><span class="line">      std::<span class="built_in">copy</span>(right_brother_page-&gt;<span class="built_in">GetArray</span>() + <span class="number">1</span>, right_brother_page-&gt;<span class="built_in">GetArray</span>() + right_brother_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                right_brother_page-&gt;<span class="built_in">GetArray</span>());</span><br><span class="line">      leaf_page-&gt;<span class="built_in">IncreaseSize</span>(<span class="number">1</span>);</span><br><span class="line">      right_brother_page-&gt;<span class="built_in">SetSize</span>(right_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);</span><br><span class="line">      parent_page-&gt;<span class="built_in">SetKeyAt</span>(index + <span class="number">1</span>, right_brother_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].first);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 左brother</span></span><br><span class="line">    <span class="built_in">BUSTUB_ASSERT</span>(index - <span class="number">1</span> &gt;= <span class="number">0</span>, <span class="string">&quot;left brother must exist&quot;</span>);</span><br><span class="line">    <span class="type">page_id_t</span> left_brother_page_id = parent_page-&gt;<span class="built_in">GetArray</span>()[index - <span class="number">1</span>].second;</span><br><span class="line">    <span class="keyword">auto</span> left_brother_page_guard = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(left_brother_page_id);</span><br><span class="line">    <span class="keyword">auto</span> left_brother_page = left_brother_page_guard.<span class="built_in">AsMut</span>&lt;LeafPage&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> merge_size = left_brother_page-&gt;<span class="built_in">GetSize</span>() + leaf_page-&gt;<span class="built_in">GetSize</span>();</span><br><span class="line">    <span class="keyword">if</span> (merge_size &lt; left_brother_page-&gt;<span class="built_in">GetMaxSize</span>()) &#123;  <span class="comment">// 可以合并</span></span><br><span class="line">      <span class="comment">// merge</span></span><br><span class="line">      std::<span class="built_in">copy</span>(leaf_page-&gt;<span class="built_in">GetArray</span>(), leaf_page-&gt;<span class="built_in">GetArray</span>() + leaf_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                left_brother_page-&gt;<span class="built_in">GetArray</span>() + left_brother_page-&gt;<span class="built_in">GetSize</span>());</span><br><span class="line">      left_brother_page-&gt;<span class="built_in">SetSize</span>(merge_size);</span><br><span class="line">      left_brother_page-&gt;<span class="built_in">SetNextPageId</span>(leaf_page-&gt;<span class="built_in">GetNextPageId</span>());</span><br><span class="line">      <span class="built_in">RemoveFromParent</span>(index, ctx, ctx.write_set_.<span class="built_in">size</span>() - <span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// borrow</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> i = leaf_page-&gt;<span class="built_in">GetSize</span>(); i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">        leaf_page-&gt;<span class="built_in">GetArray</span>()[i] = leaf_page-&gt;<span class="built_in">GetArray</span>()[i - <span class="number">1</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      leaf_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>] = left_brother_page-&gt;<span class="built_in">GetArray</span>()[left_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>];</span><br><span class="line">      leaf_page-&gt;<span class="built_in">IncreaseSize</span>(<span class="number">1</span>);</span><br><span class="line">      left_brother_page-&gt;<span class="built_in">SetSize</span>(left_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);</span><br><span class="line">      parent_page-&gt;<span class="built_in">SetKeyAt</span>(index, leaf_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].first);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.<span class="built_in">Drop</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BPLUSTREE_TYPE::RemoveFromParent</span><span class="params">(<span class="type">int</span> valueIndex, Context &amp;ctx, <span class="type">int</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> &amp;page_guard = ctx.write_set_[index];</span><br><span class="line">  <span class="keyword">auto</span> page = page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = valueIndex + <span class="number">1</span>; i &lt; page-&gt;<span class="built_in">GetSize</span>(); ++i) &#123;  <span class="comment">// 删除key value</span></span><br><span class="line">    page-&gt;<span class="built_in">GetArray</span>()[i - <span class="number">1</span>] = page-&gt;<span class="built_in">GetArray</span>()[i];</span><br><span class="line">  &#125;</span><br><span class="line">  page-&gt;<span class="built_in">SetSize</span>(page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);  <span class="comment">// 更新page的size</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (page-&gt;<span class="built_in">GetSize</span>() &gt;= page-&gt;<span class="built_in">GetMinSize</span>()) &#123;  <span class="comment">// 无underflow</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// underflow</span></span><br><span class="line">  <span class="keyword">if</span> (ctx.<span class="built_in">IsRootPage</span>(page_guard.<span class="built_in">PageId</span>())) &#123;  <span class="comment">// 该page是根节点</span></span><br><span class="line">    <span class="keyword">if</span> (page-&gt;<span class="built_in">GetSize</span>() == <span class="number">1</span>) &#123;               <span class="comment">// 根节点需要更换了</span></span><br><span class="line">      <span class="built_in">BUSTUB_ASSERT</span>(ctx.header_page_ != std::<span class="literal">nullopt</span>, <span class="string">&quot;ctx.header_page must exist&quot;</span>);</span><br><span class="line">      <span class="keyword">auto</span> header_page = ctx.header_page_-&gt;<span class="built_in">AsMut</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">      header_page-&gt;root_page_id_ = page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].second;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">BUSTUB_ASSERT</span>(index - <span class="number">1</span> &gt;= <span class="number">0</span>, <span class="string">&quot;parent_page_guard must exist&quot;</span>);</span><br><span class="line">  <span class="keyword">auto</span> &amp;parent_page_guard = ctx.write_set_[index - <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">auto</span> parent_page = parent_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line">  <span class="keyword">auto</span> pos = parent_page-&gt;<span class="built_in">ValueIndex</span>(page_guard.<span class="built_in">PageId</span>());</span><br><span class="line">  <span class="built_in">BUSTUB_ASSERT</span>(pos != <span class="number">-1</span>, <span class="string">&quot;pos must not be -1&quot;</span>);</span><br><span class="line">  <span class="comment">// 如果有右brother</span></span><br><span class="line">  <span class="keyword">if</span> (pos &lt; parent_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">page_id_t</span> right_brother_page_id = parent_page-&gt;<span class="built_in">GetArray</span>()[pos + <span class="number">1</span>].second;</span><br><span class="line">    <span class="keyword">auto</span> right_brother_page_guard = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(right_brother_page_id);</span><br><span class="line">    <span class="keyword">auto</span> right_brother_page = right_brother_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> merge_size = right_brother_page-&gt;<span class="built_in">GetSize</span>() + page-&gt;<span class="built_in">GetSize</span>();</span><br><span class="line">    <span class="keyword">if</span> (merge_size &lt;= page-&gt;<span class="built_in">GetMaxSize</span>()) &#123;  <span class="comment">// 可以合并</span></span><br><span class="line">      <span class="comment">// merge</span></span><br><span class="line">      std::<span class="built_in">copy</span>(right_brother_page-&gt;<span class="built_in">GetArray</span>(), right_brother_page-&gt;<span class="built_in">GetArray</span>() + right_brother_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                page-&gt;<span class="built_in">GetArray</span>() + page-&gt;<span class="built_in">GetSize</span>());</span><br><span class="line">      page-&gt;<span class="built_in">SetSize</span>(merge_size);</span><br><span class="line">      <span class="built_in">RemoveFromParent</span>(pos + <span class="number">1</span>, ctx, index - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// borrow</span></span><br><span class="line">      page-&gt;<span class="built_in">GetArray</span>()[page-&gt;<span class="built_in">GetSize</span>()] = right_brother_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>];</span><br><span class="line">      std::<span class="built_in">copy</span>(right_brother_page-&gt;<span class="built_in">GetArray</span>() + <span class="number">1</span>, right_brother_page-&gt;<span class="built_in">GetArray</span>() + right_brother_page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                right_brother_page-&gt;<span class="built_in">GetArray</span>());</span><br><span class="line">      page-&gt;<span class="built_in">IncreaseSize</span>(<span class="number">1</span>);</span><br><span class="line">      right_brother_page-&gt;<span class="built_in">SetSize</span>(right_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);</span><br><span class="line">      parent_page-&gt;<span class="built_in">SetKeyAt</span>(pos + <span class="number">1</span>, right_brother_page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].first);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 左brother</span></span><br><span class="line">    <span class="built_in">BUSTUB_ASSERT</span>(pos - <span class="number">1</span> &gt;= <span class="number">0</span>, <span class="string">&quot;left brother must exist&quot;</span>);</span><br><span class="line">    <span class="type">page_id_t</span> left_brother_page_id = parent_page-&gt;<span class="built_in">GetArray</span>()[pos - <span class="number">1</span>].second;</span><br><span class="line">    <span class="keyword">auto</span> left_brother_page_guard = bpm_-&gt;<span class="built_in">FetchPageWrite</span>(left_brother_page_id);</span><br><span class="line">    <span class="keyword">auto</span> left_brother_page = left_brother_page_guard.<span class="built_in">AsMut</span>&lt;InternalPage&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> merge_size = left_brother_page-&gt;<span class="built_in">GetSize</span>() + page-&gt;<span class="built_in">GetSize</span>();</span><br><span class="line">    <span class="keyword">if</span> (merge_size &lt;= left_brother_page-&gt;<span class="built_in">GetMaxSize</span>()) &#123;  <span class="comment">// 可以合并</span></span><br><span class="line">      <span class="comment">// merge</span></span><br><span class="line">      std::<span class="built_in">copy</span>(page-&gt;<span class="built_in">GetArray</span>(), page-&gt;<span class="built_in">GetArray</span>() + page-&gt;<span class="built_in">GetSize</span>(),</span><br><span class="line">                left_brother_page-&gt;<span class="built_in">GetArray</span>() + left_brother_page-&gt;<span class="built_in">GetSize</span>());</span><br><span class="line">      left_brother_page-&gt;<span class="built_in">SetSize</span>(merge_size);</span><br><span class="line">      <span class="built_in">RemoveFromParent</span>(pos, ctx, index - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// borrow</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> i = page-&gt;<span class="built_in">GetSize</span>(); i &gt;= <span class="number">1</span>; --i) &#123;</span><br><span class="line">        page-&gt;<span class="built_in">GetArray</span>()[i] = page-&gt;<span class="built_in">GetArray</span>()[i - <span class="number">1</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>] = left_brother_page-&gt;<span class="built_in">GetArray</span>()[left_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>];</span><br><span class="line">      page-&gt;<span class="built_in">IncreaseSize</span>(<span class="number">1</span>);</span><br><span class="line">      left_brother_page-&gt;<span class="built_in">SetSize</span>(left_brother_page-&gt;<span class="built_in">GetSize</span>() - <span class="number">1</span>);</span><br><span class="line">      parent_page-&gt;<span class="built_in">SetKeyAt</span>(pos, page-&gt;<span class="built_in">GetArray</span>()[<span class="number">0</span>].first);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Task-3-Index-Iterator"><a href="#Task-3-Index-Iterator" class="headerlink" title="Task #3 Index Iterator"></a>Task #3 Index Iterator</h2><p>Index Iterator 代码实现：</p>
<blockquote>
<p>Index Iterator的实现只需要支持单线程</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">INDEXITERATOR_TYPE::IsEnd</span><span class="params">()</span> <span class="type">const</span> -&gt; <span class="type">bool</span> </span>&#123; <span class="keyword">return</span> read_guard_ == std::<span class="literal">nullopt</span>; &#125;</span><br><span class="line"></span><br><span class="line">INDEX_TEMPLATE_ARGUMENTS</span><br><span class="line"><span class="keyword">auto</span> INDEXITERATOR_TYPE::<span class="keyword">operator</span>*() -&gt; <span class="type">const</span> MappingType &amp; &#123;</span><br><span class="line">  <span class="keyword">auto</span> page = read_guard_-&gt;<span class="built_in">As</span>&lt;B_PLUS_TREE_LEAF_PAGE_TYPE&gt;();</span><br><span class="line">  <span class="built_in">BUSTUB_ASSERT</span>(page-&gt;<span class="built_in">GetSize</span>() &gt; index_, <span class="string">&quot;index_ must be valid&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> page-&gt;<span class="built_in">GetArray</span>()[index_];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">INDEX_TEMPLATE_ARGUMENTS</span><br><span class="line"><span class="keyword">auto</span> INDEXITERATOR_TYPE::<span class="keyword">operator</span>++() -&gt; INDEXITERATOR_TYPE &amp; &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsEnd</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> leaf_page = read_guard_-&gt;<span class="built_in">As</span>&lt;B_PLUS_TREE_LEAF_PAGE_TYPE&gt;();</span><br><span class="line">  <span class="keyword">if</span> (index_ + <span class="number">1</span> &lt; leaf_page-&gt;<span class="built_in">GetSize</span>()) &#123;</span><br><span class="line">    index_++;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (leaf_page-&gt;<span class="built_in">GetNextPageId</span>() != INVALID_PAGE_ID) &#123;</span><br><span class="line">    read_guard_ = bpm_-&gt;<span class="built_in">FetchPageRead</span>(leaf_page-&gt;<span class="built_in">GetNextPageId</span>());</span><br><span class="line">    index_ = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  read_guard_ = std::<span class="literal">nullopt</span>;</span><br><span class="line">  index_ = INVALID_PAGE_ID;</span><br><span class="line">  <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> <span class="keyword">operator</span>==(<span class="type">const</span> IndexIterator &amp;itr) <span class="type">const</span> -&gt; <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsEnd</span>() &amp;&amp; itr.<span class="built_in">IsEnd</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsEnd</span>() || itr.<span class="built_in">IsEnd</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> read_guard_-&gt;<span class="built_in">PageId</span>() == itr.read_guard_-&gt;<span class="built_in">PageId</span>() &amp;&amp; index_ == itr.index_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> <span class="keyword">operator</span>!=(<span class="type">const</span> IndexIterator &amp;itr) <span class="type">const</span> -&gt; <span class="type">bool</span> &#123; <span class="keyword">return</span> !(*<span class="keyword">this</span> == itr); &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>BplusTree实现Begin和End函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::Begin</span><span class="params">()</span> -&gt; INDEXITERATOR_TYPE </span>&#123;</span><br><span class="line">  Context ctx;</span><br><span class="line">  <span class="keyword">auto</span> header_page_guard = bpm_-&gt;<span class="built_in">FetchPageRead</span>(header_page_id_);</span><br><span class="line">  <span class="keyword">auto</span> header_page = header_page_guard.<span class="built_in">As</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (header_page-&gt;root_page_id_ == INVALID_PAGE_ID) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">INDEXITERATOR_TYPE</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.root_page_id_ = header_page-&gt;root_page_id_;</span><br><span class="line">  ctx.read_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageRead</span>(ctx.root_page_id_));</span><br><span class="line">  header_page_guard.<span class="built_in">Drop</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> page = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">  <span class="keyword">while</span> (!page-&gt;<span class="built_in">IsLeafPage</span>()) &#123;</span><br><span class="line">    <span class="keyword">auto</span> internal = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;InternalPage&gt;();</span><br><span class="line">    <span class="type">page_id_t</span> id = internal-&gt;<span class="built_in">ValueAt</span>(<span class="number">0</span>);</span><br><span class="line">    ctx.read_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageRead</span>(id));</span><br><span class="line">    ctx.read_set_.<span class="built_in">pop_front</span>();</span><br><span class="line">    page = ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;BPlusTreePage&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">INDEXITERATOR_TYPE</span>(bpm_, std::<span class="built_in">move</span>(ctx.read_set_.<span class="built_in">back</span>()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::Begin</span><span class="params">(<span class="type">const</span> KeyType &amp;key)</span> -&gt; INDEXITERATOR_TYPE </span>&#123;</span><br><span class="line">  Context ctx;</span><br><span class="line">  <span class="keyword">auto</span> header_page_guard = bpm_-&gt;<span class="built_in">FetchPageRead</span>(header_page_id_);</span><br><span class="line">  <span class="keyword">auto</span> header_page = header_page_guard.<span class="built_in">As</span>&lt;BPlusTreeHeaderPage&gt;();</span><br><span class="line">  <span class="keyword">if</span> (header_page-&gt;root_page_id_ == INVALID_PAGE_ID) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">INDEXITERATOR_TYPE</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.root_page_id_ = header_page-&gt;root_page_id_;</span><br><span class="line">  ctx.read_set_.<span class="built_in">push_back</span>(bpm_-&gt;<span class="built_in">FetchPageRead</span>(ctx.root_page_id_));</span><br><span class="line">  header_page_guard.<span class="built_in">Drop</span>();</span><br><span class="line">  <span class="built_in">FindLeafPage</span>(key, Operation::Search, ctx);</span><br><span class="line">  <span class="type">int</span> pos = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (!ctx.read_set_.<span class="built_in">back</span>().<span class="built_in">As</span>&lt;LeafPage&gt;()-&gt;<span class="built_in">KeyIndex</span>(key, comparator_, pos)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">Exception</span>(<span class="string">&quot;key not exist&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">INDEXITERATOR_TYPE</span>(bpm_, std::<span class="built_in">move</span>(ctx.read_set_.<span class="built_in">back</span>()), pos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">INDEX_TEMPLATE_ARGUMENTS</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">BPLUSTREE_TYPE::End</span><span class="params">()</span> -&gt; INDEXITERATOR_TYPE </span>&#123; <span class="keyword">return</span> <span class="built_in">INDEXITERATOR_TYPE</span>(); &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Task-4-Concurrency-Control"><a href="#Task-4-Concurrency-Control" class="headerlink" title="Task #4 Concurrency Control"></a>Task #4 Concurrency Control</h2><h3 id="Latch-Crabbing-Coupling"><a href="#Latch-Crabbing-Coupling" class="headerlink" title="Latch Crabbing&#x2F;Coupling"></a>Latch Crabbing&#x2F;Coupling<br></h3><p>Latch Crabbing 的基本思想如下：<br></p>
<ol>
<li>获取 parent 的 latch<br></li>
<li>获取 child 的 latch<br></li>
<li>如果安全，则可以释放 parent 的 latch</li>
</ol>
<p>这里的“安全”指的是，当发生更新操作时，该节点不会发生 split 或 merge 的操作，即：</p>
<ul>
<li>在插入元素时，节点未满</li>
<li>在删除元素时，节点超过半满</li>
</ul>
<p>Search<br>从 root 往下，不断地：</p>
<ul>
<li>获取 child 的 read latch</li>
<li>释放 parent 的 read latch</li>
</ul>
<p><img src="/../images/cmu15445-project2/8.png" alt="img"><br><img src="/../images/cmu15445-project2/9.png" alt="img"><br><img src="/../images/cmu15445-project2/10.png" alt="img"><br><img src="/../images/cmu15445-project2/11.png" alt="img"><br><img src="/../images/cmu15445-project2/12.png" alt="img"></p>
<p>Insert&#x2F;Delete<br><br>从 root 往下，按照需要获取 write latch，一旦获取了 child 的 write latch，检查它是否安全，如果安全，则释放之前获取的所有 write latch。<br>安全判断函数逻辑见函数IsSafePage<br></p>
<h3 id="Better-Latching-Algorithm"><a href="#Better-Latching-Algorithm" class="headerlink" title="Better Latching Algorithm"></a>Better Latching Algorithm<br></h3><ul>
<li>Search：与 Latch Crabbing 相同<br></li>
<li>Insert&#x2F;Delete:<br><ul>
<li>使用与 Search 相同的方式在查询路径上获取、释放 latch，在 leaf node 上获取 write latch<br></li>
<li>如果 leaf node 不安全，可能会引起其它节点的变动，则使用 Latch Crabbing 的策略再执行一遍<br></li>
</ul>
</li>
</ul>
<p>该方法乐观地假设整个操作只会引起 leaf node 的变化，若假设错误，则使用 Latch Crabbing 的原始方案。<br></p>
<p>CheckPoint#2本地测试<br><br><img src="/../images/cmu15445-project2/13.png" alt="img"><br><img src="/../images/cmu15445-project2/14.png" alt="img"><br><img src="/../images/cmu15445-project2/15.png" alt="img"><br><img src="/../images/cmu15445-project2/16.png" alt="img"></p>
<p><a target="_blank" rel="noopener" href="https://15445.courses.cs.cmu.edu/spring2023/bpt-printer/">Bustub Tree printer</a><br></p>
<p>CheckPoint#2线上测试<br><br><img src="/../images/cmu15445-project2/7.png" alt="img"></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/cmu15445%E2%80%942023/" rel="tag"># cmu15445—2023</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/02/26/cmu15445-project1/" rel="prev" title="cmu15445-project1">
      <i class="fa fa-chevron-left"></i> cmu15445-project1
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/02/27/cmu15445-project3/" rel="next" title="cmu15445-project3">
      cmu15445-project3 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#B-Tree"><span class="nav-number">1.</span> <span class="nav-text">B+ Tree</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#B-Tree-Operations"><span class="nav-number">2.</span> <span class="nav-text">B+ Tree Operations</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CheckPoint-1"><span class="nav-number">3.</span> <span class="nav-text">CheckPoint#1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Task-1-B-Tree-Pages"><span class="nav-number">3.1.</span> <span class="nav-text">Task #1 B+ Tree Pages</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#class-BPlusTreePage%E7%9A%843%E4%B8%AA%E7%B1%BB%E6%88%90%E5%91%98"><span class="nav-number">3.1.1.</span> <span class="nav-text">class BPlusTreePage的3个类成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#class-BPlusTreeInternalPage-public-BPlusTreePage"><span class="nav-number">3.1.2.</span> <span class="nav-text">class BPlusTreeInternalPage : public BPlusTreePage </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#class-BPlusTreeLeafPage-public-BPlusTreePage"><span class="nav-number">3.1.3.</span> <span class="nav-text">class BPlusTreeLeafPage : public BPlusTreePage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Class-BplusTreeHeaderPage"><span class="nav-number">3.1.4.</span> <span class="nav-text">Class BplusTreeHeaderPage</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Task-2a-B-Tree-Data-Structure-Insertion-Point-Search"><span class="nav-number">3.2.</span> <span class="nav-text">Task #2a B+ Tree Data Structure(Insertion, Point Search)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CheckPoint-2"><span class="nav-number">4.</span> <span class="nav-text">CheckPoint#2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Task-2b-B-Tree-Data-Structure-Deletion"><span class="nav-number">4.1.</span> <span class="nav-text">Task #2b B+ Tree Data Structure(Deletion)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Task-3-Index-Iterator"><span class="nav-number">4.2.</span> <span class="nav-text">Task #3 Index Iterator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Task-4-Concurrency-Control"><span class="nav-number">4.3.</span> <span class="nav-text">Task #4 Concurrency Control</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Latch-Crabbing-Coupling"><span class="nav-number">4.3.1.</span> <span class="nav-text">Latch Crabbing&#x2F;Coupling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Better-Latching-Algorithm"><span class="nav-number">4.3.2.</span> <span class="nav-text">Better Latching Algorithm</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="jingtao8a"
      src="/images/iverson.jpg">
  <p class="site-author-name" itemprop="name">jingtao8a</p>
  <div class="site-description" itemprop="description">this is life, full of ups and down</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jingtao8a</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
